{
  "name": "SENTINEL Knowledge Agent v2 - Enhanced AI",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "id": "trigger-schedule",
      "name": "Run Every 6 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, insight_type, content, confidence_score, metadata, created_at\nFROM mottivme_intelligence_system.sentinel_insights\nWHERE processed_for_kb = false\n  AND insight_type IN ('pattern', 'solution', 'recommendation')\nORDER BY confidence_score DESC, created_at DESC\nLIMIT 50",
        "options": {}
      },
      "id": "get-unprocessed-insights",
      "name": "Get Unprocessed Insights",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [450, 300],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT title, content, tags, category, created_at\nFROM mottivme_intelligence_system.knowledge_base\nWHERE created_at >= NOW() - INTERVAL '7 days'\nORDER BY created_at DESC\nLIMIT 20",
        "options": {}
      },
      "id": "get-recent-kb",
      "name": "Get Recent KB Entries",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [450, 450],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-insights",
      "name": "Process One by One",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Prepare enhanced prompt with context\nconst item = $input.first().json;\nconst recentKB = $('Get Recent KB Entries').all().map(k => k.json);\n\n// Build context from recent KB entries\nconst recentContext = recentKB.length > 0 \n  ? recentKB.slice(0, 5).map(kb => `- ${kb.title} [${kb.category}]`).join('\\n')\n  : 'Nenhuma entrada recente';\n\nconst prompt = `Analise este insight e decida se deve virar uma entrada de Knowledge Base.\n\n## INSIGHT A ANALISAR\nTipo: ${item.insight_type}\nConteúdo: ${item.content}\nConfiança: ${item.confidence_score}\nContexto: ${JSON.stringify(item.metadata || {})}\n\n## ENTRADAS RECENTES NA KB (últimos 7 dias)\n${recentContext}\n\n## SUA TAREFA\n1. Verifique se já existe entrada similar nas entradas recentes\n2. Avalie se o insight traz valor único para a KB\n3. Se SIM, crie uma entrada estruturada\n4. Se NÃO, explique o motivo\n\n## RESPOSTA OBRIGATÓRIA (JSON puro, sem markdown):\n{\n  \"should_create\": true/false,\n  \"reason\": \"Explicação da decisão\",\n  \"is_duplicate\": true/false,\n  \"category\": \"faq|solution|process|best_practice\",\n  \"title\": \"Título claro e objetivo (max 100 chars)\",\n  \"content\": \"Conteúdo detalhado, útil e acionável\",\n  \"tags\": [\"tag1\", \"tag2\", \"tag3\"],\n  \"priority\": 1-5\n}`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    insight_id: item.id,\n    original_content: item.content,\n    insight_type: item.insight_type\n  }\n}];"
      },
      "id": "prepare-enhanced-prompt",
      "name": "Prepare Enhanced Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.prompt }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "# IDENTIDADE\nVocê é o SENTINEL Knowledge Agent v2 - um sistema de curadoria inteligente de Knowledge Base.\n\n# MISSÃO\nTransformar insights valiosos em entradas de KB estruturadas, evitando duplicatas e mantendo alta qualidade.\n\n# REGRAS DE CURADORIA\n\n## 1. VERIFICAÇÃO DE DUPLICATAS\n- Compare o insight com entradas recentes da KB\n- Se encontrar conteúdo similar (>70% overlap semântico), marque is_duplicate: true\n- Mesmo conteúdo com palavras diferentes = duplicata\n\n## 2. CRITÉRIOS DE QUALIDADE\nCrie entrada APENAS se:\n- ✅ Traz informação acionável e específica\n- ✅ É relevante para CS/suporte\n- ✅ Não é duplicata\n- ✅ Tem confiança >= 0.7\n- ❌ NÃO criar se: muito genérico, óbvio, ou vago\n\n## 3. CATEGORIZAÇÃO\n- **faq**: Pergunta frequente de cliente\n- **solution**: Solução para problema específico\n- **process**: Processo ou workflow\n- **best_practice**: Melhores práticas\n\n## 4. ESTRUTURA DO CONTEÚDO\n- Título: Claro, objetivo, searchable\n- Conteúdo: Detalhado, com passos se aplicável\n- Tags: 3-5 tags relevantes (lowercase, sem acentos)\n- Prioridade: 1=baixa, 3=média, 5=crítica\n\n# OUTPUT OBRIGATÓRIO\n\nResponda SEMPRE com JSON puro (sem ```json, sem markdown):\n\n{\n  \"should_create\": boolean,\n  \"reason\": \"string\",\n  \"is_duplicate\": boolean,\n  \"category\": \"faq|solution|process|best_practice\",\n  \"title\": \"string\",\n  \"content\": \"string\",\n  \"tags\": [\"string\"],\n  \"priority\": number\n}\n\nSe should_create=false, apenas reason é obrigatório."
        }
      },
      "id": "knowledge-agent-v2",
      "name": "Knowledge Curator Agent v2",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "model": "llama-3.3-70b-versatile",
        "options": {
          "temperature": 0.3,
          "maxTokens": 2000
        }
      },
      "id": "groq-model",
      "name": "Groq Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [1050, 500],
      "credentials": {
        "groqApi": {
          "id": "WVbQ0d3w6cnLwPtX",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "fromJson",
        "jsonSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"should_create\": { \"type\": \"boolean\" },\n    \"reason\": { \"type\": \"string\" },\n    \"is_duplicate\": { \"type\": \"boolean\" },\n    \"category\": { \"type\": \"string\", \"enum\": [\"faq\", \"solution\", \"process\", \"best_practice\"] },\n    \"title\": { \"type\": \"string\" },\n    \"content\": { \"type\": \"string\" },\n    \"tags\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"priority\": { \"type\": \"number\", \"minimum\": 1, \"maximum\": 5 }\n  },\n  \"required\": [\"should_create\", \"reason\"]\n}"
      },
      "id": "output-parser",
      "name": "Structured Output Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [1050, 650]
    },
    {
      "parameters": {
        "jsCode": "// Enhanced parsing with retry logic\nconst aiResponse = $input.first().json;\nconst preparedData = $('Prepare Enhanced Prompt').first().json;\n\nlet parsed;\ntry {\n  // Try multiple extraction methods\n  let content = aiResponse.output || aiResponse.text || aiResponse.json || JSON.stringify(aiResponse);\n  \n  // Clean markdown artifacts\n  content = content.replace(/```json\\s*/g, '').replace(/```\\s*/g, '').trim();\n  \n  // Try direct parse\n  try {\n    parsed = typeof content === 'string' ? JSON.parse(content) : content;\n  } catch {\n    // Extract JSON from text\n    const match = content.match(/\\{[\\s\\S]*?\\}/g);\n    if (match && match.length > 0) {\n      // Get the largest JSON object (likely the complete one)\n      const largest = match.reduce((a, b) => a.length > b.length ? a : b);\n      parsed = JSON.parse(largest);\n    }\n  }\n  \n  // Validate parsed object\n  if (!parsed || typeof parsed.should_create === 'undefined') {\n    throw new Error('Invalid response structure');\n  }\n  \n} catch (error) {\n  // Fallback: mark as failed for retry\n  return [{\n    json: {\n      parse_failed: true,\n      skip: true,\n      insight_id: preparedData.insight_id,\n      reason: `Parse error: ${error.message}`,\n      raw_response: aiResponse\n    }\n  }];\n}\n\n// Check if should skip\nif (!parsed.should_create || parsed.is_duplicate) {\n  return [{\n    json: {\n      skip: true,\n      insight_id: preparedData.insight_id,\n      reason: parsed.reason || 'Not relevant or duplicate',\n      is_duplicate: parsed.is_duplicate || false\n    }\n  }];\n}\n\n// Valid entry to create\nreturn [{\n  json: {\n    skip: false,\n    insight_id: preparedData.insight_id,\n    insight_type: preparedData.insight_type,\n    knowledge_entry: {\n      category: parsed.category || 'solution',\n      title: (parsed.title || '').substring(0, 100),\n      content: parsed.content || '',\n      tags: Array.isArray(parsed.tags) ? parsed.tags.slice(0, 5) : [],\n      priority: Math.min(5, Math.max(1, parsed.priority || 3)),\n      source: 'sentinel_ai_v2',\n      source_insight_id: preparedData.insight_id,\n      status: 'published'\n    },\n    ai_reason: parsed.reason\n  }\n}];"
      },
      "id": "parse-enhanced-response",
      "name": "Parse & Validate Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-skip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-should-create",
      "name": "Should Create Entry?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Additional duplicate check using similarity\nSELECT id, title, \n  similarity(title, $1) as title_sim,\n  similarity(content, $2) as content_sim\nFROM mottivme_intelligence_system.knowledge_base\nWHERE created_at >= NOW() - INTERVAL '30 days'\n  AND (similarity(title, $1) > 0.6 OR similarity(content, $2) > 0.5)\nORDER BY GREATEST(similarity(title, $1), similarity(content, $2)) DESC\nLIMIT 1",
        "options": {
          "queryReplacement": "={{ [$json.knowledge_entry.title, $json.knowledge_entry.content] }}"
        }
      },
      "id": "similarity-check",
      "name": "Similarity Check (Final)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1650, 200],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-similar",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-no-duplicates",
      "name": "No Duplicates?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO mottivme_intelligence_system.knowledge_base (\n  category, title, content, tags, priority, source, source_insight_id, status, usage_count, helpful_votes, not_helpful_count, created_by\n) VALUES ($1, $2, $3, $4::jsonb::text[], $5, $6, $7::uuid, $8, 0, 0, 0, 'SENTINEL AI')\nRETURNING id, title",
        "options": {
          "queryReplacement": "={{ [\n  $('Parse & Validate Response').first().json.knowledge_entry.category,\n  $('Parse & Validate Response').first().json.knowledge_entry.title,\n  $('Parse & Validate Response').first().json.knowledge_entry.content,\n  JSON.stringify($('Parse & Validate Response').first().json.knowledge_entry.tags || []),\n  $('Parse & Validate Response').first().json.knowledge_entry.priority,\n  $('Parse & Validate Response').first().json.knowledge_entry.source,\n  $('Parse & Validate Response').first().json.knowledge_entry.source_insight_id,\n  $('Parse & Validate Response').first().json.knowledge_entry.status\n] }}"
        }
      },
      "id": "insert-knowledge",
      "name": "Insert to Knowledge Base",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2050, 250],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE mottivme_intelligence_system.sentinel_insights\nSET processed_for_kb = true, updated_at = NOW()\nWHERE id = $1::uuid",
        "options": {
          "queryReplacement": "={{ [$('Parse & Validate Response').first().json.insight_id] }}"
        }
      },
      "id": "mark-processed-success",
      "name": "Mark as Processed (Created)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2250, 300],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE mottivme_intelligence_system.sentinel_insights\nSET processed_for_kb = true, updated_at = NOW()\nWHERE id = $1::uuid",
        "options": {
          "queryReplacement": "={{ [$json.insight_id] }}"
        }
      },
      "id": "mark-processed-skipped",
      "name": "Mark as Processed (Skipped)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1650, 450],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE mottivme_intelligence_system.sentinel_insights\nSET processed_for_kb = true, updated_at = NOW()\nWHERE id = $1::uuid",
        "options": {
          "queryReplacement": "={{ [$('Parse & Validate Response').first().json.insight_id] }}"
        }
      },
      "id": "mark-processed-duplicate",
      "name": "Mark as Processed (Duplicate)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2050, 450],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Aggregate metrics from all processed items\nconst allData = $input.all();\n\nconst metrics = {\n  total_processed: allData.length,\n  created: 0,\n  skipped: 0,\n  duplicates: 0,\n  parse_errors: 0,\n  by_category: {},\n  avg_priority: 0\n};\n\nlet totalPriority = 0;\nlet priorityCount = 0;\n\nallData.forEach(item => {\n  const data = item.json;\n  \n  if (data.skip) {\n    if (data.is_duplicate) {\n      metrics.duplicates++;\n    } else if (data.parse_failed) {\n      metrics.parse_errors++;\n    } else {\n      metrics.skipped++;\n    }\n  } else if (data.knowledge_entry) {\n    metrics.created++;\n    const cat = data.knowledge_entry.category || 'unknown';\n    metrics.by_category[cat] = (metrics.by_category[cat] || 0) + 1;\n    \n    if (data.knowledge_entry.priority) {\n      totalPriority += data.knowledge_entry.priority;\n      priorityCount++;\n    }\n  }\n});\n\nmetrics.avg_priority = priorityCount > 0 ? (totalPriority / priorityCount).toFixed(2) : 0;\n\nconst timestamp = new Date().toISOString();\n\nreturn [{\n  json: {\n    execution_time: timestamp,\n    metrics: metrics,\n    summary: `Processados: ${metrics.total_processed} | Criados: ${metrics.created} | Pulados: ${metrics.skipped} | Duplicatas: ${metrics.duplicates} | Erros: ${metrics.parse_errors}`\n  }\n}];"
      },
      "id": "collect-metrics",
      "name": "Collect Execution Metrics",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2450, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO mottivme_intelligence_system.sentinel_insights (\n  insight_type, content, confidence_score, metadata, processed_for_kb\n) VALUES (\n  'kb_curation_metrics',\n  $1,\n  1.0,\n  $2::jsonb,\n  true\n) RETURNING id",
        "options": {
          "queryReplacement": "={{ [$json.summary, JSON.stringify($json.metrics)] }}"
        }
      },
      "id": "save-metrics",
      "name": "Save Metrics to DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2650, 300],
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels."
        }
      }
    }
  ],
  "connections": {
    "Run Every 6 Hours": {
      "main": [[
        { "node": "Get Unprocessed Insights", "type": "main", "index": 0 },
        { "node": "Get Recent KB Entries", "type": "main", "index": 0 }
      ]]
    },
    "Get Unprocessed Insights": {
      "main": [[{ "node": "Process One by One", "type": "main", "index": 0 }]]
    },
    "Process One by One": {
      "main": [[{ "node": "Prepare Enhanced Prompt", "type": "main", "index": 0 }]]
    },
    "Prepare Enhanced Prompt": {
      "main": [[{ "node": "Knowledge Curator Agent v2", "type": "main", "index": 0 }]]
    },
    "Knowledge Curator Agent v2": {
      "main": [[{ "node": "Parse & Validate Response", "type": "main", "index": 0 }]]
    },
    "Groq Chat Model": {
      "ai_languageModel": [[{ "node": "Knowledge Curator Agent v2", "type": "ai_languageModel", "index": 0 }]]
    },
    "Structured Output Parser": {
      "ai_outputParser": [[{ "node": "Knowledge Curator Agent v2", "type": "ai_outputParser", "index": 0 }]]
    },
    "Parse & Validate Response": {
      "main": [[{ "node": "Should Create Entry?", "type": "main", "index": 0 }]]
    },
    "Should Create Entry?": {
      "main": [
        [{ "node": "Similarity Check (Final)", "type": "main", "index": 0 }],
        [{ "node": "Mark as Processed (Skipped)", "type": "main", "index": 0 }]
      ]
    },
    "Similarity Check (Final)": {
      "main": [[{ "node": "No Duplicates?", "type": "main", "index": 0 }]]
    },
    "No Duplicates?": {
      "main": [
        [{ "node": "Insert to Knowledge Base", "type": "main", "index": 0 }],
        [{ "node": "Mark as Processed (Duplicate)", "type": "main", "index": 0 }]
      ]
    },
    "Insert to Knowledge Base": {
      "main": [[{ "node": "Mark as Processed (Created)", "type": "main", "index": 0 }]]
    },
    "Mark as Processed (Created)": {
      "main": [[
        { "node": "Process One by One", "type": "main", "index": 0 },
        { "node": "Collect Execution Metrics", "type": "main", "index": 0 }
      ]]
    },
    "Mark as Processed (Skipped)": {
      "main": [[
        { "node": "Process One by One", "type": "main", "index": 0 },
        { "node": "Collect Execution Metrics", "type": "main", "index": 0 }
      ]]
    },
    "Mark as Processed (Duplicate)": {
      "main": [[
        { "node": "Process One by One", "type": "main", "index": 0 },
        { "node": "Collect Execution Metrics", "type": "main", "index": 0 }
      ]]
    },
    "Collect Execution Metrics": {
      "main": [[{ "node": "Save Metrics to DB", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "instanceId": "mis-sentinel"
  },
  "tags": [
    { "name": "SENTINEL" },
    { "name": "Knowledge" },
    { "name": "AI-Enhanced" }
  ]
}
