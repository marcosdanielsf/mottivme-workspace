{
    "name": "MIS - Auto Response FINAL WORKING",
    "nodes": [
        {
            "parameters": {
                "jsCode": "// Extrair array de issues do response\nconst response = $input.first().json;\n\nif (!response.success || !response.issues || response.issues.length === 0) {\n  return [];\n}\n\n// Retornar cada issue como item separado\nreturn response.issues.map(issue => ({\n  json: issue\n}));"
            },
            "id": "8a9d9282-7462-4288-9631-33950ec771f8",
            "name": "Code - Extract Issues Array",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                650,
                300
            ]
        },
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "minutes",
                            "minutesInterval": 5
                        }
                    ]
                }
            },
            "id": "86c79970-ae67-417c-b3ae-448ca909e4bb",
            "name": "Schedule - Every 5min",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.1,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/open?priority=critical&limit=10",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "x-vercel-protection-bypass",
                            "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
                        }
                    ]
                },
                "options": {}
            },
            "id": "c918fa2b-6bdd-4bc5-96c4-b236a919e2c5",
            "name": "HTTP - Get Open Critical Issues",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                450,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// Preparar contexto do issue individual para o AI Agent\nconst issue = $input.first().json;\n\nconst metadata = typeof issue.metadata === 'string' \n  ? JSON.parse(issue.metadata) \n  : (issue.metadata || {});\n\n// Criar contexto estruturado\nconst issueContext = {\n  id: issue.id,\n  tipo: issue.issue_type,\n  cliente: issue.customer_name || 'N√£o identificado',\n  telefone: issue.customer_phone || 'N√£o informado',\n  prioridade: issue.priority,\n  detectado_em: new Date(issue.detected_at).toLocaleString('pt-BR'),\n  status: issue.status,\n  mensagem_preview: metadata?.message_preview || 'Sem mensagem pr√©via',\n  sentimento: metadata?.sentiment || 'neutro',\n  keywords: metadata?.keywords || [],\n  analise_time: metadata?.team_analysis || 'Sem an√°lise pr√©via'\n};\n\nconst prompt = `üö® PROBLEMA CR√çTICO DETECTADO\n\nüìã Informa√ß√µes:\n- Cliente: ${issueContext.cliente}\n- Tipo: ${issueContext.tipo}\n- Prioridade: ${issueContext.prioridade}\n- Detectado: ${issueContext.detectado_em}\n\nüí¨ Contexto:\n${issueContext.mensagem_preview}\n\nüòä Sentimento: ${issueContext.sentimento}\n${issueContext.keywords.length > 0 ? 'üîë Keywords: ' + issueContext.keywords.join(', ') : ''}\n\nGere uma resposta profissional e emp√°tica para resolver este problema.`;\n\nreturn [{\n  json: {\n    ...issue,\n    issue_context: issueContext,\n    chat_input: prompt\n  }\n}];"
            },
            "id": "53248923-b07a-46f8-88ee-44ed2c8acb34",
            "name": "Code - Prepare Context",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                850,
                300
            ]
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.chat_input }}",
                "options": {
                    "systemMessage": "Voc√™ √© um assistente inteligente da Mottivme especializado em atendimento ao cliente.\n\nSUA MISS√ÉO:\nGerar respostas profissionais, emp√°ticas e objetivas para problemas cr√≠ticos de clientes.\n\nDIRETRIZES:\n1. Seja breve e direto (m√°ximo 3 par√°grafos)\n2. Mostre empatia genu√≠na\n3. Ofere√ßa solu√ß√µes concretas e imediatas\n4. Use tom profissional mas humanizado\n5. Para problemas t√©cnicos: forne√ßa passo-a-passo claro\n6. Para reclama√ß√µes: assuma responsabilidade e comprometa-se\n7. Inclua pr√≥ximos passos claros\n8. A mensagem ser√° enviada via WhatsApp, seja cordial\n\nFORMATO DA RESPOSTA:\n- N√£o inclua sauda√ß√µes formais (Prezado, etc)\n- V√° direto ao ponto\n- Use quebras de linha para melhor leitura\n- N√£o use markdown ou formata√ß√£o especial\n- M√°ximo 500 caracteres"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 1.7,
            "position": [
                1050,
                300
            ],
            "id": "258bd7b9-4280-42fb-b9bc-f6ac14be1074",
            "name": "AI Agent"
        },
        {
            "parameters": {
                "jsCode": "// Extrair resposta do AI Agent\nconst agentOutput = $input.first().json;\nconst previousData = $('Code - Prepare Context').first().json;\n\nlet aiResponse = 'Desculpe, n√£o conseguimos gerar uma resposta autom√°tica. Nossa equipe entrar√° em contato em breve.';\n\n// O AI Agent retorna a resposta no campo 'output'\nif (agentOutput?.output) {\n  aiResponse = agentOutput.output.trim();\n} else if (agentOutput?.text) {\n  aiResponse = agentOutput.text.trim();\n} else if (agentOutput?.response) {\n  aiResponse = agentOutput.response.trim();\n}\n\n// Garantir que n√£o ultrapasse 500 caracteres\nif (aiResponse.length > 500) {\n  aiResponse = aiResponse.substring(0, 497) + '...';\n}\n\nreturn [{\n  json: {\n    ...previousData,\n    ai_response: aiResponse,\n    ai_model: 'gemini-1.5-flash-agent',\n    response_generated_at: new Date().toISOString(),\n    response_length: aiResponse.length\n  }\n}];"
            },
            "id": "9c26cbf3-f88b-4bde-a73d-f2e75808b719",
            "name": "Code - Extract AI Response",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1250,
                300
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "condition-phone-001",
                            "leftValue": "={{ $json.customer_phone }}",
                            "rightValue": "",
                            "operator": {
                                "type": "string",
                                "operation": "isNotEmpty"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "266a359e-e84a-4660-b837-d3c52e82890e",
            "name": "Filter - Has Phone",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1450,
                300
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://SUA-EVOLUTION-API.com/message/sendText",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "SEU_TOKEN_EVOLUTION_AQUI"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"number\": {{ JSON.stringify($json.customer_phone) }},\n  \"text\": {{ JSON.stringify($json.ai_response) }}\n}",
                "options": {}
            },
            "id": "1616233f-be5d-4d7d-89f1-fc164d46f5e2",
            "name": "HTTP - Send WhatsApp",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1650,
                200
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/action",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "x-vercel-protection-bypass",
                            "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"issue_id\": {{ JSON.stringify($json.id) }},\n  \"action_type\": \"automated_response\",\n  \"action_description\": \"‚úÖ AI Agent Response (\" + {{ JSON.stringify($json.ai_model) }} + \", \" + $json.response_length + \" chars): \" + {{ JSON.stringify($json.ai_response.substring(0, 100)) }} + \"...\",\n  \"taken_by\": \"SYSTEM_AI_AGENT\",\n  \"success\": true\n}",
                "options": {}
            },
            "id": "7857a28e-ee6a-4ee9-9c66-391a781bab37",
            "name": "HTTP - Log Action in CRT",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1850,
                200
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/action",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "x-vercel-protection-bypass",
                            "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"issue_id\": {{ JSON.stringify($json.id) }},\n  \"action_type\": \"no_phone_available\",\n  \"action_description\": \"‚ö†Ô∏è Cliente sem telefone - AI Agent gerou resposta mas n√£o foi enviada (\" + $json.response_length + \" chars): \" + {{ JSON.stringify($json.ai_response.substring(0, 100)) }} + \"...\",\n  \"taken_by\": \"SYSTEM_AI_AGENT\",\n  \"success\": false\n}",
                "options": {}
            },
            "id": "78a274db-76b6-421c-b6ae-588d93f607c1",
            "name": "HTTP - Log No Phone",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1650,
                400
            ]
        },
        {
            "parameters": {
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1,
            "position": [
                1050,
                480
            ],
            "id": "7763954a-9c7d-43c0-8fea-bd07a0a656a2",
            "name": "Google Gemini Chat Model",
            "credentials": {
                "googlePalmApi": {
                    "id": "Id8CEvNKDTHbg6vv",
                    "name": "gemini marcos"
                }
            }
        }
    ],
    "connections": {
        "Code - Extract Issues Array": {
            "main": [
                [
                    {
                        "node": "Code - Prepare Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Schedule - Every 5min": {
            "main": [
                [
                    {
                        "node": "HTTP - Get Open Critical Issues",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP - Get Open Critical Issues": {
            "main": [
                [
                    {
                        "node": "Code - Extract Issues Array",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code - Prepare Context": {
            "main": [
                [
                    {
                        "node": "AI Agent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI Agent": {
            "main": [
                [
                    {
                        "node": "Code - Extract AI Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code - Extract AI Response": {
            "main": [
                [
                    {
                        "node": "Filter - Has Phone",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter - Has Phone": {
            "main": [
                [
                    {
                        "node": "HTTP - Send WhatsApp",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "HTTP - Log No Phone",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP - Send WhatsApp": {
            "main": [
                [
                    {
                        "node": "HTTP - Log Action in CRT",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Google Gemini Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "active": false,
    "settings": {
        "executionOrder": "v1"
    },
    "versionId": "FINAL",
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "mis-sentinel-final-working"
    },
    "id": "mis-auto-response-final",
    "tags": [
        "production",
        "working",
        "ai-agent",
        "automation"
    ]
}