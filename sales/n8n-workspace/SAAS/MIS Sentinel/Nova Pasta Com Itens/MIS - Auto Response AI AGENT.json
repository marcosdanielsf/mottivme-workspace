{
    "name": "MIS - Auto Response AI Agent (OPTIMIZED)",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "minutes",
                            "minutesInterval": 5
                        }
                    ]
                }
            },
            "id": "schedule-trigger-001",
            "name": "Schedule - Every 5min",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.1,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/open?priority=critical&limit=10",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "x-vercel-protection-bypass",
                            "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
                        }
                    ]
                },
                "options": {}
            },
            "id": "http-get-issues-001",
            "name": "HTTP - Get Open Critical Issues",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                450,
                300
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "condition-001",
                            "leftValue": "={{ $json.issues ? $json.issues.length : 0 }}",
                            "rightValue": 0,
                            "operator": {
                                "type": "number",
                                "operation": "gt"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "id": "if-has-issues-001",
            "name": "Filter - Has Issues",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                650,
                300
            ]
        },
        {
            "parameters": {
                "fieldToSplitOut": "issues",
                "options": {}
            },
            "id": "split-in-batches-001",
            "name": "Split Issues",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [
                850,
                200
            ]
        },
        {
            "parameters": {
                "jsCode": "// Gerar prompt contextual para IA\nconst issue = $input.first().json;\n\nconst metadata = typeof issue.metadata === 'string' \n  ? JSON.parse(issue.metadata) \n  : (issue.metadata || {});\n\nconst prompt = `Voc√™ √© um assistente inteligente da Mottivme.\n\nUm problema cr√≠tico foi detectado:\n\nüìã INFORMA√á√ïES DO ISSUE:\n- Tipo: ${issue.issue_type}\n- Cliente: ${issue.customer_name || 'N√£o identificado'}\n- Telefone: ${issue.customer_phone || 'N√£o informado'}\n- Prioridade: ${issue.priority}\n- Detectado em: ${new Date(issue.detected_at).toLocaleString('pt-BR')}\n\n${metadata?.message_preview ? `üí¨ MENSAGEM DO CLIENTE:\\n${metadata.message_preview}\\n` : ''}\n${metadata?.sentiment ? `üòä SENTIMENTO: ${metadata.sentiment}\\n` : ''}\n${metadata?.keywords?.length > 0 ? `üîë PALAVRAS-CHAVE: ${metadata.keywords.join(', ')}\\n` : ''}\n${metadata?.team_analysis ? `üë• AN√ÅLISE DO TIME:\\n${metadata.team_analysis}\\n` : ''}\n\nüéØ SUA MISS√ÉO:\nGere uma resposta PROFISSIONAL, EMP√ÅTICA e OBJETIVA para resolver este problema.\n\n‚úÖ DIRETRIZES:\n1. Seja breve e direto (m√°ximo 3 par√°grafos)\n2. Mostre empatia e compreens√£o\n3. Ofere√ßa solu√ß√µes concretas e imediatas\n4. Se for t√©cnico: ofere√ßa suporte com passo-a-passo\n5. Se for reclama√ß√£o: assuma responsabilidade e comprometa-se\n6. Use tom profissional mas humanizado\n7. Inclua pr√≥ximos passos claros\n\nüì± IMPORTANTE: Esta mensagem ser√° enviada via WhatsApp, seja cordial!\n\nRESPOSTA:`;\n\nreturn [{\n  json: {\n    ...issue,\n    ai_prompt: prompt,\n    metadata: metadata\n  }\n}];"
            },
            "id": "code-prepare-prompt-001",
            "name": "Code - Prepare AI Prompt",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1050,
                200
            ]
        },
        {
            "parameters": {
                "resource": "text",
                "operation": "message",
                "modelId": "gemini-1.5-flash",
                "prompt": "={{ $json.ai_prompt }}",
                "options": {
                    "temperature": 0.7,
                    "maxOutputTokens": 500,
                    "topP": 0.9
                }
            },
            "id": "ai-agent-gemini-001",
            "name": "AI Agent - Gemini 1.5 Flash",
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1.1,
            "position": [
                1250,
                200
            ],
            "credentials": {
                "googleGeminiOAuth2Api": {
                    "id": "YOUR_GEMINI_CREDENTIAL_ID",
                    "name": "Google Gemini API"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Extrair resposta da IA e preparar dados\nconst aiOutput = $input.first().json;\nconst previousData = $('Code - Prepare AI Prompt').first().json;\n\n// A resposta do AI Agent vem no campo 'response' ou 'output'\nlet aiResponse = 'Desculpe, n√£o foi poss√≠vel gerar uma resposta autom√°tica. Nossa equipe entrar√° em contato em breve.';\n\nif (aiOutput?.response) {\n  aiResponse = aiOutput.response.trim();\n} else if (aiOutput?.output) {\n  aiResponse = aiOutput.output.trim();\n} else if (aiOutput?.text) {\n  aiResponse = aiOutput.text.trim();\n}\n\nreturn [{\n  json: {\n    ...previousData,\n    ai_response: aiResponse,\n    ai_model: 'gemini-1.5-flash',\n    response_generated_at: new Date().toISOString()\n  }\n}];"
            },
            "id": "code-extract-response-001",
            "name": "Code - Extract AI Response",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1450,
                200
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "conditions": [
                        {
                            "id": "condition-phone-001",
                            "leftValue": "={{ $json.customer_phone }}",
                            "rightValue": "",
                            "operator": {
                                "type": "string",
                                "operation": "isNotEmpty"
                            }
                        }
                    ],
                    "combinator": "and"
                }
            },
            "id": "if-has-phone-001",
            "name": "Filter - Has Phone",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                1650,
                200
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://SUA-EVOLUTION-API.com/message/sendText",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "SEU_TOKEN_EVOLUTION_AQUI"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"number\": {{ JSON.stringify($json.customer_phone) }},\n  \"text\": {{ JSON.stringify($json.ai_response) }}\n}",
                "options": {}
            },
            "id": "http-send-whatsapp-001",
            "name": "HTTP - Send WhatsApp",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1850,
                100
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/action",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "x-vercel-protection-bypass",
                            "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"issue_id\": {{ JSON.stringify($json.id) }},\n  \"action_type\": \"automated_response\",\n  \"action_description\": \"‚úÖ Resposta AI enviada via WhatsApp (\" + {{ JSON.stringify($json.ai_model) }} + \"): \" + {{ JSON.stringify($json.ai_response.substring(0, 100)) }} + \"...\",\n  \"taken_by\": \"SYSTEM_AUTO_AI\",\n  \"success\": true\n}",
                "options": {}
            },
            "id": "http-log-action-001",
            "name": "HTTP - Log Action in CRT",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                2050,
                100
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/action",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "x-vercel-protection-bypass",
                            "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
                        },
                        {
                            "name": "Content-Type",
                            "value": "application/json"
                        }
                    ]
                },
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\n  \"issue_id\": {{ JSON.stringify($json.id) }},\n  \"action_type\": \"no_phone_available\",\n  \"action_description\": \"‚ö†Ô∏è Cliente sem telefone - resposta AI gerada mas n√£o enviada: \" + {{ JSON.stringify($json.ai_response.substring(0, 100)) }} + \"...\",\n  \"taken_by\": \"SYSTEM_AUTO_AI\",\n  \"success\": false\n}",
                "options": {}
            },
            "id": "http-log-no-phone-001",
            "name": "HTTP - Log No Phone",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1850,
                300
            ]
        }
    ],
    "pinData": {},
    "connections": {
        "Schedule - Every 5min": {
            "main": [
                [
                    {
                        "node": "HTTP - Get Open Critical Issues",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP - Get Open Critical Issues": {
            "main": [
                [
                    {
                        "node": "Filter - Has Issues",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter - Has Issues": {
            "main": [
                [
                    {
                        "node": "Split Issues",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Split Issues": {
            "main": [
                [
                    {
                        "node": "Code - Prepare AI Prompt",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code - Prepare AI Prompt": {
            "main": [
                [
                    {
                        "node": "AI Agent - Gemini 1.5 Flash",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI Agent - Gemini 1.5 Flash": {
            "main": [
                [
                    {
                        "node": "Code - Extract AI Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code - Extract AI Response": {
            "main": [
                [
                    {
                        "node": "Filter - Has Phone",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Filter - Has Phone": {
            "main": [
                [
                    {
                        "node": "HTTP - Send WhatsApp",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "HTTP - Log No Phone",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP - Send WhatsApp": {
            "main": [
                [
                    {
                        "node": "HTTP - Log Action in CRT",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP - Log Action in CRT": {
            "main": [
                [
                    {
                        "node": "Split Issues",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "HTTP - Log No Phone": {
            "main": [
                [
                    {
                        "node": "Split Issues",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {
        "executionOrder": "v1"
    },
    "versionId": "2",
    "meta": {
        "instanceId": "mis-sentinel-ai-agent-optimized"
    },
    "id": "mis-auto-response-ai-agent",
    "tags": [
        "ai",
        "automation",
        "crt",
        "customer-service"
    ]
}