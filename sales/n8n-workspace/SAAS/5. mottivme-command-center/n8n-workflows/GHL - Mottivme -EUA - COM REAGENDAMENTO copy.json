{
  "name": "GHL - Mottivme -EUA - COM REAGENDAMENTO copy",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "837edd77-2445-4556-b2a1-303534b0e744",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1040,
        400
      ],
      "id": "83a13114-16dc-4fe0-bfa1-6614399cc1c9",
      "name": "Mensagem recebida",
      "webhookId": "837edd77-2445-4556-b2a1-303534b0e744"
    },
    {
      "parameters": {
        "content": "# Enviando resposta\nVamos verificar se nossa resposta deve ser enviada ou não caso o usuario tenha enviado alguma mensagem durante o pensamento da IA, significa que precisamos considerar a ultima mensagem antes de responder, e o processo seguinte ira receber nossa mensagem que iriamos mandar.",
        "height": 668,
        "width": 2236,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        6832,
        32
      ],
      "id": "b380a3dd-5b82-4c78-b662-3da910f2fc0f",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "# Tratando input\n",
        "height": 540,
        "width": 1060
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -336,
        224
      ],
      "id": "1c48b94f-1d36-479b-985c-b6a04b25bf30",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## 1. Assistencia",
        "height": 80,
        "width": 540,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -336,
        80
      ],
      "id": "2b745081-96e3-4389-b054-7a42ae18ec70",
      "name": "Sticky Note30"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO execution_metrics (\n  execution_id,\n  workflow_id,\n  workflow_name,\n  workflow_version,\n  n8n_version,\n  environment,\n  status,\n  started_at,\n  owner_id\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, NOW(), $8\n)\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ $json.dados }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2240,
        0
      ],
      "id": "43d11b73-ab48-431b-aa8e-5c478eada2bd",
      "name": "Postgres",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4a6c297c-ff22-4d5d-9f91-35eaa64b0d9a",
              "name": "=dados",
              "value": "={{ $execution.id }},{{ $workflow.id }},{{ $workflow.name }},1,1.99,{{ $execution.mode }},running,cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "f3b2358a-0eec-409b-9d61-a27ea7fbe59d",
              "name": "session",
              "value": "=etapa,{{ $('Info').first().json.etapa_funil || 'NULL' }},{{ $execution.id }},{{ $('Info').first().json.lead_id}},{{ !$('Info').first().json.n8n_ativo === false }},{{ $('Info').first().json.chat_id || 'NULL' }},{{ $('Info').first().json.api_key || 'NULL' }},{{ $('Info').first().json.location.id || 'NULL' }},{{ $('Info').first().json.source || 'whatsapp' }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false,
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        0
      ],
      "id": "196cf956-da59-4973-8e0b-ae963c2ef61f",
      "name": "GetInfo",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Rastreio de consumo",
        "height": 240,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        944,
        -80
      ],
      "id": "b4a01d3e-8699-4f7e-a97e-88743afc0d08",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "304623c3-1fc3-495e-867b-8710765f00fd",
              "leftValue": "={{ $json.output.length }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        6864,
        320
      ],
      "id": "96bf8fb1-c585-4d9d-82ec-0ae96955a603",
      "name": "Filter"
    },
    {
      "parameters": {
        "content": "## Última mensagem e Fluxo",
        "height": 240,
        "width": 416
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1392,
        -80
      ],
      "id": "5c4dac51-c4ca-4396-bb1b-8c6a4d447b2b",
      "name": "Sticky Note28"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "7b69ca5f-98d5-4187-af8e-cac2ea00c1c2",
      "name": "Loop Over Items3",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        9328,
        320
      ]
    },
    {
      "parameters": {},
      "id": "7f61e62d-1973-4d3f-b47d-e1efc952ff64",
      "name": "no.op",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        10224,
        384
      ]
    },
    {
      "parameters": {
        "content": "## Verifica se o cliente mandou mensagem\nVerificamos se enquanto a IA está pensando, se o cliente mandou mensagem. Se sim, temos que salvar nossa mensagem para pensar novamente.",
        "height": 544,
        "width": 1200,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        5616,
        32
      ],
      "id": "da01e081-89bf-46fc-b6ee-21181d3c4940",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"{{ $json.output }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9776,
        416
      ],
      "id": "6c54ba1c-e97b-4271-804d-0272cb761a0a",
      "name": "Instagram",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $('Info').first().json.lead_id }}\",\n  \"message\": \"{{ $json.output }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9776,
        224
      ],
      "id": "0f0376f7-c8b8-4e08-b7c5-a77700f836fa",
      "name": "Whatsapp",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "whatsapp ",
                    "rightValue": "={{ $('Info').first().json.source }} ",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f5034094-22ae-449d-a556-1fc1bc216e49"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "21897a45-e463-4f12-aa85-a06b148d7ecb",
                    "leftValue": "instagram",
                    "rightValue": "={{ $('Info').first().json.source }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        9552,
        320
      ],
      "id": "b9de2952-24de-42f4-a8ba-82eb489063b2",
      "name": "Canal"
    },
    {
      "parameters": {
        "amount": 1.5
      },
      "id": "5ac7eee4-6585-46d9-a215-f8d13a993f4a",
      "name": "1.5s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        10000,
        320
      ],
      "webhookId": "dfdf8a76-acd0-41c0-bbe1-4c8cdcd4f0a3"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_response",
              "value": "={{ $('Parser  Chain').item.json.output.messages.join(\"\") }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        9776,
        32
      ],
      "id": "7c212cde-fb84-4491-b8e5-2754fe2cf8d4",
      "name": "Execution Data1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "22078f8d-4e31-4138-955b-5aebf5e9c54c",
                    "leftValue": "={{ $json.location_id }}",
                    "rightValue": "mHuN6v75KQc3lwmBd6mV",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Milton"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.location_id }}",
                    "rightValue": "=mHuN6v75KQc3lwmBd6mV",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "5acaf89e-0978-4e4e-9707-010666a790b2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Padrão"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        5024,
        384
      ],
      "id": "dd6bc47a-002e-4c57-9a63-58f201d610c6",
      "name": "Tipo de IA"
    },
    {
      "parameters": {
        "toolDescription": "Adicionar tag 'perdido'. Use quando o lead se enquadrar em qualquer situação: já cadastrado, é agente, mora no Brasil, sem interesse, ou está insatisfeito. Motivo da desqualificação deve ser especificado.",
        "method": "PUT",
        "url": "https://services.leadconnectorhq.com/contacts/{contact_Id}",
        "sendHeaders": true,
        "parametersHeaders": {
          "values": [
            {
              "name": "Authorization",
              "valueProvider": "fieldValue",
              "value": "=Bearer {{ $('Info').first().json.api_key }}"
            },
            {
              "name": "Version",
              "valueProvider": "fieldValue",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tags\": [\"perdido\"]\n}",
        "placeholderDefinitions": {
          "values": [
            {
              "name": "contact_Id",
              "description": "ID do contato",
              "type": "string"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        5888,
        560
      ],
      "id": "0e90765b-2a16-4bfa-b6eb-a5560c249325",
      "name": "Adicionar_tag_perdido"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c2f0dc1a-df0b-4b25-b860-e0fe6b204092",
                    "leftValue": "={{ $('Info').first().json.agente_ia }}",
                    "rightValue": "followuper",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "followuper"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "11fcf8b1-3421-4eda-b9ba-bfd77777548d",
                    "leftValue": "={{ $('Info').first().json.first_name }}",
                    "rightValue": "Marcos Daniels",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Marcos Daniel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Info').first().json.agente_ia }}",
                    "rightValue": "sdrcarreira",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1d24e4cd-fb46-464d-a0e8-cd441c83711a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SDR Carreira"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c6a257bf-f976-4bb7-862e-f8e2ec42f906",
                    "leftValue": "={{ $('Info').first().json.agente_ia }}",
                    "rightValue": "sdrconsultoria",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SDR Consultoria"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d8efacc2-b932-41f4-bad3-b3e72e1fd686",
                    "leftValue": "={{ $('Info').first().json.agente_ia }}",
                    "rightValue": "rescheduler",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "rescheduler"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3f90ae36-2e0e-4a41-977a-d9b49c650549",
                    "leftValue": "={{ $('Info').first().json.agente_ia }}",
                    "rightValue": "assistente_admin",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        5184,
        592
      ],
      "id": "c65baa12-84a7-4a54-8689-3e7bec9340c1",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c1347694-76f6-44df-888e-74ee5d651820",
              "name": "prompt",
              "value": "=## OBJETIVO\n\n- Construir relacionamento antes da conversão  \n- Identificar o momento certo para apresentar a oportunidade certa  \n- Gerar valor e engajamento desde o primeiro contato  \n- Responder dúvidas frequentes sobre carreira e consultoria  \n- Guiar o lead com linguagem clara e acolhedora  \n- Confirmar se o número é brasileiro e orientar sobre o uso do “9” se necessário  \n- Agendar, remarcar ou cancelar reuniões estratégicas com agilidade  \n- Se não tiver o  confirmar se o número é brasileiro e orientar sobre uso do “9” se necessário\n- Agendar, remarcar ou cancelar reuniões estratégicas com agilidade\n\n{{ $('Set mensagens').item.json.output_preview && '## Mensagem que você(atendente) iria enviar ao cliente e você ainda não enviou pois o cliente mandou uma nova mensagem e precisamos considerar antes de responder ele de fato e mudar nossa resposta se necessário:' || \"\" }}\n{{ $('Set mensagens').item.json.output_preview && \"Atendente(não enviado): '\"+$('Set mensagens').item.json.output_preview+\"'\" || \"\" }}\n\n\n---\n\n## REGRAS DE OURO (PRINCÍPIOS FUNDAMENTAIS)\n\n- Nunca pergunte diretamente sobre status imigratório ou “work permit” na abordagem inicial.  \n- Justifique o contato apenas se o lead perguntar.  \n- Priorize o ESTADO onde o lead vive, não a cidade.  \n- Foque em criar conexão e abrir diálogo.  \n- Use linguagem natural, personalizada e empática — nunca pareça um robô.  \n- Não pergunte se o lead quer agendar reunião sem antes gerar conexão e qualificar.  \n- Para leads de PROSPECÇÃO ({{ $('Info').item.json['Fonte do Lead BPOSS'] }}), gere valor antes de ofertar.  \n- Evite perguntas diretas sobre work permit nessa fase, pois eles não solicitaram ajuda.  \n\n- somos nós quem buscamos eles, precisamos nos conectar, gerar valor antes de ofertar algo. Então frases como ex: \n\n\"Me diz uma coisa, só pra eu saber como te ajudar... vc já tem permissão de trabalho (work permit)?\"\n\nNão devem ser utilizadas, pois eles não pediram ajuda, nós quem precisamos gerar valor para eles, para que tenham interesse em saber mais sobre a carreira ou até mesmo para ofertar a consultoria financeira.\n\n\n---\n\n### 2. DEFINIÇÃO DO TIPO DE REUNIÃO\n\n- Consulte o campo Fonte do Lead BPOSS (ID: 2785532).\n\n*Se o valor for:*\n- Tráfego - Lead Direct - Recrutamento → Follow-up com foco em *carreira*\n- Tráfego - Lead Direct - Consultoria ou Landing Page → Follow-up com foco em *consultoria*\n\n*Se o valor for:* \n- Prospecção Carreira - VS\n- Prospecção Consultoria - VS\n- Novo Seguidor\n- Deve seguir buscando se conectar com o lead, gerar valor antes de ofertar a carreira ou a consultoria ou seja deve seguir abordagem padrão igual igual ao F1 - BPO Social Selling - EUA id do funil: 8919615\n\n---\n\n## 3. VERIFICAÇÃO DE PERMISSÃO DE TRABALHO (para leads de carreira)\n\n- Consulte o campo Permissão de trabalho (ID: 814630):  \n  - Se NÃO possui Work Permit → redirecione para consultoria gratuita  \n  - Se POSSUI Work Permit → prossiga com reunião de carreira  \n\n---\n\n## 4. VERIFICAÇÃO DO ESTADO\n\n- Consulte o campo Endereço curto (ID: 2788018)  \n- Se estiver vazio, pergunte de forma sutil:  \n  “Você mora em qual estado dos EUA hoje, [nome]?”\n\n\n\nFOLLOW-UP APÓS RESPOSTA (LEADS FRIOS):\nSe ele responder algo como: \"Tô trabalhando com [X] ainda\"\nEntendi! E como tá sendo? Tá satisfeito com essa área ou às vezes pensa em mudar de rumo?\n\nPergunto porque vejo muita gente que continua no mesmo só pela estabilidade, mas não tá realizada de verdade...\nSe ele responder: \"Mudei de área, agora tô em [Y]\"\nBacana! E essa mudança foi boa pra você?\n\nTá conseguindo crescer aí ou é mais do mesmo?\nSe ele responder muito genérico: \"Tá tudo bem por aqui\"\nQue bom! \n\nE aquele interesse em construir algo na área financeira, ainda existe ou você já seguiu outro caminho?\n\nPergunto porque muita coisa mudou desde quando conversamos...\n\nTRANSIÇÃO PARA QUALIFICAÇÃO:\nApós reconectar e entender a situação atual, siga com as etapas de qualificação:\n\nValidar interesse atual em carreira financeira\nVerificar estado onde mora (se não estiver no CRM)\nVerificar work permit de forma natural na conversa\nOferecer reunião ou consultoria conforme o caso\n\n\nIMPORTANTE:\n\nNão force agendamento logo de cara\nDeixe o lead contar a situação atual primeiro\nSó ofereça reunião após reconectar e validar interesse\nSe não tiver work permit, redirecione para consultoria gratuita\n\n\n---\n\n## MENSAGEM DE FOLLOW-UP PADRÃO (para leads com interação anterior)\n\n### Etapa 1: Conhecer a história do lead  \n- “Admiro muito quem teve a coragem de vir pros EUA. Muita gente fala, mas poucos realmente vêm. Com o que você tá trabalhando aí?”  \n- “Imagino que o começo deve ter sido desafiador por aí também, né?”\n\n### Etapa 2: Ponte para a carreira  \n- “Uma coisa que vejo muito por aqui é a correria pra pagar as contas... e às vezes a gente acaba deixando os sonhos de lado, né?”  \n- “No seu caso, o que mais te preocupa hoje quando pensa no seu futuro aqui nos EUA?”\n\n### Etapa 3: Oferta leve da oportunidade  \n- “Foi por isso que eu entrei nessa área. Hoje consigo organizar minha vida e ajudar outras famílias também. Estamos buscando pessoas com essa visão pra expandir a agência.”  \n- “Se fizer sentido pra você, topa bater um papo rápido no Zoom pra eu te mostrar como funciona? Sem compromisso.”\n\n### Condição especial: se o lead disser que não tem work permit  \n- “Poxa, entendi. Como você ainda não tem o Work Permit, posso te oferecer uma consultoria gratuita que mostra como proteger sua renda e planejar o futuro mesmo sem documentos. Posso te encaixar?”\n\n---\n\n## REGRAS PARA FOLLOW-UP\n\n- Se o lead não puder falar no momento, pergunte data e horário para conversar.  \n- Se o lead parar de responder, agende follow-up para o mesmo dia em horários estratégicos.  \n- Para agendar follow-up, insira `data_msg_fup` (id: 2796271) e `mensagem_fup` (id: 2796273) no CRM.  \n- Após resposta do lead, finalize o follow-up apagando ambos os campos antes de continuar.  \n\n---\n\n## FINALIZAÇÃO\n\n- Se o lead aceitar, siga o SOP de agendamento.  \n- Sempre colete WhatsApp e e-mail se não estiverem preenchidos.  \n- Não use placeholders genéricos — sempre use valores reais.  \n- Não envie follow-up para leads com reunião já agendada.  \n\n### Coleta de dados e agendamento\n\n- Se houver WhatsApp e e-mail, realize o agendamento.  \n- Se faltar algum dado após escolha do horário, pergunte:  \n  “Perfeito! Tá ótimo pra mim também. Pra confirmar, preciso que você digite seu e-mail e WhatsApp, ok? Peço que escreva o WhatsApp para evitar agendar com número errado.”  \n- Valide número de WhatsApp:  \n  - EUA: “Esse número é +1XXXXXXXXXX, correto?”  \n  - Brasil: “Esse número é +55XXXXXXXXX, correto?”  \n  - Se não informar país, pergunte: “Esse número é dos EUA ou do Brasil?”  \n- Valide e-mail: “Esse <email> está escrito certinho mesmo?”  \n- Após agendamento confirme:  \n  “Maravilhaaa {{ $('Info').item.json.nome.split().first() }}! Daqui a pouco te envio pelo e-mail e WhatsApp, ok?”  \n- Em caso de erro na API, solicite confirmação dos dados.  \n- Após o agendamento, se o lead falar algo, responda:  \n  “Valeu, {{ $('Info').item.json.nome.split().first() }}! Só pra deixar registrado aqui no direct, agendei pra <dia_reuniao>, às <horario_reuniao> (NY).”",
              "type": "string"
            },
            {
              "id": "7c1cec03-5b93-4741-a15c-01ccaade24de",
              "name": "origem",
              "value": "Prompt F3 - FUP",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5408,
        528
      ],
      "id": "6c0fc132-5601-4ec6-b474-39a09b5b975c",
      "name": "Prompt F3 - followuper1"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        5632,
        560
      ],
      "id": "6a4be16b-ec4e-40ef-9a56-3a749c510737",
      "name": "Gemini2",
      "notesInFlow": false,
      "credentials": {
        "googlePalmApi": {
          "id": "Id8CEvNKDTHbg6vv",
          "name": "gemini marcos"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5",
          "mode": "list",
          "cachedResultName": "gpt-5"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5760,
        560
      ],
      "id": "74186f2f-2614-47af-85c4-8cc16f22c831",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "description": "Uma ferramenta de raciocínio interno para agentes de IA no n8n.\nUse-a para estruturar pensamentos, lógica e instruções ocultas que ajudam o modelo a chegar em uma resposta final.\nO conteúdo definido aqui não é mostrado ao usuário final — serve apenas como contexto privado para guiar a geração de saída."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1,
      "position": [
        6016,
        560
      ],
      "id": "161f153a-4412-40ff-a0bc-c42615c329c9",
      "name": "Think1"
    },
    {
      "parameters": {
        "description": "Buscar/consultar por horários disponíveis antes de agendar. Exemplo: startDate=1735689600000 endDate=1736294400000. calendario pode ser consultoria financeira ou carreira. E dateEndTo e dateStartFrom é a data de inicio e fim, geralmente entre hoje e 7 dias. Garanta que vai buscar slots disponíveis à partir do ano 2025",
        "workflowId": {
          "__rl": true,
          "value": "pZIcRI1PGMzbQHZZ",
          "mode": "list",
          "cachedResultUrl": "/workflow/pZIcRI1PGMzbQHZZ",
          "cachedResultName": "[ GHL ] Busca Disponibilidade"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "calendar": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar', `exemplo: LvZWMISiyYnF8p7TrY7q`, 'string') }}",
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "startDate": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('startDate', `exemplo: 1735689600000`, 'string') }}",
            "endDate": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('endDate', `exemplo: 1736294400000`, 'string') }}",
            "lead_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_id', `exemplo: 23533559\n`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "calendar",
              "displayName": "calendar",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "startDate",
              "displayName": "startDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "endDate",
              "displayName": "endDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        6144,
        560
      ],
      "id": "ccaa4d31-49d4-4a02-86ee-6cb93f5ea769",
      "name": "Busca_disponibilidade"
    },
    {
      "parameters": {
        "description": "Agendar um nova reunião. startTime segue o seguinte padrão 2021-06-23T03:30:00+05:30.",
        "workflowId": {
          "__rl": true,
          "value": "u1UsmjNNpaEiwIsp",
          "mode": "list",
          "cachedResultUrl": "/workflow/u1UsmjNNpaEiwIsp",
          "cachedResultName": "Agendar pelo GHL - ATUALIZAR KOMMO"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "telefone": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('telefone', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}",
            "calendar_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('calendar_id', ``, 'string') }}",
            "startTime": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('startTime', ``, 'string') }}",
            "firstName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('firstName', ``, 'string') }}",
            "lastName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lastName', ``, 'string') }}",
            "lead_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lead_id', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "calendar_id",
              "displayName": "calendar_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "startTime",
              "displayName": "startTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "firstName",
              "displayName": "firstName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lastName",
              "displayName": "lastName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "estadoValue",
              "displayName": "estadoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "workPermitValue",
              "displayName": "workPermitValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        6272,
        560
      ],
      "id": "295bdc40-3e9a-49a0-b447-deb5a4981e1b",
      "name": "Agendar_reuniao"
    },
    {
      "parameters": {
        "description": "Atualizar o estado onde o lead mora (estado_onde_mora). Use esta tool quando o lead informar em qual estado dos EUA ele reside. Valores aceitos: nomes dos estados americanos (ex: Florida, California, Texas, New York, etc). Campo ID customizado no GHL.",
        "workflowId": {
          "__rl": true,
          "value": "3Dd8d5AnpD4iLPwG",
          "mode": "list",
          "cachedResultUrl": "/workflow/3Dd8d5AnpD4iLPwG",
          "cachedResultName": "Atualizar Work Permit GHL (Otimizado)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}",
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "contact_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contact_id', ``, 'string') }}",
            "workPermitValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('workPermitValue', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "workPermitValue",
              "displayName": "workPermitValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        6400,
        560
      ],
      "id": "9a08e857-dd31-4197-9531-3a938d2330fb",
      "name": "Atualizar Work Permit"
    },
    {
      "parameters": {
        "description": "Atualizar a profissão/ocupação do lead (contact.profissao). Use esta tool quando o lead informar qual é sua profissão ou área de atuação atual. Valores: texto livre com a profissão (ex: Engenheiro, Médico, Empresário, Corretor de Imóveis, etc). Campo ID customizado no GHL.",
        "workflowId": {
          "__rl": true,
          "value": "Kq3b79P6v4rTsiaH",
          "mode": "list",
          "cachedResultUrl": "/workflow/Kq3b79P6v4rTsiaH",
          "cachedResultName": "Atualizar Profissão GHL"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}",
            "contact_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contact_id', ``, 'string') }}",
            "profissaoValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('profissaoValue', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "profissaoValue",
              "displayName": "profissaoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        6528,
        560
      ],
      "id": "e1cf7c58-6a41-4368-bf3f-7dd1d8765bf7",
      "name": "Atualizar Profissão"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "66bb063b-646e-4774-9415-e21a35c7e99b",
              "leftValue": "={{ $json.output }}",
              "rightValue": "<ctrl",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "50ac2eba-f7b0-4477-98e6-f19887142f51",
              "leftValue": "{{ $json.output }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6672,
        336
      ],
      "id": "4f4a6672-1995-4037-8ead-128ed41fbb74",
      "name": "Tudo certo?3"
    },
    {
      "parameters": {
        "description": "Atualizar o estado onde o lead mora (estado_onde_mora). Use esta tool quando o lead informar em qual estado dos EUA ele reside. Valores aceitos: nomes dos estados americanos (ex: Florida, California, Texas, New York, etc). Campo ID customizado no GHL.",
        "workflowId": {
          "__rl": true,
          "value": "wsQQYmx8CLNBHoWq",
          "mode": "list",
          "cachedResultUrl": "/workflow/wsQQYmx8CLNBHoWq",
          "cachedResultName": "Atualizar Estado GHL (Otimizado)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "API_KEY": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('API_KEY', ``, 'string') }}",
            "estadoValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('estadoValue', ``, 'string') }}",
            "contact_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('contact_id', ``, 'string') }}",
            "location_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('location_id', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "estadoValue",
              "displayName": "estadoValue",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        6656,
        560
      ],
      "id": "6ff644fb-04cd-4f64-906e-bcfef2eafc14",
      "name": "Atualizar Estado"
    },
    {
      "parameters": {
        "jsCode": "const ultima_mensagem_da_fila = $('Buscar mensagens').last()\nconst mensagem_do_workflow = $('Info').first().json.mensagem_id\n\nif (ultima_mensagem_da_fila.json.id_mensagem !== mensagem_do_workflow) {\n  // Mensagem encavalada, para o workflow\n  return [];\n}\n\n// Pass-through da fila de mensagens\nreturn $('Buscar mensagens').all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2512,
        400
      ],
      "id": "5a3c2238-58b8-43e7-92ff-62468431c91d",
      "name": "Mensagem encavalada?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $json.lead_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2080,
        400
      ],
      "id": "03da1c8c-34b9-4618-b99a-a239f099211a",
      "name": "Buscar mensagens",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2672,
        400
      ],
      "id": "0efb78e1-0460-413d-b62d-8eb01d3aebec",
      "name": "Limpar fila de mensagens",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "# Processando mensagens encavaladas\n\nEssa etapa trata a situação em que o usuário envia múltiplas mensagens seguidas. O ponto negativo é o aumento no tempo de resposta do agente. Lógica dispensa uso de soluções mais complexas, como RabbitMQ.\n\nTempo de espera recomendado de ~16s. Quando estiver testando, recomendamos reduzir um pouco para ficar mais rápido de testar.\n",
        "height": 540,
        "width": 1216,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        768,
        224
      ],
      "id": "d79feb03-c58e-46c6-8392-5f7b16792ad0",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "amount": 18
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1856,
        400
      ],
      "id": "81ed46db-e75e-47b2-8629-c91c1c8b987b",
      "name": "Esperar",
      "webhookId": "77807094-b539-48b3-a9f0-76f824145d6e"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_fila_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_fila_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "mensagem": "={{ $json.mensagem }}",
            "id_mensagem": "={{ $json.mensagem_id }}",
            "timestamp": "={{ $json.datetime }}",
            "lead_id": "={{ $json.lead_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "id_mensagem",
              "displayName": "id_mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "instagram",
              "displayName": "instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1664,
        400
      ],
      "id": "4651e180-7f23-4a2d-97db-16a20ffa8185",
      "name": "Enfileirar mensagem.",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.photo_audio }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "chatwootApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1856,
        880
      ],
      "id": "843cdacf-37a9-4668-8c32-5abf2212db6f",
      "name": "Download áudio",
      "retryOnFail": true,
      "credentials": {
        "chatwootApi": {
          "id": "UmVE5jAScA8a8vNB",
          "name": "ChatWoot account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "pt"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2464,
        880
      ],
      "id": "a8cf5073-16a7-4b4f-b4df-34077e509cdb",
      "name": "Transcrever audio",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2048,
        880
      ],
      "id": "301c1511-eb7b-46c4-9dfd-4a5a74d13eb3",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2256,
        912
      ],
      "id": "bd3b846a-8324-486c-ba44-f2bf9a3f5940",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c3bb05a3-1c9e-4993-a20f-7d92b005cc09",
              "name": "last_db_message",
              "value": "={{ $input.last().json }}",
              "type": "string"
            },
            {
              "id": "80a47b08-9d11-4fa6-b5c0-c892bd503182",
              "name": "current_message",
              "value": "={{ $('Info').first().json.mensagem_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2304,
        400
      ],
      "id": "65a2b174-09a2-430e-9a4b-bcd6e8c775dc",
      "name": "Form Mensagem"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "8ca54eae-15d1-49d3-af33-7a6e5d17b833",
              "leftValue": "={{ $('Info').item.json.n8n_ativo }}",
              "rightValue": "disparo realizado",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "8d1933c9-21dc-4aeb-bce7-6b20411d2801",
              "leftValue": "={{ $('Tipo de mensagem').item.json.mensagem.toLowerCase() }}",
              "rightValue": "ok",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        3504,
        384
      ],
      "id": "861846f0-c639-43b8-978d-fcd3131f584e",
      "name": "Permitido AI?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            },
            {
              "column": "workflow_id",
              "value": "={{ $('Info').item.json.workflow_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3104,
        400
      ],
      "id": "9ea1c96f-83aa-434e-ada4-7dd07d3fb536",
      "name": "Conversa Ativa",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.isEmpty() || $json.status === 'inactive' || (new Date() - new Date($json.created_at)) > 1 * 60 * 1000  }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "be5f5420-f7d0-46e7-acb7-663377e7ff88"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Iniciar Conversa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "064c4e28-0fba-45da-8ad8-15c9678b7842",
                    "leftValue": "={{ $json.retries > 10 ||  $json.waiting_process_id && $json.status === 'active' && $json.waiting_process_id !== $('Info').item.json.process_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ignorar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ccd478c2-5d5c-4e0d-a6ad-3727d8fb420e",
                    "leftValue": "={{ $json.status === 'active' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Aguardar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3264,
        400
      ],
      "id": "263f13c6-fdb5-4f4a-a8f9-07a6dff05a12",
      "name": "Ação Planejada"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3712,
        560
      ],
      "id": "8ca23d99-b529-4f48-a9cf-6537fa7a944b",
      "name": "Wait",
      "webhookId": "36a21a46-5155-4067-995f-d5d5d2455b95"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "waiting_process_id": "={{ $('Info').item.json.process_id }}",
            "id": "={{ $('Conversa Ativa').item.json.id }}",
            "workflow_id": "={{ $json.workflow_id }}",
            "retries": "={{ $('Conversa Ativa').item.json.retries + 1 }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "retries",
              "displayName": "retries",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3504,
        560
      ],
      "id": "0f873d95-7464-4a1c-b75f-d1fcd1168729",
      "name": "Salvar Espera",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_id",
              "value": "={{ $('Info').item.json.lead_id }}"
            },
            {
              "key": "a_lead_name",
              "value": "={{ $('Info').item.json.full_name }}"
            },
            {
              "key": "location_name",
              "value": "={{ $('Info').first().json.location_name }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        3664,
        384
      ],
      "id": "084b400d-9649-46fc-85ec-7f3f0ddb5ded",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "resource": "image",
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-5-20250929",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-5-20250929"
        },
        "text": "O que há nessa imagem?",
        "imageUrls": "={{ $json.photo_audio }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [
        1664,
        592
      ],
      "id": "92fbd5a7-81d8-4e8b-a2f3-2d4b17ad9989",
      "name": "Analyze image",
      "credentials": {
        "anthropicApi": {
          "id": "nNkFTZpNoiBCbO1I",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fd3e8b9e-eed6-4f43-94c8-089af8417065",
              "name": "imagem",
              "value": "={{ $json.content[0].text ? \"[Imagem Recebida]: \"+ $json.content[0].text : \"\"}}",
              "type": "string"
            },
            {
              "id": "a3bc628f-18b3-4e08-b620-65c5a3a57b40",
              "name": "audio:",
              "value": "={{ $json.text ? \"[Audio Recebido]: \"+ $json.text : \"\"}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2624,
        592
      ],
      "id": "2fee2adc-8d0a-4483-b2bf-d672c0316f6c",
      "name": "Imagem ou audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\":[\n      {\"text\": \"Extraia as informações dessa imagem. Não inclua nenhum comentário adicional, além do conteúdo extraído da imagem.\"},\n      {\n        \"inline_data\": {\n          \"mime_type\": \"image/jpeg\",\n          \"data\": \"{{ $json.data }}\"\n        }\n      }\n    ]\n  }]\n}\n",
        "options": {}
      },
      "id": "b331fd2c-d9bf-408f-8b9d-4bb68b2fae19",
      "name": "Extrair dados comprovante1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1568,
        592
      ],
      "typeVersion": 4.2,
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "content": "# Processando áudio",
        "height": 276,
        "width": 880,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        944,
        784
      ],
      "id": "9f2f966a-e5f0-4bf6-8957-6164df0ff83a",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set mensagens').item.json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "1382cd26-d96e-4c55-99dd-2ca305ffe82e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        7104,
        320
      ],
      "id": "d68d245e-5b82-43ed-9788-9d0cb314fd1c",
      "name": "Tipo de mensagem1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        8288,
        752
      ],
      "id": "0efe0d61-6785-4a38-b6f8-3a50d6bb9df0",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "97df1142-b72f-499f-9053-d3b2f6500f9c",
              "leftValue": "={{ $json.waiting_process_id && $json.waiting_process_id !== $('Info').first().json.process_id }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        7984,
        224
      ],
      "id": "93766be0-4ded-44b8-93c3-a985f16a215f",
      "name": "Deve enviar mensagem?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}"
            },
            {
              "column": "workflow_id",
              "value": "={{ $('Info').first().json.workflow_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        7312,
        320
      ],
      "id": "fd2569b8-a405-49c6-a784-5a3dc1305686",
      "name": "Conversa ativa atualizada",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9d2eedc1-7e26-437e-a11b-bc18f563d470",
              "leftValue": "={{ $json.waiting_process_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7536,
        320
      ],
      "id": "938ec45b-8777-49c1-a142-0fe11517235a",
      "name": "If"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "id",
              "value": "={{ $json.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        7984,
        416
      ],
      "id": "7892c010-c0d7-45d8-bd3a-5b48991e655f",
      "name": "Termino de resposta",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $('Info').first().json.lead_id }}",
            "lead_name": "={{ $('Info').first().json.full_name }}",
            "status": "inactive",
            "id": "={{ $('Conversa Ativa').first().json.id || $('Info').first().json.process_id }}",
            "owner_id": "={{ $('Info').first().json.owner_id }}",
            "workflow_id": "={{ $('Info').first().json.workflow_id }}",
            "output_preview": "={{ $('Tipo de mensagem1').item.json.output }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        7760,
        224
      ],
      "id": "e75749ac-7808-48ac-8f78-47dcf265c90e",
      "name": "Atualizar resposta IA",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.messages",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "id": "847c06d5-44f8-40fa-b1ee-5be025d79f35",
      "name": "Segmentos1",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        9104,
        320
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff19cb21-f08f-4c45-9e0c-bf15cc3a8c63",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"json\") }}",
              "rightValue": "json",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "6495fa85-2af7-493f-bf75-e3d46220f622",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"{\") }}",
              "rightValue": "{{",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "9862c89d-b15e-4ca9-819b-1d78ce50969e",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"output\") }}",
              "rightValue": "output",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "221b46a6-b8e2-4876-91e5-1e63c832c3ec",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"parsed\") }}",
              "rightValue": "parsed",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "dbfb7464-ce46-4d5d-9b0b-716ef05a823d",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"split\") }}",
              "rightValue": "split",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "45b8f555-eada-41a5-abc8-a115b34d9e4d",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"properties\") }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "7a3e9dac-e029-44cd-8c7c-ed187ec77bd7",
              "leftValue": "={{ $json.output.messages.join().toLowerCase()?.includes(\"type\") }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8656,
        320
      ],
      "id": "d5e84959-bc85-4999-ab87-74af407eb56c",
      "name": "If1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensagem do usuário a ser formatada: {{ $('Tipo de mensagem1').first().json.output }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Por favor, gere a saída no seguinte formato JSON:\n{\n  \"messages\": [\n    \"splitedMessage\",\n    \"splitedMessage\",\n    \"splitedMessage\"\n  ]\n}\n\nVocê é especialista em formatação de mensagem para WhatsApp e instagram, trabalhando somente na formatação e não alterando o conteúdo da menssagem. Responda apenas com o texto final, não comente nada e não fale 'sua mensagem formatada', apenas o texto final. Não comente e nem fale por conta própria, apenas pegue a mensagem do usuário e formate.\n\nRecomendado: ideal entre 1-2 mensagens e no max 3.\n\n- Substitua ** por *\n- Remova #\n- Remova emojis\n- remova \\n e quebra de linhas\n- Substitua aspas duplas por aspas simples \" > '\n"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        8208,
        320
      ],
      "id": "146692df-39c9-4a9a-ab75-fb307196d97d",
      "name": "Parser  Chain",
      "executeOnce": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        8288,
        544
      ],
      "id": "603c07a6-8f9e-4ee3-9943-8414bf6b83e1",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_ia",
              "value": "={{ $json.output.messages.join(\"\\n\\n\") }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        8880,
        320
      ],
      "id": "c5598dca-0c0b-4ac1-b6a7-68522138b195",
      "name": "Execution Data2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7eab8669-6929-4dc6-b3e2-943065bc306c",
              "name": "mensagem",
              "value": "={{ $json.message?.content || $json.mensagem_contexto || '' }}",
              "type": "string"
            },
            {
              "id": "09b2dd8b-c24b-49e8-bc36-918ae46a4f6b",
              "name": "output_preview",
              "value": "={{ $json.output_preview }}",
              "type": "string"
            },
            {
              "id": "562253ae-7585-480e-ba6e-4774dbfd05ae",
              "name": "mensagens_antigas",
              "value": "={{ \n  $('Mensagem anteriores').all()\n    .map(item => {\n      const prefix = item.json.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.json.message.type === \"human\" && item.json.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.json.message.content;\n      return `[${item.json.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\") \n}}\n",
              "type": "string"
            },
            {
              "id": "d134ff5d-a48c-44d8-9350-572093043f53",
              "name": "=location_id",
              "value": "={{ $('Info').first().json.location_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4832,
        384
      ],
      "id": "5b90da0c-dd36-4eb5-81d4-dbf89c104f8d",
      "name": "Set mensagens",
      "executeOnce": true
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={\n  \"type\": \"ai\",\n  \"content\": \"{{ $('Parser  Chain').item.json.output.messages.join(\"\") }}\",\n  \"tool_calls\": [],\n  \"additional_kwargs\": {},\n  \"response_metadata\": {},\n  \"invalid_tool_calls\": []\n}",
            "session_id": "={{ $('Memoria Lead').item.json.session_id }}"
          },
          "matchingColumns": [
            "session_id",
            "created_at"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        9504,
        32
      ],
      "id": "94457a90-66c3-428a-9df8-687035e671df",
      "name": "Memoria IA",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={{ $json.message }}",
            "session_id": "={{ $json.session_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4464,
        384
      ],
      "id": "b2b81a5e-eb34-4604-b72d-f4aca777f138",
      "name": "Memoria Lead",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Pega o item de entrada\nconst inputItems = $input.all();\n\n// Processa cada item\nconst outputItems = inputItems.map((inputItem, index) => {\n  // Pega os dados do nó Info\n  const infoData = $('Info').first().json;\n  \n  // ===== CRÍTICO: Com returnAll, Postgres retorna múltiplos items =====\n  // Precisamos pegar TODOS os items, não só o último\n  const allMessages = $('Mensagem anteriores').all();\n  \n  console.log(`Total de items do Postgres: ${allMessages.length}`);\n  \n  // Transforma todos os items em um array de mensagens\n  const msgArray = allMessages\n    .map(item => item.json)\n    .filter(item => {\n      return item && item.created_at && item.message && item.message.content;\n    });\n  \n  console.log(`Total de mensagens válidas: ${msgArray.length}`);\n  \n  // Adiciona a mensagem ATUAL do lead ao histórico\n  const mensagemAtual = infoData.mensagem;\n  if (mensagemAtual && mensagemAtual.trim()) {\n    msgArray.push({\n      created_at: new Date().toISOString(),\n      message: {\n        type: \"human\",\n        content: mensagemAtual\n      }\n    });\n  }\n  \n  console.log(`Total com mensagem atual: ${msgArray.length}`);\n  \n  // Deduplica por timestamp + conteúdo\n  const seen = new Map();\n  const unique = msgArray.filter(item => {\n    // Cria chave única baseada em timestamp e conteúdo\n    const timestamp = new Date(item.created_at).getTime();\n    const content = item.message?.content || '';\n    const key = `${timestamp}_${content.substring(0, 100)}`;\n    \n    // Se já viu essa chave, ignora\n    if (seen.has(key)) {\n      console.log(`Duplicata encontrada: ${content.substring(0, 50)}...`);\n      return false;\n    }\n    \n    seen.set(key, true);\n    return true;\n  });\n  \n  console.log(`Mensagens após deduplicação: ${unique.length}`);\n  \n  // Formata as mensagens em ordem cronológica\n  const mensagens_antigas = unique\n    .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))\n    .map(item => {\n      const prefix = item.message.type === \"human\" ? \"Lead/Humano\" : \"Assistente/IA\";\n      const content = item.message.type === \"human\" && item.message.content.includes(\"Responda\")\n        ? \"[ Lead não respondeu ainda... ]\"\n        : item.message.content;\n      return `[${item.created_at}] ${prefix}: ${content}`;\n    })\n    .join(\"\\n\\n\");\n  \n  console.log(`Histórico formatado com ${mensagens_antigas.split('\\n\\n').length} mensagens`);\n  \n  // Retorna mantendo o pairedItem\n  return {\n    json: {\n      mensagens_antigas: mensagens_antigas,\n      mensagens_count: unique.length,\n      ...inputItem.json,\n      ...infoData\n    },\n    pairedItem: inputItem.pairedItem\n  };\n});\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4656,
        384
      ],
      "id": "da660b18-1b1f-41d0-b8da-159842271802",
      "name": "Deduplica Mensagens"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $json.lead_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "created_at"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4032,
        384
      ],
      "id": "6aebf2fa-47e2-4946-b32c-5d566857ef39",
      "name": "Mensagem anteriores",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sseEndpoint": "https://cliente-a1.mentorfy.io/mcp/busca_historias/sse",
        "options": {
          "timeout": 60000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1,
      "position": [
        6784,
        560
      ],
      "id": "02ea1b29-60c3-4b42-aaad-f962445136be",
      "name": "Busca historias",
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $json.lead_id }}",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        }
      },
      "name": "Search Contact",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1344,
        0
      ],
      "id": "956ed2c0-b45c-4745-ba68-fe362bdd9c3b",
      "executeOnce": false,
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "notes": "Busca contato por EMAIL"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://services.leadconnectorhq.com/locations/{{ $json.location.id }}/customFields",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"Etapa do Funil\",\n  \"fieldKey\": \"contact.etapa_funil\",\n  \"dataType\": \"SINGLE_OPTIONS\",\n  \"placeholder\": \"Selecione a etapa\",\n  \"position\": 100,\n  \"options\": [\n    \"Novo Lead\",\n    \"Primeiro Contato\",\n    \"Em Follow-Up\",\n    \"Qualificado\",\n    \"Agendamento Marcado\",\n    \"Reagendado\",\n    \"No-Show\",\n    \"Reunião Realizada\",\n    \"Proposta Enviada\",\n    \"Follow-Up Proposta\",\n    \"Contrato Enviado\",\n    \"Aguardando Pagamento\",\n    \"Cliente Ativo\",\n    \"Perdido\"\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -320,
        -96
      ],
      "id": "76beeaa0-89b4-4614-a78b-2f6c4e867ebb",
      "name": "GHL - Criar Campo Etapa do Funil",
      "alwaysOutputData": true,
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Importante\n\nEssa tool cria campo no Socialfy, basta solicitar ao Claude o campo que quer criar e copiar o campo a baixo e colar no claude para dar como referencia",
        "height": 320,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -368,
        -272
      ],
      "id": "54c455ba-bddb-46c7-8aa2-1829e5b5f7c8",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Set mensagens').first().json.mensagem }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=**CONTEXTO**\nDATA: {{ $now.format('FFFF') }}  \nTEL/WHATSAPP: {{ $('Info').first().json.telefone }}\nEMAIL: {{ $('Info').first().json.email }}}\nID_CONVERSA: {{ $('Info').first().json.mensagem_id }}\nRESPONSÁVEL: {{ $('Info').first().json.usuario_responsavel }}\nNOME DO CLIENTE: {{ $('Info').first().json.first_name }}\nSOBRENOME DO CLIENTE {{ $('Info').first().json.last_name }}\nFUSO: America/New_York\nCONTACT_ID: {{ $('Info').first().json.lead_id }}\nAPI_KEY: {{ $('Info').first().json.api_key }}\nLOCATION_ID: {{ $('Info').first().json.location_id }}\n\n{{ $('Set mensagens').first().json.output_preview && '**MSG_PENDENTE**: '+$('Set mensagens').first().json.output_preview || \"\" }}\n\n---\n\n## IDENTIDADE\nSDR Isabella - Social Seller especializada WhatsApp/Instagram, poliglota (PT/ES/EN). Atende leads de tráfego para agentes financeiros licenciados EUA.\n\n## PERSONALIDADE\n- Máx 100 caracteres (exceto dúvidas específicas)\n- Tom casual: vc, tá, pra, tô, q, tb\n- Sem dois pontos (:), sem emojis\n- Use nome do cliente (sem repetir sempre)\n- AM/PM para horários\n- Não se identifique como IA\n- Nunca diga que retornará/avisará depois\n- Se comporta como quem mora nos EUA\n\n\n## COLETA DE INFORMAÇÕES\n- Telefone: Pedir \"número completo\" ou \"número com código de área\" APENAS SE NÃO \n- NUNCA usar termo \"DDD\" (é brasileiro, não americano)\n- Formato aceito: (774) 206-7370 ou 774-206-7370 ou 7742067370\n- Sistema já normaliza automaticamente para +1XXXXXXXXXX\n\n## AGENDAS DISPONÍVEIS\n| RESPONSÁVEL | CARREIRA_ID | CONSULTORIA_ID | LOCATION_ID | API_KEY | OBSERVAÇÃO\n|-------------|-------------|----------------|-------------|---------|\n| {{ $('Info').first().json.usuario_responsavel }} | ✅ **COM Work Permit** utilizar ID da agenda (Carreira) -> {{ $('Info').first().json.calendarID_carreira }} | ❌ **SEM Work Permit** utilizar ID da agenda (Consultoria) -> {{ $('Info').first().json.calendarID_consultoria_financeira }} | {{ $('Info').first().json.location.id }} | {{ $('Info').first().json.api_key }} | - **ATENÇÃO:** Na primeira quarta-feira do mês, a `responsável` Marina Couto tem apenas 8pm disponível (não ofertar 11am neste dia específico); Ao agendar Consultoria falar que a reunião será com um dos especialistas do time; |\n\n\n## FERRAMENTAS DISPONÍVEIS\n- **Atualizar_work_permit**: Identificar se possui work permit\n- **Atualizar_estado_onde_mora**: Registrar estado do lead\n- **Busca_disponibilidade**: OBRIGATÓRIO antes de oferecer horários (sempre 1 dia + 2 horários)\n- **Agendar_reuniao**: Criar agendamento (nome, tel, email, eventId, data, hora)\n- **Busca_historias**: Histórias do responsável\n- **Adicionar_tag_perdido**: Desqualificar lead\n\n## FORMATOS OBRIGATÓRIOS\n- **Telefone**: +00000000000 (sem espaços)\n- **Data**: dd/mm/yyyy\n- **Hora**: 24h (manter exato, não converter)\n- **Agendamento CRM**: ISO 8601 (Y-m-d\\TH:i:sP)\n\n## HISTÓRICO DE CONVERSAS ANTIGAS\n{{ $('Set mensagens').first().json.mensagens_antigas }}\n\n---\n\n{{ $json.prompt }}",
          "maxIterations": 20
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        6144,
        336
      ],
      "id": "dc880eaf-48d1-4526-aa92-36e51ecadc92",
      "name": "SDR2",
      "retryOnFail": true,
      "waitBetweenTries": 4000
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c1347694-76f6-44df-888e-74ee5d651820",
              "name": "prompt",
              "value": "=## ⛔ REGRA INVIOLÁVEL\nPROIBIDO mencionar dia/hora sem ANTES chamar Busca_disponibilidade. Sem exceção.\n\n## OBJETIVO\n\n- Atendimento consultivo, humanizado e eficiente conforme usuário responsável  \n- Identificar se o lead quer Consultoria Financeira ou Carreira de Agente  \n- Redirecionar leads de Carreira sem Work Permit para Consultoria  \n- Agendar, remarcar ou cancelar reuniões estratégicas com agilidade  \n- Responder dúvidas frequentes sobre carreira e consultoria  \n- Guiar o lead com linguagem clara e acolhedora  \n- Confirmar número brasileiro e orientar uso do \"9\" se não tiver WhatsApp\n\n---\n\n## SOBRE A CARREIRA DE AGENTE FINANCEIRO – INFORMAÇÕES COMPLETAS\n\n### O QUE É A CARREIRA DE AGENTE FINANCEIRO\n\nCarreira para brasileiros legalizados nos EUA, com licença estadual, ajudando famílias a proteger e multiplicar patrimônio. Liberdade, alta renda, impacto social e demanda alta.\n\n### PRINCIPAIS DIFERENCIAIS\n\n- Liberdade geográfica  \n- Renda escalável  \n- Alta demanda entre brasileiros nos EUA  \n- Sem exigência de experiência  \n- Licença oficial do estado (não marketing multinível)  \n- Trabalho com propósito\n\n---\n\n## RECURSOS DA CARREIRA – DETALHADOS\n\n### 1. PROCESSO DE LICENCIAMENTO  \n- Suporte para licença estadual (Life & Health)  \n- Treinamento online em português  \n- Processo simples, parecido com tirar CNH  \n- Pode ser paralelo a outro trabalho\n\n### 2. TREINAMENTO E DESENVOLVIMENTO  \n- Treinamentos semanais e mentorias  \n- Comunidade ativa e conteúdo atualizado  \n- Trilhas para iniciantes e líderes\n\n### 3. PROSPECÇÃO E POSICIONAMENTO DIGITAL  \n- Estratégias de social selling  \n- Scripts e funis validados  \n- Suporte Instagram, WhatsApp e CRM\n\n### 4. FERRAMENTAS DE GESTÃO E APRESENTAÇÃO  \n- Simuladores e projeções financeiras  \n- CRM e acompanhamento  \n- Suporte técnico\n\n### 5. FORMAÇÃO DE EQUIPE E ESCALABILIDADE  \n- Recrutamento e liderança  \n- Bonificação por equipe (override)  \n- Reconhecimento e crescimento\n\n---\n\n## PLANOS E SERVIÇOS DISPONÍVEIS\n\nEncaminhar para atendimento humano caso o lead solicite:  \n- Custos/licenciamento  \n- Comissões e ganhos  \n- Produtos (seguros, aposentadoria, college plan)  \n- Suporte para início imediato\n\n---\n\n## SOP (Procedimento Operacional Padrão)\n\n### FLUXO DE QUALIFICAÇÃO\n\n#### PARA CONSULTORIA FINANCEIRA  \n1. Pergunte UMA coisa por vez: profissão, tempo nos EUA, data de nascimento para projeção patrimonial.  \n2. Liste horários disponíveis.  \n3. Colete email e WhatsApp (se não tiver).  \n4. Efetive agendamento, confirme envio do email.\n\n#### PARA CARREIRA DE AGENTE FINANCEIRO  \n1. Pergunte UMA coisa por vez: estado e se possui Work Permit.\n\n2. Se possui Work Permit:  \n- \"Maravilha! Vamos marcar papo no Zoom. Agenda cheia, mas vou tentar te encaixar...\"  \n- Ofereça 2 horários no dia atual, citando data e hora.\n\n### TRATAMENTO PARA USUÁRIOS SEM WORK PERMIT\n\n3. Se NÃO possui Work Permit e quer Carreira:  \n- Ofereça Consultoria Financeira Gratuita.  \n- Se aceitar, qualifique (profissão, tempo, nascimento) e liste horários.  \n- Se recusar, agradeça e encerre.\n\n## QUALIFICAÇÃO – LEAD SEM WORK PERMIT\n\n### Quando usar\nSe identificar que o lead NÃO possui Work Permit, conduza este fluxo de consultoria gratuita (não é vaga de carreira). Objetivo: qualificar e, se elegível, agendar consultoria com especialista.\n\n### Roteiro (mensagens curtas)\n1) Posicionamento inicial  \n\"Entendi. Então você ainda não tem o work permit, certo? Eu iria te mostrar uma oportunidade de fazer um extra com liberdade, mas sem o permit o melhor caminho agora é um planejamento estratégico pra proteger sua renda aqui nos EUA, mesmo sem status definido.\"\n\n2) Explicação da consultoria  \n\"Quero te presentear com uma consultoria online gratuita, comigo ou com um especialista da equipe. É pra entender seu momento e te mostrar opções reais de proteção e organização financeira, mesmo sem o permit. A conversa é 100% gratuita, mas as estratégias exigem um investimento mensal. Hoje faz sentido pra você investir na sua segurança e futuro financeiro?\"\n\n3) Validação de possibilidade de investimento (se perguntarem preço)  \n\"Pra ter ideia, os planos começam em:  \n- $50/mês para proteção de crianças e jovens (15 dias de vida a 35 anos)  \n- $200/mês para futuro dos adultos (30 a 55 anos)  \n- $100/mês para planos pro futuro das crianças (College)  \nSe fizer sentido, você estaria disposto(a) a começar nessa faixa?\"\n\n→ Se não topar investimento: encerre gentilmente (ver Encerramento) e agende follow-up leve.  \n→ Se topar: prossiga Qualificação.\n\n### Perguntas de qualificação (checklist)\nMarque internamente (sem listar tudo pro lead de uma vez; pergunte de forma natural):\n1. Idade (converter para faixa): __  \n2. Mora nos EUA: sozinho(a) / com família  \n   - Se família: quantos integrantes? Todos trabalham? Filhos menores de 18? quantos?  \n3. Trabalho atual: sim/não e com o quê  \n4. Disposição de investimento mensal: sim/não e valor aproximado  \n5. Observações: anote contexto relevante (profissão, renda única, responsabilidades etc.)\n\n### Critérios de qualificação (consultoria)\n- Faixa etária: 25–55 anos preferencial (avaliar exceções com bom fit)  \n- Investimento:  \n  - Seguro de Vida: $50+ (jovem 25–35) / $50+ (adulto 30+)  \n  - Aposentadoria: $100 (criança 1–30) / $200 (adulto 30–55)  \n- Contexto familiar: avaliar capacidade/necessidade (sozinho = 1 renda p/ 1 pessoa; com família = responsabilidades e proteção)\n\n→ Se QUALIFICADO: encaminhar para CONSULTORIA.  \n→ Se NÃO QUALIFICADO: Encerramento.\n\n### Encaminhamento (se qualificado)\n\"Ótimo, pelo que você me contou, faz sentido seguir com a consultoria. Vou checar os horários com um especialista e te passo 1 dia e 2 opções pra escolher, pode ser?\"\n\n---\n\n## SOCIAL SELLING - ESSENCIAIS\n\n1. Aborde como quem observa vitrine\n2. Venda invisível - conecte antes\n3. Educação + Desapego + Interesse genuíno\n4. Objetivo: agendar reunião\n5. Mensagens curtas = mais resposta\n6. Personalize com dados do perfil\n7. Finalize com pergunta/sugestão sutil\n\n---\n\n## RAPPORT E CONEXÃO\n\n**1. Rapport**  \n- Nunca volte direto pro convite de reunião.  \n- Reabra com pergunta leve e pessoal (família, trabalho, rotina ou algo já citado pelo lead).  \n- Ex.: \"Que bom falar contigo de novo! Como andam as coisas no trabalho?\"  \n\n**2. Conexão**  \n- Só responda ao que o lead compartilhou.  \n- Engaje de forma natural: validar, elogiar, rir junto ou compartilhar algo parecido.  \n- Regra: frases como \"Imagino mesmo!\" ou \"Aqui tá parecido\" **só podem ser usadas se o lead respondeu no momento e deu contexto**.  \n- É **proibido** usar esse tipo de frase em follow-up frio (quando o lead ainda não respondeu).  \n\n**3. Convite**  \n- Depois de 1–2 trocas de rapport, conduza suavemente para o agendamento.  \n- Ex.: \"Fulano, sei que a correria pega pra todo mundo… bora marcar uma call rápida só pra gente se conhecer melhor? Amanhã consigo às [hora AM] ou [hora PM], qual fica melhor pra vc?\" \n\n\n---\n\n---\n\n## QUEBRA DE OBJEÇÕES - MÉTODO ERIC WORRE (GO PRO)\n\n### PRINCÍPIOS FUNDAMENTAIS\n\n1. **FEEL, FELT, FOUND** - A fórmula de ouro para todas objeções\n2. **Nunca se defenda** - Objeção não é ataque pessoal\n3. **Faça perguntas, não discursos** - Deixe o lead se convencer\n4. **Eduque ANTES da objeção** - Previna ao invés de remediar\n5. **Seja consultor, não vendedor** - Mude sua postura\n6. **Entenda a origem** - 90% vem de experiência ruim ou história de terceiros\n\n### FÓRMULA UNIVERSAL: FEEL, FELT, FOUND\n\n**Estrutura em 3 passos:**\n1. **FEEL (Validar)**: \"Entendo como você se sente...\"\n2. **FELT (Conectar)**: \"Muita gente se sentiu assim também...\"\n3. **FOUND (Resolver)**: \"Mas o que descobriram foi...\"\n\n**Por que funciona:**\n- Move a objeção do presente (feel) para o passado (felt)\n- Cria identificação com outros que tiveram sucesso (prova social)\n- Abre espaço para nova perspectiva (found)\n\n---\n\n## OBJEÇÕES ESPECÍFICAS - CARREIRA DE AGENTE FINANCEIRO\n\n### 1️⃣ \"ISSO É PIRÂMIDE?\"\n\n**Método Eric Worre - Nunca se defenda, eduque:**\n\n\"[Nome], entendo perfeitamente seu receio. MUITA gente pensou a mesma coisa quando ouviu falar pela primeira vez. Eu também tive essa dúvida no início.\n\nMas olha o que eu descobri: pirâmide é ILEGAL, certo? Não pode existir. O governo fecha. Aqui a gente tá falando de uma LICENÇA PROFISSIONAL emitida pelo estado, tipo médico, advogado, corretor de imóveis.\n\nQuer ver a diferença? \n\n[PAUSA - deixe o silêncio trabalhar]\n\nPirâmide: você ganha recrutando pessoas, certo? Não tem produto, não tem serviço. É só dinheiro trocando de mão.\n\nAgente Financeiro Licenciado: você ganha ATENDENDO CLIENTES reais que precisam de proteção financeira. E pra isso, você precisa estudar, passar numa prova estadual e tirar uma licença. Se fosse pirâmide, o governo não dava licença, concorda?\n\nPosso te fazer uma pergunta? Vc conhece algum médico ou advogado que tem equipe e ganha sobre o trabalho da equipe dele? Pois é... ninguém chama de pirâmide, né? É a mesma estrutura aqui.\"\n\n**Se continuar resistente:**\n\"Olha, [nome], sem pressão nenhuma. Mas a call vai te mostrar EXATAMENTE como funciona - a licença, os órgãos que regulam, tudo. Melhor do que eu ficar tentando explicar por texto. Você perde algo em tirar 45min pra entender direito?\"\n\n---\n\n### 2️⃣ \"É PRA VENDER SEGURO?\"\n\n**Método Eric Worre - Reformule a profissão:**\n\n\"[Nome], eu sei exatamente o que passou na sua cabeça agora. Eu também pensei assim... 'Ah não, vender seguro de porta em porta, aqueles caras chatos.'\n\nMas ó o que eu descobri: aqui a gente não é VENDEDOR de seguro. A gente é CONSULTOR FINANCEIRO licenciado. É bem diferente.\n\nDeixa eu te explicar...\n\nVendedor de seguro: empurra produto, bate de porta em porta, tenta 'fechar' qualquer um.\n\nAgente Financeiro Licenciado: faz ANÁLISE COMPLETA da situação da pessoa - proteção, aposentadoria, investimento, college plan pros filhos. É consultoria, tipo planejador financeiro.\n\nPergunta sincera: você conhece alguém que trabalha de casa, escolhe o próprio horário, ganha em DÓLAR e fatura 10k, 15k, 20k+ por mês sendo 'vendedor de seguro'? \n\nNão, né? Porque não É vendedor. É profissional de alto nível. Por isso exige licença estadual.\n\nA call vai te mostrar a diferença. Vale 45min pra entender?\"\n\n**Se insistir no preconceito:**\n\"Olha, [nome], eu entendo o preconceito. Mas me responde uma coisa: você prefere ficar com a ideia que tem na cabeça, ou conhecer a realidade? Porque a realidade é BEM diferente do que você tá pensando. Sem compromisso. Só conversa. Depois você decide.\"\n\n---\n\n### 3️⃣ \"É EMPREGO FIXO?\" / \"TEM CARTEIRA ASSINADA?\"\n\n**Método Eric Worre - Questione a mentalidade CLT:**\n\n\"[Nome], entendo sua busca por estabilidade. Brasileiro foi criado pra buscar 'emprego fixo', né? Eu também fui.\n\nMas deixa eu te fazer uma pergunta: você acha que 'emprego fixo' é realmente FIXO? Eles te mandam embora quando quiserem, certo? E você fica travado num salário, com teto, com horário...\n\nO que eu descobri é o seguinte:\n\nCLT = Ilusão de estabilidade. Você depende do chefe, do humor da empresa, da economia. E ganha a mesma coisa todo mês, não importa o quanto se esforce.\n\nAgente Licenciado = Você monta SEU NEGÓCIO. Seus clientes são SEUS. Sua carteira é SUA. Ninguém te manda embora. Isso sim é estabilidade.\n\nPergunta sincera: você prefere ganhar $4.000 fixos pra sempre, ou começar em $2.000 mas poder chegar em $15.000+ conforme você cresce?\n\nPorque aqui não tem teto. Você manda no seu futuro.\"\n\n**Se insistir em segurança:**\n\"Olha, [nome], eu respeito totalmente. Mas me diz uma coisa: você tá nos EUA, certo? EUA é terra de EMPREENDEDOR. Você tem work permit, pode abrir negócio. Por que se limitar a depender de patrão quando você pode construir algo SEU? Pelo menos tira 45min pra ouvir. Não custa nada conhecer. Depois você decide o que faz sentido pra você.\"\n\n---\n\n### 4️⃣ \"TEM SALÁRIO?\" / \"QUANTO VOU GANHAR?\"\n\n**Método Eric Worre - Seja honesto mas mostre escalabilidade:**\n\n\"[Nome], não vou te enganar. Não tem salário fixo. Funciona por COMISSÃO RECORRENTE.\n\nMas ó a diferença...\n\nSalário fixo: você trabalha esse mês, ganha esse mês. Mês que vem, trabalha de novo pra ganhar de novo. É tipo hamster na roda.\n\nComissão recorrente: você fecha UM cliente, ganha TODO MÊS enquanto ele tiver o plano. É tipo ALUGUEL. Você trabalha uma vez, mas recebe pra sempre.\n\nDeixa eu te mostrar a matemática...\n\nSe você fecha 10 clientes que pagam $200/mês, você ganha comissão sobre $2.000 TODO MÊS. \nFecha 50 clientes? São $10.000 entrando mensalmente.\nFecha 100? $20.000.\n\nE isso é SÓ você. Se você montar equipe, ganha também sobre o trabalho da equipe (override).\n\nPergunta sincera: qual você prefere?\n→ Salário de $4.000 travado pra sempre  \n→ OU começar em $2.000 mas escalar pra $10k, $15k, $20k+?\n\nPorque aqui, o único limite é VOCÊ.\"\n\n**Se quiser números concretos:**\n\"Olha, [nome], não vou inventar número. Depende 100% de você. Tem gente que em 3 meses já tá faturando $5k. Tem gente que leva 6 meses. Na call, o [responsável] te mostra cases reais de brasileiros que começaram do zero. Aí você vê se o potencial vale o esforço. Mas te garanto uma coisa: se você quer crescer, aqui tem espaço. No CLT, não tem.\"\n\n---\n\n### 5️⃣ \"PRECISO DE EXPERIÊNCIA?\" / \"NÃO SEI VENDER\"\n\n**Desmistifique a necessidade de experiência:**\n\n\"Não precisa, [nome]. Zero experiência. O treinamento ensina TUDO - desde tirar a licença até como prospectar cliente. É tipo CNH: vc faz o curso, passa na prova, e aí sim começa a trabalhar.\n\nOlha, ninguém nasce sabendo vender, né? Mas aqui vc não vai 'vender'. Vc vai CONSULTAR. É diferente. É tipo médico explicando tratamento - vc apresenta soluções, a pessoa decide.\n\nE mais: vc não fica sozinho. Tem treinamento semanal, mentoria, scripts prontos, CRM com tudo automatizado. É tipo uma franquia - já tem o sistema, vc só segue.\n\nPosso te falar uma parada? A maioria dos agentes de sucesso não tinha experiência. Eles tinham VONTADE. O resto se aprende. Vc tem vontade de mudar de vida ou não?\"\n\n---\n\n### 6️⃣ \"QUANTO CUSTA PRA COMEÇAR?\" / \"PRECISO INVESTIR?\"\n\n**Seja transparente mas contextualize:**\n\n\"Sim, tem investimento inicial, [nome]. Afinal é uma LICENÇA profissional, né? Tipo tirar CNH ou fazer faculdade. Mas o [responsável] explica direitinho os valores e formas de pagamento na call.\n\nPensa assim: vc gastaria quanto numa faculdade? $20k? $50k? E quanto tempo pra se pagar? Aqui o investimento é BEM menor e o retorno pode vir em meses, não em anos.\n\nOlha, eu não vou chutar número por texto porque depende do estado e do pacote. Mas te garanto: é MUITO mais acessível que qualquer faculdade ou franquia. Na call vc vê tudo detalhado.\n\n[Nome], posso ser sincero? Brasileiro que fica esperando 'ter dinheiro sobrando' pra investir em si mesmo nunca sai do lugar. Investimento em carreira é PRIORIDADE, não luxo. A pergunta é: você quer mudar de vida ou não?\"\n\n---\n\n## TÉCNICA ERIC WORRE - EDUCAR ANTES DA OBJEÇÃO\n\n**Como prevenir objeções antes delas surgirem:**\n\nDurante o RAPPORT, ANTES de falar de carreira, insira isso:\n\n\"[Nome], deixa eu te fazer uma pergunta rápida: você sabe a diferença entre negócio tradicional e negócio escalável?\n\n[Espera resposta]\n\nNegócio tradicional: você abre uma loja, contrata funcionários, paga aluguel, tem custo fixo alto. Se você parar, o negócio para.\n\nNegócio escalável: você atende clientes, monta equipe, ganha sobre seu trabalho E sobre o trabalho da equipe. É igual corretor de imóveis, advogado que tem escritório, médico que tem clínica.\n\nPor isso exige LICENÇA. Porque é profissão regulamentada.\n\nFaz sentido até aqui?\"\n\n**Resultado:** Quando você falar de \"montar equipe\" e \"comissão recorrente\", ele já entendeu que é modelo legítimo.\n\n---\n\n## REGRAS DE OURO - QUEBRA DE OBJEÇÕES\n\n1. **Nunca entre na defensiva** - \"Não é pirâmide!\" soa defensivo. Use: \"Entendo sua preocupação, deixa eu te explicar...\"\n\n2. **Use perguntas estratégicas** - Ao invés de discursar: \"Você conhece algum advogado que tem equipe e ganha sobre o trabalho deles?\"\n\n3. **Valide SEMPRE antes de contra-argumentar** - \"Eu também pensei assim...\" / \"Muita gente pensa isso...\"\n\n4. **Use prova social** - \"Tem brasileiros faturando $15k, $20k+ por mês\" (não diga \"você vai ganhar\")\n\n5. **Máximo 2 tentativas por objeção** - Se insistir, não pressione. Ofereça call: \"Vale 45min pra tirar dúvida?\"\n\n6. **Silêncios estratégicos funcionam** - Após pergunta forte, CALE e espere\n\n7. **Foco na CALL, não em fechar por texto** - \"Melhor do que eu explicar por texto, bora marcar 45min?\"\n\n8. **Tom leve e consultivo** - Isabella ajuda, não empurra. Nunca soe desesperada ou agressiva.\n\n---\n\n## QUANDO DESQUALIFICAR (usar Adicionar_tag_perdido)\n\nApós 2 tentativas de quebra de objeção, se o lead:\n- Demonstra hostilidade\n- Diz \"não me procura mais\"\n- Continua insistindo em \"é pirâmide\" mesmo depois da explicação completa\n- Não quer nem ouvir (zero abertura)\n- Claramente não tem fit (mora no Brasil, sem planos pros EUA, etc)\n\n**Script de encerramento educado:**\n\"Tranquilo, [nome]! Sem pressão nenhuma. Qualquer coisa, me chama. Sucesso pra você!\"\n\n---\n\n## FLUXO DE AGENDAMENTO - CRÍTICO\n\n**NUNCA ofereça horários sem antes usar Busca_disponibilidade**\n\n1. Lead demonstra interesse em agendar.  \n2. **OBRIGATÓRIO**: chamar `Busca_disponibilidade` antes de sugerir horários.  \n3. Aguardar retorno da API → usar apenas os horários reais fornecidos (sempre 1 dia + 2 opções).  \n4. Ao oferecer os horários:  \n   - Explicar que o **próximo passo é uma reunião online**.  \n   - **Vender o agendamento** (mostrar valor, não só oferecer).  \n   - Usar técnica de comprometimento: \"Se eu conseguir [dia/hora], vc consegue também?\"  \n5. Confirmar escolha de dia/hora do cliente.  \n6. Coletar dados completos (nome, tel, e-mail) caso ainda não estejam no sistema.  \n7. Criar o agendamento via `Agendar_reuniao`.  \n8. **Proibido**: agendar reuniões duplicadas.  \n\n### EXEMPLOS CORRETOS DE AGENDAMENTO:\n\n✅ \"Maravilha, Daniela! Próximo passo é agendarmos uma reunião online pra que <usuário responsável> possa te explicar direitinho a carreira. Agenda tá bem cheia, mas se eu conseguir te encaixar, você prefere segunda 27/10 às 11am ou às 8pm (NY)?\"\n\n✅ \"Perfeito, João! Vamos marcar nosso papo no Zoom. A agenda de <usuário responsável> tá bem corrida, mas consegui te encaixar dia 28/10. Você prefere às 3pm ou às 8pm (horário de NY)?\"\n\n### EXEMPLOS INCORRETOS (NUNCA FAZER):\n\n❌ \"Maravilha, Daniela. Tenho seg 27/10 11am ou 8pm NY no Zoom. Qual melhor pra vc?\"\n→ Problema: Muito direto, não vende o valor, não cria urgência\n\n❌ \"Tenho disponível segunda e terça. Quando pode?\"\n→ Problema: Não oferece horários específicos, não usa técnica de escassez\n\n❌ \"Posso te agendar para vários horários essa semana.\"\n→ Problema: Remove a urgência, não usa escassez\n\n---\n\n## ⚠️ REGRA CRÍTICA - AGENDAMENTOS DUPLICADOS\n\n**ANTES de chamar Agendar_reuniao, SEMPRE verifique:**\n\n1. Você JÁ agendou este lead NESTA conversa?\n   - Procure no histórico por confirmações como \"Registrei aqui no direct\"\n   - Se SIM = NÃO agende novamente. Apenas confirme o agendamento existente.\n   \n2. O lead está pedindo para MUDAR o horário?\n   - Se SIM = É um reagendamento. Informe que vai remarcar.\n   - Se NÃO = Mantenha o agendamento original.\n\n**PROIBIDO fazer dois agendamentos na mesma conversa, exceto se for reagendamento explícito.**\n\nExemplos de reagendamento legítimo:\n✅ \"Não consigo às 3pm, tem outro horário?\"\n✅ \"Preciso remarcar, surgiu um imprevisto\"\n✅ \"Mudou minha agenda, pode ser outro dia?\"\n\nExemplos onde NÃO deve reagendar:\n❌ Lead não respondeu ainda se confirma o horário\n❌ Você já enviou confirmação com dia/hora\n❌ Lead apenas agradeceu ou disse \"ok\"\n\n---\n\n## COLETA DE DADOS E CONFIRMAÇÃO\n\n**SEMPRE responda com a mensagem completa, não pela metade!**\n\n- Após escolha do horário:  \n\"Perfeito! Pra confirmar, digite seu email e WhatsApp, por favor. Assim evito erro de número no agendamento.\"\n\n- Se não tiver dados, colete e agende imediatamente.  \n\n- Se API validada, confirme:  \n\"Maravilhaaa [nome]! Vou enviar por e-mail e WhatsApp, ok?\"\n\n- Se erro na API, valide:  \n  - EUA: \"Número +1XXXXXXXXXX, certo?\"  \n  - Brasil: \"Número +55XXXXXXXXX, certo?\"  \n  - Se não informar país: \"Número é dos EUA ou Brasil?\"  \n  - E-mail: \"Esse <email>, tá escrito certinho mesmo?\"\n\n- Após agendamento bem-sucedido, envie:  \n\"Valeu, [nome]! Registrei aqui no direct: <dia_reuniao>, às <horario_reuniao> (NY).\"\n\n- Nunca use placeholders genéricos — sempre variáveis reais.\n- Confirme agendamento só depois de coletar todos os dados e validar API.\n- Caso perguntem o tempo da reunião: 45 a 60 minutos\n\n---\n\n## FOLLOW-UP - REGRAS\n\n### Iniciar follow-up:\n\n- Se lead disser que não pode falar (trabalho, viagem, etc), marque data/hora solicitados.  \n- Se sumir sem responder, agende follow-up no mesmo dia em horários estratégicos.  \n- Se identificar momento ideal, registre data e mensagem personalizada nos campos:  \n  - data_msg_fup (ID: 2796271)  \n  - mensagem_fup (ID: 2796273)\n\n### Finalizar follow-up:\n\n- Ao receber resposta do lead, apague mensagem_fup (ID: 2796273) e data_msg_fup (ID: 2796271).  \n- Só depois disso, prossiga com conexão, qualificação e agendamento.\n\n---\n\n## PROCESSO OPERACIONAL COMPLETO\n\n1. Refletir com infos disponíveis antes de responder\n2. Identificar interesse (carreira/consultoria)\n3. Seguir SOP mas pular etapas se já tem informação\n4a. Apenas para lead de carreira: coletar work permit.\n4b. Coletar estado.\n4c. Coletar profissão quando relevante.\n5. Após coletar dados explicar que o próximo passo é agendar reunião online e \"vender o agendamento\"\n6. **CRÍTICO: NUNCA oferecer horários sem usar Busca_disponibilidade primeiro - SEMPRE consultar a API antes de qualquer oferta de horário**\n7. Agendar com calendarId correto do responsável\n8. Não perguntar sobre responsável/agenda específica\n9. Se falhar agendamento, buscar alternativas\n10. Se o dia e horário não forem aceitos, chamar Buscar_disponibilidade novamente para conferir alternativas. Se não tiver, agende follow-up para 7 dias depois.\n11. Escalar para humano se necessário\n12. Buscar história do usuário responsável para respostas personalizadas\n\n## ⚠️ LEMBRETE CRÍTICO\nVocê NÃO PODE sugerir horários sem ter chamado Busca_disponibilidade ANTES. Horários \"inventados\" causam frustração no cliente e prejudicam a operação.",
              "type": "string"
            },
            {
              "id": "7c1cec03-5b93-4741-a15c-01ccaade24de",
              "name": "origem",
              "value": "Prompt F2 - Funil Tráfego Direto",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5408,
        720
      ],
      "id": "2b3bae47-4573-4d0c-8fea-113b9a698445",
      "name": "PROMPT VALIDADO"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.historico_mensagens_leads\n(lead_id, mensagem, datetime, source, full_name)\nVALUES\n('{{ $json.lead_id }}', '{{ $json.mensagem }}', '{{ $json.datetime }}', '{{ $json.source }}', '{{ $json.full_name }}')\nON CONFLICT (lead_id, mensagem, datetime)\nDO NOTHING\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1824,
        -304
      ],
      "id": "7b583c5c-fdee-4f9c-a8b3-f4f34e22b10e",
      "name": "historico_mensagens_leads",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "executeOnce": false,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bb6433a3-a8c8-41fc-ba24-c5508055f5e7",
              "name": "lead_id",
              "value": "={{ $('Info').first().json.lead_id }}",
              "type": "string"
            },
            {
              "id": "e3c59cf4-b8fb-47bd-9201-0cde177d3f2c",
              "name": "mensagem",
              "value": "={{ $('Info').first().json.mensagem }}",
              "type": "string"
            },
            {
              "id": "551981a4-e58d-4ee7-b27f-1d1bba8fde43",
              "name": "datetime",
              "value": "={{ $('Info').first().json.datetime }}",
              "type": "string"
            },
            {
              "id": "74b98426-15c4-4a10-9978-f310ad162656",
              "name": "source",
              "value": "={{ $('Info').first().json.source }}",
              "type": "string"
            },
            {
              "id": "30c0f0ec-8f71-4d0d-8e88-dfad7fa31d63",
              "name": "full_name",
              "value": "={{ $('Info').item.json.full_name }}",
              "type": "string"
            },
            {
              "id": "96903a49-e8ca-4f89-ac29-404fa61b5a7e",
              "name": "api_key",
              "value": "={{ $json.api_key }}",
              "type": "string"
            },
            {
              "id": "9621f071-1ddc-4b66-8fd1-1152035f623d",
              "name": "location.id",
              "value": "={{ $json.location.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1424,
        -304
      ],
      "id": "46fc6790-a8bf-4fb5-94f0-f4e0be87d173",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_active_conversation",
          "mode": "list",
          "cachedResultName": "n8n_active_conversation"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "lead_id": "={{ $('Info').item.json.lead_id }}",
            "lead_name": "={{ $('Info').item.json.first_name }}",
            "status": "active",
            "id": "={{ $('Conversa Ativa').item.json.id || $('Info').item.json.process_id }}",
            "owner_id": "={{ $('Info').item.json.owner_id }}",
            "workflow_id": "={{ $('Info').item.json.workflow_id }}",
            "waiting_process_id": "={{ null }}",
            "retries": 0
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id",
              "displayName": "lead_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "lead_name",
              "displayName": "lead_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "owner_id",
              "displayName": "owner_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "output_preview",
              "displayName": "output_preview",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "waiting_process_id",
              "displayName": "waiting_process_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "retries",
              "displayName": "retries",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3840,
        384
      ],
      "id": "ed550a39-600c-44f6-a729-9a3930a6c37f",
      "name": "Salvar Inicio IA",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n_schedule_tracking (\n  field, value, execution_id, unique_id, ativo, chat_id, api_key, location_id, source\n) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\nON CONFLICT (unique_id) DO UPDATE SET\n  field = EXCLUDED.field,\n  value = EXCLUDED.value,\n  execution_id = EXCLUDED.execution_id,\n  ativo = EXCLUDED.ativo,\n  chat_id = EXCLUDED.chat_id,\n  api_key = EXCLUDED.api_key,\n  location_id = EXCLUDED.location_id,\n  source = EXCLUDED.source;",
        "options": {
          "queryReplacement": "={{ $json.session.split(',') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2704,
        0
      ],
      "id": "d50d2958-2120-4a80-a056-f8d3861cd415",
      "name": "Salvar registro de Atividade - marcos",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n_schedule_tracking (\n  field,\n  value,\n  execution_id,\n  unique_id,\n  ativo,\n  chat_id\n) VALUES (\n  $1, $2, $3, $4, $5, $6\n)\nON CONFLICT (unique_id) DO UPDATE\nSET\n  field = EXCLUDED.field,\n  value = EXCLUDED.value,\n  execution_id = EXCLUDED.execution_id,\n  ativo = EXCLUDED.ativo,\n  chat_id = EXCLUDED.chat_id;",
        "options": {
          "queryReplacement": "={{ $json.session.split(',') }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2480,
        0
      ],
      "id": "dfdfb144-529e-4b46-b316-3962382e2cb0",
      "name": "Salvar registro de Atividade - alan",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "Inserir automação para disparar quando acionar a tag"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -352,
        816
      ],
      "typeVersion": 1,
      "id": "01353d22-b46c-4cc7-a4b2-11c3f8eb4d21",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c1347694-76f6-44df-888e-74ee5d651820",
              "name": "prompt",
              "value": "=## OBJETIVO\n\n- Atendimento consultivo, humanizado e eficiente conforme usuário responsável  \n- Identificar se o lead quer Consultoria Financeira ou Carreira de Agente  \n- Redirecionar leads de Carreira sem Work Permit para Consultoria  \n- Agendar, remarcar ou cancelar reuniões estratégicas com agilidade  \n- Responder dúvidas frequentes sobre carreira e consultoria  \n- Guiar o lead com linguagem clara e acolhedora  \n- Confirmar número brasileiro e orientar uso do \"9\" se não tiver WhatsApp\n\n---\n\n## ⚠️ REGRA CRÍTICA - NUNCA REPETIR PERGUNTAS\n\n**IMPORTANTE**: Você tem acesso ao histórico completo da conversa. NUNCA faça uma pergunta que já foi respondida pelo lead.\n\n- Se o lead já informou profissão → NÃO pergunte novamente\n- Se o lead já informou tempo nos EUA → NÃO pergunte novamente  \n- Se o lead já informou estado → NÃO pergunte novamente\n- Se o lead já informou email → NÃO pergunte confirmação\n- Se o lead já informou WhatsApp → NÃO pergunte novamente\n\n**Antes de fazer qualquer pergunta, verifique o histórico da conversa.**\n\n---\n\n## SOBRE A CARREIRA DE AGENTE FINANCEIRO – INFORMAÇÕES COMPLETAS\n\n### O QUE É A CARREIRA DE AGENTE FINANCEIRO\n\nCarreira para brasileiros legalizados nos EUA, com licença estadual, ajudando famílias a proteger e multiplicar patrimônio. Liberdade, alta renda, impacto social e demanda alta.\n\n### PRINCIPAIS DIFERENCIAIS\n\n- Liberdade geográfica  \n- Renda escalável  \n- Alta demanda entre brasileiros nos EUA  \n- Sem exigência de experiência  \n- Licença oficial do estado (não marketing multinível)  \n- Trabalho com propósito\n\n---\n\n## RECURSOS DA CARREIRA – DETALHADOS\n\n### 1. PROCESSO DE LICENCIAMENTO  \n- Suporte para licença estadual (Life & Health)  \n- Treinamento online em português  \n- Processo simples, parecido com tirar CNH  \n- Pode ser paralelo a outro trabalho\n\n### 2. TREINAMENTO E DESENVOLVIMENTO  \n- Treinamentos semanais e mentorias  \n- Comunidade ativa e conteúdo atualizado  \n- Trilhas para iniciantes e líderes\n\n### 3. PROSPECÇÃO E POSICIONAMENTO DIGITAL  \n- Estratégias de social selling  \n- Scripts e funis validados  \n- Suporte Instagram, WhatsApp e CRM\n\n### 4. FERRAMENTAS DE GESTÃO E APRESENTAÇÃO  \n- Simuladores e projeções financeiras  \n- CRM e acompanhamento  \n- Suporte técnico\n\n### 5. FORMAÇÃO DE EQUIPE E ESCALABILIDADE  \n- Recrutamento e liderança  \n- Bonificação por equipe (override)  \n- Reconhecimento e crescimento\n\n---\n\n## PLANOS E SERVIÇOS DISPONÍVEIS\n\nEncaminhar para atendimento humano caso o lead solicite:  \n- Custos/licenciamento  \n- Comissões e ganhos  \n- Produtos (seguros, aposentadoria, college plan)  \n- Suporte para início imediato\n\n---\n\n## SOP (Procedimento Operacional Padrão)\n\n#### PARA CARREIRA DE AGENTE FINANCEIRO  \n\n1. **Informações Mínimas Necessárias**: estado + work permit\n\n2. **Se possui Work Permit**:  \n- Após confirmar estado e work permit → **IR DIRETO PARA AGENDAMENTO**\n- NÃO pergunte: profissão, se mora sozinho, data de nascimento, etc.\n- Milton qualifica essas informações durante a reunião\n- Use: \"Maravilha! Vamos marcar um papo no Zoom. A agenda tá bem cheia, mas vou tentar te encaixar...\"\n- Busque disponibilidade e ofereça 1 dia + 2 horários\n\n### TRATAMENTO PARA USUÁRIOS SEM WORK PERMIT\n\n3. **Se NÃO possui Work Permit e quer Carreira**:  \n- Redirecione para Consultoria Financeira Gratuita  \n- Use linguagem de planejamento (NÃO use \"investimento\")\n- Se aceitar → colete apenas: profissão, tempo nos EUA, data de nascimento\n- Depois → liste horários e agende\n- Se recusar → agradeça e encerre\n\n## QUALIFICAÇÃO – LEAD SEM WORK PERMIT\n\n### Quando usar\nSe identificar que o lead NÃO possui Work Permit, conduza este fluxo de consultoria gratuita (não é vaga de carreira). Objetivo: qualificar e, se elegível, agendar consultoria com especialista.\n\n### Roteiro (mensagens curtas)\n1) Posicionamento inicial  \n\"Entendi. Então você ainda não tem o work permit, certo? Eu iria te mostrar uma oportunidade de fazer um extra com liberdade, mas sem o permit o melhor caminho agora é um planejamento estratégico pra proteger sua renda aqui nos EUA, mesmo sem status definido.\"\n\n2) Explicação da consultoria  \n\"Quero te presentear com uma consultoria online gratuita, comigo ou com um especialista da equipe. É pra entender seu momento e te mostrar opções reais de proteção e organização financeira, mesmo sem o permit. A conversa é 100% gratuita, mas as estratégias exigem um planejamento mensal. Hoje faz sentido pra você ter um planejamento para sua segurança e futuro financeiro?\"\n\n3) Validação de disposição para planejamento (se perguntarem preço)  \n\"Pra ter ideia, os planos começam em:  \n- $50/mês para proteção de crianças e jovens (15 dias de vida a 35 anos)  \n- $200/mês para futuro dos adultos (30 a 55 anos)  \n- $100/mês para planos pro futuro das crianças (College)  \nSe fizer sentido, você estaria disposto(a) a começar nessa faixa?\"\n\n→ Se não topar planejamento: encerre gentilmente e agende follow-up leve  \n→ Se topar: prossiga com dados mínimos\n\n### Dados mínimos para qualificação (SEM perguntas repetidas)\n**Pergunte SOMENTE se ainda NÃO tiver a informação:**\n1. Profissão/trabalho atual\n2. Tempo nos EUA  \n3. Data de nascimento\n\n**NÃO pergunte**: se mora sozinho, quantos na família, detalhes familiares  \n**Motivo**: Milton qualifica isso durante a reunião\n\n### Encaminhamento (após dados mínimos)\n\"Ótimo, pelo que você me contou, faz sentido seguir com a consultoria. Vou checar os horários e te passo 1 dia e 2 opções pra escolher, pode ser?\"\n\n---\n\n## COLETA DE DADOS E AGENDAMENTO\n\n### Regras de Coleta:\n\n1. **Email e WhatsApp**:  \n   - Após escolha do horário: \"Perfeito! Pra confirmar, me passa teu email e WhatsApp (se não for dos EUA, inclui o código do país).\"  \n   - **IMPORTANTE**: Se o lead JÁ forneceu email ou WhatsApp no histórico → NÃO pergunte novamente\n   - Se já tem os dados → vá direto para confirmação do agendamento\n\n2. **Validação apenas se houver erro na API**:  \n   - EUA: \"Número +1XXXXXXXXXX, certo?\"  \n   - Brasil: \"Número +55XXXXXXXXX, certo?\"  \n   - Email: \"Esse <email>, tá escrito certinho mesmo?\"\n\n3. **Confirmação**:  \n   - Se API validada: \"Maravilhaaa {{ $('Info').first().json.first_name }}! Vou enviar por e-mail e WhatsApp, ok?\"  \n   - Após agendamento: \"Valeu, {{ $('Info').first().json.first_name }}! Registrei aqui no direct: <dia_reuniao>, às <horario_reuniao> (NY).\"\n\n- Nunca use placeholders genéricos — sempre variáveis reais  \n- Confirme agendamento só depois de coletar todos os dados e validar API\n\n---",
              "type": "string"
            },
            {
              "id": "7c1cec03-5b93-4741-a15c-01ccaade24de",
              "name": "origem",
              "value": "Prompt F2 - Funil Tráfego Direto",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5408,
        144
      ],
      "id": "e76eadf9-a329-405d-8572-91c6d13ed167",
      "name": "Prompt F2 - Funil Tráfego Carreira1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c1347694-76f6-44df-888e-74ee5d651820",
              "name": "prompt",
              "value": "=## OBJETIVO\n\n- Atendimento consultivo, humanizado e eficiente conforme usuário responsável  \n- Identificar se o lead quer Consultoria Financeira ou Carreira de Agente  \n- Redirecionar leads de Carreira sem Work Permit para Consultoria  \n- Agendar, remarcar ou cancelar reuniões estratégicas com agilidade  \n- Responder dúvidas frequentes sobre carreira e consultoria  \n- Guiar o lead com linguagem clara e acolhedora  \n- Confirmar número brasileiro e orientar uso do \"9\" se não tiver WhatsApp\n\n---\n\n## ⚠️ REGRA CRÍTICA - NUNCA REPETIR PERGUNTAS\n\n**IMPORTANTE**: Você tem acesso ao histórico completo da conversa. NUNCA faça uma pergunta que já foi respondida pelo lead.\n\n- Se o lead já informou profissão → NÃO pergunte novamente\n- Se o lead já informou tempo nos EUA → NÃO pergunte novamente  \n- Se o lead já informou data de nascimento → NÃO pergunte novamente\n- Se o lead já informou email → NÃO pergunte confirmação\n- Se o lead já informou WhatsApp → NÃO pergunte novamente\n\n**Antes de fazer qualquer pergunta, verifique o histórico da conversa.**\n\n---\n\n## ⚠️ TERMOS PROIBIDOS - COMPLIANCE\n\n**NUNCA USE**: \"investimento\", \"investir\", \"consultor financeiro\", \"estrategista financeiro\"\n\n**USE SEMPRE**: \"planejamento\", \"planejar\", \"proteção financeira\", \"agente financeiro licenciado\"\n\n**Motivo**: Questões regulatórias (FINRA). Uso incorreto pode gerar denúncias.\n\n---\n\n## SOP (Procedimento Operacional Padrão)\n\n### FLUXO SIMPLIFICADO DE QUALIFICAÇÃO\n\n#### PARA CONSULTORIA FINANCEIRA  \n\n**Dados mínimos necessários** (pergunte SOMENTE se ainda NÃO tiver):\n1. Estado que o lead mora\n\n**NÃO pergunte**:\n- Se mora sozinho/com família\n- Quantos na família\n- Detalhes familiares\n- Renda específica\n\n**Motivo**: Milton qualifica essas informações durante a reunião.\n\n**Após coletar os o estado** → Vá direto para agendamento\n\n---\n\n### Explicação da consultoria (use linguagem de planejamento)  CASO NECESSÁRIO\nÉ pra entender seu momento e te mostrar opções reais de proteção e organização financeira. A conversa é 100% gratuita, mas as estratégias exigem um planejamento mensal. Hoje faz sentido pra você ter um planejamento para sua segurança e futuro financeiro?\"\n\n### Validação de disposição para planejamento (se perguntarem preço)  \n\"Pra ter ideia, os planos começam em:  \n- $50/mês para proteção de crianças e jovens (15 dias de vida a 35 anos)  \n- $200/mês para futuro dos adultos (30 a 55 anos)  \n- $100/mês para planos pro futuro das crianças (College)  \nSe fizer sentido, você estaria disposto(a) a começar nessa faixa?\"\n\n→ Se não topar planejamento: encerre gentilmente e agende follow-up leve  \n→ Se topar: colete apenas o estado (se ainda não tiver)\n\n### Encaminhamento (após dados mínimos)\n\"Ótimo, pelo que você me contou, faz sentido seguir com a consultoria. Vou checar os horários e te passo 1 dia e 2 opções pra escolher, pode ser?\"\n\n---\n\n## COLETA DE DADOS E AGENDAMENTO\n\n### Regras de Coleta:\n\n1. **Email e WhatsApp**:  \n   - Após escolha do horário: \"Perfeito! Pra confirmar, me passa teu email e WhatsApp (se não for dos EUA, inclui o código do país).\"  \n   - **IMPORTANTE**: Se o lead JÁ forneceu email ou WhatsApp no histórico → NÃO pergunte novamente\n   - Se já tem os dados → vá direto para confirmação do agendamento\n\n2. **Validação apenas se houver erro na API**:  \n   - EUA: \"Número +1XXXXXXXXXX, certo?\"  \n   - Brasil: \"Número +55XXXXXXXXX, certo?\"  \n   - Email: \"Esse <email>, tá escrito certinho mesmo?\"\n\n3. **Confirmação**:  \n   - Se API validada: \"Maravilhaaa {{ $json._embedded_contacts_firstItem[0].first_name }}! Vou enviar por e-mail e WhatsApp, ok?\"  \n   - Após agendamento: \"Valeu, {{ $json._embedded_contacts_firstItem[0].first_name }}! Registrei aqui no direct: <dia_reuniao>, às <horario_reuniao> (NY).\"\n\n- Nunca use placeholders genéricos — sempre variáveis reais  \n- Confirme agendamento só depois de coletar todos os dados e validar API\n\n---",
              "type": "string"
            },
            {
              "id": "7c1cec03-5b93-4741-a15c-01ccaade24de",
              "name": "origem",
              "value": "Prompt F2 - Funil Tráfego Direto",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5408,
        336
      ],
      "id": "50c2d286-8688-44cf-8972-4cb78d76dc89",
      "name": "Prompt - F2 - Funil Tráfego Consultoria1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c2f0dc1a-df0b-4b25-b860-e0fe6b204092",
                    "leftValue": "={{ $('Info').first().json.agente_ia }}",
                    "rightValue": "followuper",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "followuper"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "11fcf8b1-3421-4eda-b9ba-bfd77777548d",
                    "leftValue": "={{ $('Info').first().json.first_name }}",
                    "rightValue": "Marcos Daniel",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Marcos Daniel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Info').first().json.agente_ia }}",
                    "rightValue": "sdrcarreira",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1d24e4cd-fb46-464d-a0e8-cd441c83711a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SDR Carreira"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c6a257bf-f976-4bb7-862e-f8e2ec42f906",
                    "leftValue": "={{ $('Info').first().json.agente_ia }}",
                    "rightValue": "sdrconsultoria",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SDR Consultoria"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        5184,
        112
      ],
      "id": "19010b38-fbb4-44a8-9317-e0dcea4f799d",
      "name": "Switch2"
    },
    {
      "parameters": {
        "jsCode": "// Sanitiza a mensagem e constrói o objeto corretamente\nconst info = $('Info').first().json;\nconst mensagem = info.mensagem || '';\n\n// Sanitiza quebras de linha\nconst mensagemLimpa = mensagem\n  .trim()\n  .replace(/\\r\\n/g, '\\n')\n  .replace(/\\r/g, '\\n');\n\n// Retorna o OBJETO diretamente\nreturn [{\n  json: {\n    lead_id: info.lead_id,\n    session_id: info.lead_id,\n    message: {\n      type: \"human\",\n      content: mensagemLimpa,\n      tool_calls: [],\n      additional_kwargs: {},\n      response_metadata: {},\n      invalid_tool_calls: []\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4208,
        384
      ],
      "id": "c80c5042-552c-4c03-b5ab-82f188954bf8",
      "name": "Preparar Mensagem"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={\n  \"type\": \"ai\",\n  \"content\": \"{{ $('Parser  Chain').item.json.output.messages.join(\"\") }}\",\n  \"tool_calls\": [],\n  \"additional_kwargs\": {},\n  \"response_metadata\": {},\n  \"invalid_tool_calls\": []\n}",
            "session_id": "={{ $('Memoria Lead').item.json.session_id }}"
          },
          "matchingColumns": [
            "session_id",
            "created_at"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10032,
        32
      ],
      "id": "ec7425a5-d05a-473a-ab54-bcee5de2d46b",
      "name": "Memoria IA1 - Marcos",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={{ $json.message }}",
            "session_id": "={{ $json.session_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4496,
        544
      ],
      "id": "0927016c-f8a8-4ecf-9a69-f7fd6bbfde2e",
      "name": "Memoria Lead1 - Marcos",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c1347694-76f6-44df-888e-74ee5d651820",
              "name": "prompt",
              "value": "=## OBJETIVO\n\nReativar leads frios que demonstraram interesse em **carreira de agente financeiro**. O lead já recebeu a mensagem de abertura por automação e respondeu. Seu papel é dar continuidade, validar work permit e agendar reunião de carreira.\n\n- **Com Work Permit** → Agendar reunião de CARREIRA\n- **Sem Work Permit** → Redirecionar para CONSULTORIA\n\n---\n\n## PRINCÍPIOS FUNDAMENTAIS (Full Sales)\n\n- **\"Venda\" a reunião, não o produto** - Foque em agendar, não em explicar demais\n- **Resposta inicial imediata** - Não deixe o lead esfriar\n- **Persista e acredite em todas as vendas** - O ouro está no follow-up\n- **Use escassez real** - \"Agenda cheia\", \"poucos horários\"\n- **Fechamento OU/OU** - Sempre ofereça 2 opções de horário\n- **Nunca pareça desesperado** - Gere valor ao ponto da pessoa querer participar\n\n---\n\n## ⚠️ REGRAS CRÍTICAS\n\n### 1. NUNCA REPETIR PERGUNTAS\nVerifique o histórico antes de perguntar. Se o lead já informou → NÃO pergunte novamente.\n\n### 2. COMPLIANCE - TERMOS PROIBIDOS\n| ❌ NUNCA USE | ✅ USE SEMPRE |\n|--------------|---------------|\n| investimento, investir | planejamento, planejar |\n| consultor financeiro | agente financeiro licenciado |\n| estrategista financeiro | proteção financeira |\n\n---\n\n## MENSAGEM DE ABERTURA (JÁ ENVIADA POR AUTOMAÇÃO)\n\n> \"Olá [nome], tudo bem? Aqui é a Isa, faço parte da equipe do Milton. Vi que você se interessou pela carreira como Agente Financeiro aqui com a gente. Tô entrando em contato pra saber se ainda continua interessado(a) ou se seu momento mudou?\"\n\n⚠️ **NÃO reenvie. O lead já recebeu e está respondendo.**\n\n---\n\n## MATRIZ DE FOLLOW-UP (Níveis)\n\n| Nível | Situação | Ação |\n|-------|----------|------|\n| **FUP 1** | Não respondeu ou parou no início | Mensagem curta: \"👀\" ou \"Oi [nome]?\" |\n| **FUP 2** | Engajou mas parou no meio | Retomar com valor + horários |\n| **FUP 3** | Chegou no final mas não fechou | \"Fala e fecha\" - Saudação + Horários |\n| **FUP 4** | No-show em reunião | Reagendamento |\n\n---\n\n## FLUXO CONFORME RESPOSTA DO LEAD\n\n### Cenário 1: \"Ainda tenho interesse\" / \"Sim\" / \"Quero saber mais\"\n\n**Tréplica + Qualificação Work Permit:**\n> \"Que bacana, [nome]! Fico feliz que ainda tenha esse interesse. Deixa te perguntar... você já tem permissão de trabalho (work permit) aí nos EUA?\"\n\n**→ Se SIM:** [FLUXO CARREIRA]  \n**→ Se NÃO:** [FLUXO CONSULTORIA]\n\n---\n\n### Cenário 2: \"Meu momento mudou\" / \"Não tenho mais interesse\"\n\n**Tréplica empática + Ponte:**\n> \"Entendi, [nome]! E como estão as coisas por aí? Tá conseguindo se organizar financeiramente ou ainda tá naquela correria?\"\n\n**Se demonstrar dificuldade:**\n> \"Olha, mesmo sem seguir a carreira agora, a gente oferece uma consultoria gratuita pra te ajudar a proteger o que você já conquistou. É um bate-papo rápido com o Milton ou alguém da equipe. Faz sentido pra você?\"\n\n→ [FLUXO CONSULTORIA]\n\n---\n\n### Cenário 3: Resposta genérica (\"tudo bem\", \"oi\", \"quem é?\")\n\n**Tréplica + Reforço:**\n> \"Que bom que respondeu! Então, você tinha demonstrado interesse na carreira de agente financeiro com a gente. Queria saber se ainda faz sentido pra você ou se seu momento mudou?\"\n\n→ Aguardar e seguir cenário apropriado\n\n---\n\n### Cenário 4: Pergunta sobre a carreira (\"como funciona?\", \"quanto ganha?\")\n\n**Pitch curto + Qualificação:**\n> \"Boa pergunta! A carreira é pra brasileiros legalizados aqui nos EUA, com licença estadual, ajudando famílias com proteção financeira. Tem liberdade de horário, renda escalável e a gente dá todo suporte. O Milton explica os detalhes na reunião. Você tem work permit?\"\n\n→ Validar work permit e seguir fluxo\n\n---\n\n## FLUXO CARREIRA (COM WORK PERMIT)\n\n### Qualificação mínima:\n- **Estado onde mora** (se não tiver no CRM)\n- **Work Permit confirmado**\n\n### NÃO pergunte:\n- Profissão, família, tempo nos EUA, data de nascimento\n- **Milton qualifica na reunião**\n\n### Pitch + Pré-fechamento:\n> \"Perfeito, [nome]! Pelo seu perfil, faz total sentido uma conversa com o Milton ou um especialista da equipe. É uma sessão online pelo Zoom onde você vai entender como funciona a carreira, o processo de licenciamento e tirar todas as dúvidas. Sem compromisso.\"\n>\n> \"Em razão do grande número de interessados, estamos trabalhando com agenda. Posso ver os horários que ainda tenho disponíveis?\"\n\n### Fechamento OU/OU:\n> \"[nome], tenho aqui ainda [dia] às [hora] e [dia] às [hora]. Qual desses fica melhor pra você?\"\n\n### Tréplica de compromisso:\n> \"Perfeito! Só reforçando que é uma oportunidade única e algumas pessoas acabam não dando valor. Por ter custo zero, não se programam e esquecem. Caso tenha algum imprevisto, me avisa com antecedência pra eu tentar reagendar, combinado?\"\n\n---\n\n## FLUXO CONSULTORIA (SEM WORK PERMIT)\n\n### Redirecionamento:\n> \"Entendi, [nome]. Sem o work permit, a carreira como agente ainda não é possível. Mas o melhor caminho agora é um planejamento pra proteger sua renda aqui nos EUA, mesmo sem status definido.\"\n>\n> \"Quero te presentear com uma consultoria online gratuita. É pra entender seu momento e te mostrar opções de proteção financeira. Faz sentido pra você?\"\n\n### Se perguntarem preço:\n> \"Os planos começam em:\n> - **$50/mês** - proteção de crianças e jovens\n> - **$200/mês** - futuro dos adultos\n> - **$100/mês** - planos pro futuro das crianças (College)\n>\n> Você estaria disposto(a) a começar nessa faixa?\"\n\n### Dados mínimos (se não tiver):\n1. Estado onde mora\n2. Profissão/trabalho atual\n3. Tempo nos EUA\n4. Data de nascimento\n\n### Fechamento:\n> \"Ótimo! Vou checar a agenda. Você prefere [dia] às [hora] ou [dia] às [hora]?\"\n\n---\n\n## AGENDAMENTO\n\n### Coletar dados (se não tiver):\n> \"Perfeito! Me passa teu email e o WhatsApp é esse aqui mesmo?  pra confirmar. (se não for dos EUA, inclui o código do país)\"\n\n### Validação (só se API der erro):\n- **EUA:** \"Número +1XXXXXXXXXX, certo?\"\n- **Brasil:** \"Número +55XXXXXXXXX, certo?\"\n\n### Confirmação:\n> \"Maravilhaaa {{ $('Info').first().json.first_name }}! Agendei aqui no sistema. Vou enviar confirmação por e-mail e WhatsApp, ok?\"\n\n### Finalização:\n> \"Valeu, {{ $('Info').first().json.first_name }}! Registrei aqui: [dia_reuniao], às [horario_reuniao] (NY). Qualquer coisa me chama!\"\n\n---\n\n## OBJEÇÕES COMUNS\n\n### \"Não tenho tempo agora\"\n> \"Entendo! A conversa é rápida, uns 20-30 minutos. Tenho horário [dia] às [hora] ou [dia] às [hora]. Algum desses encaixa?\"\n\n### \"Me manda mais informações por aqui\"\n> \"Claro! Mas assim, pra eu te passar informações que realmente façam sentido pro seu momento, o ideal é uma conversa rápida. O Milton consegue personalizar de acordo com seu perfil. Posso ver um horário?\"\n\n### \"Vou pensar\"\n> \"Tranquilo! Fica à vontade. Só te aviso que os horários estão bem disputados essa semana. Se quiser, já deixo reservado e qualquer coisa você me avisa. Pode ser?\"\n\n### \"Quanto custa pra começar na carreira?\"\n> \"Boa pergunta! O Milton passa os detalhes na reunião porque depende do estado onde você mora e do seu perfil. Posso agendar pra você tirar essa dúvida direto com ele?\"\n",
              "type": "string"
            },
            {
              "id": "7c1cec03-5b93-4741-a15c-01ccaade24de",
              "name": "origem",
              "value": "Prompt F3 - FUP",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5408,
        -48
      ],
      "id": "e2e9c303-dc41-475e-af5c-2dfed72597ce",
      "name": "Prompt F3 - followuper"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ativar-ia-check",
              "leftValue": "={{ $json.ativar_ia }}",
              "rightValue": "sim",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "80f34e52-b954-48d7-b92a-fb1c95652f9b",
              "leftValue": "={{ $json.etiquetas }}",
              "rightValue": "assistente-admin",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        784,
        400
      ],
      "id": "252949f5-9795-42f6-9d53-2af89a26d84e",
      "name": "IA Ativa?"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ !!$json.mensagem && !$json.mensagem.includes(\"The message could not be displayed\") }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "texto-check"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "imagem-check",
                    "leftValue": "={{ $json.photo_audio }}",
                    "rightValue": ".jpeg",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Imagem"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "audio-check",
                    "leftValue": "={{ $json.photo_audio }}",
                    "rightValue": ".mp4",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio/Video"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1024,
        368
      ],
      "id": "8f495ccb-3968-4c0a-9313-2f41d0cf9659",
      "name": "Tipo de mensagem"
    },
    {
      "parameters": {
        "jsCode": "// Contexto Inicial do Lead baseado em UTM\nconst input = $input.first().json.body;\n\nconst utmContent = input.contact?.attributionSource?.utmContent || '';\nconst messageBody = (input.message?.body || '').trim();\nconst isPrimeiraMensagem = !messageBody || messageBody === '' || messageBody === ' ';\n\nconst contextoPorUTM = {\n  'CARREIRA': {\n    contexto: 'Lead interessado em CARREIRA no mercado financeiro americano',\n    interesse: 'Oportunidades de carreira como agente de seguros nos EUA',\n    abordagem: 'Falar sobre licenciamento, ganhos, estrutura de trabalho'\n  },\n  'CONSULTORIA': {\n    contexto: 'Lead interessado em CONSULTORIA financeira pessoal',\n    interesse: 'Planejamento financeiro, proteção patrimonial, seguros',\n    abordagem: 'Falar sobre benefícios, proteção familiar, investimentos'\n  },\n  'INVESTIMENTO': {\n    contexto: 'Lead interessado em INVESTIMENTOS',\n    interesse: 'Opções de investimento e crescimento patrimonial',\n    abordagem: 'Falar sobre produtos financeiros, retornos, segurança'\n  }\n};\n\nlet tipoLead = '';\nfor (const tipo of Object.keys(contextoPorUTM)) {\n  if (utmContent.toUpperCase().includes(tipo)) {\n    tipoLead = tipo;\n    break;\n  }\n}\n\nlet mensagemContexto = '';\nlet contextoObj = null;\n\nif (isPrimeiraMensagem && tipoLead) {\n  contextoObj = contextoPorUTM[tipoLead];\n  mensagemContexto = `[CONTEXTO DO LEAD]\\nTipo: ${tipoLead}\\n${contextoObj.contexto}\\nInteresse principal: ${contextoObj.interesse}\\nAbordagem sugerida: ${contextoObj.abordagem}\\n\\nWork Permit: ${input['Work Permit'] || input.customData?.work_permit || 'Não informado'}\\nEstado: ${input['Estado onde mora'] || 'Não informado'}\\n`;\n}\n\nreturn {\n  json: {\n    body: input,\n    is_primeira_mensagem: isPrimeiraMensagem,\n    tem_contexto_utm: !!tipoLead,\n    tipo_lead: tipoLead || 'NAO_IDENTIFICADO',\n    utm_content: utmContent,\n    mensagem_contexto: mensagemContexto,\n    mensagem_original: messageBody,\n    work_permit: input['Work Permit'] || input.customData?.work_permit || '',\n    estado: input['Estado onde mora'] || '',\n    contexto_para_ai: isPrimeiraMensagem && contextoObj ? contextoObj : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        400
      ],
      "id": "70f7ba98-8b91-48f0-b1e8-bb9fee40082f",
      "name": "Contexto UTM"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar Nome do Lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\n\nlet nome = body.full_name || ((body.first_name || '') + ' ' + (body.last_name || '')).trim() || body.customData?.name || '';\nconst nomeOriginal = nome;\n\nnome = nome.replace(/\\d+/g, '').trim();\nnome = nome.replace(/[_\\-.@]/g, ' ').trim();\nnome = nome.replace(/([a-z])([A-Z])/g, '$1 $2');\n\nconst apelidosCurtos = ['lu', 'le', 'li', 'jo', 'ze', 'ma', 'mi', 'ju', 'du', 'bi', 'ca', 'ka', 'fe', 'be', 'ne', 're', 'ra', 'ro', 'vi', 'va', 'na', 'ni', 'ta', 'ti', 'la', 'lo', 'ed', 'el'];\n\nfunction separarApelidoSobrenome(str) {\n  if (str.includes(' ')) return str;\n  if (str.length <= 10) return str;\n  const lower = str.toLowerCase();\n  for (let len = 2; len <= 3; len++) {\n    const possivel = lower.slice(0, len);\n    if (apelidosCurtos.includes(possivel)) {\n      const resto = str.slice(len);\n      if (resto.length >= 4) return str.slice(0, len) + ' ' + resto;\n    }\n  }\n  return str;\n}\n\nnome = separarApelidoSobrenome(nome);\nnome = nome.replace(/\\s+/g, ' ').trim();\n\nfunction capitalizar(str) {\n  const preposicoes = ['de', 'da', 'do', 'das', 'dos', 'e'];\n  return str.toLowerCase().split(' ').map((palavra, i) => {\n    if (i > 0 && preposicoes.includes(palavra)) return palavra;\n    return palavra.charAt(0).toUpperCase() + palavra.slice(1);\n  }).join(' ');\n}\n\nlet partes = nome.split(' ').filter(p => p.length > 0);\nlet firstName = partes[0] || nome || '';\nlet lastName = partes.slice(1).join(' ') || '';\n\nfirstName = capitalizar(firstName);\nlastName = capitalizar(lastName);\n\nconst tinhaNumero = /\\d/.test(nomeOriginal);\nconst qualidade = (firstName.length < 2 || tinhaNumero) ? 'revisar' : 'ok';\n\nreturn {\n  json: {\n    ...inputData,\n    nome_original: nomeOriginal,\n    first_name: firstName,\n    last_name: lastName,\n    nome_completo: lastName ? `${firstName} ${lastName}` : firstName,\n    qualidade_nome: qualidade\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        400
      ],
      "id": "93aabf37-4d7b-4d3e-a079-388c7ddd4a3c",
      "name": "Normalizar Nome1"
    },
    {
      "parameters": {
        "jsCode": "// Normalizar dados do lead\nconst inputData = $input.first().json;\nconst body = inputData.body || {};\nconst customData = body.customData || {};\nconst tags = (body.tags || '').toLowerCase();\nconst utmContent = body.contact?.attributionSource?.utmContent || '';\n\n// === OBJETIVO DO LEAD ===\nlet objetivo_do_lead = customData.objetivodolead || '';\n\nif (!objetivo_do_lead) {\n  if (tags.includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (tags.includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else if (utmContent.toLowerCase().includes('consultoria')) {\n    objetivo_do_lead = 'consultoria';\n  } else if (utmContent.toLowerCase().includes('carreira')) {\n    objetivo_do_lead = 'carreira';\n  } else {\n    objetivo_do_lead = 'indefinido'; // ✅ Não assume mais 'carreira' como padrão\n  }\n}\n\n// === AGENTE IA ===\nlet agente_ia = customData.motive || '';\n\nif (!agente_ia) {\n  // Verifica tags específicas\n  if (tags.includes('closer')) {\n    agente_ia = 'closer';\n  } else if (tags.includes('followuper')) {\n    agente_ia = 'followuper';\n  } else if (objetivo_do_lead === 'consultoria') {\n    agente_ia = 'sdrconsultoria';\n  } else if (objetivo_do_lead === 'carreira') {\n    agente_ia = 'sdrcarreira';\n  } else {\n    agente_ia = 'indefinido'; // ✅ Leads sem classificação clara\n  }\n}\n// ✅ Se customData.motive vier com 'assistente_admin' ou 'assistente_interno', \n//    mantém o valor original\n\n// === ATIVAR IA ===\nlet ativar_ia = customData.ativar_ia || '';\n\nif (tags.includes('perdido')) {\n  ativar_ia = 'nao';\n} else if (utmContent) {\n  ativar_ia = 'sim';\n} else if (ativar_ia === 'sim' || tags.includes('ativar_ia')) {\n  ativar_ia = 'sim';\n} else {\n  ativar_ia = 'nao';\n}\n\nreturn {\n  json: {\n    ...inputData,\n    objetivo_do_lead,\n    agente_ia,\n    ativar_ia,\n    utm_content: utmContent,\n    tags_original: body.tags\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        400
      ],
      "id": "a5e02e4d-c09c-47c8-8bb0-9e16d4793d1a",
      "name": "Normalizar Dados1"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "contact_id",
              "value": "={{ $json.body.contact_id }}"
            },
            {
              "key": "location_name",
              "value": "={{ $json.body.location.name }}"
            },
            {
              "key": "agente_ia",
              "value": "={{ $json.agente_ia }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -144,
        400
      ],
      "id": "42858a50-1b80-4667-bac6-fdb5834ce2c2",
      "name": "Execution Data5"
    },
    {
      "parameters": {
        "jsCode": "const start = new Date();\nconst starttimeISO = start.toISOString();\nconst starttimeMs = start.getTime();\n\nconst end = new Date(start);\nend.setDate(end.getDate() + 7);\nconst endtimeISO = end.toISOString();\nconst endtimeMs = end.getTime();\n\nconst inputData = $input.first().json;\n\nreturn [{\n  json: {\n    ...inputData,\n    starttimeISO,\n    starttimeMs,\n    endtimeISO,\n    endtimeMs\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        400
      ],
      "id": "a58aa6de-838c-4231-a7a6-b95136655388",
      "name": "Code1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "734cd3ca-c411-46fe-8924-1ea800f80804",
              "name": "mensagem",
              "value": "={{ ($json.body?.message?.body || '').trim() || $json.mensagem_contexto || ($json.body?.customData?.message?.split(\"Instance Source:\")[0] ?? $json.body?.message?.content?.text ?? '').trim() }}",
              "type": "string"
            },
            {
              "id": "ccb3a74d-0336-4a28-9f43-7bdaff77b906",
              "name": "source",
              "value": "={{ $json.body?.contact?.attributionSource?.medium === \"instagram\" ? \"instagram\": \"whatsapp\" }}",
              "type": "string"
            },
            {
              "id": "332d6a13-10c8-465f-8ddb-fa97266f9fec",
              "name": "first_name",
              "value": "={{ $json.first_name }}",
              "type": "string"
            },
            {
              "id": "60cb5031-9132-4c86-9ab7-c487a170c9e3",
              "name": "last_name",
              "value": "={{ $json.last_name }}",
              "type": "string"
            },
            {
              "id": "9d4ae7a5-635b-4dbc-93d1-9464ace3208c",
              "name": "email",
              "value": "={{ $json.body?.email }}",
              "type": "string"
            },
            {
              "id": "d6301da3-de8a-45e3-9705-32cf65c3bf1e",
              "name": "telefone",
              "value": "={{ $json.body?.customData?.phone }}",
              "type": "string"
            },
            {
              "id": "7e094af2-d305-42ba-b6d2-014b62231ebb",
              "name": "datetime",
              "value": "={{ $json.body?.date_created }}",
              "type": "string"
            },
            {
              "id": "f3471b65-9533-4f5c-a669-60aaf549b4e8",
              "name": "process_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "257ef1e2-26bb-461e-8335-3d1101d3cda6",
              "name": "owner_origin",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "1e235f54-27cf-4b91-b156-1c0a69149370",
              "name": "owner_id",
              "value": "=cmcprclas0000syak01gtgj80",
              "type": "string"
            },
            {
              "id": "5041121e-02b1-4993-ad9c-34131a44b08d",
              "name": "timezone_do_lead",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "367c6400-fd93-4f50-a09b-b2d56aea0bd9",
              "name": "lead_id",
              "value": "={{ $json.body?.contact_id }}",
              "type": "string"
            },
            {
              "id": "66a3f763-5dbe-4033-abd7-3079835a035a",
              "name": "mensagem_id",
              "value": "={{ $json.starttimeMs }}",
              "type": "string"
            },
            {
              "id": "110eb8f6-d0b2-4358-a002-3741abbcfeb7",
              "name": "workflow_id",
              "value": "={{ $workflow.id }}",
              "type": "string"
            },
            {
              "id": "ab843596-5dfa-41d7-8ac4-02cd1dd5b661",
              "name": "api_key",
              "value": "={{ $json.body?.customData?.ghl_api_key }}",
              "type": "string"
            },
            {
              "id": "8be8461d-83f1-4563-9e2e-46e978d3afb4",
              "name": "location_id",
              "value": "={{ $json.body?.location?.id }}",
              "type": "string"
            },
            {
              "id": "3df2e105-88b1-4d12-b957-6b5d909056be",
              "name": "tipo",
              "value": "={{ $json.body?.customData?.tipo }}",
              "type": "string"
            },
            {
              "id": "d1fa8d84-c23b-4292-86bc-2066e14c7882",
              "name": "calendarID_carreira",
              "value": "={{ $json.body?.customData?.calendar_id_carreira }}",
              "type": "string"
            },
            {
              "id": "cca7fe8b-af83-40c1-ba8b-d4de7cd21c47",
              "name": "calendarID_consultoria_financeira",
              "value": "={{ $json.body?.customData?.consultoria_financeira }}",
              "type": "string"
            },
            {
              "id": "dad6c1f3-82b2-45ea-b3be-c512a879ac98",
              "name": "origem_teste",
              "value": "Marcos Danielss",
              "type": "string"
            },
            {
              "id": "3038f1ef-1199-4aab-9354-dc9463c775de",
              "name": "etiquetas",
              "value": "={{ $json.body?.tags }}",
              "type": "string"
            },
            {
              "id": "4100931a-e49b-4b97-8a16-7a797b67899e",
              "name": "area_de_atuacao",
              "value": "={{ $json.body?.['Qual a sua área de atuação?']?.[0] }}",
              "type": "string"
            },
            {
              "id": "4ed525e0-9bb6-4663-980a-70a10db813d4",
              "name": "idade",
              "value": "={{ $json.body?.Idade }}",
              "type": "string"
            },
            {
              "id": "b14c96ea-7093-48b6-add5-dd0159af29cd",
              "name": "instagram",
              "value": "={{ $json.body?.Instagram }}",
              "type": "string"
            },
            {
              "id": "9d450e98-e0e3-48fb-bb77-41c6d701f227",
              "name": "modelo_de_atuacao",
              "value": "={{ $json.body?.['Modelo de atuação'] }}",
              "type": "string"
            },
            {
              "id": "69b88a48-6d28-42b1-8ff4-5120e516f348",
              "name": "faturamento_medio",
              "value": "={{ $json.body?.['Faturamento médio'] }}",
              "type": "string"
            },
            {
              "id": "35274cdc-7a80-4945-9296-5d74db32aff2",
              "name": "investimento",
              "value": "={{ $json.body?.Investimento }}",
              "type": "string"
            },
            {
              "id": "247f2856-13b1-4bc4-bb55-cf7842680459",
              "name": "event_chat",
              "value": "={{ $json.body?.event?.Info?.Chat }}",
              "type": "string"
            },
            {
              "id": "dda2ed54-8e91-41e2-92c9-1b2d12763e2b",
              "name": "event_is_group",
              "value": "={{ $json.body?.event?.Info?.IsGroup }}",
              "type": "boolean"
            },
            {
              "id": "b9e46b5c-3fb8-4be2-bb9e-71080728bd85",
              "name": "video_ads_url",
              "value": "={{ $json.body?.contact?.attributionSource?.videoUrl }}",
              "type": "string"
            },
            {
              "id": "16308ff3-20b3-4fd4-b126-21c34248530b",
              "name": "time_zone_do_agente",
              "value": "={{ $json.body?.customData?.timezone }}",
              "type": "string"
            },
            {
              "id": "2566e00f-ecfd-44e8-bab2-7d68447e3b9a",
              "name": "historia_do_usuario",
              "value": "={{ $json.body?.customData?.minha_historias }}",
              "type": "string"
            },
            {
              "id": "391cb65e-46a0-475b-8c42-3629883ad983",
              "name": "usuario_responsavel",
              "value": "={{ $json.body?.user?.firstName }} {{ $json.body?.user?.lastName }}",
              "type": "string"
            },
            {
              "id": "1cd51504-1dc9-4aea-956a-9a4757db1b6c",
              "name": "photo_audio",
              "value": "={{ $json.body?.customData?.photo_audio }}",
              "type": "string"
            },
            {
              "id": "77c42ca4-2ef7-4a40-b1ed-2fc5e8af7292",
              "name": "fonte_do_lead_bposs",
              "value": "={{ $json.body?.customData?.fonte_do_lead_bposs }}",
              "type": "string"
            },
            {
              "id": "a976a2ec-ed9f-452b-91d1-5725631ae2d5",
              "name": "quebra_de_objecoes_geral",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_geral }}",
              "type": "string"
            },
            {
              "id": "cc085a35-fef6-47b9-ad97-e9d671a71d29",
              "name": "quebra_de_objecoes_carreira",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_carreira }}",
              "type": "string"
            },
            {
              "id": "8f3c6a4d-df4f-4de7-ad41-0177eb567ed4",
              "name": "quebra_de_objecoes_consultoria",
              "value": "={{ $json.body?.customData?.quebra_de_objecoes_consultoria }}",
              "type": "string"
            },
            {
              "id": "03c2a02f-e2c2-4d42-afe3-3d6b7bfae375",
              "name": "tipos_work_permit_permitidos",
              "value": "={{ $json.body?.customData?.estruturas_work_permit }}",
              "type": "string"
            },
            {
              "id": "2d89fd62-be99-4c63-9bf9-c2b97c0cc735",
              "name": "link_do_zoom",
              "value": "={{ $json.body?.customData?.link_do_zoom }}",
              "type": "string"
            },
            {
              "id": "939d130d-8780-41e6-9693-10b83cd9bab5",
              "name": "agendamento_duracao_minutos",
              "value": "30",
              "type": "string"
            },
            {
              "id": "c9a26bfa-ced7-4b82-a6bb-2c0aeb46f9a3",
              "name": "cobranca_valor",
              "value": "500",
              "type": "string"
            },
            {
              "id": "9290e4ff-d01b-4fca-b5f3-7605d4f74c07",
              "name": "id_conversa_alerta",
              "value": "skfa6JP6lLlAXkc8FfIp",
              "type": "string"
            },
            {
              "id": "c594a0f2-aba9-458c-92ff-81e73086416c",
              "name": "url_asaas",
              "value": "https://api-sandbox.asaas.com",
              "type": "string"
            },
            {
              "id": "103fad86-a8b6-4591-b310-2dc7069bc189",
              "name": "etapa_funil",
              "value": "={{ $json.body?.customData?.etapa_funil }}",
              "type": "string"
            },
            {
              "id": "3ae92580-436d-4dfc-a7cc-f83f8f68309e",
              "name": "full_name",
              "value": "={{ $json.nome_completo }}",
              "type": "string"
            },
            {
              "id": "5476f99e-273b-45a1-996f-b98cb86ddd25",
              "name": "work_permit",
              "value": "={{ $json.body?.customData?.work_permit }}",
              "type": "string"
            },
            {
              "id": "989fb582-9e56-4962-8883-6076627c72b5",
              "name": "state",
              "value": "={{ $json.body?.customData?.state }}",
              "type": "string"
            },
            {
              "id": "15265189-0d84-420c-b7da-6181170a6b08",
              "name": "location_name",
              "value": "={{ $json.body?.location?.name }}",
              "type": "string"
            },
            {
              "id": "5770d76c-1a0f-4515-9683-381881715eb5",
              "name": "resposta_ia",
              "value": "={{ $json.body?.['Resposta IA'] }}",
              "type": "string"
            },
            {
              "id": "b1871710-95d0-495d-9592-ff09ea8ab983",
              "name": "objetivo_do_lead",
              "value": "={{ $json.objetivo_do_lead }}",
              "type": "string"
            },
            {
              "id": "5a729725-994d-46e5-a6f1-aac7b9504a3a",
              "name": "ativar_ia",
              "value": "={{ $json.ativar_ia }}",
              "type": "string"
            },
            {
              "id": "5e293330-4c28-4ae8-92ef-e99bc9feb55e",
              "name": "utm_content",
              "value": "={{ $json.utm_content }}",
              "type": "string"
            },
            {
              "id": "7d94c551-b241-48e8-84e8-9ab152f6a526",
              "name": "agente_ia",
              "value": "={{ $json.agente_ia }}",
              "type": "string"
            },
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "name": "mensagem_contexto",
              "value": "={{ $json.mensagem_contexto }}",
              "type": "string"
            },
            {
              "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
              "name": "is_primeira_mensagem",
              "value": "={{ $json.is_primeira_mensagem }}",
              "type": "boolean"
            },
            {
              "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
              "name": "tipo_lead",
              "value": "={{ $json.tipo_lead }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        304,
        400
      ],
      "id": "4414e7cd-e49e-49c3-b532-159c38dd910c",
      "name": "Info"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt-rescheduler-main",
              "name": "prompt",
              "value": "=## PAPEL\nSDR Isabella - Modo REAGENDAMENTO/RECUPERACAO DE NO-SHOW\n\nO lead deu NO-SHOW ou foi marcado para reagendamento (TAG: reagendar). Sua missao:\n1. Descobrir o motivo do no-show (sem pressao, com empatia)\n2. Quebrar objecao se houver\n3. Reagendar com urgencia/escassez\n\n## PERSONALIDADE\n- Max 120 caracteres (exceto discovery e reversao de objecao)\n- Tom casual: vc, ta, pra, to, q, tb\n- Sem dois pontos (:)\n- Emojis estrategicos: apenas para empatia (1-2 max)\n- Use nome do cliente de forma natural\n- Formato AM/PM para horarios\n\n---\n\n## SOP - PROCEDIMENTO OPERACIONAL\n\n### ETAPA 1: ABERTURA EMPATICA (primeira mensagem - JA ENVIADA)\nA primeira mensagem ja foi enviada automaticamente:\n\"Oi [nome], aqui e a Isabella! Vi que nao deu pra vc vir na reuniao. Tudo certo por ai?\"\n\nAgora AGUARDE a resposta do lead e siga para ETAPA 2.\n\n---\n\n### ETAPA 2: DISCOVERY DA OBJECAO REAL\n\nApos lead responder, identifique a categoria:\n\n**A) CONFLITO DE AGENDA / IMPREVISTO**\n\"Entendo perfeitamente. Imprevistos acontecem.\nOlha, tenho um horario alternativo que talvez encaixe melhor.\n[Usar Busca_disponibilidade - ofereca 1 dia + 2 horarios]\nQual dos dois funciona melhor?\"\n\n**B) DUVIDA SOBRE A OPORTUNIDADE**\n\"Otimo que vc falou isso. Duvida e sinal de interesse, so precisa de clareza.\nMe diz: qual foi o ponto especifico que te deixou em duvida?\"\n[AGUARDE resposta - depois ofereca esclarecimento e reagendamento]\n\n**C) REPENSOU / NAO E PRA ELE**\n\"Entendo. Posso te perguntar: o que especificamente te fez pensar isso?\"\n[AGUARDE resposta - depois use reversao de crenca]\n\"Olha, a reuniao nao e pra todo mundo. Mas e pra quem quer pelo menos ENTENDER as opcoes.\nQue tal 30min so pra tirar duvidas, sem compromisso?\"\n\n**D) QUESTAO FINANCEIRA**\n\"Entendo. Momento ta dificil mesmo.\nDeixa eu perguntar: 'nao ter condicoes agora' significa que em 30-60 dias melhora ou e mais longo?\"\n[Se curto prazo: ofereca reuniao gratuita para entender opcoes]\n[Se longo prazo: mova para nutricao com gentileza]\n\n---\n\n### ETAPA 3: REAGENDAMENTO\n\nApos identificar e tratar objecao:\n\n1. Use Busca_disponibilidade SEMPRE antes de oferecer horario\n2. Ofereca 1 dia + 2 horarios com escassez:\n   \"Consegui um encaixe especial pra vc. Tenho [dia] as [hora1] ou [hora2]. Qual funciona?\"\n3. Confirme dados (whatsapp, email) se necessario\n4. Use Agendar_reuniao apos confirmacao\n5. Confirme envio e remova tag reagendar\n\n---\n\n### SE NAO RESPONDER (apos 24h - via Follow Up Eterno)\n\n\"[nome], so pra vc ter ideia do que ficou faltando:\n\nCom [responsavel] vc ia descobrir:\n- Como proteger sua familia financeiramente\n- Opcoes que funcionam pro seu momento\n- Plano personalizado pro seu caso\n\nConsegui te reencaixar pra [dia] as [hora].\nQuer garantir ou prefere que eu libere pra lista de espera?\"\n\n---\n\n## LIMITE DE TENTATIVAS\n\nMaximo 3 tentativas de recuperacao. Apos 3 tentativas sem sucesso:\n\"[nome], entendo que nao e o momento.\nVou te adicionar na lista de conteudos. Se fizer sentido no futuro, e so chamar.\"\n[Usar Atualizar_lead_perdido com motivo 'No-Show - 3 tentativas']\n\n---\n\n## FERRAMENTAS\n\n**Busca_disponibilidade**: SEMPRE antes de oferecer horario\n**Agendar_reuniao**: Apos confirmacao explicita do lead\n**Atualizar_lead**: Apos cada acao importante\n**Atualizar_lead_perdido**: Apos 3 tentativas sem sucesso (status 143)\n**Agendar_follow_up**: Para proxima tentativa se nao responder\n\n---\n\n## CASOS ESPECIAIS\n\n### Lead Hostil\n\"Entendo sua frustracao. Vou te remover agora. Desculpa o transtorno.\"\n\n### Ja Agendou por Outro Meio\n\"Vi que ja tem reuniao marcada! Desculpa a confusao.\"\n\n### Confirmou que Vai\n\"Perfeito! Te espero la entao. Qualquer coisa me avisa.\"",
              "type": "string"
            },
            {
              "id": "origem-rescheduler-main",
              "name": "origem",
              "value": "Reagendamento - No Show (TAG)",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5424,
        896
      ],
      "id": "68b1074d-b3fc-4372-8cca-99cb8126a8dc",
      "name": "Prompt Reagendamento - No Show1",
      "notes": "Este prompt e usado quando o lead responde apos receber a mensagem inicial de reagendamento"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "GWKl5KuXAdeu4BLr",
          "mode": "list",
          "cachedResultUrl": "/workflow/GWKl5KuXAdeu4BLr",
          "cachedResultName": "Registrar Custo IA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "location_id": "={{ $('Info').first().json.location_id }}",
            "location_name": "={{ $('Info').first().json.location_name }}",
            "contact_id": "={{ $json.session_id }}",
            "contact_name": "={{ $('Info').first().json.first_name }}",
            "modelo_ia": "gemini-2.5-pro",
            "tokens_input": "={{ $('SDR2').first().json.tokenUsage?.promptTokens ?? $('SDR2').first().json.usage?.promptTokens ?? 0 }}",
            "tokens_output": "={{ $('SDR2').first().json.tokenUsage?.completionTokens ?? $('SDR2').first().json.usage?.completionTokens ?? 0 }}",
            "canal": "={{ $('Info').first().json.source }}",
            "tipo_acao": "Agendar",
            "mensagem_saida": "={{ $('Info').first().json.mensagem }}",
            "parent_workflow_id": "={{ $workflow.id }}",
            "parent_workflow_name": "={{ $workflow.name }}",
            "parent_execution_id": "={{ $execution.id }}",
            "mensagem_entrada": "={{ $('Info').first().json.etiquetas }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "location_name",
              "displayName": "location_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_id",
              "displayName": "contact_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "contact_name",
              "displayName": "contact_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "modelo_ia",
              "displayName": "modelo_ia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tokens_input",
              "displayName": "tokens_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number"
            },
            {
              "id": "tokens_output",
              "displayName": "tokens_output",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number"
            },
            {
              "id": "canal",
              "displayName": "canal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "tipo_acao",
              "displayName": "tipo_acao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "mensagem_entrada",
              "displayName": "mensagem_entrada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "mensagem_saida",
              "displayName": "mensagem_saida",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "parent_workflow_id",
              "displayName": "parent_workflow_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "parent_workflow_name",
              "displayName": "parent_workflow_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "parent_execution_id",
              "displayName": "parent_execution_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        10272,
        48
      ],
      "id": "499c8db9-4206-4c42-9f22-5307b3b8b46e",
      "name": "Call Track AI Cost",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "RWIFCp2Jw3eajc2v",
          "mode": "list",
          "cachedResultUrl": "/workflow/RWIFCp2Jw3eajc2v",
          "cachedResultName": "4. Assistente-adm - Mottivme Sales"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "nome_split_firstItem": "={{ $('Info').first().json.nome.split(' ')[0] }}",
            "agente_ia_firstItem": "={{ $('Info').first().json.agente_ia }}",
            "mensagem": "={{ $('Set mensagens').first().json.mensagem }}",
            "output_preview_firstItem": "={{ $('Set mensagens').first().json.output_preview }}",
            "whatsapp_firstItem": "={{ $('Info').first().json.telefone }}",
            "email_firstItem": "={{ $('Info').first().json.email }}",
            "responsavel_firstItem": "={{ $('Info').first().json.usuario_responsavel }}",
            "chat_id_firstItem": "={{ $('Info').first().json.mensagem_id }}",
            "lead_id_firstItem": "={{ $('Info').first().json.lead_id }}",
            "nome_firstItem": "={{ $('Info').first().json.first_name }}",
            "mensagens_antigas_firstitem": "={{ $('Set mensagens').first().json.mensagens_antigas }}",
            "calendarID": "={{ $('Info').first().json.calendarID }}",
            "API_KEY": "={{ $('Info').first().json.api_key }}",
            "location_id": "={{ $('Info').first().json.location_id }}",
            "motive": "={{ $('Info').first().json.agente_ia }}"
          },
          "matchingColumns": [
            "nome_split_firstItem",
            "agente_ia_firstItem",
            "mensagem",
            "estado_onde_mora_firstItem",
            "output_preview_firstItem",
            "work_permit_firstItem",
            "_embedded_contacts_firstItem",
            "whatsapp_firstItem",
            "Info_estado_onde_mora_firstItem",
            "email_firstItem",
            "_embedded_leads_firstItem",
            "responsavel_firstItem",
            "pergunta_0_firstItem",
            "pergunta_1_firstItem",
            "pergunta_2_firstItem",
            "pergunta_3_firstItem",
            "pergunta_4_firstItem",
            "chat_id_firstItem",
            "lead_id_firstItem",
            "nome_firstItem",
            "_firstItem"
          ],
          "schema": [
            {
              "id": "nome_split_firstItem",
              "displayName": "nome_split_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "agente_ia_firstItem",
              "displayName": "agente_ia_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "output_preview_firstItem",
              "displayName": "output_preview_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "_embedded_contacts_firstItem",
              "displayName": "_embedded_contacts_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "whatsapp_firstItem",
              "displayName": "whatsapp_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email_firstItem",
              "displayName": "email_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "_embedded_leads_firstItem",
              "displayName": "_embedded_leads_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "responsavel_firstItem",
              "displayName": "responsavel_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "chat_id_firstItem",
              "displayName": "chat_id_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_id_firstItem",
              "displayName": "lead_id_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nome_firstItem",
              "displayName": "nome_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "mensagens_antigas_firstitem",
              "displayName": "mensagens_antigas_firstitem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "calendarID",
              "displayName": "calendarID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location_id",
              "displayName": "location_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "API_KEY",
              "displayName": "API_KEY",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "motive",
              "displayName": "motive",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        5440,
        1296
      ],
      "name": "4. Agente Financeiro IA - BPO",
      "id": "9c81f9c0-2a57-479a-8f72-e79f10125c6c"
    }
  ],
  "pinData": {},
  "connections": {
    "Mensagem recebida": {
      "main": [
        [
          {
            "node": "Contexto UTM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetInfo": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar registro de Atividade - alan",
            "type": "main",
            "index": 0
          },
          {
            "node": "Salvar registro de Atividade - marcos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Tipo de mensagem1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [
          {
            "node": "Memoria IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "no.op": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal": {
      "main": [
        [
          {
            "node": "Whatsapp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram": {
      "main": [
        [
          {
            "node": "1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp": {
      "main": [
        [
          {
            "node": "1.5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1.5s": {
      "main": [
        [
          {
            "node": "no.op",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de IA": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adicionar_tag_perdido": {
      "ai_tool": [
        [
          {
            "node": "SDR2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Prompt F3 - followuper1",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "PROMPT VALIDADO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "PROMPT VALIDADO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prompt Reagendamento - No Show1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "4. Agente Financeiro IA - BPO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prompt F3 - followuper1": {
      "main": [
        [
          {
            "node": "SDR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini2": {
      "ai_languageModel": [
        [
          {
            "node": "SDR2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "SDR2",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Think1": {
      "ai_tool": [
        [
          {
            "node": "SDR2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Busca_disponibilidade": {
      "ai_tool": [
        [
          {
            "node": "SDR2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agendar_reuniao": {
      "ai_tool": [
        [
          {
            "node": "SDR2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Work Permit": {
      "ai_tool": [
        [
          {
            "node": "SDR2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Profissão": {
      "ai_tool": [
        [
          {
            "node": "SDR2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tudo certo?3": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SDR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Estado": {
      "ai_tool": [
        [
          {
            "node": "SDR2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem encavalada?": {
      "main": [
        [
          {
            "node": "Limpar fila de mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar mensagens": {
      "main": [
        [
          {
            "node": "Form Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar fila de mensagens": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar": {
      "main": [
        [
          {
            "node": "Buscar mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar mensagem.": {
      "main": [
        [
          {
            "node": "Esperar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download áudio": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever audio": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Transcrever audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Form Mensagem": {
      "main": [
        [
          {
            "node": "Mensagem encavalada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Permitido AI?": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa Ativa": {
      "main": [
        [
          {
            "node": "Ação Planejada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ação Planejada": {
      "main": [
        [
          {
            "node": "Permitido AI?",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Salvar Espera",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Espera": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Salvar Inicio IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Imagem ou audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem ou audio": {
      "main": [
        [
          {
            "node": "Conversa Ativa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de mensagem1": {
      "main": [
        [
          {
            "node": "Conversa ativa atualizada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Parser  Chain",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Deve enviar mensagem?": {
      "main": [
        [
          {
            "node": "Parser  Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa ativa atualizada": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Atualizar resposta IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Termino de resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Termino de resposta": {
      "main": [
        [
          {
            "node": "Parser  Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar resposta IA": {
      "main": [
        [
          {
            "node": "Deve enviar mensagem?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Execution Data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser  Chain": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Parser  Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data2": {
      "main": [
        [
          {
            "node": "Segmentos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Segmentos1": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria IA": {
      "main": [
        [
          {
            "node": "Execution Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set mensagens": {
      "main": [
        [
          {
            "node": "Tipo de IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria Lead": {
      "main": [
        [
          {
            "node": "Deduplica Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplica Mensagens": {
      "main": [
        [
          {
            "node": "Set mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem anteriores": {
      "main": [
        [
          {
            "node": "Preparar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca historias": {
      "ai_tool": [
        [
          {
            "node": "SDR2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Search Contact": {
      "main": [
        [
          {
            "node": "GetInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SDR2": {
      "main": [
        [
          {
            "node": "Tudo certo?3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "historico_mensagens_leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "historico_mensagens_leads": {
      "main": [
        []
      ]
    },
    "PROMPT VALIDADO": {
      "main": [
        [
          {
            "node": "SDR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Inicio IA": {
      "main": [
        [
          {
            "node": "Mensagem anteriores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Prompt F3 - followuper",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Prompt F2 - Funil Tráfego Carreira1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prompt - F2 - Funil Tráfego Consultoria1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prompt - F2 - Funil Tráfego Consultoria1": {
      "main": [
        [
          {
            "node": "SDR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prompt F2 - Funil Tráfego Carreira1": {
      "main": [
        [
          {
            "node": "SDR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Mensagem": {
      "main": [
        [
          {
            "node": "Memoria Lead",
            "type": "main",
            "index": 0
          },
          {
            "node": "Memoria Lead1 - Marcos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prompt F3 - followuper": {
      "main": [
        [
          {
            "node": "SDR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data1": {
      "main": [
        [
          {
            "node": "Memoria IA1 - Marcos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA Ativa?": {
      "main": [
        [
          {
            "node": "Tipo de mensagem",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Tipo de mensagem": {
      "main": [
        [
          {
            "node": "Enfileirar mensagem.",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download áudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contexto UTM": {
      "main": [
        [
          {
            "node": "Normalizar Nome1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Nome1": {
      "main": [
        [
          {
            "node": "Normalizar Dados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Dados1": {
      "main": [
        [
          {
            "node": "Execution Data5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data5": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Search Contact",
            "type": "main",
            "index": 0
          },
          {
            "node": "IA Ativa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prompt Reagendamento - No Show1": {
      "main": [
        [
          {
            "node": "SDR2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memoria IA1 - Marcos": {
      "main": [
        [
          {
            "node": "Call Track AI Cost",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. Agente Financeiro IA - BPO": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/New_York",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "dc997aeb-c182-44f7-9ca6-86936cd8e672",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "wK2rtvWCx394Z9Xu",
  "tags": [
    {
      "updatedAt": "2025-06-20T13:58:36.168Z",
      "createdAt": "2025-06-20T13:58:36.168Z",
      "id": "kEruuvE7z6URbdVG",
      "name": "Marcos-Daniel"
    }
  ]
}