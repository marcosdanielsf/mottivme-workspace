{
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://bfumywvwubvernvhjehk.supabase.co/rest/v1/rpc/get_expert_data",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ p_project_id: $json.body.project_id }) }}"
      },
      "id": "a1b2c3d4-e5f6-4789-http-111111111111",
      "name": "üìñ Get Expert Data (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [620, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extrai os dados do resultado da API\nconst data = $input.first().json;\n\nconst project = data.project || {};\nconst briefing = data.briefing || {};\nconst clone = data.clone || {};\nconst offers = data.offers || {};\n\nfunction getValue(obj, field) {\n  if (!obj || !obj[field]) return null;\n  if (obj[field] === '') return null;\n  return obj[field];\n}\n\nfunction formatSection(title, content) {\n  if (!content || (typeof content === 'string' && content.trim() === '')) return '';\n  if (typeof content === 'object') content = JSON.stringify(content, null, 2);\n  return `\\n### ${title}\\n${content}\\n`;\n}\n\nlet context = `# üß¨ PERFIL COMPLETO DO EXPERT\\n`;\ncontext += `Este √© o perfil detalhado extra√≠do do briefing e dados do projeto.\\n`;\ncontext += `\\n---\\n`;\n\ncontext += `\\n## üìã DADOS B√ÅSICOS DO EXPERT\\n`;\ncontext += `\\n**Nome:** ${project.name || 'N√£o informado'}\\n`;\ncontext += `**Nicho:** ${getValue(briefing, 'nicho') || 'N√£o informado'}\\n`;\ncontext += `**Produto:** ${getValue(briefing, 'produto') || 'N√£o informado'}\\n`;\n\ncontext += `\\n---\\n`;\ncontext += `\\n## üéØ BRIEFING\\n`;\ncontext += formatSection('Avatar/P√∫blico-Alvo', getValue(briefing, 'avatar_descricao'));\ncontext += formatSection('Dor Principal', getValue(briefing, 'dor_principal'));\ncontext += formatSection('Desejo Principal', getValue(briefing, 'desejo_principal'));\ncontext += formatSection('Transforma√ß√£o Prometida', getValue(briefing, 'transformacao'));\ncontext += formatSection('Diferencial', getValue(briefing, 'diferencial'));\ncontext += formatSection('Ticket M√©dio', getValue(briefing, 'ticket_medio'));\ncontext += formatSection('Tipo de Funil', getValue(briefing, 'tipo_funil'));\ncontext += formatSection('Tom de Comunica√ß√£o', getValue(briefing, 'tom_comunicacao'));\n\nif (clone && clone.system_prompt) {\n  context += `\\n---\\n`;\n  context += `\\n## üß¨ CLONE SYSTEM PROMPT (EXISTENTE)\\n`;\n  context += `\\n\\`\\`\\`\\n${clone.system_prompt}\\n\\`\\`\\`\\n`;\n}\n\nif (clone && clone.dna_psicologico) {\n  context += formatSection('DNA Psicol√≥gico', clone.dna_psicologico);\n}\n\nif (clone && clone.engenharia_reversa) {\n  context += formatSection('Engenharia Reversa', clone.engenharia_reversa);\n}\n\nif (clone && clone.sintese_estrategica) {\n  context += `\\n---\\n`;\n  context += `\\n## üìä POSICIONAMENTO ESTRAT√âGICO\\n`;\n  context += formatSection('S√≠ntese Estrat√©gica', clone.sintese_estrategica);\n  context += formatSection('An√°lise de Concorrentes', clone.analise_concorrentes);\n}\n\nif (offers && offers.avatar) {\n  context += `\\n---\\n`;\n  context += `\\n## üí∞ ECOSSISTEMA DE OFERTAS\\n`;\n  context += formatSection('Avatar Detalhado', offers.avatar);\n  context += formatSection('Promessas', offers.promessas);\n  context += formatSection('Big Idea', offers.big_idea);\n  context += formatSection('High Ticket', offers.high_ticket);\n  context += formatSection('Frontend', offers.frontend);\n}\n\ncontext += `\\n---\\n`;\ncontext += `\\n*Contexto gerado automaticamente a partir do Supabase.*\\n`;\n\nreturn [{\n  json: {\n    expert_context: context,\n    expert_name: project.name,\n    expert_id: project.id,\n    project_id: project.id,\n    nicho: getValue(briefing, 'nicho'),\n    clone_system_prompt: clone?.system_prompt || null,\n    has_clone: !!clone?.system_prompt,\n    has_posicionamento: !!clone?.sintese_estrategica,\n    has_ofertas: !!offers?.avatar,\n    context_length: context.length,\n    timestamp: new Date().toISOString(),\n    _project: project,\n    _briefing: briefing,\n    _clone: clone,\n    _offers: offers\n  }\n}];"
      },
      "id": "a1b2c3d4-e5f6-4789-http-222222222222",
      "name": "üîÑ Transform Expert Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 300]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://bfumywvwubvernvhjehk.supabase.co/rest/v1/clone_experts?project_id=eq.{{ $json.project_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  dna_psicologico: $('1. Agent 1: DNA Psicol√≥gico1').item.json.output,\n  engenharia_reversa: $('2. Agent 2: Engenheiro Reverso2').item.json.output,\n  configuracao_clone: $('3. Agent 3: Configurador1').item.json.output,\n  system_prompt: $json.output,\n  status: 'ready'\n}) }}"
      },
      "id": "a1b2c3d4-e5f6-4789-http-333333333333",
      "name": "üíæ Update Clone - FASE 1A (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://bfumywvwubvernvhjehk.supabase.co/rest/v1/clone_experts?project_id=eq.{{ $json.project_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  analise_concorrentes: $('5. Agent 5: Identity Mapper').item.json.text,\n  concorrentes_internacionais: $('6A. Perplexity Internacional').item.json.choices[0].message.content,\n  concorrentes_brasileiros: $('6B. Perplexity Brasil').item.json.choices[0].message.content,\n  sintese_estrategica: $('6C. Synthesis and Strategic Analysis').item.json.text\n}) }}"
      },
      "id": "a1b2c3d4-e5f6-4789-http-444444444444",
      "name": "üíæ Update Posicionamento - FASE 1B (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 500],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bfumywvwubvernvhjehk.supabase.co/rest/v1/offers",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  project_id: $json.project_id,\n  avatar: $('7. Agent: Avatar Creator').item.json.text,\n  avatar_detalhado: $('7B. Agent: Avatar Detalhado').item.json.text,\n  promessas: $('8. Agent: Promise Generator').item.json.text,\n  big_idea: $('9. Agent: Big Idea Creator').item.json.text,\n  mecanismo_unico: $('9B. Agent: Mecanismo √önico').item.json.text,\n  high_ticket: $json['High Ticket Ofertas - IA'],\n  mid_ticket: $json['Back End Ofertas - IA'],\n  frontend: $json['Ofertas Front End - IA'],\n  status: 'ready'\n}) }}"
      },
      "id": "a1b2c3d4-e5f6-4789-http-555555555555",
      "name": "üíæ Upsert Offers - FASE 2 (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 700],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bfumywvwubvernvhjehk.supabase.co/rest/v1/contents",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  project_id: $json.project_id,\n  type: 'reel',\n  title: $json.title || 'Reel gerado',\n  body: $json.script || $json.content,\n  hook: $json.hook,\n  cta: $json.cta,\n  generated_by: 'generateMarketingeGeracaodeDemanda',\n  status: 'draft'\n}) }}"
      },
      "id": "a1b2c3d4-e5f6-4789-http-666666666666",
      "name": "üíæ Insert Content - Reel (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 900],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bfumywvwubvernvhjehk.supabase.co/rest/v1/contents",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  project_id: $json.project_id,\n  type: 'carousel',\n  title: $json.title || 'Carrossel gerado',\n  body: $json.script || $json.content,\n  hook: $json.hook,\n  cta: $json.cta,\n  generated_by: 'generateMarketingeGeracaodeDemanda',\n  status: 'draft'\n}) }}"
      },
      "id": "a1b2c3d4-e5f6-4789-http-777777777777",
      "name": "üíæ Insert Content - Carrossel (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 1100],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bfumywvwubvernvhjehk.supabase.co/rest/v1/contents",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  project_id: $json.project_id,\n  type: 'story',\n  title: $json.title || 'Story gerado',\n  body: $json.script || $json.content,\n  hook: $json.hook,\n  cta: $json.cta,\n  generated_by: 'generateMarketingeGeracaodeDemanda',\n  status: 'draft'\n}) }}"
      },
      "id": "a1b2c3d4-e5f6-4789-http-888888888888",
      "name": "üíæ Insert Content - Stories (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 1300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase API"
        }
      }
    }
  ],
  "connections": {
    "üìñ Get Expert Data (HTTP)": {
      "main": [
        [
          {
            "node": "üîÑ Transform Expert Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
