{
  "name": "[ GHL ] Follow Up Eterno",
  "nodes": [
    {
      "parameters": {
        "content": "# Workflow Follow Up Eterno - Go High Level\n\n## Configura√ß√£o Necess√°ria\n\n### 1. Vari√°veis de Ambiente (n8n)\nConfigure no n8n:\n- `GHL_API_KEY`: Sua API key do Go High Level\n- `GHL_LOCATION_ID`: ID da sua localiza√ß√£o no GHL\n\n### 2. Campos Customizados do GHL\nCertifique-se de ter estes campos criados no GHL:\n- `pergunta_0`, `pergunta_1`, `pergunta_2`, `pergunta_3`, `pergunta_4`\n- `fonte_do_lead_bposs`\n- `funil`\n- `fluxo_vs`\n- `fonte`\n- `data_hora_agendamento`\n- `ativar_desativar_ia`\n- `mensagem_fup`\n- `controle_fup`\n- `controle_fup_datahora`\n\n### 3. Webhook (Opcional)\nSe quiser usar webhook para eventos em tempo real:\n- Configure um webhook no GHL apontando para a URL do webhook deste workflow\n- Eventos recomendados: contact.update, message.received\n\n### 4. Banco de Dados\n- O workflow usa PostgreSQL para rastreamento\n- Certifique-se de que as credenciais est√£o configuradas\n- Tabela: `n8n_schedule_tracking`\n\n## Diferen√ßas do Kommo\n\n1. **Busca de Leads**: Agora via API REST do GHL\n2. **Envio de Mensagens**: Direto via API do GHL (sem workflow intermedi√°rio)\n3. **Estrutura de Dados**: Campos customizados acessados de forma diferente\n4. **Tags**: Formato de array simples no GHL\n\n## Pr√≥ximos Passos\n\n1. Importe este workflow no n8n\n2. Configure as vari√°veis de ambiente\n3. Ajuste os nomes dos campos customizados se necess√°rio\n4. Teste com um lead de exemplo\n5. Monitore os logs para identificar poss√≠veis ajustes\n",
        "height": 800,
        "width": 600,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        688,
        -800
      ],
      "id": "42cd99bf-f521-4042-bee2-03acad62d4b9",
      "name": "üìã INSTRU√á√ïES - LEIA ANTES DE USAR"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $json.contact_id || $json.unique_id || $('Sem Resposta').item.json.unique_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Sem Resposta').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1920,
        -320
      ],
      "id": "f4b4ade6-40c1-40e8-816c-429603f98c26",
      "name": "Buscar Lead GHL",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info GHL').item.json.ghl_api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $('Info GHL').item.json.contact_id }}\",\n  \"message\": \"{{ $json.messages.join(' ') }}\",\n  \"phone\": \"{{ $('Info GHL').item.json.telefone }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6608,
        48
      ],
      "id": "941b4392-68de-4c0d-836d-cf4bf9435251",
      "name": "Whatsapp",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Info GHL').item.json.ghl_api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"IG\",\n  \"contactId\": \"{{ $('Info GHL').item.json.contact_id }}\",\n  \"message\": \"{{ $json.messages.join(' ') }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6608,
        192
      ],
      "id": "2f1591b4-5a3b-49a7-ba56-acfe38c472f1",
      "name": "Instagram",
      "retryOnFail": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1024,
        -512
      ],
      "id": "c6790b8a-dfdd-4a77-a384-8f3e924e3112",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM n8n_schedule_tracking\nWHERE ativo = true\n  AND field = 'etapa'\n  AND (last_execution IS NULL OR last_execution < NOW() - INTERVAL '1 hour')\n  AND (\n    -- INSTAGRAM: Apenas leads com menos de 24h\n    (source = 'instagram' AND created_at > NOW() - INTERVAL '24 hour' AND\n     ((next_event IS NOT NULL AND next_event < NOW()) OR \n      (next_event IS NULL AND created_at < NOW() - INTERVAL '2 hour')))\n    OR\n    -- WHATSAPP: Cad√™ncia normal (sem limite de 24h)\n    (source != 'instagram' AND\n     ((next_event IS NOT NULL AND next_event >= created_at AND next_event < NOW()) OR\n      ((next_event IS NULL OR next_event < created_at) AND created_at < NOW() - INTERVAL '30 minute')))\n  )\n  AND value !~ '[0]'\nLIMIT 50;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        704,
        -512
      ],
      "id": "6674b977-9d04-45ba-8a55-a3db66c73042",
      "name": "Sem Resposta",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n_schedule_tracking (\n  unique_id,\n  ativo,\n  last_execution\n) VALUES (\n  $1, true, NOW()\n)\nON CONFLICT (unique_id) DO UPDATE\nSET \n  ativo = true,\n  last_execution = NOW(),\n  next_event = NULL;",
        "options": {
          "queryReplacement": "={{ $json.contact.id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2736,
        -544
      ],
      "id": "068e42b6-da31-4f57-a9c4-887ae415bd64",
      "name": "Atualiza status IA - CORRIGIDO",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1264,
        -528
      ],
      "id": "26cee0d6-fdd3-44a5-9a1d-5c34f9cbf235",
      "name": "Fim"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "97f84d0c-fa78-4c19-a490-e2ca78373501",
              "name": "Hor√°rio do agendamento",
              "value": "={{ $('Buscar Appointments do Contato').item.json.events[0].startTime }}",
              "type": "string"
            },
            {
              "id": "a30c9893-5f86-429b-a901-1fce91088cb8",
              "name": "Tipo de comunica√ß√£o",
              "value": "={{ $('Buscar Lead GHL').item.json._embedded.leads[0].data.custom_fields.controle-fup }}",
              "type": "string"
            },
            {
              "id": "48cf4ae1-ba13-4731-88ab-9c1c8c397df6",
              "name": "√öltima atualiza√ß√£o",
              "value": "={{ $json.last_execution }}",
              "type": "string"
            },
            {
              "id": "ec4e2895-3647-439d-a418-30ad9d66a70e",
              "name": "Lead Id",
              "value": "={{ $('Buscar Lead GHL').item.json.contact.id }}",
              "type": "string"
            },
            {
              "id": "d3a27bdd-cb2a-4762-83ad-dd3a717a2a7d",
              "name": "ultima_etapa",
              "value": "={{ $json.value }}",
              "type": "string"
            },
            {
              "id": "65dd86be-3834-40c5-968b-d4f9e6f14dbd",
              "name": "data_cria√ß√£o",
              "value": "={{ $json.created_at }}",
              "type": "string"
            },
            {
              "id": "e6bedfbb-6cfc-4e5e-8571-66893f3d8ad1",
              "name": "ultimo_follow_up",
              "value": "={{ $json.next_event }}",
              "type": "string"
            },
            {
              "id": "55ef44e9-fa86-439c-bf7f-af7eb8eeafc3",
              "name": "name",
              "value": "={{ $('Buscar Lead GHL').item.json.contact.firstName }}",
              "type": "string"
            },
            {
              "id": "1eeae277-fbd6-4124-b9b6-06a93411e30d",
              "name": "responsavel",
              "value": "={{ $('Buscar Lead GHL').item.json.contact.assignedTo }}",
              "type": "string"
            },
            {
              "id": "add48960-039c-4232-a998-a16d916fb341",
              "name": "historico_mensagens",
              "value": "={{ $('Mensagem anteriores').all().filter(item => !item.json.message.content?.includes('espond')).map(item => `${item.json.message.type === 'human' ? 'Humano' : 'IA'} [${new Date(item.json.created_at).toLocaleString('pt-BR')}]: ${item.json.message.content}`).join('\\n') }}\n",
              "type": "string"
            },
            {
              "id": "581d0631-1d0e-4555-abba-6a5ab51bb4af",
              "name": "contacts[0].phone",
              "value": "={{ $('Search Contact1').item.json.contacts[0].phone }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3616,
        -416
      ],
      "id": "6345668b-f754-4e71-b0a7-06b08a57a2c3",
      "name": "Informa√ß√µes Relevantes - FUP"
    },
    {
      "parameters": {
        "sseEndpoint": "https://cliente-a1.mentorfy.io/mcp/04ebfb45-5c60-4cf3-9baa-b5a87ffc479f/sse",
        "include": "selected",
        "includeTools": [
          "Atualizar_lead_perdido"
        ],
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1,
      "position": [
        4336,
        -160
      ],
      "id": "588d9062-50d0-4d30-a0e6-f8c538f33fc3",
      "name": "Atualizar Lead",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sseEndpoint": "https://cliente-a1.mentorfy.io/mcp/204838be-eb1a-4142-a7ea-b1718648fbcb/sse",
        "include": "selected",
        "includeTools": [
          "Busca_disponibilidade"
        ],
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1,
      "position": [
        4448,
        -160
      ],
      "id": "6a27dfad-7814-4019-bc7b-b7cef5f2bdcb",
      "name": "API Agendafy"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_schedule_tracking",
          "mode": "list",
          "cachedResultName": "n8n_schedule_tracking"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "unique_id",
              "value": "={{ $('Formatacao').first().json.data.id.toString() }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3456,
        -416
      ],
      "id": "35e9eb77-9ac4-4a0f-a22d-18c43b406cb2",
      "name": "Busca Rastreio",
      "retryOnFail": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Processamento simplificado para GHL\nconst contact = $('Buscar Lead GHL').first().json.contact;\n\n// Fun√ß√£o para pegar custom field pelo ID do GHL\nfunction getCustomField(contact, fieldId) {\n  if (!contact.customFields || !Array.isArray(contact.customFields)) return null;\n  const field = contact.customFields.find(cf => cf.id === fieldId);\n  return field ? field.value : null;\n}\n\n// Fun√ß√£o para pegar custom field com valor do enum\nfunction getCustomFieldWithEnum(contact, fieldId) {\n  const value = getCustomField(contact, fieldId);\n  if (!value) return null;\n  return {\n    value: value,\n    enum_id: null\n  };\n}\n\n// MAPEAMENTO DE IDs CONFIRMADOS\nconst FIELD_IDS = {\n  ATIVAR_IA: 'YFFXi3ByB0DuISqrq6MW',      // \"sim\"\n  ESTADO: 'NBugndbaCqI3gGDn1gSB',          // \"Florida\"\n  CONTADOR: 'lAzhCcLqTgUe3x2iYTN2',       // 0\n  \n  // FALTAM - Descubra os IDs quando precisar\n  MENSAGEM_FUP: null,\n  DATA_AGENDAMENTO: null,\n  FONTE_LEAD: null,\n  FUNIL: null,\n  FONTE: null,\n  CONTROLE_FUP: null,\n  CONTROLE_FUP_DATA: null\n};\n\nconst simplified = {\n  // Informa√ß√µes b√°sicas\n  id: contact.id || null,\n  name: `${contact.firstName || ''} ${contact.lastName || ''}`.trim() || null,\n  email: contact.email || null,\n  phone: contact.phone || null,\n  \n  // Foto de perfil\n  profile_photo: contact.profilePhoto || null,\n  \n  // Usu√°rio respons√°vel\n  responsible_user_id: contact.assignedTo || null,\n  \n  // Pipeline e status\n  pipeline_id: contact.pipelineId || null,\n  status_id: contact.pipelineStageId || null,\n  \n  // Datas\n  created_at: contact.dateAdded || null,\n  updated_at: contact.dateUpdated || null,\n  \n  // Tags\n  tags: contact.tags || [],\n  tag_names: contact.tags || [],\n  \n  // Atribui√ß√£o e fonte\n  attribution: {\n    ad_id: contact.attributionSource?.adId || null,\n    utm_content: contact.attributionSource?.utmContent || null,\n    medium: contact.attributionSource?.medium || null,\n    session_source: contact.attributionSource?.sessionSource || null,\n    ig_sid: contact.attributionSource?.igSid || null\n  },\n  \n  // Campos customizados\n  custom_fields: {\n    fonte_do_lead_bposs: getCustomField(contact, FIELD_IDS.FONTE_LEAD),\n    funil: getCustomFieldWithEnum(contact, FIELD_IDS.FUNIL),\n    fonte: getCustomFieldWithEnum(contact, FIELD_IDS.FONTE),\n    data_hora_agendamento: getCustomField(contact, FIELD_IDS.DATA_AGENDAMENTO),\n    ativar_desativar_ia: getCustomField(contact, FIELD_IDS.ATIVAR_IA),\n    mensagem_fup: getCustomField(contact, FIELD_IDS.MENSAGEM_FUP),\n    controle_fup: getCustomField(contact, FIELD_IDS.CONTROLE_FUP),\n    controle_fup_datahora: getCustomField(contact, FIELD_IDS.CONTROLE_FUP_DATA),\n    estado: getCustomField(contact, FIELD_IDS.ESTADO),\n    contador: getCustomField(contact, FIELD_IDS.CONTADOR)\n  },\n  \n  // Location\n  location_id: contact.locationId || null,\n  \n  // Tipo de contato\n  type: contact.type || 'lead'\n};\n\nreturn {\n  success: true,\n  data: simplified\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2736,
        -272
      ],
      "id": "9d38fa23-dd2a-47d2-bb09-30b6b66d91e5",
      "name": "Formatacao",
      "executeOnce": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data?.tags?.includes('ativar_ia') && !$json.data?.custom_fields?.mensagem_fup && $('Ultima Atualizacao').item.json.ativo }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "f833be81-d1fb-4c04-9382-52f491742ef7"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Envia mensagem"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45c341a1-5b59-49a6-9fb6-a78f56170e35",
                    "leftValue": true,
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Ignora"
            }
          ]
        },
        "options": {
          "allMatchingOutputs": true
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3120,
        -320
      ],
      "id": "872fc8f5-0776-470f-be90-c1fa6872dfd0",
      "name": "Switch"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2960,
        -320
      ],
      "id": "6b7de818-51da-4b87-a173-956d93073cc5",
      "name": "Merge",
      "executeOnce": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff19cb21-f08f-4c45-9e0c-bf15cc3a8c63",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "json",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "6495fa85-2af7-493f-bf75-e3d46220f622",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "{{",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "1a3f003d-7c63-4458-b21c-077df3110d65",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "{",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "9862c89d-b15e-4ca9-819b-1d78ce50969e",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "output",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "221b46a6-b8e2-4876-91e5-1e63c832c3ec",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "parsed",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "1ca62833-b23f-46d8-99dd-c885bc588a55",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "6954d9c3-7eaf-42e6-a165-4deb8ae9a253",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "error",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5584,
        112
      ],
      "id": "11b89618-2c49-42fc-b154-f8241c93f6a4",
      "name": "If",
      "executeOnce": false
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/15 8-20 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        528,
        -512
      ],
      "id": "432cc40c-bc61-4305-abad-ea002e7ff307",
      "name": "Trigger Diario"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2f65fbdb-8bb1-4d20-8437-fbaffcad8b13",
              "leftValue": "={{ $now.diffTo($json.last_execution, 'hour') > 1 || !$json.last_execution }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1376,
        -352
      ],
      "id": "0c2286ef-d351-4fa8-a9e0-57e74cd707be",
      "name": "If5"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_schedule_tracking",
          "mode": "list",
          "cachedResultName": "n8n_schedule_tracking"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "unique_id",
              "value": "={{ $json.unique_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1184,
        -352
      ],
      "id": "e175b115-4424-4d18-a983-e70afdebfdcf",
      "name": "Ultima Atualizacao",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b5a31f90-9b34-46f8-9cde-2faadea015d7",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "tools",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "c5f9a2ad-fe84-4187-8375-7774b7d145e0",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "lead",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "29c988ab-9dea-4345-ab2d-8903cfd5c4e3",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "next_event",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "2fbd0b30-fe51-49fa-974c-855867549da4",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "agent",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "1a1fee2a-75cd-4125-95b4-0b5d944fa119",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "iterations",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "89a20331-1690-4bd0-8690-4a7c42a95802",
              "leftValue": "={{ $('Formatar texto').first().json.text.parseJson().messages.join() }}",
              "rightValue": "stopped",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        5760,
        96
      ],
      "id": "0dec6ffd-6c7d-496f-9f32-ba18cbeab71d",
      "name": "Filter"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=[Lead ainda n√£o respondeu...]",
        "options": {
          "systemMessage": "=## 1. üéØ CONTEXTO E PAPEL\n\nVoc√™ √© um especialista em **reativa√ß√£o de leads e vendas consultivas**.\nSua miss√£o √©:\n\n* Retomar conversas de forma **natural e personalizada**.\n* **Sempre agendar follow-up** com `Agendar_follow_up` ap√≥s cada mensagem.\n* Adaptar a cad√™ncia com base na **√∫ltima intera√ß√£o**.\n* Avan√ßar o lead no funil de forma leve, incentivando a marcar reuni√µes.\n\nüìå Data/hora atual: `{{ $now.format('FFFF') }}`\nüìå Fuso: America/New_York (NY)\n\n[INFORMA√á√ïES DO LEAD]\n\n* Nome: {{ $('Informa√ß√µes Relevantes - FUP').first().json.name }}\n* Lead_id: {{ $('Informa√ß√µes Relevantes - FUP').first().json['Lead Id'] }}\n* Respons√°vel: {{ $('Informa√ß√µes Relevantes - FUP').first().json.responsavel }}\n* Fluxo atual: {{ $('Informa√ß√µes Relevantes - FUP').first().json.fluxo_vs }}\n* √öltima etapa: {{ $('Informa√ß√µes Relevantes - FUP').first().json.ultima_etapa }}\n* √öltima reuni√£o: {{ $('Informa√ß√µes Relevantes - FUP').first().json['Hor√°rio do agendamento'] }}\n* √öltima msg recebida: {{ $('Informa√ß√µes Relevantes - FUP').first().json['data_cria√ß√£o'] }}\n* √öltimo follow-up: {{ $('Informa√ß√µes Relevantes - FUP').first().json.ultimo_follow_up ?? \"Ainda n√£o agendado\" }}\n\n---\n\n## 2. üß† PERSONALIDADE E ESTILO\n\n* Tom: **casual, leve, direto**.\n* Use o nome do lead de forma natural, mas **n√£o sempre na primeira frase**.\n* Frases curtas, mas **sem limite r√≠gido de caracteres**. Clareza > tamanho.\n* Pode usar conectores normais (v√≠rgula, dois pontos), desde que soe humano.\n* Nunca use termos t√©cnicos (lead, funil, etapa, IA, sistema).\n* Evite repeti√ß√µes √≥bvias e mensagens gen√©ricas.\n\n---\n\n## 3. ‚ö° FLUXO DE A√á√ÉO\n\n### Etapa 1 ‚Äî Entender cen√°rio\n\n* Analise: `fonte_do_lead_bposs`, `funil`, `fluxo_vs`, `ultima_etapa`, `data_cria√ß√£o`, hist√≥rico.\n* Identifique se √©:\n\n  1. **Lead ativo** (respondeu recentemente).\n  2. **Lead frio** (dias/semana sem resposta).\n  3. **P√≥s-reuni√£o** (j√° teve call).\n\n### Etapa 2 ‚Äî Definir pr√≥ximo passo\n\n* Se ativo ‚Üí continue a conversa.\n* Se frio ‚Üí retome de forma leve e objetiva.\n* Se p√≥s-reuni√£o ‚Üí confirmar materiais ou propor nova agenda.\n\nEtapa 3 ‚Äî Criar mensagem (ajustado)\n\nUse as respostas anteriores (P0‚ÄìP4) e hist√≥rico.\nNunca repita mensagens anteriores.\nNunca use termos vagos como ‚Äúaquilo‚Äù, ‚Äúaquele interesse‚Äù, \"aquele assunto\", ‚Äúsobre isso‚Äù, se o assunto n√£o √© claro, n√£o mencionamos.\n\nMencione de forma clara o assunto em aberto se houver (ex.: proposta, opera√ß√£o, estrat√©gia nos EUA, agendamento da call, etc.).\n\nSe n√£o houver contexto, fa√ßa pergunta simples para reabrir contato, mas sempre com algum tema relacionado ao hist√≥rico do lead.\n\n### Etapa 4 ‚Äî Follow-up\n\n* Ap√≥s cada mensagem, sempre agende novo contato:\n\n```js\nAgendar_follow_up(data, hora, \"msg sugerida para pr√≥xima tentativa\")\n```\n\n* Apenas **uma chamada por mensagem**.\n\n### Etapa 5 ‚Äî Escalonar para humano\n\n* Encaminhar se:\n\n  * 3 recusas seguidas\n  * Pedido fora do escopo\n  * Quest√£o legal/contratual\n  * Contexto confuso\n\n---\n\n## 4. üõ†Ô∏è FERRAMENTAS\n\n| Ferramenta                 | Fun√ß√£o                            |\n| -------------------------- | --------------------------------- |\n| **Busca_disponibilidade**  | Verificar hor√°rios p/ reuni√µes    |\n| **Agendar_follow_up**      | Agendar novo contato              |\n| **Atualizar_lead_perdido** | Marcar como perdido ap√≥s cad√™ncia |\n\n---\n\n## 5. üìÖ AGENDAMENTO DE REUNI√ïES\n\n* S√≥ ofere√ßa reuni√£o se lead estiver em etapa de agendamento ou reagendamento.\n* Antes de sugerir hor√°rio ‚Üí use `Busca_disponibilidade`.\n* Convite sempre em tom leve, ex:\n\n  > ‚ÄúQuer q eu veja uns hor√°rios pra gente conversar rapidinho?‚Äù\n\n---\n\n## 6. ‚úÖ REGRAS ESSENCIAIS\n\n* Sempre personalize.\n* Sempre agende follow-up.\n* Nunca repita mensagens.\n* Clareza e naturalidade acima de tudo.\n* Na mensagem foque apenas no conte√∫do do hist√≥rico de conversa para criar a mensagem de reativa√ß√£o de lead.\n* Mensagens curtas\n\n---\n# 7. Exemplos mais gen√©ricos\n1. Ol√° [Nome], tudo bem?\nVoc√™ ainda gostaria de continuar nossa conversa?\n\n2. Oi [Nome]! Faz um tempinho que n√£o falamos, gostaria de retomar nosso papo?\n\n3. Ol√° [Nome], tudo certo?\nAinda faz sentido seguirmos com nossa conversa?\n\n4. Oi [Nome], espero que esteja bem üôÇ\nPodemos continuar de onde paramos?\n\n---\n\n## 8. üéØ SA√çDA FINAL\n\n* Apenas a **mensagem para o lead**.\n* Um `Agendar_follow_up` obrigat√≥rio com data/hora e msg de pr√≥xima tentativa.\n* Nada de explica√ß√µes extras.\n* N√£o usar texto com \"(\", \")\" ou \"[\", \"]\".\n\n# 9. HIST√ìRICO DE CONVERSA (LEAD E ASSISTENTE)\n{{ $('Informa√ß√µes Relevantes - FUP').first().json.historico_mensagens }}",
          "maxIterations": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        4192,
        -416
      ],
      "id": "f53fffab-a10f-49ae-b461-6e8e18fd2958",
      "name": "Assistente de follow up eterno",
      "retryOnFail": false,
      "maxTries": 5,
      "waitBetweenTries": 2000,
      "executeOnce": true
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "a_lead_id",
              "value": "={{ $('Buscar Lead GHL').item.json.contact.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        3296,
        -416
      ],
      "id": "9a13d9d2-2584-4627-b3a6-7ff2dc898d81",
      "name": "Execution Data",
      "executeOnce": true
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Atualiza quando dever√° ser o pr√≥ximo FollowUp(pr√≥ximo contato) do cliente. unique_id √© o lead_id. IMPORTANTE: Para Instagram, agende no m√°ximo at√© 23h ap√≥s o primeiro contato. Para WhatsApp, pode agendar livremente. Sempre ser√° chamado.",
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_schedule_tracking",
          "mode": "list",
          "cachedResultName": "n8n_schedule_tracking"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "next_event": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('next_event', `Formato: 2025-08-29 15:00:00+00. ATEN√á√ÉO: Se source=instagram, agende no m√°ximo 23h ap√≥s created_at. Se WhatsApp, sem restri√ß√£o.`, 'string') }}",
            "unique_id": "={{ $('Informa√ß√µes Relevantes - FUP').first().json['Lead Id'].toString() }}",
            "ativo": "true"
          },
          "matchingColumns": [
            "unique_id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "field",
              "displayName": "field",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "value",
              "displayName": "value",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "unique_id",
              "displayName": "unique_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "execution_id",
              "displayName": "execution_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ativo",
              "displayName": "ativo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "next_event",
              "displayName": "next_event",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        5040,
        64
      ],
      "id": "ced84098-4a94-4b0c-bcc7-5e6338f87fd8",
      "name": "Agendar_follow_up_tool",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Ferramenta de agente de follow-up. Respons√°vel por agendar o proximo follow-up. S√≥ pode ser chamado uma √∫nica vez e n√£o mais.",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}",
        "options": {
          "systemMessage": "=Voc√™ √© um assistente de agendamento de follow-up, sua miss√£o √© identificar a cadencia atual que o lead est√° e agendar para a pr√≥xima cad√™ncia.\n\nüìå **Data/hora atual:** `{{ $now.format('FFFF') }}`  \nüìå **Fuso:** America/New_York (NY)\n\n[INFORMA√á√ïES DO LEAD] \nNome: {{ $('Informa√ß√µes Relevantes - FUP').first().json.name }} \nLead_id: {{ $('Informa√ß√µes Relevantes - FUP').first().json['Lead Id'] }} \nfunil: {{ $('Informa√ß√µes Relevantes - FUP').first().json.funil }} \nrespons√°vel: {{ $('Informa√ß√µes Relevantes - FUP').first().json.responsavel }} \nfonte do lead bposs: {{ $('Informa√ß√µes Relevantes - FUP').first().json.fonte_do_lead_bposs }} \nfluxovs: {{ $('Informa√ß√µes Relevantes - FUP').first().json.fluxo_vs }} \n√öltima reuni√£o agendada: {{ $('Informa√ß√µes Relevantes - FUP').first().json['Hor√°rio do agendamento'] }}\nUltima etapa registrada: {{ $('Informa√ß√µes Relevantes - FUP').first().json.ultima_etapa }} \nData da √∫ltima mensagem do lead: {{ $('Informa√ß√µes Relevantes - FUP').first().json['data_cria√ß√£o'] }} \nUltimo follow up agendado: {{ $('Informa√ß√µes Relevantes - FUP').first().json.ultimo_follow_up ?? \"Ainda n√£o agendado\" }}\n\n\n**Obs: mesmo que n√£o tenha tido follow up anteriormente, precisamos considerar o tempo que se passou, por exemplo, se passou 1h desde a ultima mensagem do lead, significa que a cadecia atual seria a mais pr√≥xima do tempo atual e precisamos saber e agendar a cad√™ncia seguinte. Nesse exemplo, se passou 1h, se tivermos cadencia de 1h, 2h e 3h, a cadecia futura ser√° a de 3h, pois 2h √© a atual.**\n\n**Obs 2: Se na √∫ltima cad√™cia agora ent√£o n√£o precisamos agendar a futura. Mas se j√° n√£o estamos perto de uma cad√™ncia atualmente(j√° ultrapassamos o m√°ximo) ent√£o chamamos a ferramenta \"Fim_de_cadencia\" para n√£o enviarmos mensagem agora e encerrar. Por√©m se j√° agendamento o pr√≥ximo follow up ent√£o n√£o precisamos fazer nada, deixamos assim.**\n\n**Obs 3: s√≥ podemos chamar o Agendar_follow_up_tool ou o Fim_de_cadencia apenas uma unica vez.\n\n--\n\n## FERRAMENTAS:\n- Refletir_cadencia: para raciocinar a cadencia correta. Sempre devemos usar.\n- Agendar_follow_up_tool: para agendar o proximo follow-up.\n- Fim_de_cadencia: encerrar conversa com lead.\n\n---\n\n# üìå TABELA DE CAD√äNCIAS ‚Äî POR CEN√ÅRIO\n\n## **Cen√°rio 1**  \n`fonte_do_lead_bposs: Tr√°fego - Lead Direct - Carreira`  \n`funil: F2 - Funil Tr√°fego Direto`\n\n| Etapa | Cad√™ncia |\n|-------|----------|\n| 1. Ativa√ß√£o | 15min, 1h, 3h, D+1 10h, D+2 15h, D+4 18h, D+7 11h, D+10 16h, D+13 9h, D+16 19h, D+19 14h |\n| 2. Qualifica√ß√£o | 30min, 2h, 4h, D+1 16h, D+2 11h, D+4 19h, D+7 10h, D+10 18h, D+13 15h, D+16 9h, D+19 17h |\n| 3. Sondagem | 15min, 2h, 6h, D+1 9h, D+2 14h, D+4 11h, D+7 17h, D+10 10h, D+13 19h, D+16 13h, D+19 18h |\n| 4. Dados p/ Agendamento | 15min, 1h, 3h, D+1 18h, D+2 16h, D+4 9h, D+7 14h, D+10 19h, D+13 11h, D+16 17h, D+19 10h |\n| 5. P√≥s-Reuni√£o | T+15min, T+2h, D+1 10h, D+3 10h, D+7 10h, D+14 11h, D+30 15h |\n| 6. Reagendamento | 15min, 1h, 4h, D+1 11h, D+2 15h, D+4 19h, D+7 9h, D+10 16h, D+13 14h, D+16 18h, D+19 10h |\n\n---\n\n## **Cen√°rio 2**  \n`fonte_do_lead_bposs: Tr√°fego - Lead Direct - Consultoria`  \n`funil: F2 - Funil Tr√°fego Direto`  \n\n*(Segue a mesma cad√™ncia do Cen√°rio 1)*\n\n---\n\n## **Cen√°rio 3**  \n`fonte_do_lead_bposs: Prospec√ß√£o / Novo Seguidor (BPO Social Selling)`  \n`funil: F1 - BPO do Social Selling - EUA`\n\n| Etapa | Cad√™ncia |\n|-------|----------|\n| 1. Ativa√ß√£o | 24h, 48h, 72h, D+5 10h, D+7 15h, D+10 11h, D+13 18h, D+16 14h, D+19 9h, D+25 16h, D+30 10h, D+45 15h, D+60 11h |\n| 2. Qualifica√ß√£o | 24h, 72h, D+5 15h, D+7 18h, D+10 9h, D+13 16h, D+19 11h, D+25 19h, D+30 14h, D+45 10h, D+60 15h |\n| 3. Sondagem | 48h, 72h, D+5 11h, D+7 14h, D+10 17h, D+13 10h, D+16 18h, D+19 13h, D+25 9h, D+30 17h, D+45 11h, D+60 16h |\n| 4. Dados p/ Agendamento | 48h, 72h, D+5 14h, D+7 17h, D+10 10h, D+13 19h, D+16 15h, D+19 18h, D+25 11h, D+30 16h, D+45 14h, D+60 18h |\n| 5. P√≥s-Reuni√£o | T+10min, T+2h, D+1 10h, D+3 10h, D+7 10h, D+14 11h, D+30 15h, D+60 15h |\n| 6. Reagendamento | 24h, 48h, 72h, D+5 11h, D+7 15h, D+10 14h, D+13 9h, D+16 17h, D+19 11h, D+25 15h, D+30 19h, D+45 13h, D+60 10h |\n\nEXEMPLO DE EXECU√á√ÉO COMPLETA DE CAD√äNCIA\n\n**Exemplo pr√°tico ‚Äî Cen√°rio 1 ‚Äî Etapa 1 (Ativa√ß√£o)**\nüìç **√öltima mensagem do lead:** 10:00 (NY)  \nüìç **Data atual:** 10:15 (NY)  \nüìç **Cad√™ncia:** 15min ‚Üí 1h ‚Üí 3h ‚Üí D+1 10h...\n\n\nAo final responda se o agendamento foi concluido com sucesso explicando o porque essa cadencia foi escolhida."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        4592,
        -160
      ],
      "id": "84d5a078-5c8a-4fae-81e6-302c91cce31e",
      "name": "Agendar_follow_up",
      "disabled": true
    },
    {
      "parameters": {
        "description": "Use a ferramenta para pensar sobre algo. Ela n√£o obter√° novas informa√ß√µes nem alterar√° o banco de dados, apenas anexar√° o pensamento ao registro. Use-a quando for necess√°rio racioc√≠nio complexo ou alguma mem√≥ria cache."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4736,
        64
      ],
      "id": "94b1da19-3790-4eb5-baef-981ffa5772b3",
      "name": "Refletir_cadencia"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Execute a SQL query in Postgres",
        "operation": "executeQuery",
        "query": "INSERT INTO n8n_schedule_tracking (\n  unique_id,\n  ativo\n) VALUES (\n  $1, FALSE\n)\nON CONFLICT (unique_id) DO UPDATE\nSET \n  ativo = FALSE,\n  next_event = NULL;",
        "options": {
          "queryReplacement": "={{ $('Informa√ß√µes Relevantes - FUP').first().json['Lead Id'] }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        4880,
        64
      ],
      "id": "5c6db960-4f21-49b7-a67c-39213dddca01",
      "name": "Fim de cadencia",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_schedule_tracking",
          "mode": "list",
          "cachedResultName": "n8n_schedule_tracking"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "unique_id",
              "value": "={{ $('Informa√ß√µes Relevantes - FUP').first().json['Lead Id'].toString() }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5264,
        -416
      ],
      "id": "0e1398aa-b2bd-47b8-98a2-1c82ef59be14",
      "name": "Ultima Atualizacao6",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// L√ìGICA: Se tem telefone OU source != instagram ‚Üí WhatsApp\n// Se N√ÉO tem telefone E source = instagram ‚Üí Instagram\n\nconst leadData = $('Buscar Lead GHL').item.json.contact;\nconst phone = leadData?.phone;\nconst attributionMedium = leadData?.attributionSource?.medium || leadData?.lastAttributionSource?.medium;\n\n// Decis√£o inteligente\nlet source;\nif (phone && phone.trim() !== '') {\n  // Tem telefone = pode usar WhatsApp (cad√™ncia longa)\n  source = 'whatsapp';\n} else if (attributionMedium === 'instagram') {\n  // N√£o tem telefone E veio do Instagram = s√≥ Instagram (24h)\n  source = 'instagram';\n} else {\n  // Default: whatsapp\n  source = 'whatsapp';\n}\n\nconst leadId = $('Informa√ß√µes Relevantes - FUP').first().json['Lead Id'].toString();\n\nconsole.log(`Lead ${leadId}: source=${source}, phone=${phone || 'null'}, medium=${attributionMedium}`);\n\nreturn {\n  json: {\n    lead_id: leadId,\n    source: source,\n    query_params: `${leadId},${source}`\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5024,
        -416
      ],
      "id": "c7182ea5-0b67-4f17-bba6-dd6bb3dddc4e",
      "name": "Calcular Source (Instagram vs WhatsApp)",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n_schedule_tracking (\n  unique_id,\n  ativo,\n  source\n) VALUES (\n  $1, true, $2\n)\nON CONFLICT (unique_id) DO UPDATE\nSET source = EXCLUDED.source\nWHERE n8n_schedule_tracking.source IS NULL;",
        "options": {
          "queryReplacement": "={{ $json.query_params }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5120,
        -416
      ],
      "id": "ca633aaf-1b25-4484-b88a-e01ce3160cda",
      "name": "Garantir Registro Existe - COM SOURCE",
      "retryOnFail": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4592,
        64
      ],
      "id": "d301f3a8-9679-4bfb-9902-4007e66d0e5e",
      "name": "Modelo",
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $json.contact.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2736,
        -416
      ],
      "id": "1a6dc5e7-bfbb-47b8-8d57-b0f98110e1c1",
      "name": "Mensagem anteriores",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Informa√ß√µes Relevantes - FUP').item.json['Lead Id'] }}",
        "tableName": "n8n_historico_mensagens",
        "contextWindowLength": 25
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        4192,
        16
      ],
      "id": "67199827-673b-4ecc-9619-6e3f20615eeb",
      "name": "Memory",
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ce11f02d-1cb3-42d0-bde8-6388cf1ab4da",
              "name": "messages",
              "value": "={{ $('Formatar texto').first().json.text.parseJson().messages }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        6080,
        96
      ],
      "id": "0817c483-828c-42a0-b332-ebb0c9ac9ac8",
      "name": "resposta"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        4976,
        -272
      ],
      "id": "524921a5-cb0f-410f-95ea-e94b231d8f42",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_historico_mensagens",
          "mode": "list",
          "cachedResultName": "n8n_historico_mensagens"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message": "={\n  \"type\": \"ai\",\n  \"content\": \"{{ $('Formatar texto').first().json.text.parseJson().messages.join() }}\",\n  \"tool_calls\": [],\n  \"additional_kwargs\": {},\n  \"response_metadata\": {},\n  \"invalid_tool_calls\": []\n}",
            "session_id": "={{ $('Informa√ß√µes Relevantes - FUP').item.json['Lead Id'].toString() }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5936,
        96
      ],
      "id": "77894cb8-52f3-4db4-bbc7-1cbf87450d7c",
      "name": "Atualiza status IA5",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "B0fAAM3acruSSuiz",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "inputText": "={{ $json.historico_mensagens }}",
        "options": {
          "categories": "Positive, Neutral, Negative",
          "includeDetailedResults": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.sentimentAnalysis",
      "typeVersion": 1.1,
      "position": [
        3808,
        -432
      ],
      "id": "75dd9415-27d2-4984-b067-ea3d9043b7bd",
      "name": "Sentiment Analysis",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensagem que ser√° enviada: {{$('Assistente de follow up eterno').first().json.output}}",
        "messages": {
          "messageValues": [
            {
              "message": "=Voc√™ √© um assistente cuja √∫nica fun√ß√£o √© REVISAR a mensagem antes de ela ser enviada para o usu√°rio.\n\n## Contexto\n- Voc√™ recebe como entrada o [hist√≥rico] de mensagens j√° trocadas e a [nova mensagem] que o sistema quer enviar.\n- Sua miss√£o √© garantir que a resposta seja clara, curta, sem repeti√ß√µes e natural.\n- Se a resposta tiver v√°rias perguntas, simplifique para apenas UMA pergunta por vez, escolhendo a mais relevante ou necess√°ria para continuar a conversa.\n- Evite frases longas, blocos de texto pesados ou repetir o que j√° foi dito no hist√≥rico.\n- A conversa deve parecer leve, guiada e natural, como em um di√°logo humano.\n\n## Instru√ß√µes\n1. Leia o [hist√≥rico] para entender o que j√° foi falado.\n2. Analise a [nova mensagem].\n3. Reescreva a [nova mensagem] de forma mais curta e natural.\n4. Caso haja v√°rias perguntas, mantenha s√≥ a principal.\n5. N√£o invente informa√ß√µes novas e n√£o mude o sentido.\n6. Responda apenas com a mensagem revisada, sem coment√°rios extras.\n7. Se tiver algum trexo com underline \"_\" devemos remover essa parte em diante.\n8. se tiver texto com \"(\", \")\", \"[\" ou \"]\" vamos remover.\n\n## Formato de sa√≠da\nRetorne apenas a vers√£o revisada da mensagem final.\n\n## SENTIMENTO DA CONVERSA\n{{ $('Sentiment Analysis').item.json.sentimentAnalysis.category }}\n\n## HIST√ìRICO\n{{ $('Informa√ß√µes Relevantes - FUP').first().json.historico_mensagens }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        4544,
        -416
      ],
      "id": "59788d0a-961c-4cea-8a37-ee82f8799302",
      "name": "QA"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4192,
        -160
      ],
      "id": "c1f006c1-2f68-4fdd-b007-008ed55f9bbb",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "4ut0CD80SN7lbITM",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "model": "meta-llama/llama-4-scout",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        3968,
        -160
      ],
      "id": "d1563e6e-5d25-4619-a983-225a1bc1a892",
      "name": "OpenRouter1",
      "credentials": {
        "openRouterApi": {
          "id": "sfkNv3IS1mwYy1mQ",
          "name": "OpenRouter Alan"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensagem a ser formatada: {{ $json.text }}",
        "messages": {
          "messageValues": [
            {
              "message": "=Voc√™ √© especialista em formata√ß√£o de mensagem para WhatsApp, trabalhando somente na formata√ß√£o e n√£o alterando o conte√∫do da menssagem. Responda apenas com o texto final, n√£o comente nada e n√£o fale 'sua mensagem formatada', apenas o texto final. N√£o comente e nem fale por conta pr√≥pria, apenas pegue a mensagem do usu√°rio e formate.\n\n- Substitua ** por *\n- Remova #\n- Remova emojis\n- remova \\n e quebra de linhas\n- Substitua aspas duplas por aspas simples \" > '\n\n* remova partes do texto que n√£o fazem parte da conversa como:\n- Mens√£o a tools ou \"Agendar_follow_up\" ou partes que n√£o parecem fazer sentido na frase que √© uma resposta de uma conversa.\n\nPor favor, gere a sa√≠da no seguinte formato JSON:\n{\n  \"messages\": [\n    \"splitedMessage\",\n    \"splitedMessage\",\n    \"splitedMessage\"\n  ]\n}\n\nRecomendado: ideal entre 2 mensagens e no max 3. Pode usar como referencia exclama√ß√µes ou ponto."
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        4912,
        -416
      ],
      "id": "12076ceb-2b03-42c9-8247-4c33292959a1",
      "name": "Formatar texto",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "maxTries": 5,
      "executeOnce": false
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=https://services.leadconnectorhq.com/contacts/search/",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "locationId",
              "value": "={{ $('Ultima Atualizacao').item.json.location_id }}"
            },
            {
              "name": "pageLimit",
              "value": "={{20}}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Sem Resposta').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        }
      },
      "name": "Search Contact1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1648,
        -512
      ],
      "id": "337e589e-9fa3-4cb3-9189-012ce134cf4f",
      "notes": "Busca contato por EMAIL"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-error",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "any",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2416,
        -624
      ],
      "id": "428487b8-2146-46a9-b6e3-307db750ff68",
      "name": "Busca OK?",
      "notes": "Verifica se a busca foi bem sucedida"
    },
    {
      "parameters": {
        "jsCode": "// Pega dados do input (vem do Merge ou do node anterior)\nconst items = $input.all();\n\n// Identifica qual item √© o qu√™\nconst contact = items.find(item => item.json.contact)?.json.contact;\nconst appointments = items.find(item => item.json.events)?.json.events || [];\nconst tracking = items.find(item => item.json.unique_id)?.json;\nconst mensagens = items.filter(item => item.json.message);\n\n// Se n√£o encontrou contact, tenta pegar direto\nif (!contact) {\n  return items; // Retorna como est√°\n}\n\n// Pega o pr√≥ximo agendamento (mais recente futuro)\nconst nextAppointment = appointments\n  .filter(a => new Date(a.startTime) > new Date())\n  .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))[0];\n\n// Custom fields por ID\nconst getField = (id) => contact.customFields?.find(cf => cf.id === id)?.value;\n\n// Hist√≥rico de mensagens\nconst historico = mensagens\n  .filter(m => !m.json.message.content?.includes('espond'))\n  .map(m => `${m.json.message.type === 'human' ? 'Humano' : 'IA'} [${new Date(m.json.created_at).toLocaleString('pt-BR')}]: ${m.json.message.content}`)\n  .join('\\n');\n\nreturn {\n  // Dados b√°sicos\n  id: contact.id,\n  name: `${contact.firstName || ''} ${contact.lastName || ''}`.trim(),\n  email: contact.email,\n  phone: contact.phone,\n  profile_photo: contact.profilePhoto,\n  \n  // Agendamento (da API de appointments!)\n  data_hora_agendamento: nextAppointment?.startTime || null,\n  appointment_status: nextAppointment?.appointmentStatus || null,\n  appointment_address: nextAppointment?.address || null,\n  \n  // Custom fields\n  ativar_ia: getField('YFFXi3ByB0DuISqrq6MW'),\n  estado: getField('NBugndbaCqI3gGDn1gSB'),\n  etapa: getField('6LXWNQDqao8vQtBhMjzK'),\n  funil: getField('GfCjI3pQPB7fDbEtdh9O'),\n  contador: getField('lAzhCcLqTgUe3x2iYTN2'),\n  \n  // Attribution\n  medium: contact.attributionSource?.medium,\n  session_source: contact.attributionSource?.sessionSource,\n  ad_id: contact.attributionSource?.adId,\n  utm_content: contact.attributionSource?.utmContent,\n  \n  // Tags\n  tags: contact.tags || [],\n  \n  // Tracking\n  ultima_etapa: tracking?.value,\n  data_criacao: tracking?.created_at,\n  ultimo_follow_up: tracking?.next_event,\n  \n  // Respons√°vel e pipeline\n  responsible_user_id: contact.assignedTo,\n  pipeline_id: contact.opportunities?.[0]?.pipelineId,\n  pipeline_stage_id: contact.opportunities?.[0]?.pipelineStageId,\n  \n  // Hist√≥rico\n  historico_mensagens: historico,\n  \n  // Location\n  location_id: contact.locationId\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1952,
        -640
      ],
      "id": "66980690-9c10-4c85-b086-4216a8c8c1de",
      "name": "Parse"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $json.unique_id }}/appointments",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Sem Resposta').item.json.api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        }
      },
      "name": "Buscar Appointments do Contato",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1600,
        -304
      ],
      "id": "9f5d6108-8a0e-4e2f-8aff-8efb350254c7",
      "continueOnFail": true,
      "notes": "Busca appointments diretamente do contato"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "=",
                    "rightValue": "whatsapp",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "22c9ad16-22b8-4d91-bb3b-4f1db7d4dd45"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Whatsapp"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.source }}",
                    "rightValue": "instagram",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3ad07000-d6bb-4600-a297-6e0420bc64fb"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Instagram"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        6304,
        144
      ],
      "id": "6c0de2b7-925e-4002-a213-cea5dae9d1b7",
      "name": "Switch5"
    }
  ],
  "pinData": {},
  "connections": {
    "Buscar Lead GHL": {
      "main": [
        [
          {
            "node": "Formatacao",
            "type": "main",
            "index": 0
          },
          {
            "node": "Mensagem anteriores",
            "type": "main",
            "index": 0
          },
          {
            "node": "Atualiza status IA - CORRIGIDO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whatsapp": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Fim",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ultima Atualizacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sem Resposta": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Informa√ß√µes Relevantes - FUP": {
      "main": [
        [
          {
            "node": "Sentiment Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Lead": {
      "ai_tool": [
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "API Agendafy": {
      "ai_tool": [
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Busca Rastreio": {
      "main": [
        [
          {
            "node": "Informa√ß√µes Relevantes - FUP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatacao": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Diario": {
      "main": [
        [
          {
            "node": "Sem Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Buscar Appointments do Contato",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ultima Atualizacao": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Atualiza status IA5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assistente de follow up eterno": {
      "main": [
        [
          {
            "node": "QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Busca Rastreio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agendar_follow_up_tool": {
      "ai_tool": [
        [
          {
            "node": "Agendar_follow_up",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agendar_follow_up": {
      "ai_tool": [
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Refletir_cadencia": {
      "ai_tool": [
        [
          {
            "node": "Agendar_follow_up",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Fim de cadencia": {
      "ai_tool": [
        [
          {
            "node": "Agendar_follow_up",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Ultima Atualizacao6": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Modelo": {
      "ai_languageModel": [
        [
          {
            "node": "Agendar_follow_up",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem anteriores": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "resposta": {
      "main": [
        [
          {
            "node": "Switch5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza status IA5": {
      "main": [
        [
          {
            "node": "resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sentiment Analysis": {
      "main": [
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA": {
      "main": [
        [
          {
            "node": "Formatar texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter1": {
      "ai_languageModel": [
        [
          {
            "node": "Assistente de follow up eterno",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Sentiment Analysis",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "QA",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Formatar texto",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Formatar texto": {
      "main": [
        [
          {
            "node": "Calcular Source (Instagram vs WhatsApp)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Source (Instagram vs WhatsApp)": {
      "main": [
        [
          {
            "node": "Garantir Registro Existe - COM SOURCE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Garantir Registro Existe - COM SOURCE": {
      "main": [
        [
          {
            "node": "Ultima Atualizacao6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Appointments do Contato": {
      "main": [
        [
          {
            "node": "Search Contact1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Contact1": {
      "main": [
        [
          {
            "node": "Buscar Lead GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza status IA - CORRIGIDO": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch5": {
      "main": [
        [
          {
            "node": "Whatsapp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instagram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "6958961c-5817-47e6-83be-073177460e6b",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "TWE7PMLjCsaiSBEp",
  "tags": []
}