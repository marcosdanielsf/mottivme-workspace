{
  "name": "Verificar agendamento existente",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "API_KEY"
            },
            {
              "name": "email"
            },
            {
              "name": "telefone"
            },
            {
              "name": "location_id"
            },
            {
              "name": "calendar_id"
            },
            {
              "name": "startTime"
            },
            {
              "name": "firstName"
            },
            {
              "name": "lastName"
            },
            {
              "name": "lead_id"
            },
            {
              "name": "estadoValue"
            },
            {
              "name": "workPermitValue"
            }
          ]
        }
      },
      "id": "e1c70680-f10c-47f1-818f-955e0892a201",
      "typeVersion": 1.1,
      "name": "Start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        -2096,
        -800
      ]
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "telefone",
              "value": "={{ $json.telefone }}"
            },
            {
              "key": "email",
              "value": "={{ $json.email }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -1888,
        -800
      ],
      "id": "8bcab030-07f5-4f94-896c-22cae9fa4dbb",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/contacts/{{ $('Start').item.json.lead_id }}/appointments",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Start').item.json.API_KEY }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        }
      },
      "name": "Buscar Appointments do Contato1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        -1392,
        -800
      ],
      "id": "f3b01c59-0883-437e-a758-d12f7b37b537",
      "continueOnFail": true,
      "notes": "Busca appointments diretamente do contato"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-error",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "any",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1200,
        -800
      ],
      "id": "aebaff25-de33-437d-8517-a666f34f6a9b",
      "name": "Busca OK?1",
      "notes": "Verifica se a busca foi bem sucedida"
    },
    {
      "parameters": {
        "jsCode": "// Se a primeira tentativa falhou, vamos buscar via calendários\nconst locationId = $('Start').item.json.location_id;\nconst contactId = $('Start').item.json.contact_id;\n\n// Retorna dados para próxima tentativa\nreturn {\n  json: {\n    locationId,\n    contactId,\n    needsAlternative: true\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        -672
      ],
      "id": "a2c82a25-1e7e-409a-b847-41e68f923ad9",
      "name": "Preparar Busca Alternativa1",
      "notes": "Prepara dados para método alternativo"
    },
    {
      "parameters": {
        "url": "=https://services.leadconnectorhq.com/calendars/events",
        "options": {},
        "headerParametersUi": {
          "parameter": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Start').item.json.API_KEY }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            }
          ]
        },
        "queryParametersUi": {
          "parameter": [
            {
              "name": "locationId",
              "value": "={{ $json.locationId }}"
            },
            {
              "name": "contactId",
              "value": "={{ $json.contactId }}"
            },
            {
              "name": "startTime",
              "value": "={{ $now.toISO() }}"
            }
          ]
        }
      },
      "name": "Buscar via Calendar Events1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        -800,
        -672
      ],
      "id": "94730497-1e6f-42b8-a70f-27be8ae8dd16",
      "continueOnFail": true,
      "notes": "Método alternativo: busca via events com filtro de contactId"
    },
    {
      "parameters": {
        "jsCode": "// Processa resultado - verifica qual método retornou dados\nlet appointments = [];\nlet sourceMethod = 'none';\n\n// Pega o item atual que chegou neste node\nconst currentItem = $input.item.json;\n\n// Verifica se é resposta do método direto ou alternativo\nif (currentItem.events || currentItem.appointments) {\n  // Tem dados diretamente no item atual\n  appointments = currentItem.events || currentItem.appointments || [];\n  sourceMethod = currentItem.needsAlternative ? 'alternative' : 'direct';\n}\n\n// Se não tem appointments, retorna vazio\nif (!appointments || appointments.length === 0) {\n  return {\n    json: {\n      tem_agendamento: false,\n      total_agendamentos: 0,\n      agendamentos: [],\n      proximo_agendamento: null,\n      source: sourceMethod\n    }\n  };\n}\n\n// Filtra apenas appointments FUTUROS e ATIVOS\nconst now = new Date();\nconst activeAppointments = appointments.filter(event => {\n  if (!event.startTime) return false;\n  \n  const startTime = new Date(event.startTime);\n  const isNotCancelled = event.appointmentStatus !== 'cancelled';\n  const isFuture = startTime > now;\n  \n  return isFuture && isNotCancelled;\n});\n\n// Ordena por data (mais próximo primeiro)\nactiveAppointments.sort((a, b) => \n  new Date(a.startTime) - new Date(b.startTime)\n);\n\nreturn {\n  json: {\n    tem_agendamento: activeAppointments.length > 0,\n    total_agendamentos: activeAppointments.length,\n    agendamentos: activeAppointments,\n    proximo_agendamento: activeAppointments[0] || null,\n    source: sourceMethod\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        -800
      ],
      "id": "a3febc4a-b5a1-4764-b171-c6c05018310a",
      "name": "Processar Appointments1",
      "notes": "Filtra e ordena appointments vindos de qualquer método"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "tem-agendamento",
              "name": "tem_agendamento",
              "value": "={{ $json.tem_agendamento }}",
              "type": "boolean"
            },
            {
              "id": "total-agendamentos",
              "name": "total_agendamentos",
              "value": "={{ $json.total_agendamentos }}",
              "type": "number"
            },
            {
              "id": "appointment-id",
              "name": "appointment_id",
              "value": "={{ $json.proximo_agendamento?.id || '' }}",
              "type": "string"
            },
            {
              "id": "data-agendamento",
              "name": "data_agendamento",
              "value": "={{ $json.proximo_agendamento?.startTime || '' }}",
              "type": "string"
            },
            {
              "id": "calendar-id",
              "name": "calendar_id",
              "value": "={{ $json.proximo_agendamento?.calendarId || '' }}",
              "type": "string"
            },
            {
              "id": "calendar-name",
              "name": "calendar_name",
              "value": "={{ $json.proximo_agendamento?.title || '' }}",
              "type": "string"
            },
            {
              "id": "status",
              "name": "appointment_status",
              "value": "={{ $json.proximo_agendamento?.appointmentStatus || '' }}",
              "type": "string"
            },
            {
              "id": "data-formatada",
              "name": "data_formatada",
              "value": "={{ $json.proximo_agendamento?.startTime ? new Date($json.proximo_agendamento.startTime).toLocaleString('pt-BR', { timeZone: 'America/New_York', dateStyle: 'short', timeStyle: 'short' }) : '' }}",
              "type": "string"
            },
            {
              "id": "mensagem-agente",
              "name": "mensagem_para_agente",
              "value": "={{ $json.tem_agendamento ? 'Lead JÁ possui agendamento ativo para ' + $json.data_formatada + ' (horário NY). NÃO agende novamente, apenas confirme o existente.' : 'Lead não possui agendamentos ativos. Pode prosseguir com novo agendamento.' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -400,
        -800
      ],
      "id": "5fcb4f23-bff8-473a-8c4e-05dce625006a",
      "name": "Formatar Resposta Final1",
      "notes": "Retorna estrutura padronizada com mensagem clara para o agente"
    }
  ],
  "pinData": {
    "Start": [
      {
        "json": {
          "API_KEY": "pit-7f333e6f-a839-4f58-b371-778fed9dc2ea",
          "email": "sibellee@hotmail.com",
          "telefone": "+14075150453",
          "location_id": "Bgi2hFMgiLLoRlOO0K5b",
          "calendar_id": "LvZWMISiyYnF8p7TrY7q",
          "startTime": "2025-11-19T20:00:00-05:00",
          "firstName": "Sibele",
          "lastName": ",",
          "lead_id": "e3Mv0608JZfcFOVTTms2",
          "estadoValue": null,
          "workPermitValue": null
        }
      }
    ]
  },
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Buscar Appointments do Contato1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Appointments do Contato1": {
      "main": [
        [
          {
            "node": "Busca OK?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca OK?1": {
      "main": [
        [
          {
            "node": "Processar Appointments1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Busca Alternativa1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Busca Alternativa1": {
      "main": [
        [
          {
            "node": "Buscar via Calendar Events1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar via Calendar Events1": {
      "main": [
        [
          {
            "node": "Processar Appointments1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Appointments1": {
      "main": [
        [
          {
            "node": "Formatar Resposta Final1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "d9acaf18-1481-4d86-822a-8e7835a7dab3",
  "meta": {
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "ai7BN4P1nRVufG2V",
  "tags": []
}