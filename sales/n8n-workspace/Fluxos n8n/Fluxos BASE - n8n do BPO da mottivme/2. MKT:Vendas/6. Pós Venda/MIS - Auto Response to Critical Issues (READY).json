{
  "name": "MIS - Auto Response to Critical Issues (READY)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes"
            }
          ]
        }
      },
      "id": "e1997a98-b210-41c8-9b0c-8add7edab3c6",
      "name": "Schedule - Every 5min",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        -1744,
        240
      ]
    },
    {
      "parameters": {
        "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/open?priority=critical&limit=10",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-vercel-protection-bypass",
              "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
            }
          ]
        },
        "options": {}
      },
      "id": "23c37ad6-a045-43e9-84c8-e2b5684ef062",
      "name": "HTTP - Get Open Critical Issues",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -1552,
        240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-001",
              "leftValue": "={{ $json.issues ? $json.issues.length : 0 }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "cc9221b2-0655-4a62-9ebc-e67d406a60ed",
      "name": "Filter - Has Issues",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1344,
        240
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "9c8e5fca-55a4-408a-bf82-41821225c1c9",
      "name": "Split Issues",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1152,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "// Gerar prompt contextual para IA\nconst issue = $input.first().json;\n\nconst metadata = typeof issue.metadata === 'string' \n  ? JSON.parse(issue.metadata) \n  : (issue.metadata || {});\n\nconst prompt = `Você é um assistente inteligente da Mottivme.\n\nUm problema foi detectado:\n\nTipo: ${issue.issue_type}\nCliente: ${issue.customer_name || 'Não identificado'}\nPrioridade: ${issue.priority}\nDetectado em: ${new Date(issue.detected_at).toLocaleString('pt-BR')}\n\n${metadata?.message_preview ? `Mensagem do cliente:\\n${metadata.message_preview}` : ''}\n\n${metadata?.sentiment ? `Sentimento: ${metadata.sentiment}` : ''}\n${metadata?.keywords?.length > 0 ? `Palavras-chave: ${metadata.keywords.join(', ')}` : ''}\n\n${metadata?.team_analysis ? `Análise do time:\\n${metadata.team_analysis}` : ''}\n\nGere uma resposta profissional e empática para resolver este problema.\nSeja breve, direto e ofereça soluções concretas.\nSe for problema técnico, ofereça suporte imediato.\nSe for cliente insatisfeito, mostre empatia e compromisso em resolver.\n\nResposta:`;\n\nreturn [{\n  json: {\n    ...issue,\n    ai_prompt: prompt,\n    metadata: metadata\n  }\n}];"
      },
      "id": "c4be81b9-47d7-48a3-bc3e-4d9c1089e7dd",
      "name": "Code - Prepare AI Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -944,
        144
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=SUA_GEMINI_API_KEY_AQUI",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": {{ JSON.stringify($json.ai_prompt) }}\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.7,\n    \"maxOutputTokens\": 500\n  }\n}",
        "options": {}
      },
      "id": "1251b9c8-deb0-4cb6-8667-951988965e3d",
      "name": "Google Gemini - Generate Response",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -752,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extrair resposta do Gemini\nconst geminiResponse = $input.first().json;\nconst previousData = $('Code - Prepare AI Prompt').first().json;\n\nlet aiResponse = 'Erro ao gerar resposta';\n\nif (geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text) {\n  aiResponse = geminiResponse.candidates[0].content.parts[0].text.trim();\n}\n\nreturn [{\n  json: {\n    ...previousData,\n    ai_response: aiResponse\n  }\n}];"
      },
      "id": "144c7808-806a-48fa-8c7f-fa81fb326902",
      "name": "Code - Extract AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        144
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-phone-001",
              "leftValue": "={{ $json.customer_phone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "400a5f7f-ff29-4398-a15b-4329fcdbe42f",
      "name": "Filter - Has Phone",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -352,
        144
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://SUA-EVOLUTION-API.com/message/sendText",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "SEU_TOKEN_EVOLUTION_AQUI"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": {{ JSON.stringify($json.customer_phone) }},\n  \"text\": {{ JSON.stringify($json.ai_response) }}\n}",
        "options": {}
      },
      "id": "e7fbaf88-b335-4f33-9a60-20cf6346df3d",
      "name": "HTTP - Send WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -144,
        32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/action",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-vercel-protection-bypass",
              "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"issue_id\": {{ JSON.stringify($json.id) }},\n  \"action_type\": \"automated_response\",\n  \"action_description\": \"Resposta automática enviada via WhatsApp: \" + {{ JSON.stringify($json.ai_response) }},\n  \"taken_by\": \"SYSTEM_AUTO\",\n  \"success\": true\n}",
        "options": {}
      },
      "id": "e220a9e0-277d-4319-8245-ccc8a44180ed",
      "name": "HTTP - Log Action in CRT",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        64,
        32
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://admin-dashboard-6pr21y8gx-marcosdanielsfs-projects.vercel.app/api/issues/action",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-vercel-protection-bypass",
              "value": "k0YEgeZz2JylRDNETMuJKnk4SpUWTaeH"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"issue_id\": {{ JSON.stringify($json.id) }},\n  \"action_type\": \"no_phone_available\",\n  \"action_description\": \"Não foi possível enviar resposta automática - cliente sem telefone registrado. Resposta gerada: \" + {{ JSON.stringify($json.ai_response) }},\n  \"taken_by\": \"SYSTEM_AUTO\",\n  \"success\": false\n}",
        "options": {}
      },
      "id": "aafeb801-a0be-4910-ba24-9a740ee5749e",
      "name": "HTTP - Log No Phone",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        -144,
        240
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule - Every 5min": {
      "main": [
        [
          {
            "node": "HTTP - Get Open Critical Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP - Get Open Critical Issues": {
      "main": [
        [
          {
            "node": "Filter - Has Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter - Has Issues": {
      "main": [
        [
          {
            "node": "Split Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Issues": {
      "main": [
        [
          {
            "node": "Code - Prepare AI Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Prepare AI Prompt": {
      "main": [
        [
          {
            "node": "Google Gemini - Generate Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini - Generate Response": {
      "main": [
        [
          {
            "node": "Code - Extract AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Extract AI Response": {
      "main": [
        [
          {
            "node": "Filter - Has Phone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter - Has Phone": {
      "main": [
        [
          {
            "node": "HTTP - Send WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP - Log No Phone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP - Send WhatsApp": {
      "main": [
        [
          {
            "node": "HTTP - Log Action in CRT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP - Log Action in CRT": {
      "main": [
        [
          {
            "node": "Split Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP - Log No Phone": {
      "main": [
        [
          {
            "node": "Split Issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "2bdb2880-3b9e-4667-bf45-aff3f9c747bc",
  "meta": {
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "9QSS9WW2kRJkOI6o",
  "tags": []
}