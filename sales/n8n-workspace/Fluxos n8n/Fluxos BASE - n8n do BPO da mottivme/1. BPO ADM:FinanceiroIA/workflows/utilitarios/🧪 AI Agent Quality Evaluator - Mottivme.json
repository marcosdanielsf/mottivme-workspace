{
  "name": "üß™ AI Agent Quality Evaluator - Mottivme",
  "nodes": [
    {
      "parameters": {
        "name": "buscar_cliente_fornecedor",
        "description": "Use esta ferramenta para consultar dados de clientes ou fornecedores no banco de dados. Voc√™ pode buscar por nome, documento (CPF/CNPJ) ou telefone.",
        "workflowId": {
          "__rl": true,
          "value": "Uq3cdvnPIDwT2F8T",
          "mode": "list",
          "cachedResultUrl": "/workflow/Uq3cdvnPIDwT2F8T",
          "cachedResultName": "[TOOL] Buscar Cliente/Fornecedor"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -1552,
        -624
      ],
      "id": "725a3669-9870-4cc2-ace1-bde57e3493a7",
      "name": "Buscar Cliente/Fornecedor"
    },
    {
      "parameters": {
        "name": "fluxo_caixa_projetado",
        "description": "Consulta fluxo de caixa projetado dos pr√≥ximos 30 dias. Mostra entradas, sa√≠das e saldo acumulado.",
        "workflowId": {
          "__rl": true,
          "value": "C4kPTHRzifQ0CIMy",
          "mode": "list",
          "cachedResultUrl": "/workflow/C4kPTHRzifQ0CIMy",
          "cachedResultName": "[TOOL] Fluxo de Caixa Projetado"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -1424,
        -624
      ],
      "id": "2f611443-5c44-4462-9515-25fd357c5b23",
      "name": "Fluxo de Caixa Projetado"
    },
    {
      "parameters": {
        "name": "criar_parcelamento",
        "description": "Cria parcelamento (compra/venda parcelada). Gera todas as parcelas automaticamente.",
        "workflowId": {
          "__rl": true,
          "value": "lbOH0pP3mOyEAkXQ",
          "mode": "list",
          "cachedResultUrl": "/workflow/lbOH0pP3mOyEAkXQ",
          "cachedResultName": "[TOOL] Criar Parcelamento"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -1296,
        -624
      ],
      "id": "464e8bf5-93f2-4c7e-8f2f-6854e11d5b84",
      "name": "Criar Parcelamento"
    },
    {
      "parameters": {
        "name": "criar_recorrencia",
        "description": "Cria recorr√™ncia mensal (aluguel, sal√°rio, assinatura). Gera movimenta√ß√µes automaticamente todo m√™s.",
        "workflowId": {
          "__rl": true,
          "value": "h2JGa8pTPjTtA5vn",
          "mode": "list",
          "cachedResultUrl": "/workflow/h2JGa8pTPjTtA5vn",
          "cachedResultName": "[TOOL] Criar Recorr√™ncia"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -1168,
        -624
      ],
      "id": "f68be1e1-086a-4ae1-8d52-6901f989c400",
      "name": "Criar Recorr√™ncia"
    },
    {
      "parameters": {
        "name": "relatorio_inadimplencia",
        "description": "Relat√≥rio detalhado de inadimpl√™ncia. Mostra clientes em atraso, valores e n√≠vel de risco.",
        "workflowId": {
          "__rl": true,
          "value": "zmj9M6HKSrdxJuZb",
          "mode": "list",
          "cachedResultUrl": "/workflow/zmj9M6HKSrdxJuZb",
          "cachedResultName": "[TOOL] Relat√≥rio de Inadimpl√™ncia"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -1040,
        -624
      ],
      "id": "a588e98e-c70a-40f1-9a70-0afff7e2d853",
      "name": "Relat√≥rio de Inadimpl√™ncia"
    },
    {
      "parameters": {
        "name": "dashboard_kpis",
        "description": "Dashboard com indicadores financeiros: resultado do m√™s, contas a pagar/receber, inadimpl√™ncia, proje√ß√µes. Use quando pedirem resumo financeiro ou vis√£o geral.",
        "workflowId": {
          "__rl": true,
          "value": "s6HIkSZxkKL90B18",
          "mode": "list",
          "cachedResultUrl": "/workflow/s6HIkSZxkKL90B18",
          "cachedResultName": "[TOOL] Dashboard KPIs"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -912,
        -624
      ],
      "id": "f570685d-0dd0-48f8-934f-3a0fa4af4c3d",
      "name": "Dashboard KPIs"
    },
    {
      "parameters": {
        "name": "fin_centros_custo",
        "description": "Consulta centros de custo. Use acao='relatorio' para ver despesas por centro ou acao='listar' para ver centros dispon√≠veis.",
        "workflowId": {
          "__rl": true,
          "value": "Vu6Uk9NqVD5KTNqM",
          "mode": "list",
          "cachedResultUrl": "/workflow/Vu6Uk9NqVD5KTNqM",
          "cachedResultName": "[TOOL] Centros de Custo"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -784,
        -624
      ],
      "id": "2a734a26-64fc-4ab6-9dda-5fcf28f55bb0",
      "name": "Centros de Custo"
    },
    {
      "parameters": {
        "name": "orcamento_realizado",
        "description": "Relat√≥rio de or√ßamento vs realizado. Compara o planejado com o executado por categoria.",
        "workflowId": {
          "__rl": true,
          "value": "vStkWfdwFAg0vqZw",
          "mode": "list",
          "cachedResultUrl": "/workflow/vStkWfdwFAg0vqZw",
          "cachedResultName": "[TOOL] Or√ßamento vs Realizado"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -656,
        -624
      ],
      "id": "fa2b2beb-ae7d-4331-82c2-464158efbd51",
      "name": "Or√ßamento vs Realizado"
    },
    {
      "parameters": {
        "name": "dre_simplificado",
        "description": "DRE - Demonstrativo de Resultado do Exerc√≠cio. Mostra receitas, despesas e resultado dos √∫ltimos meses.",
        "workflowId": {
          "__rl": true,
          "value": "9N4DwvjLk6WsJm64",
          "mode": "list",
          "cachedResultUrl": "/workflow/9N4DwvjLk6WsJm64",
          "cachedResultName": "[TOOL] DRE Simplificado"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -528,
        -624
      ],
      "id": "6b51ffba-7553-4f6e-ae8f-ae60ea6f8705",
      "name": "DRE Simplificado"
    },
    {
      "parameters": {
        "name": "conciliacao_bancaria",
        "description": "Concilia√ß√£o banc√°ria. Use acao='pendentes' para ver itens n√£o conciliados ou acao='conciliar' para conciliar um item espec√≠fico.",
        "workflowId": {
          "__rl": true,
          "value": "Z1IFeHsHZYnooRMs",
          "mode": "list",
          "cachedResultUrl": "/workflow/Z1IFeHsHZYnooRMs",
          "cachedResultName": "[TOOL] Concilia√ß√£o Banc√°ria"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -400,
        -624
      ],
      "id": "def0dcd4-1376-4a7f-86a2-6dd4b283b59e",
      "name": "Concilia√ß√£o Banc√°ria"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list"
        },
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1808,
        -624
      ],
      "id": "2a88bf04-ba02-485e-8418-785487668424",
      "name": "OpenAI GPT-4o2",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "name": "buscar_movimentacoes",
        "description": "Busca movimenta√ß√µes financeiras existentes. Filtre por data, tipo, status de pagamento.",
        "workflowId": {
          "__rl": true,
          "value": "2b7qY6FV4SksBgXV",
          "mode": "list",
          "cachedResultUrl": "/workflow/2b7qY6FV4SksBgXV",
          "cachedResultName": "[TOOL] Buscar Movimenta√ß√µes"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -272,
        -624
      ],
      "id": "5ec03030-3dd5-4bb7-afe4-22cfdebac38f",
      "name": "Buscar Movimenta√ß√µes2"
    },
    {
      "parameters": {
        "name": "salvar_movimentacao",
        "description": "Salva nova movimenta√ß√£o financeira. IMPORTANTE: Use APENAS ap√≥s confirma√ß√£o do usu√°rio.",
        "workflowId": {
          "__rl": true,
          "value": "UZSQ0ovulSKyfbfL",
          "mode": "list",
          "cachedResultUrl": "/workflow/UZSQ0ovulSKyfbfL",
          "cachedResultName": "[TOOL] Salvar Movimenta√ß√£o Financeira"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -144,
        -624
      ],
      "id": "5c59309b-77f4-4cca-8916-516c13d09043",
      "name": "Salvar Movimenta√ß√£o2"
    },
    {
      "parameters": {
        "name": "criar_cliente_fornecedor",
        "description": "Cria novo cliente ou fornecedor no banco de dados.",
        "workflowId": {
          "__rl": true,
          "value": "dEPGbp6hUQbW1g5a",
          "mode": "list",
          "cachedResultUrl": "/workflow/dEPGbp6hUQbW1g5a",
          "cachedResultName": "[TOOL] Criar Cliente/Fornecedor"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        -16,
        -624
      ],
      "id": "be6c43f8-1df8-47f1-b1f9-81a295d29efa",
      "name": "Criar Cliente/Fornecedor2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagem }}",
        "options": {
          "systemMessage": "=**CONTEXTO**\nDATA: {{ $now.format('FFFF') }}  \nTEL/WHATSAPP: {{ $('Info').first().json.telefone }}\nID_CONVERSA: {{ $json.lead_id_firstItem }}\nRESPONS√ÅVEL: {{ $('Info').first().json.responsavel_firstItem }}\nNOME DO CLIENTE: {{ $('Info').first().json.nome_extraido }}\nFUSO: America/New_York\nCONTACT_ID: {{ $('Info').first().json.lead_id_firstItem }}\nAPI_KEY: {{ $('Info').first().json.API_KEY  }}\nLOCATION_ID: {{ $('Info').first().json.location_id }}\n\n{{ $('Info').first().json.output_preview && '**MSG_PENDENTE**: '+$('Info').first().json.output_preview || \"\" }}\n\n# PAPEL\n\nVoc√™ √© a assistente financeira IA da Mottivme Sales, especializada em BPO Financeiro completo. Sua miss√£o √© auxiliar no processamento, registro e an√°lise de movimenta√ß√µes financeiras via WhatsApp.\n\n# PERSONALIDADE\n\n* Profissional e confi√°vel\n* Precisa e meticulosa com valores e datas\n* Eficiente e organizada\n* Clara e objetiva\n* Respostas curtas (m√°ximo 300 caracteres quando poss√≠vel)\n\n# CONTEXTO\n\n* Empresa: Mottivme Sales - Consultoria e Gest√£o Comercial\n* Sistema: Supabase PostgreSQL\n* Moeda: Real Brasileiro (BRL)\n* Tipos de Entidade: PF (Pessoa F√≠sica) ou PJ (Pessoa Jur√≠dica)\n\n# FERRAMENTAS DISPON√çVEIS (14 tools)\n\n## Cadastros e Consultas\n1. **buscar_cliente_fornecedor** - Busca clientes/fornecedores\n2. **criar_cliente_fornecedor** - Cria novo cliente/fornecedor\n3. **listar_categorias** - Lista categorias financeiras\n\n## Movimenta√ß√µes\n4. **buscar_movimentacoes** - Consulta movimenta√ß√µes com filtros\n5. **salvar_movimentacao** - Salva nova movimenta√ß√£o (ap√≥s confirma√ß√£o)\n\n## Parcelamentos e Recorr√™ncias\n6. **criar_parcelamento** - Cria compra/venda parcelada\n7. **criar_recorrencia** - Cria despesa/receita mensal recorrente\n\n## Relat√≥rios e An√°lises\n8. **fluxo_caixa_projetado** - Proje√ß√£o de caixa 30 dias\n9. **relatorio_inadimplencia** - Clientes inadimplentes\n10. **dashboard_kpis** - Vis√£o geral/resumo financeiro\n11. **dre_simplificado** - DRE dos √∫ltimos meses\n12. **orcamento_realizado** - Planejado vs executado\n13. **fin_centros_custo** - Despesas por centro de custo\n14. **conciliacao_bancaria** - Concilia√ß√£o banc√°ria\n\n# QUANDO USAR CADA FERRAMENTA\n\n**\"Como est√£o as finan√ßas?\" / \"Resumo financeiro\" / \"Vis√£o geral\"**\n‚Üí Use **dashboard_kpis**\n\n**\"Quanto gastamos este m√™s?\" / \"Despesas por √°rea\"**\n‚Üí Use **fin_centros_custo** com acao='relatorio'\n\n**\"Estamos dentro do or√ßamento?\" / \"Meta vs realizado\"**\n‚Üí Use **orcamento_realizado**\n\n**\"Como foi o resultado dos √∫ltimos meses?\" / \"Lucro/preju√≠zo\"**\n‚Üí Use **dre_simplificado**\n\n**\"Tem algo para conciliar?\" / \"Extrato banc√°rio\"**\n‚Üí Use **conciliacao_bancaria** com acao='pendentes'\n\n**\"Quem est√° devendo?\" / \"Inadimplentes\"**\n‚Üí Use **relatorio_inadimplencia**\n\n**\"Como vai ficar o caixa?\" / \"Proje√ß√£o\"**\n‚Üí Use **fluxo_caixa_projetado**\n\n# FLUXO DE PROCESSAMENTO\n\n## Para Entrada de Movimenta√ß√£o:\n1. Extraia: tipo, valor, descri√ß√£o, data\n2. Use **listar_categorias** para identificar a categoria\n3. Use **buscar_cliente_fornecedor** se mencionado algum nome\n4. Pergunte o centro de custo para despesas\n5. Apresente resumo e pe√ßa confirma√ß√£o\n6. APENAS ap√≥s \"Sim\", use **salvar_movimentacao**\n\n## Para Parcelamento:\n1. Identifique: tipo, valor total, parcelas, data primeira\n2. Calcule e mostre valor de cada parcela\n3. Pe√ßa confirma√ß√£o\n4. Use **criar_parcelamento** ap√≥s \"Sim\"\n\n## Para Recorr√™ncia:\n1. Identifique: tipo, descri√ß√£o, valor, dia do m√™s\n2. Apresente resumo\n3. Pe√ßa confirma√ß√£o\n4. Use **criar_recorrencia** ap√≥s \"Sim\"\n\n# VALIDA√á√ïES\n\n* Valores: num√©ricos positivos, m√°ximo 2 decimais\n* Datas: converter para YYYY-MM-DD\n* Parcelas: entre 2 e 120\n* Dia vencimento: entre 1 e 31\n* Tipo entidade: PJ √© padr√£o se n√£o informado\n\n# REGRAS IMPORTANTES\n\n1. SEMPRE confirme antes de salvar\n2. SEMPRE verifique duplicatas\n3. NUNCA assuma informa√ß√µes n√£o fornecidas\n4. Em d√∫vida, PERGUNTE\n5. Para despesas, pergunte o centro de custo\n6. Use dashboard_kpis para vis√µes gerais\n\n# MENSAGENS PADR√ÉO\n\n**Sucesso:** ‚úÖ [A√ß√£o] realizada!\n**Erro:** ‚ùå Erro: [motivo]\n**Falta info:** ‚ö†Ô∏è Preciso de: [campos]\n\n# DATA ATUAL\n{{ $now.format('DD/MM/YYYY HH:mm') }}\n\n\n## HIST√ìRICO DE CONVERSAS ANTIGAS\n\n{{ $json.mensagens_antigas_firstitem }}\n\n---\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -912,
        -976
      ],
      "id": "6dfa9d2c-6d4f-44cd-bbc4-224e3853f277",
      "name": "Agente Financeiro IA2"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "nome_split_firstItem",
              "type": "any"
            },
            {
              "name": "agente_ia_firstItem",
              "type": "any"
            },
            {
              "name": "mensagem",
              "type": "any"
            },
            {
              "name": "output_preview_firstItem",
              "type": "any"
            },
            {
              "name": "_embedded_contacts_firstItem",
              "type": "any"
            },
            {
              "name": "whatsapp_firstItem",
              "type": "any"
            },
            {
              "name": "email_firstItem",
              "type": "any"
            },
            {
              "name": "_embedded_leads_firstItem",
              "type": "any"
            },
            {
              "name": "responsavel_firstItem",
              "type": "any"
            },
            {
              "name": "chat_id_firstItem",
              "type": "any"
            },
            {
              "name": "lead_id_firstItem",
              "type": "any"
            },
            {
              "name": "nome_firstItem",
              "type": "any"
            },
            {
              "name": "mensagens_antigas_firstitem"
            },
            {
              "name": "calendarID"
            },
            {
              "name": "location_id"
            },
            {
              "name": "API_KEY"
            },
            {
              "name": "motive"
            }
          ]
        }
      },
      "id": "7e5ff21e-c05d-42a9-881f-4dcb44cae8c1",
      "typeVersion": 1.1,
      "name": "Start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        -2112,
        -976
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "output-01",
              "name": "output",
              "value": "={{ $json.output }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "6f13682e-9a0d-4ecc-837e-ba419c096909",
      "name": "Formatar Saida",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1104,
        -1088
      ]
    },
    {
      "parameters": {
        "name": "listar_categorias",
        "description": "Lista todas as categorias financeiras dispon√≠veis (receitas e despesas).",
        "workflowId": {
          "__rl": true,
          "value": "Acllbvk5jMEMDzd7",
          "mode": "list",
          "cachedResultUrl": "/workflow/Acllbvk5jMEMDzd7",
          "cachedResultName": "[TOOL] Listar Categorias"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2,
      "position": [
        112,
        -624
      ],
      "id": "caba194c-a88d-442a-9c64-2d948a1d0d60",
      "name": "Listar Categorias"
    },
    {
      "parameters": {
        "jsCode": "// Extrair dados do campo mensagem\nconst input = $input.first().json;\nconst mensagemCompleta = input.mensagem;\n\n// Regex para extrair: telefone + nome + mensagem\n// Formato: \"5511936180422 Marcos Daniel:\\n\\nQuais clientes est√£o ativos?\"\nconst regex = /^(\\d+)\\s+(.+?):\\n\\n(.+)$/s;\nconst match = mensagemCompleta.match(regex);\n\nlet telefone = '';\nlet nome = '';\nlet mensagem = '';\n\nif (match) {\n  telefone = match[1];           // 5511936180422\n  nome = match[2];               // Marcos Daniel\n  mensagem = match[3].trim();    // Quais clientes est√£o ativos?\n} else {\n  // Fallback se n√£o bater o padr√£o\n  mensagem = mensagemCompleta;\n}\n\nreturn {\n  // Dados extra√≠dos\n  telefone,\n  nome,\n  mensagem,\n  \n  // Manter dados originais\n  ...input,\n  \n  // Sobrescrever com dados limpos\n  telefone_extraido: telefone,\n  nome_extraido: nome,\n  mensagem_limpa: mensagem\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1824,
        -976
      ],
      "id": "783791bc-9538-409b-aa2c-6fb1ad2a8014",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0f11d21d-51b4-4a4b-9cd9-1a7147b3660c",
              "name": "mensagem",
              "value": "={{ $json.mensagem_limpa }}",
              "type": "string"
            },
            {
              "id": "02",
              "name": "telefone",
              "value": "={{ $json.telefone_extraido }}",
              "type": "string"
            },
            {
              "id": "85154002-32e4-4376-8d42-13f02fe7ec8e",
              "name": "motive",
              "value": "={{ $json.motive }}",
              "type": "string"
            },
            {
              "id": "9bb5aeb2-3f0a-4f71-aca6-e98773225335",
              "name": "lead_id_firstItem",
              "value": "={{ $json.lead_id_firstItem }}",
              "type": "string"
            },
            {
              "id": "034663c7-e08d-4188-9d3b-cb6d594f4c33",
              "name": "location_id",
              "value": "={{ $json.location_id }}",
              "type": "string"
            },
            {
              "id": "3a324dd9-24ed-4162-89bc-fd4efaa27bc8",
              "name": "API_KEY",
              "value": "={{ $json.API_KEY }}",
              "type": "string"
            },
            {
              "id": "8c98f58b-934a-4df5-8799-0681af9116d1",
              "name": "telefone_extraido",
              "value": "=+{{ $json.telefone_extraido }}",
              "type": "string"
            },
            {
              "id": "e9b0c68d-33ef-4fb6-a1fb-82bc6e6300ce",
              "name": "nome_extraido",
              "value": "={{ $json.nome_extraido }}",
              "type": "string"
            },
            {
              "id": "cefebd60-eb66-47fc-aac2-8b24f0d775cc",
              "name": "mensagens_antigas_firstitem",
              "value": "={{ $json.mensagens_antigas_firstitem }}",
              "type": "string"
            },
            {
              "id": "b2c4b704-4947-4c04-8d51-85453a4a2665",
              "name": "responsavel_firstItem",
              "value": "={{ $json.responsavel_firstItem }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1600,
        -976
      ],
      "id": "698a7992-492e-4a01-b5b4-75c4b2f5f632",
      "name": "Info"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [
        -2256,
        -848
      ],
      "id": "d6228255-59f8-4566-9022-0a2abe0878e0",
      "name": "When chat message received",
      "webhookId": "665e6b22-012e-443b-83d3-804e0666ba50"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagem }}",
        "options": {
          "systemMessage": "=**CONTEXTO**\nDATA: {{ $now.format('FFFF') }}  \nTEL/WHATSAPP: {{ $('üìã Preparar Contexto Teste').first().json.telefone }}\nID_CONVERSA: {{ $json.lead_id_firstItem }}\nRESPONS√ÅVEL: {{ $('üìã Preparar Contexto Teste').first().json.responsavel_firstItem }}\nNOME DO CLIENTE: {{ $('üìã Preparar Contexto Teste').first().json.nome_extraido }}\nFUSO: America/New_York\nCONTACT_ID: {{ $('üìã Preparar Contexto Teste').first().json.lead_id_firstItem }}\nAPI_KEY: {{ $('üìã Preparar Contexto Teste').first().json.API_KEY  }}\nLOCATION_ID: {{ $('üìã Preparar Contexto Teste').first().json.location_id }}\n\n{{ $('üìã Preparar Contexto Teste').first().json.output_preview && '**MSG_PENDENTE**: '+$('üìã Preparar Contexto Teste').first().json.output_preview || \"\" }}\n# PAPEL\n\nVoc√™ √© a assistente financeira IA da Mottivme Sales, especializada em BPO Financeiro completo. Sua miss√£o √© auxiliar no processamento, registro e an√°lise de movimenta√ß√µes financeiras via WhatsApp.\n\n# PERSONALIDADE\n\n* Profissional e confi√°vel\n* Precisa e meticulosa com valores e datas\n* Eficiente e organizada\n* Clara e objetiva\n* Respostas curtas (m√°ximo 300 caracteres quando poss√≠vel)\n\n# CONTEXTO\n\n* Empresa: Mottivme Sales - Consultoria e Gest√£o Comercial\n* Sistema: Supabase PostgreSQL\n* Moeda: Real Brasileiro (BRL)\n* Tipos de Entidade: PF (Pessoa F√≠sica) ou PJ (Pessoa Jur√≠dica)\n\n# FERRAMENTAS DISPON√çVEIS (14 tools)\n\n## Cadastros e Consultas\n1. **buscar_cliente_fornecedor** - Busca clientes/fornecedores\n2. **criar_cliente_fornecedor** - Cria novo cliente/fornecedor\n3. **listar_categorias** - Lista categorias financeiras\n\n## Movimenta√ß√µes\n4. **buscar_movimentacoes** - Consulta movimenta√ß√µes com filtros\n5. **salvar_movimentacao** - Salva nova movimenta√ß√£o (ap√≥s confirma√ß√£o)\n\n## Parcelamentos e Recorr√™ncias\n6. **criar_parcelamento** - Cria compra/venda parcelada\n7. **criar_recorrencia** - Cria despesa/receita mensal recorrente\n\n## Relat√≥rios e An√°lises\n8. **fluxo_caixa_projetado** - Proje√ß√£o de caixa 30 dias\n9. **relatorio_inadimplencia** - Clientes inadimplentes\n10. **dashboard_kpis** - Vis√£o geral/resumo financeiro\n11. **dre_simplificado** - DRE dos √∫ltimos meses\n12. **orcamento_realizado** - Planejado vs executado\n13. **fin_centros_custo** - Despesas por centro de custo\n14. **conciliacao_bancaria** - Concilia√ß√£o banc√°ria\n\n# QUANDO USAR CADA FERRAMENTA\n\n**\"Como est√£o as finan√ßas?\" / \"Resumo financeiro\" / \"Vis√£o geral\"**\n‚Üí Use **dashboard_kpis**\n\n**\"Quanto gastamos este m√™s?\" / \"Despesas por √°rea\"**\n‚Üí Use **fin_centros_custo** com acao='relatorio'\n\n**\"Estamos dentro do or√ßamento?\" / \"Meta vs realizado\"**\n‚Üí Use **orcamento_realizado**\n\n**\"Como foi o resultado dos √∫ltimos meses?\" / \"Lucro/preju√≠zo\"**\n‚Üí Use **dre_simplificado**\n\n**\"Tem algo para conciliar?\" / \"Extrato banc√°rio\"**\n‚Üí Use **conciliacao_bancaria** com acao='pendentes'\n\n**\"Quem est√° devendo?\" / \"Inadimplentes\"**\n‚Üí Use **relatorio_inadimplencia**\n\n**\"Como vai ficar o caixa?\" / \"Proje√ß√£o\"**\n‚Üí Use **fluxo_caixa_projetado**\n\n# FLUXO DE PROCESSAMENTO\n\n## Para Entrada de Movimenta√ß√£o:\n1. Extraia: tipo, valor, descri√ß√£o, data\n2. Use **listar_categorias** para identificar a categoria\n3. Use **buscar_cliente_fornecedor** se mencionado algum nome\n4. Pergunte o centro de custo para despesas\n5. Apresente resumo e pe√ßa confirma√ß√£o\n6. APENAS ap√≥s \"Sim\", use **salvar_movimentacao**\n\n## Para Parcelamento:\n1. Identifique: tipo, valor total, parcelas, data primeira\n2. Calcule e mostre valor de cada parcela\n3. Pe√ßa confirma√ß√£o\n4. Use **criar_parcelamento** ap√≥s \"Sim\"\n\n## Para Recorr√™ncia:\n1. Identifique: tipo, descri√ß√£o, valor, dia do m√™s\n2. Apresente resumo\n3. Pe√ßa confirma√ß√£o\n4. Use **criar_recorrencia** ap√≥s \"Sim\"\n\n# VALIDA√á√ïES\n\n* Valores: num√©ricos positivos, m√°ximo 2 decimais\n* Datas: converter para YYYY-MM-DD\n* Parcelas: entre 2 e 120\n* Dia vencimento: entre 1 e 31\n* Tipo entidade: PJ √© padr√£o se n√£o üìã Preparar Contexto Testermado\n\n# REGRAS IMPORTANTES\n\n1. SEMPRE confirme antes de salvar\n2. SEMPRE verifique duplicatas\n3. NUNCA assuma Inforrma√ß√µes n√£o fornecidas\n4. Em d√∫vida, PERGUNTE\n5. Para despesas, pergunte o centro de custo\n6. Use dashboard_kpis para vis√µes gerais\n\n# MENSAGENS PADR√ÉO\n\n**Sucesso:** ‚úÖ [A√ß√£o] realizada!\n**Erro:** ‚ùå Erro: [motivo]\n**Falta üìã Preparar Contexto Teste:** ‚ö†Ô∏è Preciso de: [campos]\n\n# DATA ATUAL\n{{ $now.format('DD/MM/YYYY HH:mm') }}\n\n\n---\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -928,
        -848
      ],
      "id": "cd9334bd-e91b-42d1-9b0e-3d9c1345a1bb",
      "name": "Agente Financeiro IA"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('üìã Preparar Contexto Teste').item.json.mensagem }}",
        "contextWindowLength": 1000
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -1680,
        -624
      ],
      "id": "49b477b9-8f62-4cdc-a69b-a4643ce6d724",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      }
    },
    {
      "parameters": {
        "content": "## üß™ AI AGENT QUALITY EVALUATOR\n\n### Fluxo:\n1. **Chat Trigger** ‚Üí Recebe mensagem de teste\n2. **Preparar Contexto** ‚Üí Monta dados do teste\n3. **Agente Financeiro** ‚Üí Executa o agente\n4. **Avaliador GPT-4o** ‚Üí Avalia qualidade\n5. **Avaliador Gemini** ‚Üí Segunda avalia√ß√£o\n6. **Consolidar Scores** ‚Üí Combina avalia√ß√µes\n7. **Salvar Supabase** ‚Üí Persiste hist√≥rico\n\n### M√©tricas Avaliadas:\n- üéØ Tool Selection (20%)\n- ‚úÖ Confirmation Protocol (15%)\n- üìù Brevity (10%)\n- üëî Professionalism (10%)\n- üìä Data Accuracy (20%)\n- üìè Rule Adherence (10%)\n- üé≠ Context Usage (10%)\n- üé® Format Compliance (5%)",
        "height": 480,
        "width": 340,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2576,
        -1216
      ],
      "id": "275c5a93-7407-4871-bc1a-a80905dd031d",
      "name": "üìã Documenta√ß√£o"
    },
    {
      "parameters": {
        "content": "## üìä M√âTRICAS DE QUALIDADE\n\n### Pesos:\n| M√©trica | Peso |\n|---------|------|\n| Tool Selection | 20% |\n| Confirmation | 15% |\n| Brevity | 10% |\n| Professionalism | 10% |\n| Data Accuracy | 20% |\n| Rule Adherence | 10% |\n| Context Usage | 10% |\n| Format | 5% |\n\n### Grades:\n- **A**: 90-100 ‚úÖ\n- **B**: 75-89 ‚úÖ\n- **C**: 60-74 ‚ö†Ô∏è\n- **D**: 40-59 ‚ùå\n- **F**: 0-39 ‚ùå",
        "height": 380,
        "width": 260,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        192,
        -1520
      ],
      "id": "bca36a5d-f6bc-4029-928e-5c1aa50227f0",
      "name": "üìä M√©tricas"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "agent_output",
              "name": "agent_output",
              "value": "={{ $json.output }}",
              "type": "string"
            },
            {
              "id": "test_id",
              "name": "test_id",
              "value": "={{ $('üìã Preparar Contexto Teste').item.json.test_id }}",
              "type": "string"
            },
            {
              "id": "user_input",
              "name": "user_input",
              "value": "={{ $('üìã Preparar Contexto Teste').item.json.mensagem }}",
              "type": "string"
            },
            {
              "id": "session_id",
              "name": "session_id",
              "value": "={{ $('üìã Preparar Contexto Teste').item.json.sessionID }}",
              "type": "string"
            },
            {
              "id": "response_time_ms",
              "name": "response_time_ms",
              "value": "={{ Date.now() - new Date($('üìã Preparar Contexto Teste').item.json.test_start).getTime() }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        384,
        -464
      ],
      "id": "3ed9a453-c781-472f-8e15-f2301036cb54",
      "name": "üì§ Capturar Output"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        680,
        -40
      ],
      "id": "69ac09f6-5133-4cdd-ac11-66f35784ccb8",
      "name": "OpenAI GPT-4o (Evaluator)",
      "credentials": {
        "openAiApi": {
          "id": "WEENPovt22LUaeRp",
          "name": "OpenAi - Marcos"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# AVALIA√á√ÉO DE QUALIDADE DO AGENTE\n\n## CONTEXTO DO TESTE\n**Input do Usu√°rio:** {{ $json.user_input }}\n**Nome do Usu√°rio no Contexto:** {{ $('üìã Preparar Contexto Teste').item.json.nome_extraido }}\n## RESPOSTA DO AGENTE\n{{ $json.agent_output }}\n\n---\n\n## SUA TAREFA\nAvalie a resposta do agente em cada m√©trica abaixo (0-100).\n\nRetorne APENAS um JSON v√°lido com esta estrutura:\n\n```json\n{\n  \"scores\": {\n    \"tool_selection\": <0-100>,\n    \"confirmation_protocol\": <0-100>,\n    \"brevity\": <0-100>,\n    \"professionalism\": <0-100>,\n    \"data_accuracy\": <0-100>,\n    \"rule_adherence\": <0-100>,\n    \"context_usage\": <0-100>,\n    \"format_compliance\": <0-100>\n  },\n  \"issues\": [\n    {\n      \"type\": \"<categoria>\",\n      \"description\": \"<descri√ß√£o>\",\n      \"severity\": <1-5>\n    }\n  ],\n  \"suggestions\": [\"<sugest√£o 1>\", \"<sugest√£o 2>\"],\n  \"rules_violated\": [\"<regra violada se houver>\"],\n  \"overall_assessment\": \"<breve avalia√ß√£o geral>\"\n}\n```",
        "options": {
          "systemMessage": "=# VOC√ä √â UM ENGENHEIRO DE PROMPT ESPECIALISTA\n\nSua fun√ß√£o √© avaliar a qualidade das respostas de um Agente Financeiro IA.\n\n## CONTEXTO DO AGENTE AVALIADO\n\n- **Empresa:** Mottivme Sales - BPO Financeiro\n- **Fun√ß√£o:** Assistente financeira via WhatsApp\n- **Personalidade esperada:** Profissional, precisa, eficiente, objetiva\n- **Limite de resposta:** ~300 caracteres quando poss√≠vel\n\n## M√âTRICAS DE AVALIA√á√ÉO\n\n### 1. TOOL_SELECTION (Peso: 20%)\n**O que avaliar:**\n- A IA escolheu a ferramenta correta para a inten√ß√£o?\n- Para \"resumo financeiro\" ‚Üí deve usar dashboard_kpis\n- Para \"inadimplentes\" ‚Üí deve usar relatorio_inadimplencia\n- Para \"proje√ß√£o de caixa\" ‚Üí deve usar fluxo_caixa_projetado\n\n**Score:**\n- 100: Ferramenta perfeita\n- 75: Ferramenta adequada mas n√£o ideal\n- 50: Ferramenta parcialmente correta\n- 25: Ferramenta errada\n- 0: N√£o usou ferramenta quando deveria\n\n### 2. CONFIRMATION_PROTOCOL (Peso: 15%)\n**O que avaliar:**\n- Para A√á√ïES QUE MODIFICAM DADOS (salvar, criar, deletar):\n  - DEVE pedir confirma√ß√£o ANTES de executar\n  - DEVE apresentar resumo do que ser√° feito\n- Para CONSULTAS: n√£o precisa confirmar\n\n**Score:**\n- 100: Seguiu protocolo perfeitamente\n- 75: Pediu confirma√ß√£o mas faltou resumo\n- 50: N√£o pediu confirma√ß√£o mas era necess√°rio\n- 0: Executou a√ß√£o destrutiva sem confirmar\n\n### 3. BREVITY (Peso: 10%)\n**O que avaliar:**\n- Resposta direta ao ponto?\n- Dentro do limite (~300 chars para mensagens simples)?\n- Sem repeti√ß√µes ou informa√ß√µes desnecess√°rias?\n\n**Score:**\n- 100: Perfeitamente conciso\n- 75: Um pouco verbose mas aceit√°vel\n- 50: Muito longo, poderia ser mais direto\n- 25: Excessivamente longo\n\n### 4. PROFESSIONALISM (Peso: 10%)\n**O que avaliar:**\n- Tom profissional e confi√°vel?\n- Linguagem clara e objetiva?\n- Sem g√≠rias ou informalidade excessiva?\n- Tratamento respeitoso?\n\n**Score:**\n- 100: Tom perfeito\n- 75: Pequenas falhas de tom\n- 50: Tom inadequado em partes\n- 25: Tom muito informal ou rude\n\n### 5. DATA_ACCURACY (Peso: 20%)\n**O que avaliar:**\n- NUNCA inventa dados ou estat√≠sticas?\n- Usa apenas informa√ß√µes do contexto/ferramentas?\n- Valores e datas corretos?\n- N√£o \"alucina\" informa√ß√µes?\n\n**Score:**\n- 100: Dados 100% verific√°veis ou admite n√£o ter\n- 75: Pequena imprecis√£o\n- 50: Dados parcialmente inventados\n- 0: Inventou dados importantes\n\n### 6. RULE_ADHERENCE (Peso: 10%)\n**Regras do Prompt que DEVE seguir:**\n1. Confirmar antes de salvar\n2. Verificar duplicatas\n3. Nunca assumir informa√ß√µes n√£o fornecidas\n4. Em d√∫vida, perguntar\n5. Para despesas, perguntar centro de custo\n6. Usar dashboard_kpis para vis√µes gerais\n\n**Score:**\n- 100: Todas as regras seguidas\n- Desconte 15 pontos por regra violada\n\n### 7. CONTEXT_USAGE (Peso: 10%)\n**O que avaliar:**\n- Usou o nome do usu√°rio quando apropriado?\n- Considerou o contexto da conversa?\n- Referenciou informa√ß√µes anteriores quando relevante?\n\n**Score:**\n- 100: Uso perfeito do contexto\n- 75: Uso parcial\n- 50: Ignorou contexto importante\n- 25: Contexto completamente ignorado\n\n### 8. FORMAT_COMPLIANCE (Peso: 5%)\n**O que avaliar:**\n- Usou emojis padr√£o corretamente?\n  - ‚úÖ para sucesso\n  - ‚ùå para erro\n  - ‚ö†Ô∏è para falta de info\n- Formata√ß√£o clara e leg√≠vel?\n\n**Score:**\n- 100: Formato perfeito\n- 75: Pequenos desvios\n- 50: Formato inconsistente\n- 25: Formato incorreto\n\n## CLASSIFICA√á√ÉO DE ISSUES\n\nTipos de problemas:\n- `tool_error`: Ferramenta errada ou n√£o usada\n- `protocol_violation`: Violou protocolo de confirma√ß√£o\n- `verbosity`: Resposta muito longa\n- `tone_issue`: Problema de tom\n- `hallucination`: Inventou dados\n- `rule_violation`: Violou regra espec√≠fica\n- `context_miss`: N√£o usou contexto\n- `format_error`: Formata√ß√£o incorreta\n\nSeveridade (1-5):\n- 1: Menor, n√£o impacta\n- 2: Pequeno, impacto m√≠nimo\n- 3: Moderado, deve corrigir\n- 4: Grave, impacta experi√™ncia\n- 5: Cr√≠tico, falha total\n\n## IMPORTANTE\n\n- Seja JUSTO mas RIGOROSO\n- Avalie com base no contexto da Mottivme (BPO Financeiro)\n- Um agente \"A\" deve ser EXTRAORDIN√ÅRIO, n√£o apenas bom\n- Documente TODOS os problemas encontrados\n- Sugira melhorias ACION√ÅVEIS"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        608,
        -264
      ],
      "id": "a1961a44-3713-4a1f-83c2-7a3a9e4aae24",
      "name": "üîç Avaliador GPT-4o"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// üîÑ PARSER: Extrai scores do avaliador GPT-4o\n// =====================================================\n\nconst input = $input.first().json;\n\ntry {\n  // Tenta parsear o output do avaliador\n  let evaluation;\n  \n  if (typeof input.output === 'string') {\n    // Remove poss√≠veis caracteres extras\n    const cleanOutput = input.output\n      .replace(/```json\\n?/g, '')\n      .replace(/```\\n?/g, '')\n      .trim();\n    evaluation = JSON.parse(cleanOutput);\n  } else {\n    evaluation = input.output;\n  }\n  \n  // Extrai dados do contexto anterior\n  const capturedData = $('üì§ Capturar Output').first().json;\n  \n  return {\n    // Dados do teste\n    test_id: capturedData.test_id,\n    session_id: capturedData.session_id,\n    user_input: capturedData.user_input,\n    agent_output: capturedData.agent_output,\n    response_time_ms: capturedData.response_time_ms,\n    context_nome: capturedData.context_nome,\n    \n    // Scores GPT-4o\n    gpt4o_scores: evaluation.scores || {},\n    gpt4o_issues: evaluation.issues || [],\n    gpt4o_suggestions: evaluation.suggestions || [],\n    gpt4o_rules_violated: evaluation.rules_violated || [],\n    gpt4o_assessment: evaluation.overall_assessment || '',\n    \n    // Flag de sucesso\n    gpt4o_parsed: true\n  };\n  \n} catch (error) {\n  // Em caso de erro de parsing\n  const capturedData = $('üì§ Capturar Output').first().json;\n  \n  return {\n    test_id: capturedData.test_id,\n    session_id: capturedData.session_id,\n    user_input: capturedData.user_input,\n    agent_output: capturedData.agent_output,\n    response_time_ms: capturedData.response_time_ms,\n    \n    gpt4o_scores: {},\n    gpt4o_issues: [{\n      type: 'parse_error',\n      description: `Erro ao parsear avalia√ß√£o: ${error.message}`,\n      severity: 3\n    }],\n    gpt4o_suggestions: [],\n    gpt4o_rules_violated: [],\n    gpt4o_assessment: 'Erro ao processar avalia√ß√£o',\n    gpt4o_raw: input.output,\n    gpt4o_parsed: false\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        -264
      ],
      "id": "7adb86f3-24d1-42ef-89d0-542a19569671",
      "name": "üìä Parser GPT-4o"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# AVALIA√á√ÉO DE QUALIDADE DO AGENTE\n\n## CONTEXTO DO TESTE\n**Input do Usu√°rio:** {{ $json.user_input }}\n**Nome do Usu√°rio:** {{ $('üìã Preparar Contexto Teste').item.json.nome_extraido }}\n\n## RESPOSTA DO AGENTE\n{{ $json.agent_output }}\n\n---\n\n## SUA TAREFA\nAvalie a resposta do agente financeiro da Mottivme Sales.\n\nRetorne APENAS um JSON v√°lido:\n\n```json\n{\n  \"scores\": {\n    \"tool_selection\": <0-100>,\n    \"confirmation_protocol\": <0-100>,\n    \"brevity\": <0-100>,\n    \"professionalism\": <0-100>,\n    \"data_accuracy\": <0-100>,\n    \"rule_adherence\": <0-100>,\n    \"context_usage\": <0-100>,\n    \"format_compliance\": <0-100>\n  },\n  \"issues\": [\n    {\n      \"type\": \"<categoria>\",\n      \"description\": \"<descri√ß√£o>\",\n      \"severity\": <1-5>\n    }\n  ],\n  \"overall_assessment\": \"<breve avalia√ß√£o>\"\n}\n```",
        "options": {
          "systemMessage": "=# AVALIADOR DE AGENTES IA - GEMINI\n\nVoc√™ √© um avaliador especialista em qualidade de agentes de IA.\n\n## CONTEXTO\n- Agente: Assistente Financeira da Mottivme Sales\n- Fun√ß√£o: BPO Financeiro via WhatsApp\n- Expectativa: Profissional, precisa, objetiva, ~300 chars\n\n## M√âTRICAS (0-100)\n\n1. **tool_selection** - Escolheu ferramenta correta?\n2. **confirmation_protocol** - Pediu confirma√ß√£o antes de a√ß√µes?\n3. **brevity** - Resposta concisa?\n4. **professionalism** - Tom profissional?\n5. **data_accuracy** - Dados precisos, n√£o inventados?\n6. **rule_adherence** - Seguiu regras do prompt?\n7. **context_usage** - Usou contexto do usu√°rio?\n8. **format_compliance** - Emojis e formato corretos?\n\n## TIPOS DE ISSUES\n- tool_error, protocol_violation, verbosity, tone_issue\n- hallucination, rule_violation, context_miss, format_error\n\n## SEVERIDADE\n1=menor, 2=pequeno, 3=moderado, 4=grave, 5=cr√≠tico\n\nSeja rigoroso mas justo. Um \"A\" deve ser extraordin√°rio."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        608,
        -768
      ],
      "id": "ea89d57a-dddd-4992-b535-2979496986c6",
      "name": "üîç Avaliador Gemini"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// üîÑ CONSOLIDADOR: Combina avalia√ß√µes GPT-4o + Gemini\n// =====================================================\n\n// O Merge combina os dois inputs - identificar cada um\nconst allItems = $input.all();\n\n// Encontrar dados do GPT-4o (tem gpt4o_scores)\nconst gpt4oItem = allItems.find(i => i.json.gpt4o_scores !== undefined);\nconst gpt4oData = gpt4oItem ? gpt4oItem.json : {};\n\n// Encontrar dados do Gemini (tem gemini_scores)\nconst geminiItem = allItems.find(i => i.json.gemini_scores !== undefined);\nconst geminiData = geminiItem ? geminiItem.json : {};\n\n// Pegar scores de cada avaliador\nconst gptScores = gpt4oData.gpt4o_scores || {};\nconst gemScores = geminiData.gemini_scores || {};\n\n// Fun√ß√£o de m√©dia que lida corretamente com valores 0\nconst avgScore = (gpt, gem) => {\n  const hasGpt = typeof gpt === 'number';\n  const hasGem = typeof gem === 'number';\n  \n  if (hasGpt && hasGem) {\n    return Math.round((gpt + gem) / 2);\n  }\n  if (hasGpt) return gpt;\n  if (hasGem) return gem;\n  return 0;\n};\n\nconst finalScores = {\n  tool_selection: avgScore(gptScores.tool_selection, gemScores.tool_selection),\n  confirmation_protocol: avgScore(gptScores.confirmation_protocol, gemScores.confirmation_protocol),\n  brevity: avgScore(gptScores.brevity, gemScores.brevity),\n  professionalism: avgScore(gptScores.professionalism, gemScores.professionalism),\n  data_accuracy: avgScore(gptScores.data_accuracy, gemScores.data_accuracy),\n  rule_adherence: avgScore(gptScores.rule_adherence, gemScores.rule_adherence),\n  context_usage: avgScore(gptScores.context_usage, gemScores.context_usage),\n  format_compliance: avgScore(gptScores.format_compliance, gemScores.format_compliance)\n};\n\n// Calcular score final ponderado\nconst weights = {\n  tool_selection: 0.20,\n  confirmation_protocol: 0.15,\n  brevity: 0.10,\n  professionalism: 0.10,\n  data_accuracy: 0.20,\n  rule_adherence: 0.10,\n  context_usage: 0.10,\n  format_compliance: 0.05\n};\n\nlet weightedSum = 0;\nfor (const [key, weight] of Object.entries(weights)) {\n  weightedSum += (finalScores[key] || 0) * weight;\n}\nconst finalScore = Math.round(weightedSum * 100) / 100;\n\n// Calcular grade\nlet grade;\nif (finalScore >= 90) grade = 'A';\nelse if (finalScore >= 75) grade = 'B';\nelse if (finalScore >= 60) grade = 'C';\nelse if (finalScore >= 40) grade = 'D';\nelse grade = 'F';\n\n// Status\nlet status;\nif (finalScore >= 75) status = 'passed';\nelse if (finalScore >= 60) status = 'warning';\nelse status = 'failed';\n\n// Combinar issues (remover duplicatas por description)\nconst allIssues = [\n  ...(gpt4oData.gpt4o_issues || []), \n  ...(geminiData.gemini_issues || [])\n];\nconst uniqueIssues = allIssues.filter((issue, index, self) =>\n  index === self.findIndex(i => i.description === issue.description)\n);\n\n// Combinar sugest√µes\nconst allSuggestions = [\n  ...(gpt4oData.gpt4o_suggestions || []),\n  ...(geminiData.gemini_suggestions || [])\n].filter((v, i, a) => a.indexOf(v) === i);\n\n// Combinar regras violadas\nconst allRulesViolated = [\n  ...(gpt4oData.gpt4o_rules_violated || []),\n  ...(geminiData.gemini_rules_violated || [])\n].filter((v, i, a) => a.indexOf(v) === i);\n\n// Usar dados de teste do GPT-4o ou Gemini (o que tiver)\nconst testData = gpt4oData.test_id ? gpt4oData : geminiData;\n\nreturn {\n  // Identifica√ß√£o\n  test_id: testData.test_id,\n  session_id: testData.session_id,\n  agent_name: 'Agente Financeiro IA',\n  agent_version: '1.0',\n  \n  // Input/Output\n  user_input: testData.user_input,\n  agent_output: testData.agent_output,\n  \n  // Scores individuais (consolidados)\n  score_tool_selection: finalScores.tool_selection,\n  score_confirmation_protocol: finalScores.confirmation_protocol,\n  score_brevity: finalScores.brevity,\n  score_professionalism: finalScores.professionalism,\n  score_data_accuracy: finalScores.data_accuracy,\n  score_rule_adherence: finalScores.rule_adherence,\n  score_context_usage: finalScores.context_usage,\n  score_format_compliance: finalScores.format_compliance,\n  \n  // Score final\n  score_final: finalScore,\n  grade: grade,\n  evaluation_status: status,\n  \n  // Feedback detalhado de cada avaliador\n  feedback_gpt4o: {\n    scores: gptScores,\n    issues: gpt4oData.gpt4o_issues || [],\n    suggestions: gpt4oData.gpt4o_suggestions || [],\n    rules_violated: gpt4oData.gpt4o_rules_violated || [],\n    assessment: gpt4oData.gpt4o_assessment || ''\n  },\n  feedback_gemini: {\n    scores: gemScores,\n    issues: geminiData.gemini_issues || [],\n    suggestions: geminiData.gemini_suggestions || [],\n    rules_violated: geminiData.gemini_rules_violated || [],\n    assessment: geminiData.gemini_assessment || ''\n  },\n  \n  // Issues e sugest√µes consolidadas\n  issues_found: uniqueIssues,\n  improvement_suggestions: allSuggestions,\n  rules_violated: allRulesViolated,\n  \n  // Metadados\n  response_time_ms: testData.response_time_ms,\n  evaluator_models: { \n    gpt4o: gpt4oData.gpt4o_parsed !== false, \n    gemini: geminiData.gemini_parsed !== false \n  },\n  tested_by: 'system',\n  \n  // DEBUG\n  _debug: {\n    gpt4o_scores_received: gptScores,\n    gemini_scores_received: gemScores,\n    gpt4o_parsed: gpt4oData.gpt4o_parsed,\n    gemini_parsed: geminiData.gemini_parsed,\n    items_received: allItems.length\n  },\n  \n  // Para resposta ao usu√°rio\n  summary: `üìä **Avalia√ß√£o: ${grade}** (${finalScore}/100)\\n` +\n           `Status: ${status === 'passed' ? '‚úÖ Aprovado' : status === 'warning' ? '‚ö†Ô∏è Aten√ß√£o' : '‚ùå Reprovado'}\\n` +\n           `Issues: ${uniqueIssues.length}`\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        -464
      ],
      "id": "46f7366d-72a7-4611-a3d5-6b51eea2fa6b",
      "name": "üî¢ Consolidar Scores"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "response",
              "name": "output",
              "value": "={{ $('üî¢ Consolidar Scores').first().json.summary }}\n\nüìã **Detalhes:**\n- üéØ Tool Selection: {{ $('üî¢ Consolidar Scores').first().json.score_tool_selection }}/100\n- ‚úÖ Confirmation: {{ $('üî¢ Consolidar Scores').first().json.score_confirmation_protocol }}/100\n- üìù Brevity: {{ $('üî¢ Consolidar Scores').first().json.score_brevity }}/100\n- üëî Professionalism: {{ $('üî¢ Consolidar Scores').first().json.score_professionalism }}/100\n- üìä Data Accuracy: {{ $('üî¢ Consolidar Scores').first().json.score_data_accuracy }}/100\n- üìè Rule Adherence: {{ $('üî¢ Consolidar Scores').first().json.score_rule_adherence }}/100\n- üé≠ Context: {{ $('üî¢ Consolidar Scores').first().json.score_context_usage }}/100\n- üé® Format: {{ $('üî¢ Consolidar Scores').first().json.score_format_compliance }}/100\n\n---\n\n**Resposta do Agente:**\n{{ $('üî¢ Consolidar Scores').first().json.agent_output }}\n\n---\n\n**Sugest√µes:**\n{{ $('üî¢ Consolidar Scores').first().json.improvement_suggestions.join('\\n- ') || 'Nenhuma' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1856,
        -464
      ],
      "id": "a1e4c8e2-130c-470e-9885-7bfd6c2ad3dd",
      "name": "üì§ Formatar Resposta"
    },
    {
      "parameters": {
        "content": "## ‚öôÔ∏è CONFIGURA√á√ÉO\n\n### Credenciais Necess√°rias:\n1. **OpenAI API** - Para GPT-4o\n2. **Google Gemini API** - Para Gemini 2.5 Pro\n3. **Postgres (Supabase)** - Para salvar hist√≥rico\n\n### Antes de usar:\n1. Execute o SQL no Supabase\n2. Configure as credenciais\n3. Ajuste IDs se necess√°rio",
        "height": 260,
        "width": 280,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2560,
        -704
      ],
      "id": "8f4daa1d-1c06-4af4-ac4d-14230fa8a614",
      "name": "‚öôÔ∏è Config"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        680,
        -544
      ],
      "id": "ff9217a8-1ad9-48cd-a558-acca87caae0c",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "Id8CEvNKDTHbg6vv",
          "name": "gemini marcos"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0f11d21d-51b4-4a4b-9cd9-1a7147b3660c",
              "name": "mensagem",
              "value": "={{ $json.chatInput }}",
              "type": "string"
            },
            {
              "id": "02",
              "name": "telefone",
              "value": "=+5511936180422",
              "type": "string"
            },
            {
              "id": "85154002-32e4-4376-8d42-13f02fe7ec8e",
              "name": "motive",
              "value": "=assistente_admin",
              "type": "string"
            },
            {
              "id": "9bb5aeb2-3f0a-4f71-aca6-e98773225335",
              "name": "lead_id_firstItem",
              "value": "=EeQAehVFadRPpe8vOYXI",
              "type": "string"
            },
            {
              "id": "034663c7-e08d-4188-9d3b-cb6d594f4c33",
              "name": "location_id",
              "value": "=cd1uyzpJox6XPt4Vct8Y",
              "type": "string"
            },
            {
              "id": "3a324dd9-24ed-4162-89bc-fd4efaa27bc8",
              "name": "API_KEY",
              "value": "=pit-fe627027-b9cb-4ea3-aaa4-149459e66a03",
              "type": "string"
            },
            {
              "id": "8c98f58b-934a-4df5-8799-0681af9116d1",
              "name": "telefone_extraido",
              "value": "=+5511936180422",
              "type": "string"
            },
            {
              "id": "e9b0c68d-33ef-4fb6-a1fb-82bc6e6300ce",
              "name": "nome_extraido",
              "value": "=Marcos Daniel",
              "type": "string"
            },
            {
              "id": "cefebd60-eb66-47fc-aac2-8b24f0d775cc",
              "name": "sessionID",
              "value": "={{ $json.sessionId }}",
              "type": "string"
            },
            {
              "id": "b2c4b704-4947-4c04-8d51-85453a4a2665",
              "name": "responsavel_firstItem",
              "value": "=Marcos Daniel\n",
              "type": "string"
            },
            {
              "id": "d73d0ca7-3af9-4ec9-a6b8-feb26ce5e994",
              "name": "test_id",
              "value": "=TEST-{{ $now.format('yyyyMMddHHmmss') }}-{{ Math.random().toString(36).substring(7) }}",
              "type": "string"
            },
            {
              "id": "af6decf4-f5ac-4c7a-aa41-0d3b851d38f9",
              "name": "test_start",
              "value": "={{ $now.toISO() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2032,
        -848
      ],
      "id": "a501522d-075d-4ac9-bffb-b31c02c17de4",
      "name": "üìã Preparar Contexto Teste"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "ai_agent_test_evaluations",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "test_id": "={{ $('üìã Preparar Contexto Teste').first().json.test_id }}",
            "session_id": "={{ $('üìã Preparar Contexto Teste').first().json.sessionID }}",
            "agent_name": "={{ $json.agent_name }}",
            "agent_version": "={{ $json.agent_version }}",
            "user_input": "={{ $('üìã Preparar Contexto Teste').first().json.mensagem }}",
            "agent_output": "={{ $('Agente Financeiro IA').first().json.output }}",
            "score_tool_selection": "={{ $json.score_tool_selection }}",
            "score_confirmation_protocol": "={{ $json.score_confirmation_protocol }}",
            "score_brevity": "={{ $json.score_brevity }}",
            "score_professionalism": "={{ $json.score_professionalism }}",
            "score_data_accuracy": "={{ $json.score_data_accuracy }}",
            "score_rule_adherence": "={{ $json.score_rule_adherence }}",
            "score_context_usage": "={{ $json.score_context_usage }}",
            "score_format_compliance": "={{ $json.score_format_compliance }}",
            "feedback_gpt4o": "={{ { data: $json.feedback_gpt4o } }}",
            "feedback_gemini": "={{ { data: $json.feedback_gemini } }}",
            "issues_found": "={{ { items: $json.issues_found } }}",
            "improvement_suggestions": "={{ $json.improvement_suggestions }}",
            "rules_violated": "={{ $json.rules_violated }}",
            "response_time_ms": "={{ $('üì§ Capturar Output').first().json.response_time_ms }}",
            "evaluator_models": "={{ { data: $json.evaluator_models } }}",
            "tested_by": "={{ $json.tested_by }}",
            "score_final": 0,
            "tokens_input": 0,
            "tokens_output": 0,
            "tokens_total": 0,
            "estimated_cost_usd": 0
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "test_id",
              "displayName": "test_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "agent_name",
              "displayName": "agent_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "agent_version",
              "displayName": "agent_version",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "test_type",
              "displayName": "test_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "test_category",
              "displayName": "test_category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_input",
              "displayName": "user_input",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "agent_output",
              "displayName": "agent_output",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tools_called",
              "displayName": "tools_called",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "system_prompt_hash",
              "displayName": "system_prompt_hash",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "score_tool_selection",
              "displayName": "score_tool_selection",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score_confirmation_protocol",
              "displayName": "score_confirmation_protocol",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score_brevity",
              "displayName": "score_brevity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score_professionalism",
              "displayName": "score_professionalism",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score_data_accuracy",
              "displayName": "score_data_accuracy",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score_rule_adherence",
              "displayName": "score_rule_adherence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score_context_usage",
              "displayName": "score_context_usage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score_format_compliance",
              "displayName": "score_format_compliance",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score_final",
              "displayName": "score_final",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "grade",
              "displayName": "grade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "evaluation_status",
              "displayName": "evaluation_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "feedback_gpt4o",
              "displayName": "feedback_gpt4o",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "feedback_gemini",
              "displayName": "feedback_gemini",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "issues_found",
              "displayName": "issues_found",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "improvement_suggestions",
              "displayName": "improvement_suggestions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "rules_violated",
              "displayName": "rules_violated",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true
            },
            {
              "id": "response_time_ms",
              "displayName": "response_time_ms",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "tokens_input",
              "displayName": "tokens_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tokens_output",
              "displayName": "tokens_output",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tokens_total",
              "displayName": "tokens_total",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "estimated_cost_usd",
              "displayName": "estimated_cost_usd",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "agent_model",
              "displayName": "agent_model",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "evaluator_models",
              "displayName": "evaluator_models",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "evaluated_at",
              "displayName": "evaluated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tested_by",
              "displayName": "tested_by",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1632,
        -464
      ],
      "id": "c94d5289-cdc5-46c5-99c4-075654be13bb",
      "name": "üíæ Salvar Supabase1",
      "credentials": {
        "postgres": {
          "id": "WsU3bciJm7aMyAoC",
          "name": "postgress - financeiro - mottivme sales"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1184,
        -464
      ],
      "id": "f4f3fc43-d507-413d-a886-2b4d8bf0fefd",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// üîÑ PARSER: Extrai scores do avaliador Gemini\n// =====================================================\n\nconst input = $input.first().json;\n\ntry {\n  // Tenta parsear o output do avaliador\n  let evaluation;\n  \n  if (typeof input.output === 'string') {\n    // Remove poss√≠veis caracteres extras (markdown code blocks)\n    const cleanOutput = input.output\n      .replace(/```json\\n?/g, '')\n      .replace(/```\\n?/g, '')\n      .trim();\n    evaluation = JSON.parse(cleanOutput);\n  } else {\n    evaluation = input.output;\n  }\n  \n  // Extrai dados do contexto (üì§ Capturar Output - node comum)\n  const capturedData = $('üì§ Capturar Output').first().json;\n  \n  return {\n    // Dados do teste (mesmo formato do Parser GPT-4o)\n    test_id: capturedData.test_id,\n    session_id: capturedData.session_id,\n    user_input: capturedData.user_input,\n    agent_output: capturedData.agent_output,\n    response_time_ms: capturedData.response_time_ms,\n    \n    // Scores Gemini\n    gemini_scores: evaluation.scores || {},\n    gemini_issues: evaluation.issues || [],\n    gemini_suggestions: evaluation.suggestions || [],\n    gemini_rules_violated: evaluation.rules_violated || [],\n    gemini_assessment: evaluation.overall_assessment || '',\n    \n    // Flag de sucesso\n    gemini_parsed: true\n  };\n  \n} catch (error) {\n  // Em caso de erro de parsing\n  const capturedData = $('üì§ Capturar Output').first().json;\n  \n  return {\n    test_id: capturedData.test_id,\n    session_id: capturedData.session_id,\n    user_input: capturedData.user_input,\n    agent_output: capturedData.agent_output,\n    response_time_ms: capturedData.response_time_ms,\n    \n    // Gemini com erro\n    gemini_scores: {},\n    gemini_issues: [{\n      type: 'parse_error',\n      description: `Erro ao parsear avalia√ß√£o Gemini: ${error.message}`,\n      severity: 3\n    }],\n    gemini_suggestions: [],\n    gemini_rules_violated: [],\n    gemini_assessment: 'Erro ao processar avalia√ß√£o',\n    gemini_raw: input.output,\n    gemini_parsed: false\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        -664
      ],
      "id": "0a7e8c43-47d1-49e8-b4b1-6a63f0b000ed",
      "name": "üìä Parser Gemini"
    }
  ],
  "pinData": {
    "Start": [
      {
        "json": {
          "agente_ia_firstItem": "assistente_admin",
          "mensagem": "5511936180422 Marcos Daniel:\n\nQuais clientes est√£o ativos?",
          "output_preview_firstItem": null,
          "_embedded_contacts_firstItem": null,
          "whatsapp_firstItem": "+1 203633114653987",
          "email_firstItem": "120363311465398703@g.us",
          "_embedded_leads_firstItem": null,
          "responsavel_firstItem": "Marcos Daniel",
          "chat_id_firstItem": "1764927016243",
          "lead_id_firstItem": "EeQAehVFadRPpe8vOYXI",
          "nome_firstItem": "Mottivme",
          "mensagens_antigas_firstitem": "[2025-12-04T16:05:16.894Z] Lead/Humano: 5511936180422 Marcos Daniel:\n\nQuais clientes est√£o ativos?\n\n[2025-12-04T16:05:36.632Z] Assistente/IA: Oi Marcos Daniel, tudo bem? Meu foco aqui e ajudar brasileiros que moram nos EUA a organizar a vida financeira ou a comecar uma nova carreira como agente financeiro.Vc ta buscando uma consultoria pra suas financas ou tem interesse na carreira de agente?\n\n[2025-12-04T16:13:14.316Z] Lead/Humano: 5511936180422 Marcos Daniel:\n\nOpa\n\n[2025-12-04T16:13:30.426Z] Assistente/IA: Oi Mottivme, tudo bem? Meu foco aqui e ajudar brasileiros que moram nos EUA a organizar a vida financeira ou a comecar uma nova carreira como agente financeiro.Vc ta buscando uma consultoria pra suas financas ou tem interesse na carreira de agente?\n\n[2025-12-04T16:37:38.468Z] Lead/Humano: 5511936180422 Marcos Daniel:\n\nOpa\n\n[2025-12-04T16:44:21.312Z] Lead/Humano: 5511936180422 Marcos Daniel:\n\nOpa\n\n[2025-12-04T16:47:12.504Z] Lead/Humano: 5511936180422 Marcos Daniel:\n\nOpa\n\n[2025-12-05T01:18:58.349Z] Lead/Humano: 5511936180422 Marcos Daniel:\n\nQuais clientes est√£o ativos?\n\n[2025-12-05T01:19:05.197Z] Assistente/IA: Preciso de mais informa√ß√µes para ajudar. Poderia esclarecer sua d√∫vida ou pedido?\n",
          "location_id": "cd1uyzpJox6XPt4Vct8Y",
          "API_KEY": "pit-fe627027-b9cb-4ea3-aaa4-149459e66a03",
          "motive": "assistente_admin"
        }
      }
    ]
  },
  "connections": {
    "Buscar Cliente/Fornecedor": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Fluxo de Caixa Projetado": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Criar Parcelamento": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Criar Recorr√™ncia": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Relat√≥rio de Inadimpl√™ncia": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Dashboard KPIs": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Centros de Custo": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Or√ßamento vs Realizado": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "DRE Simplificado": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Concilia√ß√£o Banc√°ria": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI GPT-4o2": {
      "ai_languageModel": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Movimenta√ß√µes2": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Movimenta√ß√£o2": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente/Fornecedor2": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agente Financeiro IA2": {
      "main": [
        [
          {
            "node": "Formatar Saida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Categorias": {
      "ai_tool": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Agente Financeiro IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info": {
      "main": [
        [
          {
            "node": "Agente Financeiro IA2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "üìã Preparar Contexto Teste",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Agente Financeiro IA",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Agente Financeiro IA": {
      "main": [
        [
          {
            "node": "üì§ Capturar Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Capturar Output": {
      "main": [
        [
          {
            "node": "üîç Avaliador GPT-4o",
            "type": "main",
            "index": 0
          },
          {
            "node": "üîç Avaliador Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI GPT-4o (Evaluator)": {
      "ai_languageModel": [
        [
          {
            "node": "üîç Avaliador GPT-4o",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üîç Avaliador GPT-4o": {
      "main": [
        [
          {
            "node": "üìä Parser GPT-4o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Parser GPT-4o": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Avaliador Gemini": {
      "main": [
        [
          {
            "node": "üìä Parser Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üî¢ Consolidar Scores": {
      "main": [
        [
          {
            "node": "üíæ Salvar Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "üîç Avaliador Gemini",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Formatar Resposta": {
      "main": [
        []
      ]
    },
    "üìã Preparar Contexto Teste": {
      "main": [
        [
          {
            "node": "Agente Financeiro IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Salvar Supabase1": {
      "main": [
        [
          {
            "node": "üì§ Formatar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "üî¢ Consolidar Scores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Parser Gemini": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": -1,
    "availableInMCP": true
  },
  "versionId": "c233a95a-fb7d-4a96-a79f-cf4ebefbc1cd",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "RWIFCp2Jw3eajc2v",
  "tags": []
}