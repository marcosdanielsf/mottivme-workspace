{
  "name": "[TOOL] Relat√≥rio de Inadimpl√™ncia",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -256,
        192
      ],
      "id": "e0990cf1-4957-4f26-b450-c24199442659",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Resumo geral de inadimpl√™ncia\nSELECT \n  COUNT(DISTINCT m.cliente_fornecedor_id) as total_clientes_inadimplentes,\n  COUNT(m.id) as total_titulos_vencidos,\n  SUM(m.valor_previsto) as valor_total_inadimplente,\n  AVG(CURRENT_DATE - m.data_vencimento) as media_dias_atraso,\n  MAX(CURRENT_DATE - m.data_vencimento) as maior_atraso_dias\nFROM fin_movimentacoes m\nWHERE \n  m.tipo = 'receita'\n  AND m.quitado = false\n  AND m.data_vencimento < CURRENT_DATE;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -32,
        0
      ],
      "id": "18d8f343-7f0f-432e-bfa8-ef58c97705db",
      "name": "Resumo Geral",
      "credentials": {
        "postgres": {
          "id": "WsU3bciJm7aMyAoC",
          "name": "postgress - financeiro - mottivme sales"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Top 10 maiores devedores\nSELECT \n  c.id as cliente_id,\n  c.nome as cliente_nome,\n  c.telefone,\n  c.email,\n  c.tipo as tipo_cliente,\n  COUNT(m.id) as qtd_titulos,\n  SUM(m.valor_previsto) as valor_total,\n  MIN(m.data_vencimento) as vencimento_mais_antigo,\n  MAX(CURRENT_DATE - m.data_vencimento) as dias_atraso,\n  CASE \n    WHEN MAX(CURRENT_DATE - m.data_vencimento) <= 7 THEN 'leve'\n    WHEN MAX(CURRENT_DATE - m.data_vencimento) <= 30 THEN 'moderado'\n    WHEN MAX(CURRENT_DATE - m.data_vencimento) <= 90 THEN 'grave'\n    ELSE 'critico'\n  END as nivel_risco\nFROM fin_movimentacoes m\nJOIN fin_clientes_fornecedores c ON m.cliente_fornecedor_id = c.id\nWHERE \n  m.tipo = 'receita'\n  AND m.quitado = false\n  AND m.data_vencimento < CURRENT_DATE\nGROUP BY c.id, c.nome, c.telefone, c.email, c.tipo\nORDER BY valor_total DESC\nLIMIT 10;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -32,
        192
      ],
      "id": "23afa691-920a-4eba-be72-c614dbf41b1f",
      "name": "Top Devedores",
      "credentials": {
        "postgres": {
          "id": "WsU3bciJm7aMyAoC",
          "name": "postgress - financeiro - mottivme sales"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Distribui√ß√£o por faixa de atraso\nSELECT \n  CASE \n    WHEN CURRENT_DATE - data_vencimento <= 7 THEN '1-7 dias'\n    WHEN CURRENT_DATE - data_vencimento <= 15 THEN '8-15 dias'\n    WHEN CURRENT_DATE - data_vencimento <= 30 THEN '16-30 dias'\n    WHEN CURRENT_DATE - data_vencimento <= 60 THEN '31-60 dias'\n    WHEN CURRENT_DATE - data_vencimento <= 90 THEN '61-90 dias'\n    ELSE 'Mais de 90 dias'\n  END as faixa_atraso,\n  COUNT(*) as qtd_titulos,\n  SUM(valor_previsto) as valor_total,\n  COUNT(DISTINCT cliente_fornecedor_id) as qtd_clientes\nFROM fin_movimentacoes\nWHERE \n  tipo = 'receita'\n  AND quitado = false\n  AND data_vencimento < CURRENT_DATE\nGROUP BY \n  CASE \n    WHEN CURRENT_DATE - data_vencimento <= 7 THEN '1-7 dias'\n    WHEN CURRENT_DATE - data_vencimento <= 15 THEN '8-15 dias'\n    WHEN CURRENT_DATE - data_vencimento <= 30 THEN '16-30 dias'\n    WHEN CURRENT_DATE - data_vencimento <= 60 THEN '31-60 dias'\n    WHEN CURRENT_DATE - data_vencimento <= 90 THEN '61-90 dias'\n    ELSE 'Mais de 90 dias'\n  END\nORDER BY \n  MIN(CURRENT_DATE - data_vencimento);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -32,
        384
      ],
      "id": "4f64dbba-f7bb-4a3f-ba35-8ce3db6c3910",
      "name": "Por Faixa de Atraso",
      "credentials": {
        "postgres": {
          "id": "WsU3bciJm7aMyAoC",
          "name": "postgress - financeiro - mottivme sales"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar relat√≥rio de inadimpl√™ncia\n// Dados v√™m combinados do Merge - identificar cada tipo\nconst allItems = $input.all();\n\n// Separar os dados por tipo\nconst resumoItem = allItems.find(i => i.json.total_clientes_inadimplentes !== undefined);\nconst resumo = resumoItem ? resumoItem.json : {};\n\nconst devedores = allItems.filter(i => i.json.cliente_id !== undefined);\nconst faixas = allItems.filter(i => i.json.faixa_atraso !== undefined);\n\nconst formatarValor = (valor) => new Intl.NumberFormat('pt-BR', {\n  style: 'currency',\n  currency: 'BRL'\n}).format(valor || 0);\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return '-';\n  const data = new Date(dataStr + 'T00:00:00');\n  return data.toLocaleDateString('pt-BR');\n};\n\nconst getNivelEmoji = (nivel) => {\n  switch(nivel) {\n    case 'leve': return 'üü¢';\n    case 'moderado': return 'üü°';\n    case 'grave': return 'üü†';\n    case 'critico': return 'üî¥';\n    default: return '‚ö™';\n  }\n};\n\n// Se n√£o h√° inadimplentes\nif (!resumo.total_clientes_inadimplentes || resumo.total_clientes_inadimplentes === '0') {\n  return {\n    json: {\n      titulo: 'Relat√≥rio de Inadimpl√™ncia',\n      mensagem: '‚úÖ Parab√©ns! N√£o h√° clientes inadimplentes no momento.',\n      resumo: {\n        total_clientes: 0,\n        total_titulos: 0,\n        valor_total: formatarValor(0)\n      }\n    }\n  };\n}\n\n// Montar relat√≥rio\nconst relatorio = {\n  titulo: 'Relat√≥rio de Inadimpl√™ncia',\n  data_geracao: new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),\n  resumo: {\n    total_clientes_inadimplentes: parseInt(resumo.total_clientes_inadimplentes),\n    total_titulos_vencidos: parseInt(resumo.total_titulos_vencidos),\n    valor_total_inadimplente: formatarValor(resumo.valor_total_inadimplente),\n    media_dias_atraso: Math.round(parseFloat(resumo.media_dias_atraso) || 0),\n    maior_atraso: parseInt(resumo.maior_atraso_dias) + ' dias'\n  },\n  distribuicao_por_faixa: faixas.map(f => ({\n    faixa: f.json.faixa_atraso,\n    titulos: parseInt(f.json.qtd_titulos),\n    valor: formatarValor(f.json.valor_total),\n    clientes: parseInt(f.json.qtd_clientes)\n  })),\n  top_devedores: devedores.map(d => ({\n    cliente: d.json.cliente_nome,\n    tipo: d.json.tipo_cliente === 'pf' ? 'Pessoa F√≠sica' : 'Pessoa Jur√≠dica',\n    telefone: d.json.telefone || 'N√£o informado',\n    titulos: parseInt(d.json.qtd_titulos),\n    valor_total: formatarValor(d.json.valor_total),\n    dias_atraso: parseInt(d.json.dias_atraso),\n    nivel_risco: `${getNivelEmoji(d.json.nivel_risco)} ${d.json.nivel_risco.toUpperCase()}`,\n    vencimento_mais_antigo: formatarData(d.json.vencimento_mais_antigo)\n  }))\n};\n\n// Adicionar alerta se houver casos cr√≠ticos\nconst criticos = devedores.filter(d => d.json.nivel_risco === 'critico');\nif (criticos.length > 0) {\n  relatorio.alerta = `‚ö†Ô∏è ATEN√á√ÉO: ${criticos.length} cliente(s) em situa√ß√£o CR√çTICA (mais de 90 dias de atraso)`;\n}\n\nreturn { json: relatorio };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        192
      ],
      "id": "17210d9e-3f1d-4d86-a65f-898f31c406d6",
      "name": "Formatar Relat√≥rio"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        192,
        176
      ],
      "id": "4c366b28-0d18-4051-9451-80fa5519450a",
      "name": "Merge"
    }
  ],
  "pinData": {
    "Execute Workflow Trigger": [
      {
        "json": {}
      }
    ]
  },
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Resumo Geral",
            "type": "main",
            "index": 0
          },
          {
            "node": "Top Devedores",
            "type": "main",
            "index": 0
          },
          {
            "node": "Por Faixa de Atraso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resumo Geral": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Top Devedores": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Por Faixa de Atraso": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Formatar Relat√≥rio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1f7570df-73f7-41f3-85a1-923b37c0b061",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9d65e6caa0e89e696b77790e020391d74468b15f71b3dcdb63aad81f090f5e69"
  },
  "id": "zmj9M6HKSrdxJuZb",
  "tags": []
}