// ============================================
// JUNTA AS 2 PARTES DA TRILHA EDITORIAL
// Parte 1 = Dias 1-15
// Parte 2 = Dias 16-30
// ============================================

// Pegar outputs dos 2 agentes
const parte1Input = $('Parse Trilha - Parte 1').first();
const parte2Input = $('Parse Trilha - Parte 2').first();

console.log('ðŸ“¦ Juntando partes da trilha editorial...');

// âœ… VALIDAR INPUTS
if (!parte1Input || !parte2Input) {
  throw new Error('âŒ Uma das partes estÃ¡ faltando. Verifique se ambos os agentes executaram.');
}

const parte1 = parte1Input.json;
const parte2 = parte2Input.json;

// âœ… VALIDAR STATUS DE PARSING
if (parte1.parsing_status !== 'success') {
  console.warn('âš ï¸ Parte 1 teve problemas no parsing:', parte1.parsing_warning);
}

if (parte2.parsing_status !== 'success') {
  console.warn('âš ï¸ Parte 2 teve problemas no parsing:', parte2.parsing_warning);
}

// âœ… PARSEAR JSON DAS TRILHAS
let trilhaParte1, trilhaParte2;

try {
  trilhaParte1 = JSON.parse(parte1.trilha_json);
  console.log(`âœ… Parte 1: ${trilhaParte1.length} dias`);
} catch (e) {
  console.error('âŒ Erro ao parsear Parte 1:', e.message);
  trilhaParte1 = [];
}

try {
  trilhaParte2 = JSON.parse(parte2.trilha_json);
  console.log(`âœ… Parte 2: ${trilhaParte2.length} dias`);
} catch (e) {
  console.error('âŒ Erro ao parsear Parte 2:', e.message);
  trilhaParte2 = [];
}

// âœ… JUNTAR TRILHAS
const trilhaCompleta = [...trilhaParte1, ...trilhaParte2];

console.log(`ðŸ“… Trilha completa: ${trilhaCompleta.length} dias`);

// âœ… VALIDAR DIAS (devem ser 1-30)
const diasPresentes = trilhaCompleta.map(d => d.dia).sort((a, b) => a - b);
const diasFaltando = [];

for (let i = 1; i <= 30; i++) {
  if (!diasPresentes.includes(i)) {
    diasFaltando.push(i);
  }
}

if (diasFaltando.length > 0) {
  console.warn(`âš ï¸ Dias faltando: ${diasFaltando.join(', ')}`);
}

// âœ… ORDENAR POR DIA (garantir ordem 1-30)
trilhaCompleta.sort((a, b) => a.dia - b.dia);

// âœ… CALCULAR ESTATÃSTICAS COMBINADAS
const totalReels = trilhaCompleta.filter(d => d.formato_primario === 'Reel').length;
const totalStories = trilhaCompleta.filter(d => d.formato_primario === 'Story').length;
const totalCarrosseis = trilhaCompleta.filter(d => d.formato_primario === 'Carrossel').length;
const totalPosts = trilhaCompleta.filter(d => d.formato_primario === 'Post').length;

const statsCombinadas = {
  total_dias: trilhaCompleta.length,
  total_reels: totalReels,
  total_stories: totalStories,
  total_carrosseis: totalCarrosseis,
  total_posts: totalPosts,
  por_fase: {
    awareness: trilhaCompleta.filter(d => d.fase === 'Awareness').length,
    educacao: trilhaCompleta.filter(d => d.fase === 'EducaÃ§Ã£o').length,
    diferenciacao: trilhaCompleta.filter(d => d.fase === 'DiferenciaÃ§Ã£o').length,
    conversao: trilhaCompleta.filter(d => d.fase === 'ConversÃ£o').length
  }
};

// âœ… FORMATAR TRILHA COMPLETA
const trilhaFormatada = trilhaCompleta.map(dia =>
  `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
  `ðŸ“… DIA ${dia.dia} | ${dia.dia_semana} ${dia.data_sugerida}\n` +
  `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
  `ðŸŽ¯ FASE: ${dia.fase}\n` +
  `ðŸ“Œ PILAR: ${dia.pilar}\n` +
  `ðŸŒ¡ï¸ TEMPERATURA: ${dia.temperatura_lead}\n\n` +
  `ðŸ“ TEMA:\n${dia.tema}\n\n` +
  `ðŸ” Ã‚NGULO:\n${dia.angulo}\n\n` +
  `ðŸŽ¬ FORMATO: ${dia.formato_primario}${dia.duracao_estimada ? ` (${dia.duracao_estimada})` : ''}\n\n` +
  `ðŸŽª GATILHO: ${dia.gatilho_mental}\n` +
  `ðŸŽ¯ OBJETIVO: ${dia.objetivo}\n` +
  `ðŸ“Š MÃ‰TRICA: ${dia.metrica_sucesso}\n\n` +
  `ðŸ’¡ PONTOS:\n${(dia.pontos_chave || []).map((p, i) => `  ${i+1}. ${p}`).join('\n')}\n\n` +
  `ðŸª HOOK: "${dia.hook_sugerido || 'N/A'}"\n` +
  `ðŸ“£ CTA (${dia.cta_tipo}): ${dia.cta_texto || 'N/A'}\n` +
  (dia.objecao_abordada ? `ðŸš§ OBJEÃ‡ÃƒO: ${dia.objecao_abordada}\n` : '')
).join('\n\n');

// âœ… FORMATAR ESTATÃSTICAS
const statsFormatadas =
  `ðŸ“Š ESTATÃSTICAS DA TRILHA COMPLETA (30 DIAS)\n\n` +
  `ðŸ“… Total: ${statsCombinadas.total_dias} dias\n` +
  `ðŸŽ¬ Reels: ${statsCombinadas.total_reels} | Stories: ${statsCombinadas.total_stories} | CarrossÃ©is: ${statsCombinadas.total_carrosseis} | Posts: ${statsCombinadas.total_posts}\n\n` +
  `ðŸŒ¡ï¸ POR FASE:\n` +
  `  â€¢ Awareness: ${statsCombinadas.por_fase.awareness} dias\n` +
  `  â€¢ EducaÃ§Ã£o: ${statsCombinadas.por_fase.educacao} dias\n` +
  `  â€¢ DiferenciaÃ§Ã£o: ${statsCombinadas.por_fase.diferenciacao} dias\n` +
  `  â€¢ ConversÃ£o: ${statsCombinadas.por_fase.conversao} dias\n\n` +
  `âœ… Parte 1: ${trilhaParte1.length} dias (dias ${trilhaParte1[0]?.dia || '?'}-${trilhaParte1[trilhaParte1.length-1]?.dia || '?'})\n` +
  `âœ… Parte 2: ${trilhaParte2.length} dias (dias ${trilhaParte2[0]?.dia || '?'}-${trilhaParte2[trilhaParte2.length-1]?.dia || '?'})`;

// âœ… CALENDÃRIO SIMPLES
const calendarioSimples = trilhaCompleta.map(dia =>
  `${dia.data_sugerida} (${dia.dia_semana}) | ${dia.formato_primario} | ${dia.tema}`
).join('\n');

// âœ… APENAS REELS (para prÃ³ximo agente)
const diasComReels = trilhaCompleta.filter(d => d.formato_primario === 'Reel');

// âœ… AVISO SE INCOMPLETO
const aviso = trilhaCompleta.length < 30
  ? `\n\nâš ï¸ ATENÃ‡ÃƒO: Trilha incompleta! Apenas ${trilhaCompleta.length}/30 dias.\n` +
    `Dias faltando: ${diasFaltando.join(', ')}\n`
  : '\n\nâœ… Trilha completa com 30 dias!';

// âœ… COMBINAR ESTRATÃ‰GIAS E INSIGHTS
let estrategiaCombinada, insightsCombinados;

try {
  const estrategia1 = JSON.parse(parte1.trilha_completa_json).estrategia_resumo || {};
  const estrategia2 = JSON.parse(parte2.trilha_completa_json).estrategia_resumo || {};

  estrategiaCombinada =
    `ðŸ“ˆ ESTRATÃ‰GIA DO MÃŠS (30 DIAS)\n\n` +
    `ðŸŽ¯ PRIMEIRA QUINZENA:\n${estrategia1.objetivo_quinzena || 'N/A'}\n\n` +
    `ðŸŽ¯ SEGUNDA QUINZENA:\n${estrategia2.objetivo_quinzena || 'N/A'}\n\n` +
    `ðŸ“Š PILARES DOMINANTES:\n${[...(estrategia1.pilares_dominantes || []), ...(estrategia2.pilares_dominantes || [])].filter((v, i, a) => a.indexOf(v) === i).map(p => `â€¢ ${p}`).join('\n')}`;

  const insights1 = JSON.parse(parte1.trilha_completa_json).insights_estrategicos || {};
  const insights2 = JSON.parse(parte2.trilha_completa_json).insights_estrategicos || {};

  insightsCombinados =
    `ðŸ’¡ INSIGHTS ESTRATÃ‰GICOS\n\n` +
    `S1 (dias 1-7): ${insights1.semana_1 || 'N/A'}\n\n` +
    `S2 (dias 8-15): ${insights1.semana_2 || 'N/A'}\n\n` +
    `S3 (dias 16-21): ${insights2.semana_3 || 'N/A'}\n\n` +
    `S4 (dias 22-30): ${insights2.semana_4 || 'N/A'}`;

} catch (e) {
  console.error('âš ï¸ Erro ao combinar estratÃ©gias:', e.message);
  estrategiaCombinada = 'Erro ao combinar estratÃ©gias';
  insightsCombinados = 'Erro ao combinar insights';
}

console.log('âœ… TRILHA COMPLETA MONTADA!');

// âœ… RETORNAR TRILHA COMBINADA
return {
  json: {
    // Textos formatados
    trilha_texto: trilhaFormatada + aviso,
    estrategia_texto: estrategiaCombinada,
    insights_texto: insightsCombinados,
    calendario_texto: calendarioSimples,
    stats_texto: statsFormatadas + aviso,

    // JSON estruturado
    trilha_json: JSON.stringify(trilhaCompleta, null, 2),
    trilha_completa_json: JSON.stringify({
      trilha_editorial: trilhaCompleta,
      expert_id: parte1.expert_id,
      expert_name: parte1.expert_name,
      estrategia_resumo: {
        parte1: JSON.parse(parte1.trilha_completa_json).estrategia_resumo,
        parte2: JSON.parse(parte2.trilha_completa_json).estrategia_resumo
      },
      insights_estrategicos: {
        parte1: JSON.parse(parte1.trilha_completa_json).insights_estrategicos,
        parte2: JSON.parse(parte2.trilha_completa_json).insights_estrategicos
      }
    }, null, 2),

    dias_reels_json: JSON.stringify(diasComReels, null, 2),

    // Metadata
    expert_id: parte1.expert_id,
    expert_name: parte1.expert_name,
    total_dias: statsCombinadas.total_dias,
    total_reels: statsCombinadas.total_reels,
    stats: statsCombinadas,
    data_geracao: new Date().toISOString(),

    // Status
    parsing_status: trilhaCompleta.length === 30 ? 'success' : 'partial',
    parsing_warning: diasFaltando.length > 0 ? `dias_faltando: ${diasFaltando.join(',')}` : null,

    // Debug
    parte1_dias: trilhaParte1.length,
    parte2_dias: trilhaParte2.length,
    dias_faltando: diasFaltando
  }
};
