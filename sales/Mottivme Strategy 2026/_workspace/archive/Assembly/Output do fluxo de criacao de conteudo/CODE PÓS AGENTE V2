const agentOutput = $input.item.json.output;

// Remove markdown code blocks
let cleaned = typeof agentOutput === 'string'
  ? agentOutput.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim()
  : JSON.stringify(agentOutput);

console.log('ğŸ“ Tamanho do output:', cleaned.length);
console.log('ğŸ“ Primeiros 200 chars:', cleaned.substring(0, 200));

// âœ… ESTRATÃ‰GIA 1: Tentar parsear direto
try {
  const parsed = JSON.parse(cleaned);
  console.log('âœ… JSON vÃ¡lido - parse direto funcionou');
  return processarTrilha(parsed);
} catch (e1) {
  console.log('âš ï¸ Parse direto falhou:', e1.message);
}

// âœ… ESTRATÃ‰GIA 2: Limpar caracteres invisÃ­veis e tentar novamente
try {
  const cleanedInvisible = cleaned
    .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // Remove control chars
    .replace(/\r\n/g, '\n') // Normaliza line breaks
    .replace(/\t/g, ' '); // Normaliza tabs

  const parsed = JSON.parse(cleanedInvisible);
  console.log('âœ… Parse apÃ³s limpar caracteres invisÃ­veis funcionou');
  return processarTrilha(parsed);
} catch (e2) {
  console.log('âš ï¸ Parse apÃ³s limpar invisÃ­veis falhou:', e2.message);
}

// âœ… ESTRATÃ‰GIA 3: Extrair apenas o primeiro objeto vÃ¡lido
try {
  console.log('ğŸ”§ Tentando extrair objeto vÃ¡lido...');

  // Encontrar o primeiro { e tentar construir JSON vÃ¡lido
  const firstBrace = cleaned.indexOf('{');
  if (firstBrace === -1) {
    throw new Error('Nenhum objeto JSON encontrado');
  }

  let jsonStr = cleaned.substring(firstBrace);

  // Contar braces e fechar adequadamente
  let openBraces = 0;
  let closeBraces = 0;
  let inString = false;
  let escaped = false;
  let validEndPos = -1;

  for (let i = 0; i < jsonStr.length; i++) {
    const char = jsonStr[i];
    const prevChar = i > 0 ? jsonStr[i-1] : '';

    // Handle escape sequences
    if (char === '\\' && !escaped) {
      escaped = true;
      continue;
    }

    // Handle strings
    if (char === '"' && !escaped) {
      inString = !inString;
    }

    escaped = false;

    // Count braces only outside strings
    if (!inString) {
      if (char === '{') openBraces++;
      if (char === '}') closeBraces++;

      // Se fechamos todos os braces, achamos um ponto vÃ¡lido
      if (openBraces > 0 && openBraces === closeBraces) {
        validEndPos = i + 1;
        break;
      }
    }
  }

  if (validEndPos > 0) {
    jsonStr = jsonStr.substring(0, validEndPos);
    console.log('ğŸ”§ ExtraÃ­do objeto atÃ© posiÃ§Ã£o:', validEndPos);
  } else {
    // NÃ£o encontrou fim vÃ¡lido, tentar fechar manualmente
    console.log('ğŸ”§ Fechando braces manualmente...');
    const diff = openBraces - closeBraces;
    if (diff > 0) {
      // Remover Ãºltima vÃ­rgula se existir
      jsonStr = jsonStr.replace(/,\s*$/, '');
      jsonStr += '\n' + '}'.repeat(diff);
    }
  }

  const parsed = JSON.parse(jsonStr);
  console.log('âœ… Parse apÃ³s extrair objeto vÃ¡lido funcionou');
  return processarTrilha(parsed);
} catch (e3) {
  console.log('âš ï¸ ExtraÃ§Ã£o de objeto vÃ¡lido falhou:', e3.message);
}

// âœ… ESTRATÃ‰GIA 4: Regex para extrair trilha_editorial como array
try {
  console.log('ğŸ”§ Tentando extrair trilha_editorial via regex...');

  const trilhaMatch = cleaned.match(/"trilha_editorial"\s*:\s*\[([\s\S]*?)\]/);
  if (trilhaMatch) {
    const trilhaArray = `[${trilhaMatch[1]}]`;

    // Tentar parsear o array
    let dias;
    try {
      dias = JSON.parse(trilhaArray);
    } catch (parseErr) {
      // Se falhar, tentar fechar objetos incompletos
      const fixed = trilhaArray.replace(/,\s*$/, '') + ']';
      dias = JSON.parse(fixed);
    }

    console.log('âœ… ExtraÃ­do', dias.length, 'dias via regex');

    // Montar objeto mÃ­nimo
    const parsed = {
      trilha_editorial: dias,
      expert_id: cleaned.match(/"expert_id"\s*:\s*"([^"]+)"/)?.[1] || 'unknown',
      expert_name: cleaned.match(/"expert_name"\s*:\s*"([^"]+)"/)?.[1] || 'Unknown',
      estrategia_resumo: null,
      insights_estrategicos: null
    };

    return processarTrilha(parsed);
  }
} catch (e4) {
  console.log('âš ï¸ ExtraÃ§Ã£o via regex falhou:', e4.message);
}

// âœ… ESTRATÃ‰GIA 5: Retornar erro estruturado com mais informaÃ§Ãµes
console.error('âŒ TODAS AS ESTRATÃ‰GIAS DE PARSE FALHARAM');
console.error('ğŸ“Š AnÃ¡lise do JSON:');
console.error('   - Tamanho:', cleaned.length);
console.error('   - Primeiro char:', cleaned[0]);
console.error('   - Ãšltimo char:', cleaned[cleaned.length - 1]);
console.error('   - Braces:', (cleaned.match(/{/g) || []).length, 'abertos,', (cleaned.match(/}/g) || []).length, 'fechados');
console.error('   - Brackets:', (cleaned.match(/\[/g) || []).length, 'abertos,', (cleaned.match(/\]/g) || []).length, 'fechados');

// Salvar output completo para debug
return {
  json: {
    parsing_status: 'error',
    error_message: 'Todas as 5 estratÃ©gias de parse falharam',
    error_type: 'JSON_PARSE_ERROR_CRITICAL',

    // Debug info
    output_full: cleaned, // âš ï¸ Incluir output completo para anÃ¡lise
    output_length: cleaned.length,
    output_preview_start: cleaned.substring(0, 500),
    output_preview_end: cleaned.substring(Math.max(0, cleaned.length - 500)),

    // AnÃ¡lise estrutural
    structure_analysis: {
      open_braces: (cleaned.match(/{/g) || []).length,
      close_braces: (cleaned.match(/}/g) || []).length,
      open_brackets: (cleaned.match(/\[/g) || []).length,
      close_brackets: (cleaned.match(/\]/g) || []).length,
      quote_count: (cleaned.match(/"/g) || []).length
    },

    // Dados vazios
    trilha_texto: 'ERRO: Parse falhou apÃ³s 5 tentativas',
    estrategia_texto: 'ERRO: Veja output_full para debug',
    insights_texto: 'ERRO: Veja structure_analysis',
    calendario_texto: '',
    stats_texto: '',
    trilha_json: '[]',
    trilha_completa_json: '{}',
    dias_reels_json: '[]',
    expert_id: 'error',
    expert_name: 'Error',
    total_dias: 0,
    total_reels: 0,
    stats: {},
    data_geracao: new Date().toISOString()
  }
};

// ========================================
// FUNÃ‡ÃƒO AUXILIAR: PROCESSAR TRILHA
// ========================================
function processarTrilha(parsed) {
  console.log('âœ… Processando trilha parseada...');
  console.log(`ğŸ“… Dias encontrados: ${parsed.trilha_editorial?.length || 0}`);

  // âœ… FORMATA TRILHA PARA AIRTABLE
  const trilhaFormatada = (parsed.trilha_editorial || []).map(dia =>
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
    `ğŸ“… DIA ${dia.dia} | ${dia.dia_semana} ${dia.data_sugerida}\n` +
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
    `ğŸ¯ FASE: ${dia.fase}\n` +
    `ğŸ“Œ PILAR: ${dia.pilar}\n` +
    `ğŸŒ¡ï¸ TEMPERATURA: ${dia.temperatura_lead}\n\n` +
    `ğŸ“ TEMA:\n${dia.tema}\n\n` +
    `ğŸ” Ã‚NGULO:\n${dia.angulo}\n\n` +
    `ğŸ¬ FORMATO: ${dia.formato_primario}${dia.duracao_estimada ? ` (${dia.duracao_estimada})` : ''}\n\n` +
    `ğŸª GATILHO MENTAL: ${dia.gatilho_mental}\n\n` +
    `ğŸ¯ OBJETIVO:\n${dia.objetivo}\n\n` +
    `ğŸ“Š MÃ‰TRICA: ${dia.metrica_sucesso}\n\n` +
    `ğŸ’¡ PONTOS-CHAVE:\n${(dia.pontos_chave || []).map((p, i) => `  ${i+1}. ${p}`).join('\n')}\n\n` +
    `ğŸª HOOK: "${dia.hook_sugerido || 'N/A'}"\n\n` +
    `ğŸ“£ CTA (${dia.cta_tipo}): ${dia.cta_texto || 'N/A'}\n`
  ).join('\n\n');

  // âœ… FORMATA ESTRATÃ‰GIA
  const estrategiaFormatada = parsed.estrategia_resumo ?
    `ğŸ“ˆ ESTRATÃ‰GIA DO MÃŠS\n\n` +
    `ğŸ¯ OBJETIVO:\n${parsed.estrategia_resumo.objetivo_mes || 'N/A'}\n\n` +
    `ğŸ“Š PILARES:\n${(parsed.estrategia_resumo.pilares_dominantes || []).map(p => `â€¢ ${p}`).join('\n')}\n\n` +
    `ğŸ¬ FORMATOS:\n` +
    `  â€¢ Reels: ${parsed.estrategia_resumo.distribuicao_formatos?.reels || 'N/A'}\n` +
    `  â€¢ Stories: ${parsed.estrategia_resumo.distribuicao_formatos?.stories || 'N/A'}\n` +
    `  â€¢ CarrossÃ©is: ${parsed.estrategia_resumo.distribuicao_formatos?.carrosseis || 'N/A'}\n\n` +
    `ğŸ¯ KPIs:\n${(parsed.estrategia_resumo.kpis_mes || []).map(k => `â€¢ ${k}`).join('\n')}`
    : 'EstratÃ©gia nÃ£o disponÃ­vel';

  // âœ… INSIGHTS
  const insightsFormatados = parsed.insights_estrategicos ?
    `ğŸ’¡ INSIGHTS\n\n` +
    `S1: ${parsed.insights_estrategicos.semana_1 || 'N/A'}\n\n` +
    `S2: ${parsed.insights_estrategicos.semana_2 || 'N/A'}\n\n` +
    `S3: ${parsed.insights_estrategicos.semana_3 || 'N/A'}\n\n` +
    `S4: ${parsed.insights_estrategicos.semana_4 || 'N/A'}`
    : 'Insights nÃ£o disponÃ­veis';

  // âœ… CALENDÃRIO
  const calendarioSimples = (parsed.trilha_editorial || []).map(dia =>
    `${dia.data_sugerida} (${dia.dia_semana}) | ${dia.formato_primario} | ${dia.tema}`
  ).join('\n');

  // âœ… REELS
  const diasComReels = (parsed.trilha_editorial || []).filter(dia =>
    dia.formato_primario === 'Reel'
  );

  // âœ… STATS
  const trilhaArray = parsed.trilha_editorial || [];
  const stats = {
    total_dias: trilhaArray.length,
    total_reels: diasComReels.length,
    total_stories: trilhaArray.filter(d => d.formato_primario === 'Story').length,
    total_carrosseis: trilhaArray.filter(d => d.formato_primario === 'Carrossel').length,
    total_posts: trilhaArray.filter(d => d.formato_primario === 'Post').length,
    por_fase: {
      awareness: trilhaArray.filter(d => d.fase === 'Awareness').length,
      educacao: trilhaArray.filter(d => d.fase === 'EducaÃ§Ã£o').length,
      diferenciacao: trilhaArray.filter(d => d.fase === 'DiferenciaÃ§Ã£o').length,
      conversao: trilhaArray.filter(d => d.fase === 'ConversÃ£o').length
    }
  };

  const statsFormatadas =
    `ğŸ“Š ESTATÃSTICAS\n\n` +
    `ğŸ“… Total: ${stats.total_dias} dias\n\n` +
    `ğŸ¬ FORMATOS:\n` +
    `  â€¢ Reels: ${stats.total_reels}\n` +
    `  â€¢ Stories: ${stats.total_stories}\n` +
    `  â€¢ CarrossÃ©is: ${stats.total_carrosseis}\n` +
    `  â€¢ Posts: ${stats.total_posts}\n\n` +
    `ğŸŒ¡ï¸ POR FASE:\n` +
    `  â€¢ Awareness: ${stats.por_fase.awareness}\n` +
    `  â€¢ EducaÃ§Ã£o: ${stats.por_fase.educacao}\n` +
    `  â€¢ DiferenciaÃ§Ã£o: ${stats.por_fase.diferenciacao}\n` +
    `  â€¢ ConversÃ£o: ${stats.por_fase.conversao}`;

  console.log('âœ… PROCESSAMENTO COMPLETO');

  return {
    json: {
      trilha_texto: trilhaFormatada,
      estrategia_texto: estrategiaFormatada,
      insights_texto: insightsFormatados,
      calendario_texto: calendarioSimples,
      stats_texto: statsFormatadas,
      trilha_json: JSON.stringify(trilhaArray, null, 2),
      trilha_completa_json: JSON.stringify(parsed, null, 2),
      dias_reels_json: JSON.stringify(diasComReels, null, 2),
      expert_id: parsed.expert_id || 'unknown',
      expert_name: parsed.expert_name || 'Unknown',
      total_dias: stats.total_dias,
      total_reels: stats.total_reels,
      stats: stats,
      data_geracao: new Date().toISOString(),
      parsing_status: 'success'
    }
  };
}
