{
  "name": "[TOOL] Atualizar Dados Cliente",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "trigger",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "jsCode": "// Preparar campos para atualização\nconst input = $json;\n\nif (!input.cliente_id) {\n  return {\n    json: {\n      sucesso: false,\n      erro: 'cliente_id é obrigatório para atualização'\n    }\n  };\n}\n\n// Construir lista de campos para atualizar\nconst camposAtualizar = [];\nconst valores = [];\n\nif (input.nome) {\n  camposAtualizar.push(`nome = '${input.nome.replace(/'/g, \"''\")}'`);\n}\nif (input.documento) {\n  camposAtualizar.push(`documento = '${input.documento.replace(/[^0-9]/g, '')}'`);\n  // Determinar tipo baseado no documento\n  const docLimpo = input.documento.replace(/[^0-9]/g, '');\n  const tipo = docLimpo.length <= 11 ? 'pf' : 'pj';\n  camposAtualizar.push(`tipo = '${tipo}'`);\n}\nif (input.razao_social) {\n  camposAtualizar.push(`razao_social = '${input.razao_social.replace(/'/g, \"''\")}'`);\n}\nif (input.nacionalidade) {\n  camposAtualizar.push(`nacionalidade = '${input.nacionalidade.replace(/'/g, \"''\")}'`);\n}\nif (input.profissao) {\n  camposAtualizar.push(`profissao = '${input.profissao.replace(/'/g, \"''\")}'`);\n}\nif (input.estado_civil) {\n  camposAtualizar.push(`estado_civil = '${input.estado_civil.replace(/'/g, \"''\")}'`);\n}\nif (input.data_nascimento) {\n  camposAtualizar.push(`data_nascimento = '${input.data_nascimento}'::date`);\n}\nif (input.telefone) {\n  camposAtualizar.push(`telefone = '${input.telefone}'`);\n}\nif (input.email) {\n  camposAtualizar.push(`email = '${input.email.toLowerCase()}'`);\n}\nif (input.endereco) {\n  camposAtualizar.push(`endereco = '${input.endereco.replace(/'/g, \"''\")}'`);\n}\nif (input.cep) {\n  camposAtualizar.push(`cep = '${input.cep.replace(/[^0-9]/g, '')}'`);\n}\nif (input.cidade) {\n  camposAtualizar.push(`cidade = '${input.cidade.replace(/'/g, \"''\")}'`);\n}\nif (input.estado) {\n  camposAtualizar.push(`estado = '${input.estado.toUpperCase().substring(0, 2)}'`);\n}\n\nif (camposAtualizar.length === 0) {\n  return {\n    json: {\n      sucesso: false,\n      erro: 'Nenhum campo para atualizar foi fornecido'\n    }\n  };\n}\n\n// Adicionar updated_at\ncamposAtualizar.push('updated_at = NOW()');\n\nreturn {\n  json: {\n    sucesso: true,\n    cliente_id: input.cliente_id,\n    sql_set: camposAtualizar.join(', '),\n    campos_atualizados: camposAtualizar.length - 1 // -1 por causa do updated_at\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "id": "preparar-update",
      "name": "Preparar Update"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-sucesso",
              "leftValue": "={{ $json.sucesso }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [680, 300],
      "id": "check-valido",
      "name": "Válido?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Atualizar cliente\nUPDATE clientes_fornecedores\nSET {{ $json.sql_set }}\nWHERE id = '{{ $json.cliente_id }}'::uuid\nRETURNING id, nome, documento, tipo;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [900, 200],
      "id": "atualizar-cliente",
      "name": "Atualizar Cliente",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar resposta de sucesso\nconst resultado = $json;\nconst dadosOrigem = $('Preparar Update').first().json;\n\nreturn {\n  json: {\n    sucesso: true,\n    mensagem: `Dados do cliente atualizados com sucesso! ${dadosOrigem.campos_atualizados} campo(s) atualizado(s).`,\n    cliente: {\n      id: resultado.id,\n      nome: resultado.nome,\n      documento: resultado.documento,\n      tipo: resultado.tipo === 'pf' ? 'Pessoa Física' : 'Pessoa Jurídica'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 200],
      "id": "formatar-sucesso",
      "name": "Formatar Sucesso"
    },
    {
      "parameters": {
        "jsCode": "// Retornar erro\nreturn {\n  json: {\n    sucesso: false,\n    erro: $json.erro\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400],
      "id": "retornar-erro",
      "name": "Retornar Erro"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Preparar Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Update": {
      "main": [
        [
          {
            "node": "Válido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Válido?": {
      "main": [
        [
          {
            "node": "Atualizar Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Retornar Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Cliente": {
      "main": [
        [
          {
            "node": "Formatar Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "tool-atualizar-cliente",
  "tags": []
}
