{
  "name": "[TOOL] Criar Parcelamento",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "trigger",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "jsCode": "// Validar e preparar dados do parcelamento\nconst input = $json;\n\n// Campos obrigatórios\nconst tipo = input.tipo; // 'receita' ou 'despesa'\nconst descricao = input.descricao;\nconst valorTotal = parseFloat(input.valor_total);\nconst numParcelas = parseInt(input.num_parcelas);\nconst dataPrimeira = input.data_primeira_parcela;\n\n// Validações\nconst erros = [];\n\nif (!tipo || !['receita', 'despesa'].includes(tipo)) {\n  erros.push('Tipo deve ser \"receita\" ou \"despesa\"');\n}\n\nif (!descricao || descricao.trim().length < 3) {\n  erros.push('Descrição é obrigatória (mínimo 3 caracteres)');\n}\n\nif (!valorTotal || valorTotal <= 0) {\n  erros.push('Valor total deve ser maior que zero');\n}\n\nif (!numParcelas || numParcelas < 2 || numParcelas > 120) {\n  erros.push('Número de parcelas deve ser entre 2 e 120');\n}\n\nif (!dataPrimeira) {\n  erros.push('Data da primeira parcela é obrigatória');\n}\n\nif (erros.length > 0) {\n  return {\n    json: {\n      sucesso: false,\n      erro: erros.join('; ')\n    }\n  };\n}\n\n// Calcular valor da parcela\nconst valorParcela = Math.round((valorTotal / numParcelas) * 100) / 100;\n\nreturn {\n  json: {\n    sucesso: true,\n    tipo,\n    descricao: descricao.trim(),\n    valor_total: valorTotal,\n    num_parcelas: numParcelas,\n    valor_parcela: valorParcela,\n    data_primeira_parcela: dataPrimeira,\n    tipo_entidade: input.tipo_entidade || 'pj',\n    categoria_id: input.categoria_id || null,\n    cliente_fornecedor_id: input.cliente_fornecedor_id || null,\n    observacao: input.observacao || null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "id": "validar-dados",
      "name": "Validar Dados"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-sucesso",
              "leftValue": "={{ $json.sucesso }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [680, 300],
      "id": "check-validacao",
      "name": "Validação OK?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Criar registro do parcelamento\nINSERT INTO parcelamentos (\n  tipo,\n  descricao,\n  valor_total,\n  num_parcelas,\n  valor_parcela,\n  data_primeira_parcela,\n  tipo_entidade,\n  categoria_id,\n  cliente_fornecedor_id,\n  observacao\n)\nVALUES (\n  '{{ $json.tipo }}',\n  '{{ $json.descricao.replace(/'/g, \"''\") }}',\n  {{ $json.valor_total }},\n  {{ $json.num_parcelas }},\n  {{ $json.valor_parcela }},\n  '{{ $json.data_primeira_parcela }}'::date,\n  '{{ $json.tipo_entidade }}',\n  {{ $json.categoria_id ? \"'\" + $json.categoria_id + \"'::uuid\" : 'NULL' }},\n  {{ $json.cliente_fornecedor_id ? \"'\" + $json.cliente_fornecedor_id + \"'::uuid\" : 'NULL' }},\n  {{ $json.observacao ? \"'\" + $json.observacao.replace(/'/g, \"''\") + \"'\" : 'NULL' }}\n)\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [900, 200],
      "id": "criar-parcelamento",
      "name": "Criar Parcelamento",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Gerar as movimentações de cada parcela\nconst parcelamento = $('Criar Parcelamento').first().json;\nconst dadosOriginais = $('Validar Dados').first().json;\n\nconst parcelas = [];\nlet dataBase = new Date(dadosOriginais.data_primeira_parcela + 'T00:00:00');\n\nfor (let i = 1; i <= dadosOriginais.num_parcelas; i++) {\n  const dataVencimento = new Date(dataBase);\n  dataVencimento.setMonth(dataVencimento.getMonth() + (i - 1));\n  \n  parcelas.push({\n    tipo: dadosOriginais.tipo,\n    descricao: `[PARC ${i}/${dadosOriginais.num_parcelas}] ${dadosOriginais.descricao}`,\n    valor_previsto: dadosOriginais.valor_parcela,\n    data_vencimento: dataVencimento.toISOString().split('T')[0],\n    tipo_entidade: dadosOriginais.tipo_entidade,\n    categoria_id: dadosOriginais.categoria_id,\n    cliente_fornecedor_id: dadosOriginais.cliente_fornecedor_id,\n    parcelamento_id: parcelamento.id,\n    observacao: `Parcela ${i} de ${dadosOriginais.num_parcelas} - Parcelamento ID: ${parcelamento.id}`\n  });\n}\n\nreturn parcelas.map(p => ({ json: p }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 200],
      "id": "gerar-parcelas",
      "name": "Gerar Parcelas"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Criar movimentação para esta parcela\nINSERT INTO movimentacoes_financeiras (\n  tipo,\n  descricao,\n  valor_previsto,\n  data_vencimento,\n  tipo_entidade,\n  categoria_id,\n  cliente_fornecedor_id,\n  observacao,\n  quitado\n)\nVALUES (\n  '{{ $json.tipo }}',\n  '{{ $json.descricao.replace(/'/g, \"''\") }}',\n  {{ $json.valor_previsto }},\n  '{{ $json.data_vencimento }}'::date,\n  '{{ $json.tipo_entidade }}',\n  {{ $json.categoria_id ? \"'\" + $json.categoria_id + \"'::uuid\" : 'NULL' }},\n  {{ $json.cliente_fornecedor_id ? \"'\" + $json.cliente_fornecedor_id + \"'::uuid\" : 'NULL' }},\n  '{{ $json.observacao.replace(/'/g, \"''\") }}',\n  false\n)\nRETURNING id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1340, 200],
      "id": "inserir-parcela",
      "name": "Inserir Parcela",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar resposta de sucesso\nconst parcelamento = $('Criar Parcelamento').first().json;\nconst dadosOriginais = $('Validar Dados').first().json;\nconst parcelasInseridas = $('Inserir Parcela').all();\n\nconst formatarValor = (valor) => new Intl.NumberFormat('pt-BR', {\n  style: 'currency',\n  currency: 'BRL'\n}).format(valor || 0);\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return '-';\n  const data = new Date(dataStr + 'T00:00:00');\n  return data.toLocaleDateString('pt-BR');\n};\n\nreturn {\n  json: {\n    sucesso: true,\n    mensagem: `Parcelamento criado com sucesso!`,\n    detalhes: {\n      id: parcelamento.id,\n      tipo: dadosOriginais.tipo === 'receita' ? 'A Receber' : 'A Pagar',\n      descricao: dadosOriginais.descricao,\n      valor_total: formatarValor(dadosOriginais.valor_total),\n      parcelas: `${dadosOriginais.num_parcelas}x de ${formatarValor(dadosOriginais.valor_parcela)}`,\n      primeira_parcela: formatarData(dadosOriginais.data_primeira_parcela),\n      movimentacoes_criadas: parcelasInseridas.length\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 200],
      "id": "formatar-sucesso",
      "name": "Formatar Resposta"
    },
    {
      "parameters": {
        "jsCode": "// Retornar erro de validação\nreturn {\n  json: {\n    sucesso: false,\n    erro: $json.erro\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400],
      "id": "retornar-erro",
      "name": "Retornar Erro"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Validar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Dados": {
      "main": [
        [
          {
            "node": "Validação OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validação OK?": {
      "main": [
        [
          {
            "node": "Criar Parcelamento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Retornar Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Parcelamento": {
      "main": [
        [
          {
            "node": "Gerar Parcelas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar Parcelas": {
      "main": [
        [
          {
            "node": "Inserir Parcela",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Parcela": {
      "main": [
        [
          {
            "node": "Formatar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "tool-criar-parcelamento",
  "tags": []
}
