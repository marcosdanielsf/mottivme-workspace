{
  "name": "[TOOL] Criar Recorrência",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "trigger",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "jsCode": "// Validar e preparar dados da recorrência\nconst input = $json;\n\n// Campos obrigatórios\nconst tipo = input.tipo; // 'receita' ou 'despesa'\nconst descricao = input.descricao;\nconst valor = parseFloat(input.valor);\nconst diaVencimento = parseInt(input.dia_vencimento);\n\n// Validações\nconst erros = [];\n\nif (!tipo || !['receita', 'despesa'].includes(tipo)) {\n  erros.push('Tipo deve ser \"receita\" ou \"despesa\"');\n}\n\nif (!descricao || descricao.trim().length < 3) {\n  erros.push('Descrição é obrigatória (mínimo 3 caracteres)');\n}\n\nif (!valor || valor <= 0) {\n  erros.push('Valor deve ser maior que zero');\n}\n\nif (!diaVencimento || diaVencimento < 1 || diaVencimento > 31) {\n  erros.push('Dia de vencimento deve ser entre 1 e 31');\n}\n\nif (erros.length > 0) {\n  return {\n    json: {\n      sucesso: false,\n      erro: erros.join('; ')\n    }\n  };\n}\n\nreturn {\n  json: {\n    sucesso: true,\n    tipo,\n    descricao: descricao.trim(),\n    valor,\n    dia_vencimento: diaVencimento,\n    tipo_entidade: input.tipo_entidade || 'pj',\n    categoria_id: input.categoria_id || null,\n    cliente_fornecedor_id: input.cliente_fornecedor_id || null,\n    observacao: input.observacao || null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "id": "validar-dados",
      "name": "Validar Dados"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-sucesso",
              "leftValue": "={{ $json.sucesso }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [680, 300],
      "id": "check-validacao",
      "name": "Validação OK?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Verificar se já existe recorrência similar\nSELECT id, descricao, valor, dia_vencimento\nFROM recorrencias\nWHERE \n  ativo = true\n  AND tipo = '{{ $json.tipo }}'\n  AND LOWER(descricao) = LOWER('{{ $json.descricao.replace(/'/g, \"''\") }}')\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [900, 200],
      "id": "check-duplicada",
      "name": "Verificar Duplicada",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "nao-existe",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1120, 200],
      "id": "check-existe",
      "name": "Já Existe?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Criar nova recorrência\nINSERT INTO recorrencias (\n  tipo,\n  descricao,\n  valor,\n  dia_vencimento,\n  tipo_entidade,\n  categoria_id,\n  cliente_fornecedor_id,\n  observacao,\n  ativo\n)\nVALUES (\n  '{{ $('Validar Dados').item.json.tipo }}',\n  '{{ $('Validar Dados').item.json.descricao.replace(/'/g, \"''\") }}',\n  {{ $('Validar Dados').item.json.valor }},\n  {{ $('Validar Dados').item.json.dia_vencimento }},\n  '{{ $('Validar Dados').item.json.tipo_entidade }}',\n  {{ $('Validar Dados').item.json.categoria_id ? \"'\" + $('Validar Dados').item.json.categoria_id + \"'::uuid\" : 'NULL' }},\n  {{ $('Validar Dados').item.json.cliente_fornecedor_id ? \"'\" + $('Validar Dados').item.json.cliente_fornecedor_id + \"'::uuid\" : 'NULL' }},\n  {{ $('Validar Dados').item.json.observacao ? \"'\" + $('Validar Dados').item.json.observacao.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  true\n)\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1340, 100],
      "id": "criar-recorrencia",
      "name": "Criar Recorrência",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar resposta de sucesso\nconst recorrencia = $json;\nconst dadosOriginais = $('Validar Dados').first().json;\n\nconst formatarValor = (valor) => new Intl.NumberFormat('pt-BR', {\n  style: 'currency',\n  currency: 'BRL'\n}).format(valor || 0);\n\nreturn {\n  json: {\n    sucesso: true,\n    mensagem: `Recorrência criada com sucesso!`,\n    detalhes: {\n      id: recorrencia.id,\n      tipo: dadosOriginais.tipo === 'receita' ? 'Receita Recorrente' : 'Despesa Recorrente',\n      descricao: dadosOriginais.descricao,\n      valor: formatarValor(dadosOriginais.valor),\n      dia_vencimento: dadosOriginais.dia_vencimento,\n      proxima_geracao: 'Dia 1 do próximo mês às 6h'\n    },\n    nota: 'As movimentações serão geradas automaticamente no dia 1 de cada mês.'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 100],
      "id": "formatar-sucesso",
      "name": "Formatar Resposta"
    },
    {
      "parameters": {
        "jsCode": "// Retornar erro - já existe\nconst existente = $json;\n\nconst formatarValor = (valor) => new Intl.NumberFormat('pt-BR', {\n  style: 'currency',\n  currency: 'BRL'\n}).format(valor || 0);\n\nreturn {\n  json: {\n    sucesso: false,\n    erro: `Já existe uma recorrência ativa com esta descrição: \"${existente.descricao}\" - ${formatarValor(existente.valor)} dia ${existente.dia_vencimento}`\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300],
      "id": "erro-duplicada",
      "name": "Erro: Duplicada"
    },
    {
      "parameters": {
        "jsCode": "// Retornar erro de validação\nreturn {\n  json: {\n    sucesso: false,\n    erro: $json.erro\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400],
      "id": "retornar-erro",
      "name": "Retornar Erro"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Validar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Dados": {
      "main": [
        [
          {
            "node": "Validação OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validação OK?": {
      "main": [
        [
          {
            "node": "Verificar Duplicada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Retornar Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Duplicada": {
      "main": [
        [
          {
            "node": "Já Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Já Existe?": {
      "main": [
        [
          {
            "node": "Criar Recorrência",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erro: Duplicada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Recorrência": {
      "main": [
        [
          {
            "node": "Formatar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "tool-criar-recorrencia",
  "tags": []
}
