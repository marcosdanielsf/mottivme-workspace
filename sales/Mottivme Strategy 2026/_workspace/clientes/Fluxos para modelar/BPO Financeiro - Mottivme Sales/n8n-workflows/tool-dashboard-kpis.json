{
  "name": "[TOOL] Dashboard KPIs",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "trigger",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM vw_dashboard_kpis;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [460, 300],
      "id": "query-kpis",
      "name": "Buscar KPIs",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar dashboard de KPIs\nconst kpis = $json;\n\nconst formatarValor = (valor) => new Intl.NumberFormat('pt-BR', {\n  style: 'currency',\n  currency: 'BRL'\n}).format(valor || 0);\n\nconst getStatusResultado = (valor) => {\n  if (valor > 0) return 'ðŸŸ¢ POSITIVO';\n  if (valor < 0) return 'ðŸ”´ NEGATIVO';\n  return 'âšª NEUTRO';\n};\n\nconst getStatusInadimplencia = (taxa) => {\n  if (taxa <= 5) return 'ðŸŸ¢ SaudÃ¡vel';\n  if (taxa <= 15) return 'ðŸŸ¡ AtenÃ§Ã£o';\n  if (taxa <= 30) return 'ðŸŸ  Preocupante';\n  return 'ðŸ”´ CrÃ­tico';\n};\n\nconst mesAtual = new Date().toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });\n\nreturn {\n  json: {\n    titulo: `Dashboard Financeiro - ${mesAtual}`,\n    resultado_mes: {\n      receitas: formatarValor(kpis.receitas_mes_atual),\n      despesas: formatarValor(kpis.despesas_mes_atual),\n      resultado: formatarValor(kpis.resultado_mes),\n      status: getStatusResultado(parseFloat(kpis.resultado_mes))\n    },\n    contas_a_receber: {\n      total: formatarValor(kpis.total_a_receber),\n      quantidade: parseInt(kpis.qtd_a_receber) || 0\n    },\n    contas_a_pagar: {\n      total: formatarValor(kpis.total_a_pagar),\n      quantidade: parseInt(kpis.qtd_a_pagar) || 0,\n      proximos_7_dias: formatarValor(kpis.a_pagar_7dias),\n      qtd_7_dias: parseInt(kpis.qtd_vencendo_7dias) || 0\n    },\n    inadimplencia: {\n      valor_total: formatarValor(kpis.valor_inadimplente),\n      titulos_vencidos: parseInt(kpis.qtd_titulos_vencidos) || 0,\n      clientes_inadimplentes: parseInt(kpis.clientes_inadimplentes) || 0,\n      taxa: `${parseFloat(kpis.taxa_inadimplencia || 0).toFixed(1)}%`,\n      status: getStatusInadimplencia(parseFloat(kpis.taxa_inadimplencia || 0))\n    },\n    projecao: {\n      saldo_projetado: formatarValor(kpis.saldo_projetado),\n      status: getStatusResultado(parseFloat(kpis.saldo_projetado))\n    },\n    gerado_em: new Date().toLocaleString('pt-BR')\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300],
      "id": "formatar-dashboard",
      "name": "Formatar Dashboard"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Buscar KPIs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar KPIs": {
      "main": [
        [
          {
            "node": "Formatar Dashboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "tool-dashboard-kpis",
  "tags": []
}
