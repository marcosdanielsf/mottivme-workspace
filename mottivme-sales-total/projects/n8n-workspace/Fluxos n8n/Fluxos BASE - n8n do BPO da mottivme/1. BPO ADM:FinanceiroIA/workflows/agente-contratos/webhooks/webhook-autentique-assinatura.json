{
  "name": "Webhook - Notifica√ß√£o Assinatura Autentique",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "autentique-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "id": "webhook-autentique",
      "name": "Webhook Autentique",
      "webhookId": "autentique-assinatura-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Processar evento do Autentique\nconst payload = $json;\n\n// Log do payload recebido para debug\nconsole.log('Autentique Webhook Payload:', JSON.stringify(payload, null, 2));\n\n// Estrutura esperada do Autentique:\n// - event: tipo do evento (document.signed, document.finished, etc)\n// - document: dados do documento\n// - signature: dados da assinatura (quando aplic√°vel)\n\nconst evento = payload.event || payload.type || 'unknown';\nconst documento = payload.document || payload.data?.document || {};\nconst assinatura = payload.signature || payload.data?.signature || {};\n\n// Extrair informa√ß√µes relevantes\nconst docId = documento.id || documento.uuid || null;\nconst docNome = documento.name || documento.nome || 'Documento';\nconst signerNome = assinatura.name || assinatura.signer?.name || 'Signat√°rio';\nconst signerEmail = assinatura.email || assinatura.signer?.email || null;\nconst signedAt = assinatura.signed_at || assinatura.created_at || new Date().toISOString();\n\n// Verificar se √© um evento de assinatura\nconst eventosAssinatura = ['document.signed', 'signature.signed', 'signed', 'SIGNED'];\nconst eventosConclusao = ['document.finished', 'document.completed', 'finished', 'FINISHED', 'COMPLETED'];\n\nconst isAssinatura = eventosAssinatura.some(e => evento.toLowerCase().includes(e.toLowerCase()));\nconst isConclusao = eventosConclusao.some(e => evento.toLowerCase().includes(e.toLowerCase()));\n\nreturn {\n  json: {\n    evento_tipo: evento,\n    is_assinatura: isAssinatura,\n    is_conclusao: isConclusao,\n    documento: {\n      id: docId,\n      nome: docNome\n    },\n    assinatura: {\n      nome: signerNome,\n      email: signerEmail,\n      data: signedAt\n    },\n    payload_original: payload,\n    processado_em: new Date().toISOString()\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "id": "processar-evento",
      "name": "Processar Evento"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-assinatura",
              "leftValue": "={{ $json.is_assinatura }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [680, 300],
      "id": "check-tipo-evento",
      "name": "√â Assinatura?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Buscar contrato pelo autentique_doc_id\nSELECT \n  cp.id,\n  cp.nome,\n  cp.email,\n  cp.telefone,\n  cp.produto,\n  cp.valor_mensal,\n  cp.status,\n  cp.autentique_doc_id,\n  cp.google_doc_id,\n  cp.url_contrato_gerado\nFROM fin_contratos_pendentes cp\nWHERE cp.autentique_doc_id = '{{ $json.documento.id }}'\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [900, 200],
      "id": "buscar-contrato",
      "name": "Buscar Contrato",
      "credentials": {
        "postgres": {
          "id": "WsU3bciJm7aMyAoC",
          "name": "postgress - financeiro - mottivme sales"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Preparar notifica√ß√£o de assinatura\nconst evento = $('Processar Evento').first().json;\nconst contrato = $json;\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return 'Data n√£o informada';\n  const data = new Date(dataStr);\n  return data.toLocaleString('pt-BR', { \n    dateStyle: 'short', \n    timeStyle: 'short' \n  });\n};\n\n// Determinar quem assinou\nlet quemAssinou = evento.assinatura.nome || evento.assinatura.email || 'Algu√©m';\nlet tipoAssinante = 'Cliente';\n\nif (evento.assinatura.email) {\n  const email = evento.assinatura.email.toLowerCase();\n  if (email === 'hallennaiane@gmail.com') {\n    tipoAssinante = 'Admin (Hallen)';\n  } else if (email === 'ceo@marcosdaniels.com') {\n    tipoAssinante = 'CEO (Marcos)';\n  } else if (email === 'lucasadley5@gmail.com') {\n    tipoAssinante = 'Testemunha (Lucas)';\n  } else if (contrato.email && email === contrato.email.toLowerCase()) {\n    tipoAssinante = 'Cliente';\n  }\n}\n\nreturn {\n  json: {\n    contrato_encontrado: !!contrato.id,\n    contrato: {\n      id: contrato.id,\n      nome: contrato.nome,\n      email: contrato.email,\n      telefone: contrato.telefone,\n      produto: contrato.produto,\n      valor_mensal: contrato.valor_mensal,\n      status: contrato.status,\n      url_doc: contrato.url_contrato_gerado\n    },\n    assinatura: {\n      quem: quemAssinou,\n      tipo: tipoAssinante,\n      email: evento.assinatura.email,\n      data_formatada: formatarData(evento.assinatura.data)\n    },\n    notificacao: {\n      titulo: `‚úÖ Contrato Assinado - ${contrato.nome || evento.documento.nome}`,\n      mensagem: `${tipoAssinante} (${quemAssinou}) assinou o contrato em ${formatarData(evento.assinatura.data)}`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 200],
      "id": "preparar-notificacao",
      "name": "Preparar Notifica√ß√£o"
    },
    {
      "parameters": {
        "fromEmail": "contratos@marcosdaniels.com",
        "toEmail": "ceo@marcosdaniels.com",
        "subject": "={{ $json.notificacao.titulo }}",
        "emailType": "html",
        "message": "=<div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n  <h2 style=\"color: #28a745;\">‚úÖ Nova Assinatura no Contrato!</h2>\n  \n  <div style=\"background: #d4edda; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #28a745;\">\n    <p style=\"margin: 0; font-size: 18px;\"><strong>{{ $json.assinatura.tipo }}</strong> assinou!</p>\n    <p style=\"margin: 5px 0 0 0; color: #155724;\">{{ $json.assinatura.quem }}</p>\n    <p style=\"margin: 5px 0 0 0; color: #666; font-size: 12px;\">{{ $json.assinatura.data_formatada }}</p>\n  </div>\n  \n  <h3 style=\"color: #333;\">üìÑ Detalhes do Contrato</h3>\n  \n  <div style=\"background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n    <p><strong>Cliente:</strong> {{ $json.contrato.nome }}</p>\n    <p><strong>Email:</strong> {{ $json.contrato.email }}</p>\n    <p><strong>Produto:</strong> {{ $json.contrato.produto }}</p>\n    <p><strong>Valor Mensal:</strong> R$ {{ $json.contrato.valor_mensal }}</p>\n  </div>\n  \n  {{ $json.contrato.url_doc ? '<p><a href=\"' + $json.contrato.url_doc + '\" style=\"color: #0066cc;\">Ver documento no Google Docs</a></p>' : '' }}\n  \n  <hr style=\"margin: 30px 0; border: none; border-top: 1px solid #eee;\">\n  <p style=\"color: #999; font-size: 11px;\">Notifica√ß√£o autom√°tica do sistema de contratos BPO Financeiro</p>\n</div>",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1340, 200],
      "id": "enviar-email-notificacao",
      "name": "Notificar por Email",
      "credentials": {
        "smtp": {
          "id": "smtp-credentials",
          "name": "SMTP"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Webhook processado', evento: $('Processar Evento').first().json.evento_tipo }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1560, 200],
      "id": "responder-sucesso",
      "name": "Responder OK"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Evento ignorado - n√£o √© assinatura', evento: $('Processar Evento').first().json.evento_tipo }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [900, 400],
      "id": "responder-ignorado",
      "name": "Responder Ignorado"
    }
  ],
  "connections": {
    "Webhook Autentique": {
      "main": [
        [
          {
            "node": "Processar Evento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Evento": {
      "main": [
        [
          {
            "node": "√â Assinatura?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "√â Assinatura?": {
      "main": [
        [
          {
            "node": "Buscar Contrato",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Ignorado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Contrato": {
      "main": [
        [
          {
            "node": "Preparar Notifica√ß√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Notifica√ß√£o": {
      "main": [
        [
          {
            "node": "Notificar por Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notificar por Email": {
      "main": [
        [
          {
            "node": "Responder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "webhook-autentique-assinatura",
  "tags": [
    {
      "name": "BPO Financeiro"
    },
    {
      "name": "Webhooks"
    }
  ],
  "pinData": {}
}
