{
  "name": "Exemplo - Agente com Tracking via Webhook",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [240, 400],
      "id": "chat-trigger",
      "name": "Chat Trigger",
      "webhookId": "exemplo-chat-webhook"
    },
    {
      "parameters": {
        "options": {
          "returnIntermediateSteps": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [680, 400],
      "id": "ai-agent",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [300, 600],
      "id": "openai-model",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "SEU_CREDENTIAL_ID",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "code": {
          "supplyData": {
            "code": "// LangChain Code - Intercepta chamadas LLM e registra tokens via Webhook\n\n// Pega a LLM conectada (NÃO precisa mais da tool!)\nconst llm = await this.getInputConnectionData('ai_languageModel', 0);\n\n// Obtém os IDs do workflow e da execução\nconst workflowId = $workflow.id;\nconst executionId = $execution.id;\n\n// URL do webhook - SUBSTITUA pela URL do seu n8n\nconst WEBHOOK_URL = 'https://SEU-N8N.app.n8n.cloud/webhook/registrar-custo-llm';\n// Ou se for self-hosted: 'http://localhost:5678/webhook/registrar-custo-llm'\n\n// Define o callback para registrar o uso de tokens\nllm.callbacks = [{\n  handleLLMEnd: async ({ generations }) => {\n    try {\n      const gen = generations[0][0];\n\n      // Extrai usage_metadata de diferentes formatos de resposta\n      const usage = gen.message?.usage_metadata\n        || gen.message?.additional_kwargs?.usage_metadata\n        || gen.generationInfo?.usage_metadata\n        || {\n            input_tokens: gen.generationInfo?.promptTokenCount || gen.generationInfo?.input_tokens || 0,\n            output_tokens: gen.generationInfo?.candidatesTokenCount || gen.generationInfo?.output_tokens || 0,\n            total_tokens: gen.generationInfo?.totalTokenCount || gen.generationInfo?.total_tokens || 0\n        };\n\n      const input_tokens = usage.input_tokens || 0;\n      const output_tokens = usage.output_tokens || 0;\n      const total_tokens = usage.total_tokens || (input_tokens + output_tokens);\n\n      // Chama o webhook diretamente via fetch\n      await fetch(WEBHOOK_URL, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          date: new Date().toISOString(),\n          model: llm.modelName || llm.model || 'unknown-model',\n          input_tokens,\n          output_tokens,\n          total_tokens,\n          workflowId,\n          executionId\n        })\n      });\n    } catch (err) {\n      console.error('Erro ao registrar uso da LLM:', err);\n    }\n  }\n}];\n\nreturn llm;"
          }
        },
        "inputs": {
          "input": [
            {
              "type": "ai_languageModel",
              "required": true
            }
          ]
        },
        "outputs": {
          "output": [
            {
              "type": "ai_languageModel"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.code",
      "typeVersion": 1,
      "position": [460, 400],
      "id": "langchain-interceptor",
      "name": "LangChain Interceptor (Webhook)"
    }
  ],
  "connections": {
    "Chat Trigger": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "LangChain Interceptor (Webhook)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "LangChain Interceptor (Webhook)": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "exemplo-agente-tracking-webhook",
  "tags": []
}
