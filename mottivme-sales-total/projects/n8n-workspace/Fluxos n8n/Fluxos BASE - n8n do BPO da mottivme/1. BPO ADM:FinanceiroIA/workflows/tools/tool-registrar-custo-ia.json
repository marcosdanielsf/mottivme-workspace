{
  "name": "[TOOL] Registrar Custo IA",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "modelo_ia"
            },
            {
              "name": "tokens_input",
              "type": "number"
            },
            {
              "name": "tokens_output",
              "type": "number"
            },
            {
              "name": "location_id"
            },
            {
              "name": "location_name"
            },
            {
              "name": "contact_id"
            },
            {
              "name": "contact_name"
            },
            {
              "name": "canal"
            },
            {
              "name": "tipo_acao"
            },
            {
              "name": "mensagem_entrada"
            },
            {
              "name": "mensagem_saida"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [240, 300],
      "id": "trigger",
      "name": "Quando Chamado"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\n// Tabela de pre√ßos por modelo (USD por 1M tokens)\nconst precos = {\n  // Google\n  'gemini-2.0-flash': { input: 0.10, output: 0.40 },\n  'gemini-1.5-flash': { input: 0.075, output: 0.30 },\n  'gemini-1.5-pro': { input: 1.25, output: 5.00 },\n  // OpenAI\n  'gpt-4o': { input: 2.50, output: 10.00 },\n  'gpt-4o-mini': { input: 0.15, output: 0.60 },\n  'gpt-4-turbo': { input: 10.00, output: 30.00 },\n  'gpt-3.5-turbo': { input: 0.50, output: 1.50 },\n  // Anthropic\n  'claude-3-opus': { input: 15.00, output: 75.00 },\n  'claude-3-sonnet': { input: 3.00, output: 15.00 },\n  'claude-3-haiku': { input: 0.25, output: 1.25 },\n  'claude-3.5-sonnet': { input: 3.00, output: 15.00 },\n  // Groq\n  'groq-llama3-70b': { input: 0.59, output: 0.79 },\n  'groq-llama3-8b': { input: 0.05, output: 0.08 },\n  'groq-mixtral-8x7b': { input: 0.24, output: 0.24 },\n  // Default\n  'default': { input: 0.10, output: 0.40 }\n};\n\n// Normalizar nome do modelo\nlet modelo = (input.modelo_ia || 'gemini-2.0-flash').toLowerCase();\n\n// Tentar encontrar modelo na tabela\nlet preco = precos[modelo];\nif (!preco) {\n  // Tentar match parcial\n  for (const [key, val] of Object.entries(precos)) {\n    if (modelo.includes(key) || key.includes(modelo)) {\n      preco = val;\n      modelo = key;\n      break;\n    }\n  }\n}\nif (!preco) preco = precos['default'];\n\n// Tokens\nconst tokens_input = parseInt(input.tokens_input) || 0;\nconst tokens_output = parseInt(input.tokens_output) || 0;\n\n// Calcular custo\nconst custo_input = (tokens_input / 1000000) * preco.input;\nconst custo_output = (tokens_output / 1000000) * preco.output;\nconst custo_total = custo_input + custo_output;\n\nreturn {\n  json: {\n    workflow_id: $workflow.id,\n    workflow_name: $workflow.name,\n    execution_id: $execution.id,\n    location_id: input.location_id || null,\n    location_name: input.location_name || null,\n    contact_id: input.contact_id || null,\n    contact_name: input.contact_name || null,\n    canal: input.canal || 'whatsapp',\n    tipo_acao: input.tipo_acao || 'ia_generica',\n    modelo_ia: modelo,\n    tokens_input: tokens_input,\n    tokens_output: tokens_output,\n    custo_usd: parseFloat(custo_total.toFixed(6)),\n    mensagem_entrada: (input.mensagem_entrada || '').substring(0, 500),\n    mensagem_saida: (input.mensagem_saida || '').substring(0, 500)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "id": "calcular-custo",
      "name": "Calcular Custo"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO llm_costs (\n  workflow_id,\n  workflow_name,\n  execution_id,\n  location_id,\n  location_name,\n  contact_id,\n  contact_name,\n  canal,\n  tipo_acao,\n  modelo_ia,\n  tokens_input,\n  tokens_output,\n  custo_usd,\n  mensagem_entrada,\n  mensagem_saida\n)\nVALUES (\n  {{ $json.workflow_id ? \"'\" + $json.workflow_id + \"'\" : 'NULL' }},\n  {{ $json.workflow_name ? \"'\" + $json.workflow_name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.execution_id ? \"'\" + $json.execution_id + \"'\" : 'NULL' }},\n  {{ $json.location_id ? \"'\" + $json.location_id + \"'\" : 'NULL' }},\n  {{ $json.location_name ? \"'\" + $json.location_name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.contact_id ? \"'\" + $json.contact_id + \"'\" : 'NULL' }},\n  {{ $json.contact_name ? \"'\" + $json.contact_name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  '{{ $json.canal }}',\n  '{{ $json.tipo_acao }}',\n  '{{ $json.modelo_ia }}',\n  {{ $json.tokens_input }},\n  {{ $json.tokens_output }},\n  {{ $json.custo_usd }},\n  {{ $json.mensagem_entrada ? \"'\" + $json.mensagem_entrada.replace(/'/g, \"''\").replace(/\\n/g, ' ') + \"'\" : 'NULL' }},\n  {{ $json.mensagem_saida ? \"'\" + $json.mensagem_saida.replace(/'/g, \"''\").replace(/\\n/g, ' ') + \"'\" : 'NULL' }}\n)\nRETURNING id, custo_usd;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 300],
      "id": "inserir-custo",
      "name": "Inserir em llm_costs",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "success",
              "name": "success",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "custo",
              "name": "custo_usd",
              "value": "={{ $json.custo_usd }}",
              "type": "number"
            },
            {
              "id": "id",
              "name": "registro_id",
              "value": "={{ $json.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [900, 300],
      "id": "resposta",
      "name": "Resposta"
    }
  ],
  "connections": {
    "Quando Chamado": {
      "main": [
        [
          {
            "node": "Calcular Custo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Custo": {
      "main": [
        [
          {
            "node": "Inserir em llm_costs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir em llm_costs": {
      "main": [
        [
          {
            "node": "Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "tool-registrar-custo-ia",
  "tags": []
}
