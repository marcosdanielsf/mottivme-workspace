{
  "name": "[TOOL] Registrar Custo LLM",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "date"
            },
            {
              "name": "model"
            },
            {
              "name": "input_tokens",
              "type": "number"
            },
            {
              "name": "output_tokens",
              "type": "number"
            },
            {
              "name": "total_tokens",
              "type": "number"
            },
            {
              "name": "workflowId"
            },
            {
              "name": "executionId"
            },
            {
              "name": "location_id"
            },
            {
              "name": "location_name"
            },
            {
              "name": "contact_id"
            },
            {
              "name": "contact_name"
            },
            {
              "name": "canal"
            },
            {
              "name": "tipo_acao"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [240, 300],
      "id": "trigger",
      "name": "Quando Chamado"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\n// Tabela de pre√ßos por modelo (USD por 1M tokens)\nconst precos = {\n  // Google Gemini\n  'gemini-2.0-flash': { input: 0.10, output: 0.40 },\n  'gemini-2.0-flash-exp': { input: 0.10, output: 0.40 },\n  'gemini-1.5-flash': { input: 0.075, output: 0.30 },\n  'gemini-1.5-flash-latest': { input: 0.075, output: 0.30 },\n  'gemini-1.5-pro': { input: 1.25, output: 5.00 },\n  'gemini-1.5-pro-latest': { input: 1.25, output: 5.00 },\n  'gemini-pro': { input: 0.50, output: 1.50 },\n  // OpenAI\n  'gpt-4o': { input: 2.50, output: 10.00 },\n  'gpt-4o-mini': { input: 0.15, output: 0.60 },\n  'gpt-4-turbo': { input: 10.00, output: 30.00 },\n  'gpt-4': { input: 30.00, output: 60.00 },\n  'gpt-3.5-turbo': { input: 0.50, output: 1.50 },\n  'gpt-3.5-turbo-0125': { input: 0.50, output: 1.50 },\n  // Anthropic Claude\n  'claude-3-opus': { input: 15.00, output: 75.00 },\n  'claude-3-sonnet': { input: 3.00, output: 15.00 },\n  'claude-3-haiku': { input: 0.25, output: 1.25 },\n  'claude-3.5-sonnet': { input: 3.00, output: 15.00 },\n  'claude-3-5-sonnet-20241022': { input: 3.00, output: 15.00 },\n  // Groq\n  'llama3-70b-8192': { input: 0.59, output: 0.79 },\n  'llama3-8b-8192': { input: 0.05, output: 0.08 },\n  'mixtral-8x7b-32768': { input: 0.24, output: 0.24 },\n  'gemma-7b-it': { input: 0.07, output: 0.07 },\n  // OpenRouter\n  'openrouter/auto': { input: 0.50, output: 1.50 },\n  // Default\n  'default': { input: 0.10, output: 0.40 }\n};\n\n// Normalizar nome do modelo\nlet modelo = (input.model || 'gemini-model').toLowerCase();\n\n// Tentar encontrar modelo na tabela\nlet preco = precos[modelo];\nif (!preco) {\n  // Tentar match parcial\n  for (const [key, val] of Object.entries(precos)) {\n    if (modelo.includes(key) || key.includes(modelo)) {\n      preco = val;\n      break;\n    }\n  }\n}\nif (!preco) preco = precos['default'];\n\n// Tokens (vem do callback do LangChain)\nconst tokens_input = parseInt(input.input_tokens) || 0;\nconst tokens_output = parseInt(input.output_tokens) || 0;\nconst tokens_total = parseInt(input.total_tokens) || (tokens_input + tokens_output);\n\n// Calcular custo\nconst custo_input = (tokens_input / 1000000) * preco.input;\nconst custo_output = (tokens_output / 1000000) * preco.output;\nconst custo_total = custo_input + custo_output;\n\nreturn {\n  json: {\n    date: input.date || new Date().toISOString(),\n    modelo_ia: modelo,\n    tokens_input: tokens_input,\n    tokens_output: tokens_output,\n    tokens_total: tokens_total,\n    custo_usd: parseFloat(custo_total.toFixed(6)),\n    workflow_id: input.workflowId || null,\n    execution_id: input.executionId || null,\n    location_id: input.location_id || null,\n    location_name: input.location_name || null,\n    contact_id: input.contact_id || null,\n    contact_name: input.contact_name || null,\n    canal: input.canal || 'api',\n    tipo_acao: input.tipo_acao || 'llm_call'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "id": "calcular-custo",
      "name": "Calcular Custo"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO llm_costs (\n  created_at,\n  workflow_id,\n  workflow_name,\n  execution_id,\n  location_id,\n  location_name,\n  contact_id,\n  contact_name,\n  canal,\n  tipo_acao,\n  modelo_ia,\n  tokens_input,\n  tokens_output,\n  custo_usd\n)\nVALUES (\n  '{{ $json.date }}'::timestamptz,\n  {{ $json.workflow_id ? \"'\" + $json.workflow_id + \"'\" : 'NULL' }},\n  NULL,\n  {{ $json.execution_id ? \"'\" + $json.execution_id + \"'\" : 'NULL' }},\n  {{ $json.location_id ? \"'\" + $json.location_id + \"'\" : 'NULL' }},\n  {{ $json.location_name ? \"'\" + $json.location_name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  {{ $json.contact_id ? \"'\" + $json.contact_id + \"'\" : 'NULL' }},\n  {{ $json.contact_name ? \"'\" + $json.contact_name.replace(/'/g, \"''\") + \"'\" : 'NULL' }},\n  '{{ $json.canal }}',\n  '{{ $json.tipo_acao }}',\n  '{{ $json.modelo_ia }}',\n  {{ $json.tokens_input }},\n  {{ $json.tokens_output }},\n  {{ $json.custo_usd }}\n)\nRETURNING id, custo_usd;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 300],
      "id": "inserir-custo",
      "name": "Inserir em llm_costs",
      "credentials": {
        "postgres": {
          "id": "w2mBaRwhZ3tM4FUw",
          "name": "Postgres Marcos Daniels"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "success",
              "name": "success",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [900, 300],
      "id": "resposta",
      "name": "Resposta"
    }
  ],
  "connections": {
    "Quando Chamado": {
      "main": [
        [
          {
            "node": "Calcular Custo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Custo": {
      "main": [
        [
          {
            "node": "Inserir em llm_costs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir em llm_costs": {
      "main": [
        [
          {
            "node": "Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "tool-registrar-custo-llm",
  "tags": []
}
