{
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Extrai o project_id de qualquer lugar que ele possa estar\nconst input = $input.first().json;\n\n// Tenta encontrar o project_id em diferentes lugares\nlet projectId = \n  input.body?.project_id ||\n  input.body?.recordId ||\n  input.query?.project_id ||\n  input.query?.recordId ||\n  input.project_id ||\n  input.recordId ||\n  input.params?.project_id ||\n  input.params?.recordId;\n\nif (!projectId) {\n  throw new Error('project_id n√£o encontrado! Dados recebidos: ' + JSON.stringify(input, null, 2));\n}\n\nreturn [{\n  json: {\n    project_id: projectId,\n    original_input: input\n  }\n}];"
      },
      "id": "extract-project-id-001",
      "name": "üîç Extract Project ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [420, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT get_expert_data('{{ $json.project_id }}'::uuid) as data;",
        "options": {}
      },
      "id": "get-expert-data-001",
      "name": "üìñ Get Expert Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [640, 300],
      "credentials": {
        "postgres": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extrai os dados do resultado da query Postgres\nconst result = $input.first().json;\nlet data = result.data;\n\n// Se vier como string, faz parse\nif (typeof data === 'string') {\n  data = JSON.parse(data);\n}\n\nconst project = data.project || {};\nconst briefing = data.briefing || {};\nconst clone = data.clone || {};\nconst offers = data.offers || {};\n\nfunction getValue(obj, field) {\n  if (!obj || !obj[field]) return null;\n  if (obj[field] === '') return null;\n  return obj[field];\n}\n\nfunction formatSection(title, content) {\n  if (!content || (typeof content === 'string' && content.trim() === '')) return '';\n  if (typeof content === 'object') content = JSON.stringify(content, null, 2);\n  return `\\n### ${title}\\n${content}\\n`;\n}\n\nlet context = `# üß¨ PERFIL COMPLETO DO EXPERT\\n`;\ncontext += `Este √© o perfil detalhado extra√≠do do briefing e dados do projeto.\\n`;\ncontext += `\\n---\\n`;\n\ncontext += `\\n## üìã DADOS B√ÅSICOS DO EXPERT\\n`;\ncontext += `\\n**Nome:** ${project.name || 'N√£o informado'}\\n`;\ncontext += `**Nicho:** ${getValue(briefing, 'nicho') || 'N√£o informado'}\\n`;\ncontext += `**Produto:** ${getValue(briefing, 'produto') || 'N√£o informado'}\\n`;\n\ncontext += `\\n---\\n`;\ncontext += `\\n## üéØ BRIEFING\\n`;\ncontext += formatSection('Avatar/P√∫blico-Alvo', getValue(briefing, 'avatar_descricao'));\ncontext += formatSection('Dor Principal', getValue(briefing, 'dor_principal'));\ncontext += formatSection('Desejo Principal', getValue(briefing, 'desejo_principal'));\ncontext += formatSection('Transforma√ß√£o Prometida', getValue(briefing, 'transformacao'));\ncontext += formatSection('Diferencial', getValue(briefing, 'diferencial'));\ncontext += formatSection('Ticket M√©dio', getValue(briefing, 'ticket_medio'));\ncontext += formatSection('Tipo de Funil', getValue(briefing, 'tipo_funil'));\ncontext += formatSection('Tom de Comunica√ß√£o', getValue(briefing, 'tom_comunicacao'));\n\nif (clone && clone.system_prompt) {\n  context += `\\n---\\n`;\n  context += `\\n## üß¨ CLONE SYSTEM PROMPT (EXISTENTE)\\n`;\n  context += `\\n\\`\\`\\`\\n${clone.system_prompt}\\n\\`\\`\\`\\n`;\n}\n\nif (clone && clone.dna_psicologico) {\n  context += formatSection('DNA Psicol√≥gico', clone.dna_psicologico);\n}\n\nif (clone && clone.engenharia_reversa) {\n  context += formatSection('Engenharia Reversa', clone.engenharia_reversa);\n}\n\nif (clone && clone.sintese_estrategica) {\n  context += `\\n---\\n`;\n  context += `\\n## üìä POSICIONAMENTO ESTRAT√âGICO\\n`;\n  context += formatSection('S√≠ntese Estrat√©gica', clone.sintese_estrategica);\n  context += formatSection('An√°lise de Concorrentes', clone.analise_concorrentes);\n}\n\nif (offers && offers.avatar) {\n  context += `\\n---\\n`;\n  context += `\\n## üí∞ ECOSSISTEMA DE OFERTAS\\n`;\n  context += formatSection('Avatar Detalhado', offers.avatar);\n  context += formatSection('Promessas', offers.promessas);\n  context += formatSection('Big Idea', offers.big_idea);\n  context += formatSection('High Ticket', offers.high_ticket);\n  context += formatSection('Frontend', offers.frontend);\n}\n\ncontext += `\\n---\\n`;\ncontext += `\\n*Contexto gerado automaticamente a partir do Supabase.*\\n`;\n\nreturn [{\n  json: {\n    expert_context: context,\n    expert_name: project.name,\n    expert_id: project.id,\n    project_id: project.id,\n    nicho: getValue(briefing, 'nicho'),\n    clone_system_prompt: clone?.system_prompt || null,\n    has_clone: !!clone?.system_prompt,\n    has_posicionamento: !!clone?.sintese_estrategica,\n    has_ofertas: !!offers?.avatar,\n    context_length: context.length,\n    timestamp: new Date().toISOString(),\n    _project: project,\n    _briefing: briefing,\n    _clone: clone,\n    _offers: offers\n  }\n}];"
      },
      "id": "transform-context-001",
      "name": "üîÑ Transform Expert Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [860, 300]
    }
  ],
  "connections": {
    "üîç Extract Project ID": {
      "main": [
        [
          {
            "node": "üìñ Get Expert Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìñ Get Expert Data": {
      "main": [
        [
          {
            "node": "üîÑ Transform Expert Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
