{
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT get_expert_data('{{ $json.body.project_id }}'::uuid) as data;",
        "options": {}
      },
      "id": "b1a2c3d4-e5f6-4789-abcd-111111111111",
      "name": "üìñ Get Expert Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [620, 300],
      "credentials": {
        "postgres": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extrai os dados do resultado da query Postgres\nconst result = $input.first().json;\nlet data = result.data;\n\n// Se vier como string, faz parse\nif (typeof data === 'string') {\n  data = JSON.parse(data);\n}\n\nconst project = data.project || {};\nconst briefing = data.briefing || {};\nconst clone = data.clone || {};\nconst offers = data.offers || {};\n\nfunction getValue(obj, field) {\n  if (!obj || !obj[field]) return null;\n  if (obj[field] === '') return null;\n  return obj[field];\n}\n\nfunction formatSection(title, content) {\n  if (!content || (typeof content === 'string' && content.trim() === '')) return '';\n  if (typeof content === 'object') content = JSON.stringify(content, null, 2);\n  return `\\n### ${title}\\n${content}\\n`;\n}\n\nlet context = `# üß¨ PERFIL COMPLETO DO EXPERT\\n`;\ncontext += `Este √© o perfil detalhado extra√≠do do briefing e dados do projeto.\\n`;\ncontext += `\\n---\\n`;\n\ncontext += `\\n## üìã DADOS B√ÅSICOS DO EXPERT\\n`;\ncontext += `\\n**Nome:** ${project.name || 'N√£o informado'}\\n`;\ncontext += `**Nicho:** ${getValue(briefing, 'nicho') || 'N√£o informado'}\\n`;\ncontext += `**Produto:** ${getValue(briefing, 'produto') || 'N√£o informado'}\\n`;\n\ncontext += `\\n---\\n`;\ncontext += `\\n## üéØ BRIEFING\\n`;\ncontext += formatSection('Avatar/P√∫blico-Alvo', getValue(briefing, 'avatar_descricao'));\ncontext += formatSection('Dor Principal', getValue(briefing, 'dor_principal'));\ncontext += formatSection('Desejo Principal', getValue(briefing, 'desejo_principal'));\ncontext += formatSection('Transforma√ß√£o Prometida', getValue(briefing, 'transformacao'));\ncontext += formatSection('Diferencial', getValue(briefing, 'diferencial'));\ncontext += formatSection('Ticket M√©dio', getValue(briefing, 'ticket_medio'));\ncontext += formatSection('Tipo de Funil', getValue(briefing, 'tipo_funil'));\ncontext += formatSection('Tom de Comunica√ß√£o', getValue(briefing, 'tom_comunicacao'));\n\nif (clone && clone.system_prompt) {\n  context += `\\n---\\n`;\n  context += `\\n## üß¨ CLONE SYSTEM PROMPT (EXISTENTE)\\n`;\n  context += `\\n\\`\\`\\`\\n${clone.system_prompt}\\n\\`\\`\\`\\n`;\n}\n\nif (clone && clone.dna_psicologico) {\n  context += formatSection('DNA Psicol√≥gico', clone.dna_psicologico);\n}\n\nif (clone && clone.engenharia_reversa) {\n  context += formatSection('Engenharia Reversa', clone.engenharia_reversa);\n}\n\nif (clone && clone.sintese_estrategica) {\n  context += `\\n---\\n`;\n  context += `\\n## üìä POSICIONAMENTO ESTRAT√âGICO\\n`;\n  context += formatSection('S√≠ntese Estrat√©gica', clone.sintese_estrategica);\n  context += formatSection('An√°lise de Concorrentes', clone.analise_concorrentes);\n}\n\nif (offers && offers.avatar) {\n  context += `\\n---\\n`;\n  context += `\\n## üí∞ ECOSSISTEMA DE OFERTAS\\n`;\n  context += formatSection('Avatar Detalhado', offers.avatar);\n  context += formatSection('Promessas', offers.promessas);\n  context += formatSection('Big Idea', offers.big_idea);\n  context += formatSection('High Ticket', offers.high_ticket);\n  context += formatSection('Frontend', offers.frontend);\n}\n\ncontext += `\\n---\\n`;\ncontext += `\\n*Contexto gerado automaticamente a partir do Supabase.*\\n`;\n\nreturn [{\n  json: {\n    expert_context: context,\n    expert_name: project.name,\n    expert_id: project.id,\n    project_id: project.id,\n    nicho: getValue(briefing, 'nicho'),\n    clone_system_prompt: clone?.system_prompt || null,\n    has_clone: !!clone?.system_prompt,\n    has_posicionamento: !!clone?.sintese_estrategica,\n    has_ofertas: !!offers?.avatar,\n    context_length: context.length,\n    timestamp: new Date().toISOString(),\n    _project: project,\n    _briefing: briefing,\n    _clone: clone,\n    _offers: offers\n  }\n}];"
      },
      "id": "b1a2c3d4-e5f6-4789-abcd-222222222222",
      "name": "üîÑ Transform Expert Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE clone_experts SET\n  dna_psicologico = '{{ $('1. Agent 1: DNA Psicol√≥gico1').item.json.output.replace(/'/g, \"''\") }}',\n  engenharia_reversa = '{{ $('2. Agent 2: Engenheiro Reverso2').item.json.output.replace(/'/g, \"''\") }}',\n  configuracao_clone = '{{ $('3. Agent 3: Configurador1').item.json.output.replace(/'/g, \"''\") }}',\n  system_prompt = '{{ $json.output.replace(/'/g, \"''\") }}',\n  status = 'ready',\n  updated_at = NOW()\nWHERE project_id = '{{ $('üîÑ Transform Expert Context').item.json.project_id }}'::uuid\nRETURNING *;",
        "options": {}
      },
      "id": "b1a2c3d4-e5f6-4789-abcd-333333333333",
      "name": "üíæ Update Clone - FASE 1A",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1800, 300],
      "credentials": {
        "postgres": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE clone_experts SET\n  analise_concorrentes = '{{ $('5. Agent 5: Identity Mapper').item.json.text.replace(/'/g, \"''\") }}',\n  concorrentes_internacionais = '{{ $('6A. Perplexity Internacional').item.json.choices[0].message.content.replace(/'/g, \"''\") }}',\n  concorrentes_brasileiros = '{{ $('6B. Perplexity Brasil').item.json.choices[0].message.content.replace(/'/g, \"''\") }}',\n  sintese_estrategica = '{{ $('6C. Synthesis and Strategic Analysis').item.json.text.replace(/'/g, \"''\") }}',\n  updated_at = NOW()\nWHERE project_id = '{{ $('üîÑ Transform Expert Context').item.json.project_id }}'::uuid\nRETURNING *;",
        "options": {}
      },
      "id": "b1a2c3d4-e5f6-4789-abcd-444444444444",
      "name": "üíæ Update Posicionamento - FASE 1B",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1800, 500],
      "credentials": {
        "postgres": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO offers (project_id, avatar, avatar_detalhado, promessas, big_idea, mecanismo_unico, high_ticket, mid_ticket, frontend, status, created_at, updated_at)\nVALUES ($1::uuid, $2, $3, $4, $5, $6, $7, $8, $9, 'ready', NOW(), NOW())\nON CONFLICT (project_id) DO UPDATE SET\n  avatar = EXCLUDED.avatar,\n  avatar_detalhado = EXCLUDED.avatar_detalhado,\n  promessas = EXCLUDED.promessas,\n  big_idea = EXCLUDED.big_idea,\n  mecanismo_unico = EXCLUDED.mecanismo_unico,\n  high_ticket = EXCLUDED.high_ticket,\n  mid_ticket = EXCLUDED.mid_ticket,\n  frontend = EXCLUDED.frontend,\n  status = 'ready',\n  updated_at = NOW()\nRETURNING *;",
        "options": {
          "queryParams": "={{ [$json.project_id, $('7. Agent: Avatar Creator').item.json.text, $('7B. Agent: Avatar Detalhado').item.json.text, $('8. Agent: Promise Generator').item.json.text, $('9. Agent: Big Idea Creator').item.json.text, $('9B. Agent: Mecanismo √önico').item.json.text, $json['High Ticket Ofertas - IA'], $json['Back End Ofertas - IA'], $json['Ofertas Front End - IA']] }}"
        }
      },
      "id": "b1a2c3d4-e5f6-4789-abcd-555555555555",
      "name": "üíæ Upsert Offers - FASE 2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1800, 700],
      "credentials": {
        "postgres": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO contents (project_id, type, title, body, hook, cta, generated_by, status, created_at)\nVALUES ($1::uuid, $2, $3, $4, $5, $6, $7, 'draft', NOW())\nRETURNING *;",
        "options": {
          "queryParams": "={{ [$json.project_id, 'reel', $json.title || 'Reel gerado', $json.script || $json.content, $json.hook, $json.cta, 'generateMarketingeGeracaodeDemanda'] }}"
        }
      },
      "id": "b1a2c3d4-e5f6-4789-abcd-666666666666",
      "name": "üíæ Insert Content - Reel",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1800, 900],
      "credentials": {
        "postgres": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO contents (project_id, type, title, body, hook, cta, generated_by, status, created_at)\nVALUES ($1::uuid, $2, $3, $4, $5, $6, $7, 'draft', NOW())\nRETURNING *;",
        "options": {
          "queryParams": "={{ [$json.project_id, 'carousel', $json.title || 'Carrossel gerado', $json.script || $json.content, $json.hook, $json.cta, 'generateMarketingeGeracaodeDemanda'] }}"
        }
      },
      "id": "b1a2c3d4-e5f6-4789-abcd-777777777777",
      "name": "üíæ Insert Content - Carrossel",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1800, 1100],
      "credentials": {
        "postgres": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO contents (project_id, type, title, body, hook, cta, generated_by, status, created_at)\nVALUES ($1::uuid, $2, $3, $4, $5, $6, $7, 'draft', NOW())\nRETURNING *;",
        "options": {
          "queryParams": "={{ [$json.project_id, 'story', $json.title || 'Story gerado', $json.script || $json.content, $json.hook, $json.cta, 'generateMarketingeGeracaodeDemanda'] }}"
        }
      },
      "id": "b1a2c3d4-e5f6-4789-abcd-888888888888",
      "name": "üíæ Insert Content - Stories",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1800, 1300],
      "credentials": {
        "postgres": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "Supabase Postgres"
        }
      }
    }
  ],
  "connections": {
    "üìñ Get Expert Data": {
      "main": [
        [
          {
            "node": "üîÑ Transform Expert Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
