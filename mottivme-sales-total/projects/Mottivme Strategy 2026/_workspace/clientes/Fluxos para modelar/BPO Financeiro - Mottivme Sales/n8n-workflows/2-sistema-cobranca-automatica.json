{
  "name": "2. Sistema de Cobrança Automática",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 400],
      "id": "schedule-trigger",
      "name": "A cada 6 horas"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ghl-location",
              "name": "location_id",
              "value": "cd1uyzpJox6XPt4Vct8Y",
              "type": "string"
            },
            {
              "id": "ghl-api",
              "name": "ghl_api_key",
              "value": "pit-fe627027-b9cb-4ea3-aaa4-149459e66a03",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 400],
      "id": "config-ghl",
      "name": "Config GHL"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar cobranças com vencimento em 5 dias (lembretes)\nSELECT \n  m.id,\n  m.descricao,\n  m.valor_previsto as valor,\n  m.data_vencimento,\n  c.nome as cliente_nome,\n  c.telefone,\n  c.email,\n  m.observacao\nFROM movimentacoes_financeiras m\nLEFT JOIN clientes_fornecedores c ON m.cliente_fornecedor_id = c.id\nWHERE \n  m.tipo = 'receita'\n  AND m.quitado = false\n  AND m.data_vencimento = CURRENT_DATE + INTERVAL '5 days'\n  AND c.telefone IS NOT NULL\n  AND NOT EXISTS (\n    SELECT 1 FROM cobrancas_automaticas ca\n    WHERE ca.movimentacao_id = m.id\n    AND ca.status IN ('lembrete_enviado', 'cobranca_enviada', 'pago')\n  )\nORDER BY m.data_vencimento ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 300],
      "id": "query-reminders",
      "name": "Buscar Lembretes (5 dias)",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar cobranças vencendo hoje\nSELECT \n  m.id,\n  m.descricao,\n  m.valor_previsto as valor,\n  m.data_vencimento,\n  c.nome as cliente_nome,\n  c.telefone,\n  c.email,\n  m.observacao\nFROM movimentacoes_financeiras m\nLEFT JOIN clientes_fornecedores c ON m.cliente_fornecedor_id = c.id\nWHERE \n  m.tipo = 'receita'\n  AND m.quitado = false\n  AND m.data_vencimento = CURRENT_DATE\n  AND c.telefone IS NOT NULL\n  AND NOT EXISTS (\n    SELECT 1 FROM cobrancas_automaticas ca\n    WHERE ca.movimentacao_id = m.id\n    AND ca.status IN ('cobranca_enviada', 'pago')\n  )\nORDER BY m.data_vencimento ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 500],
      "id": "query-due-today",
      "name": "Buscar Vencimentos Hoje",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format reminder message (5 days before)\nconst items = $input.all();\nconst config = $('Config GHL').item.json;\nconst results = [];\n\nfor (const item of items) {\n  const data = item.json;\n  \n  if (!data.email) continue;\n  \n  const valorFormatado = new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(data.valor);\n  \n  const dataVencimento = new Date(data.data_vencimento + 'T00:00:00');\n  const vencimentoFormatado = dataVencimento.toLocaleDateString('pt-BR');\n  \n  const mensagem = `Olá ${data.cliente_nome || 'Cliente'}!\n\n*LEMBRETE DE PAGAMENTO*\n\nSua fatura de ${valorFormatado} vence em 5 dias (${vencimentoFormatado}).\n\nDescrição: ${data.descricao || 'Serviço'}\n\nEvite multas e juros pagando até o vencimento.\n\nQualquer dúvida, estamos à disposição!\n\n---\nMottivme Sales - Gestão Financeira`;\n\n  results.push({\n    json: {\n      ...data,\n      mensagem,\n      tipo_notificacao: 'lembrete',\n      location_id: config.location_id,\n      ghl_api_key: config.ghl_api_key\n    }\n  });\n}\n\nreturn results.length > 0 ? results : [{json: {skip: true}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300],
      "id": "format-reminders",
      "name": "Formatar Lembretes"
    },
    {
      "parameters": {
        "jsCode": "// Format charge message (due today)\nconst items = $input.all();\nconst config = $('Config GHL').item.json;\nconst results = [];\n\nfor (const item of items) {\n  const data = item.json;\n  \n  if (!data.email) continue;\n  \n  const valorFormatado = new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(data.valor);\n  \n  const dataVencimento = new Date(data.data_vencimento + 'T00:00:00');\n  const vencimentoFormatado = dataVencimento.toLocaleDateString('pt-BR');\n  \n  const mensagem = `*COBRANÇA - VENCIMENTO HOJE*\n\nOlá ${data.cliente_nome || 'Cliente'},\n\nSua fatura de ${valorFormatado} vence *HOJE* (${vencimentoFormatado})!\n\nDescrição: ${data.descricao || 'Serviço'}\n\nPara evitar juros e multas, efetue o pagamento o quanto antes.\n\nApós o pagamento, envie o comprovante para confirmarmos o recebimento.\n\n---\nMottivme Sales - Gestão Financeira`;\n\n  results.push({\n    json: {\n      ...data,\n      mensagem,\n      tipo_notificacao: 'cobranca',\n      location_id: config.location_id,\n      ghl_api_key: config.ghl_api_key\n    }\n  });\n}\n\nreturn results.length > 0 ? results : [{json: {skip: true}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 500],
      "id": "format-charges",
      "name": "Formatar Cobranças"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1120, 400],
      "id": "merge-all",
      "name": "Juntar Todos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "skip-check",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1340, 400],
      "id": "filter-valid",
      "name": "Filtrar Válidos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/contacts/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.ghl_api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"locationId\": \"{{ $json.location_id }}\",\n  \"pageLimit\": 1,\n  \"query\": \"{{ $json.email }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1560, 400],
      "id": "search-contact",
      "name": "Buscar Contato GHL"
    },
    {
      "parameters": {
        "jsCode": "// Extrair contact_id do resultado da busca\nconst searchResult = $input.item.json;\nconst previousData = $('Filtrar Válidos').item.json;\n\nconst contactId = searchResult.contacts?.[0]?.id || null;\n\nif (!contactId) {\n  return {\n    json: {\n      ...previousData,\n      contact_id: null,\n      erro: 'Contato não encontrado no GHL'\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...previousData,\n    contact_id: contactId\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 400],
      "id": "extract-contact-id",
      "name": "Extrair Contact ID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-contact",
              "leftValue": "={{ $json.contact_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [2000, 400],
      "id": "check-contact",
      "name": "Tem Contact ID?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.ghl_api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $json.contact_id }}\",\n  \"message\": \"{{ $json.mensagem.replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2220, 300],
      "id": "send-whatsapp",
      "name": "Enviar WhatsApp GHL"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Registrar envio de notificação\nINSERT INTO cobrancas_automaticas (\n  movimentacao_id,\n  telefone,\n  status,\n  lembrete_enviado_em,\n  cobranca_enviada_em\n)\nVALUES (\n  '{{ $json.id }}'::uuid,\n  '{{ $json.telefone }}',\n  '{{ $json.tipo_notificacao === \"lembrete\" ? \"lembrete_enviado\" : \"cobranca_enviada\" }}',\n  {{ $json.tipo_notificacao === \"lembrete\" ? \"NOW()\" : \"NULL\" }},\n  {{ $json.tipo_notificacao === \"cobranca\" ? \"NOW()\" : \"NULL\" }}\n)\nON CONFLICT (movimentacao_id) DO UPDATE\nSET \n  status = EXCLUDED.status,\n  lembrete_enviado_em = COALESCE(EXCLUDED.lembrete_enviado_em, cobrancas_automaticas.lembrete_enviado_em),\n  cobranca_enviada_em = COALESCE(EXCLUDED.cobranca_enviada_em, cobrancas_automaticas.cobranca_enviada_em)\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [2440, 300],
      "id": "log-notification",
      "name": "Registrar Envio",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1560, 560],
      "id": "noop-skip",
      "name": "Nada a Enviar"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2220, 500],
      "id": "noop-no-contact",
      "name": "Contato não encontrado"
    }
  ],
  "connections": {
    "A cada 6 horas": {
      "main": [
        [
          {
            "node": "Config GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config GHL": {
      "main": [
        [
          {
            "node": "Buscar Lembretes (5 dias)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Buscar Vencimentos Hoje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Lembretes (5 dias)": {
      "main": [
        [
          {
            "node": "Formatar Lembretes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Vencimentos Hoje": {
      "main": [
        [
          {
            "node": "Formatar Cobranças",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Lembretes": {
      "main": [
        [
          {
            "node": "Juntar Todos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Cobranças": {
      "main": [
        [
          {
            "node": "Juntar Todos",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Juntar Todos": {
      "main": [
        [
          {
            "node": "Filtrar Válidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrar Válidos": {
      "main": [
        [
          {
            "node": "Buscar Contato GHL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Nada a Enviar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Contato GHL": {
      "main": [
        [
          {
            "node": "Extrair Contact ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Contact ID": {
      "main": [
        [
          {
            "node": "Tem Contact ID?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem Contact ID?": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp GHL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Contato não encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp GHL": {
      "main": [
        [
          {
            "node": "Registrar Envio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v2.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "sistema-cobranca-automatica",
  "tags": []
}
