{
  "name": "1. Agente Financeiro Principal",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook-ghl-financeiro",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 400],
      "id": "webhook-ghl",
      "name": "Webhook GHL",
      "webhookId": "webhook-ghl-financeiro"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ghl-location",
              "name": "location_id",
              "value": "cd1uyzpJox6XPt4Vct8Y",
              "type": "string"
            },
            {
              "id": "ghl-api",
              "name": "ghl_api_key",
              "value": "pit-fe627027-b9cb-4ea3-aaa4-149459e66a03",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 400],
      "id": "config-ghl",
      "name": "Config GHL"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "01",
              "name": "contact_id",
              "value": "={{ $json.body?.contactId || $json.contactId || $json.contact_id }}",
              "type": "string"
            },
            {
              "id": "02",
              "name": "telefone",
              "value": "={{ $json.body?.phone || $json.phone || $json.from }}",
              "type": "string"
            },
            {
              "id": "03",
              "name": "email",
              "value": "={{ $json.body?.email || $json.email || '' }}",
              "type": "string"
            },
            {
              "id": "04",
              "name": "mensagem",
              "value": "={{ $json.body?.message || $json.message || $json.body?.body || $json.body || '' }}",
              "type": "string"
            },
            {
              "id": "05",
              "name": "tipo_mensagem",
              "value": "={{ $json.body?.type || $json.type || 'text' }}",
              "type": "string"
            },
            {
              "id": "06",
              "name": "tem_arquivo",
              "value": "={{ ['image', 'document', 'file', 'media'].includes($json.body?.type || $json.type || '') || !!($json.body?.attachments || $json.attachments) }}",
              "type": "boolean"
            },
            {
              "id": "07",
              "name": "url_arquivo",
              "value": "={{ $json.body?.attachments?.[0]?.url || $json.attachments?.[0]?.url || $json.body?.mediaUrl || $json.mediaUrl || '' }}",
              "type": "string"
            },
            {
              "id": "08",
              "name": "conversation_id",
              "value": "={{ $json.body?.conversationId || $json.conversationId || '' }}",
              "type": "string"
            },
            {
              "id": "09",
              "name": "location_id",
              "value": "={{ $('Config GHL').item.json.location_id }}",
              "type": "string"
            },
            {
              "id": "10",
              "name": "ghl_api_key",
              "value": "={{ $('Config GHL').item.json.ghl_api_key }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [680, 400],
      "id": "info-node",
      "name": "Extrair Informa√ß√µes"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cond-01",
              "leftValue": "={{ $json.contact_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [900, 400],
      "id": "filter-valid",
      "name": "Validar Contato"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "route-01",
                    "leftValue": "={{ $json.tem_arquivo }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Arquivo"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "route-02",
                    "leftValue": "={{ $json.mensagem }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [1120, 400],
      "id": "route-type",
      "name": "Tipo de Entrada"
    },
    {
      "parameters": {
        "url": "={{ $json.url_arquivo }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1360, 280],
      "id": "download-file",
      "name": "Download Arquivo"
    },
    {
      "parameters": {
        "resource": "image",
        "modelId": {
          "__rl": true,
          "value": "claude-sonnet-4-5-20250929",
          "mode": "list",
          "cachedResultName": "claude-sonnet-4-5-20250929"
        },
        "text": "# PAPEL\nVoc√™ √© um assistente especializado em extrair dados financeiros de documentos (extratos banc√°rios, comprovantes de pagamento, boletos, notas fiscais).\n\n# TAREFA\nAnalise o documento fornecido e extraia as seguintes informa√ß√µes:\n\n## Dados Obrigat√≥rios:\n- **tipo**: \"receita\" ou \"despesa\"\n- **valor**: valor num√©rico (apenas n√∫meros e v√≠rgula)\n- **descricao**: descri√ß√£o breve da movimenta√ß√£o\n- **data_vencimento**: data de vencimento no formato YYYY-MM-DD\n- **tipo_entidade**: \"pf\" ou \"pj\"\n\n## Dados Opcionais:\n- **data_realizado**: data de pagamento/recebimento no formato YYYY-MM-DD (se j√° pago)\n- **quitado**: true se j√° foi pago/recebido, false caso contr√°rio\n- **observacao**: informa√ß√µes adicionais relevantes\n- **fornecedor_nome**: nome do fornecedor/cliente\n- **fornecedor_cpf_cnpj**: CPF ou CNPJ do fornecedor/cliente\n\n# FORMATO DE SA√çDA\nResponda APENAS com um objeto JSON v√°lido, sem texto adicional.\n\n# REGRAS\n1. Se n√£o conseguir extrair um campo obrigat√≥rio, coloque null\n2. Inclua um campo \"confianca\" de 0 a 100\n3. Sempre retorne JSON v√°lido",
        "imageUrls": "=data:image/{{ $binary.data.fileExtension || 'png' }};base64,{{ $binary.data.data }}",
        "options": {
          "maxTokens": 1000,
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.anthropic",
      "typeVersion": 1,
      "position": [1580, 280],
      "id": "analyze-image-claude",
      "name": "Analisar com Claude",
      "credentials": {
        "anthropicApi": {
          "id": "anthropic-bpo",
          "name": "Anthropic - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse e formata resposta do Claude\nconst claudeResponse = $input.item.json.content?.[0]?.text || $input.item.json.text || $input.item.json.content || '{}';\nconst info = $('Extrair Informa√ß√µes').item.json;\n\nlet dados = {};\ntry {\n  const jsonMatch = claudeResponse.match(/```json\\s*([\\s\\S]*?)```/) || claudeResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    dados = JSON.parse(jsonMatch[1] || jsonMatch[0]);\n  } else {\n    dados = JSON.parse(claudeResponse);\n  }\n} catch (e) {\n  return {\n    json: {\n      erro: true,\n      mensagem: 'N√£o consegui processar o documento. Por favor, envie novamente ou descreva manualmente.',\n      contact_id: info.contact_id,\n      ghl_api_key: info.ghl_api_key\n    }\n  };\n}\n\nconst valorFormatado = new Intl.NumberFormat('pt-BR', {\n  style: 'currency',\n  currency: 'BRL'\n}).format(dados.valor || 0);\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return 'N√£o informada';\n  const data = new Date(dataStr + 'T00:00:00');\n  return data.toLocaleDateString('pt-BR');\n};\n\nconst tipoEmoji = dados.tipo === 'receita' ? 'üí∞' : 'üí≥';\nconst statusEmoji = dados.quitado ? '‚úÖ' : '‚è≥';\nconst statusTexto = dados.quitado ? 'PAGO' : 'PENDENTE';\n\nconst mensagem = `${tipoEmoji} *${dados.tipo?.toUpperCase() || 'MOVIMENTA√á√ÉO'} ${dados.tipo_entidade?.toUpperCase() || ''}*\n\nüìã Dados extra√≠dos do documento:\n\n‚Ä¢ Descri√ß√£o: ${dados.descricao || 'N√£o identificada'}\n‚Ä¢ Valor: ${valorFormatado}\n‚Ä¢ Vencimento: ${formatarData(dados.data_vencimento)}\n${dados.data_realizado ? '‚Ä¢ Pagamento: ' + formatarData(dados.data_realizado) : ''}\n‚Ä¢ Status: ${statusEmoji} ${statusTexto}\n${dados.fornecedor_nome ? '‚Ä¢ Fornecedor: ' + dados.fornecedor_nome : ''}\n${dados.observacao ? '‚Ä¢ Obs: ' + dados.observacao : ''}\n\nüîç Confian√ßa da extra√ß√£o: ${dados.confianca || 0}%\n\nConfirmar inser√ß√£o? (Sim/N√£o/Corrigir)`;\n\nreturn {\n  json: {\n    ...dados,\n    mensagem,\n    contact_id: info.contact_id,\n    ghl_api_key: info.ghl_api_key,\n    aguardando_confirmacao: true\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 280],
      "id": "format-file-confirmation",
      "name": "Formatar Confirma√ß√£o Arquivo"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "={{ $env.WORKFLOW_AGENTE_FINANCEIRO_IA || 'agente-financeiro-ia-bpo' }}",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "mensagem": "={{ $json.mensagem }}",
            "telefone": "={{ $json.telefone }}",
            "contact_id": "={{ $json.contact_id }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [1360, 520],
      "id": "execute-agent",
      "name": "Executar Agente IA"
    },
    {
      "parameters": {
        "jsCode": "// Formatar resposta do agente para envio WhatsApp\nconst respostaAgente = $input.item.json.output || $input.item.json.text || $input.item.json.response || '';\nconst info = $('Extrair Informa√ß√µes').item.json;\n\nreturn {\n  json: {\n    mensagem: respostaAgente,\n    contact_id: info.contact_id,\n    ghl_api_key: info.ghl_api_key\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1580, 520],
      "id": "format-agent-response",
      "name": "Formatar Resposta Agente"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.ghl_api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $json.contact_id }}\",\n  \"message\": \"{{ $json.mensagem.replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 520],
      "id": "send-whatsapp-agent",
      "name": "Enviar WhatsApp (Agente)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.ghl_api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $json.contact_id }}\",\n  \"message\": \"{{ $json.mensagem.replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2020, 280],
      "id": "send-whatsapp-file",
      "name": "Enviar WhatsApp (Arquivo)"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1120, 600],
      "id": "noop-end",
      "name": "Fim - Ignorar"
    }
  ],
  "connections": {
    "Webhook GHL": {
      "main": [
        [
          {
            "node": "Config GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config GHL": {
      "main": [
        [
          {
            "node": "Extrair Informa√ß√µes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Informa√ß√µes": {
      "main": [
        [
          {
            "node": "Validar Contato",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Contato": {
      "main": [
        [
          {
            "node": "Tipo de Entrada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fim - Ignorar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de Entrada": {
      "main": [
        [
          {
            "node": "Download Arquivo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Executar Agente IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Arquivo": {
      "main": [
        [
          {
            "node": "Analisar com Claude",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analisar com Claude": {
      "main": [
        [
          {
            "node": "Formatar Confirma√ß√£o Arquivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Confirma√ß√£o Arquivo": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp (Arquivo)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Executar Agente IA": {
      "main": [
        [
          {
            "node": "Formatar Resposta Agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Resposta Agente": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp (Agente)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v2.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "agente-financeiro-principal",
  "tags": []
}
