{
  "name": "[TOOL] Fluxo de Caixa Projetado",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "trigger",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Fluxo de caixa projetado\nWITH fluxo AS (\n  SELECT \n    data_vencimento,\n    SUM(CASE WHEN tipo = 'receita' THEN valor_previsto ELSE 0 END) as entradas,\n    SUM(CASE WHEN tipo = 'despesa' THEN valor_previsto ELSE 0 END) as saidas\n  FROM movimentacoes_financeiras\n  WHERE \n    quitado = false\n    AND data_vencimento BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '{{ $json.dias || 30 }} days'\n  GROUP BY data_vencimento\n  ORDER BY data_vencimento\n)\nSELECT \n  data_vencimento,\n  entradas,\n  saidas,\n  entradas - saidas as saldo_dia,\n  SUM(entradas - saidas) OVER (ORDER BY data_vencimento) as saldo_acumulado\nFROM fluxo;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [460, 300],
      "id": "query-fluxo",
      "name": "Buscar Fluxo de Caixa",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Resumo totais\nSELECT \n  COALESCE(SUM(CASE WHEN tipo = 'receita' AND quitado = false THEN valor_previsto ELSE 0 END), 0) as total_entradas_previstas,\n  COALESCE(SUM(CASE WHEN tipo = 'despesa' AND quitado = false THEN valor_previsto ELSE 0 END), 0) as total_saidas_previstas,\n  COALESCE(SUM(CASE WHEN tipo = 'receita' AND quitado = false THEN valor_previsto ELSE 0 END), 0) - \n  COALESCE(SUM(CASE WHEN tipo = 'despesa' AND quitado = false THEN valor_previsto ELSE 0 END), 0) as saldo_projetado\nFROM movimentacoes_financeiras\nWHERE \n  data_vencimento BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [460, 460],
      "id": "query-totais",
      "name": "Totais",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar resposta do fluxo de caixa\nconst fluxoDiario = $('Buscar Fluxo de Caixa').all().filter(i => i.json.data_vencimento);\nconst totais = $('Totais').first().json;\n\nconst formatarValor = (valor) => new Intl.NumberFormat('pt-BR', {\n  style: 'currency',\n  currency: 'BRL'\n}).format(valor || 0);\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return '-';\n  const data = new Date(dataStr + 'T00:00:00');\n  return data.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});\n};\n\n// Agrupar por semana\nconst semanas = {};\nfluxoDiario.forEach(item => {\n  const d = item.json;\n  const data = new Date(d.data_vencimento + 'T00:00:00');\n  const semana = Math.ceil((data.getDate()) / 7);\n  const chave = `Semana ${semana}`;\n  \n  if (!semanas[chave]) {\n    semanas[chave] = { entradas: 0, saidas: 0 };\n  }\n  semanas[chave].entradas += parseFloat(d.entradas) || 0;\n  semanas[chave].saidas += parseFloat(d.saidas) || 0;\n});\n\nconst entradasPrevistas = parseFloat(totais.total_entradas_previstas) || 0;\nconst saidasPrevistas = parseFloat(totais.total_saidas_previstas) || 0;\nconst saldoProjetado = parseFloat(totais.saldo_projetado) || 0;\n\nreturn {\n  json: {\n    resumo: {\n      periodo: 'Próximos 30 dias',\n      total_entradas: formatarValor(entradasPrevistas),\n      total_saidas: formatarValor(saidasPrevistas),\n      saldo_projetado: formatarValor(saldoProjetado),\n      situacao: saldoProjetado >= 0 ? 'POSITIVO' : 'NEGATIVO'\n    },\n    por_semana: Object.entries(semanas).map(([semana, valores]) => ({\n      semana,\n      entradas: formatarValor(valores.entradas),\n      saidas: formatarValor(valores.saidas),\n      saldo: formatarValor(valores.entradas - valores.saidas)\n    })),\n    detalhes_diarios: fluxoDiario.slice(0, 10).map(item => {\n      const d = item.json;\n      return {\n        data: formatarData(d.data_vencimento),\n        entradas: formatarValor(d.entradas),\n        saidas: formatarValor(d.saidas),\n        saldo_acumulado: formatarValor(d.saldo_acumulado)\n      };\n    }),\n    alerta: saldoProjetado < 0 ? `ATENÇÃO: Saldo projetado negativo de ${formatarValor(Math.abs(saldoProjetado))}` : null\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 380],
      "id": "formatar-resposta",
      "name": "Formatar Resposta"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Buscar Fluxo de Caixa",
            "type": "main",
            "index": 0
          },
          {
            "node": "Totais",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Fluxo de Caixa": {
      "main": [
        [
          {
            "node": "Formatar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Totais": {
      "main": [
        [
          {
            "node": "Formatar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "tool-fluxo-caixa",
  "tags": []
}
