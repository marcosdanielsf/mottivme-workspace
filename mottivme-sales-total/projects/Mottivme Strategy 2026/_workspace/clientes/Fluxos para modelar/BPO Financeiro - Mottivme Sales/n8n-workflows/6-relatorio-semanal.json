{
  "name": "6. Relatório Semanal Automático",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * 1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 400],
      "id": "schedule-trigger",
      "name": "Segunda-feira 9h"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ghl-location",
              "name": "location_id",
              "value": "cd1uyzpJox6XPt4Vct8Y",
              "type": "string"
            },
            {
              "id": "ghl-api",
              "name": "ghl_api_key",
              "value": "pit-fe627027-b9cb-4ea3-aaa4-149459e66a03",
              "type": "string"
            },
            {
              "id": "admin-contact",
              "name": "admin_contact_id",
              "value": "={{ $env.ADMIN_CONTACT_ID || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 400],
      "id": "config-ghl",
      "name": "Config GHL"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Resumo da semana passada - RECEITAS\nSELECT \n  'receita' as tipo,\n  COUNT(*) as quantidade,\n  COALESCE(SUM(valor_realizado), 0) as valor_realizado,\n  COALESCE(SUM(valor_previsto), 0) as valor_previsto,\n  COUNT(*) FILTER (WHERE quitado = true) as quitados\nFROM movimentacoes_financeiras\nWHERE \n  tipo = 'receita'\n  AND created_at >= CURRENT_DATE - INTERVAL '7 days';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 280],
      "id": "query-receitas",
      "name": "Receitas Semana",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Resumo da semana passada - DESPESAS\nSELECT \n  'despesa' as tipo,\n  COUNT(*) as quantidade,\n  COALESCE(SUM(valor_realizado), 0) as valor_realizado,\n  COALESCE(SUM(valor_previsto), 0) as valor_previsto,\n  COUNT(*) FILTER (WHERE quitado = true) as quitados\nFROM movimentacoes_financeiras\nWHERE \n  tipo = 'despesa'\n  AND created_at >= CURRENT_DATE - INTERVAL '7 days';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 400],
      "id": "query-despesas",
      "name": "Despesas Semana",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Top 5 maiores despesas da semana\nSELECT \n  m.descricao,\n  m.valor_previsto as valor,\n  cat.nome as categoria,\n  c.nome as fornecedor\nFROM movimentacoes_financeiras m\nLEFT JOIN categorias_financeiras cat ON m.categoria_id = cat.id\nLEFT JOIN clientes_fornecedores c ON m.cliente_fornecedor_id = c.id\nWHERE \n  m.tipo = 'despesa'\n  AND m.created_at >= CURRENT_DATE - INTERVAL '7 days'\nORDER BY m.valor_previsto DESC\nLIMIT 5;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 520],
      "id": "query-top-despesas",
      "name": "Top 5 Despesas",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Inadimplência atual\nSELECT \n  COUNT(*) as qtd_inadimplentes,\n  COALESCE(SUM(valor_previsto), 0) as valor_total_inadimplencia\nFROM movimentacoes_financeiras\nWHERE \n  tipo = 'receita'\n  AND quitado = false\n  AND data_vencimento < CURRENT_DATE;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 640],
      "id": "query-inadimplencia",
      "name": "Inadimplência",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Previsão próximos 7 dias\nSELECT \n  COALESCE(SUM(CASE WHEN tipo = 'receita' THEN valor_previsto ELSE 0 END), 0) as entradas_previstas,\n  COALESCE(SUM(CASE WHEN tipo = 'despesa' THEN valor_previsto ELSE 0 END), 0) as saidas_previstas\nFROM movimentacoes_financeiras\nWHERE \n  quitado = false\n  AND data_vencimento BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '7 days';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [680, 760],
      "id": "query-previsao",
      "name": "Previsão 7 dias",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Consolidar relatório semanal\nconst config = $('Config GHL').first().json;\n\nconst receitas = $('Receitas Semana').first().json;\nconst despesas = $('Despesas Semana').first().json;\nconst topDespesas = $('Top 5 Despesas').all().filter(i => i.json && i.json.descricao);\nconst inadimplencia = $('Inadimplência').first().json;\nconst previsao = $('Previsão 7 dias').first().json;\n\n// Função para formatar valor\nconst formatarValor = (valor) => new Intl.NumberFormat('pt-BR', {\n  style: 'currency',\n  currency: 'BRL'\n}).format(Number(valor || 0));\n\n// Calcular saldo\nconst receitasRealizadas = parseFloat(receitas.valor_realizado) || 0;\nconst despesasRealizadas = parseFloat(despesas.valor_realizado) || 0;\nconst saldoSemana = receitasRealizadas - despesasRealizadas;\n\nconst entradasPrevistas = parseFloat(previsao.entradas_previstas) || 0;\nconst saidasPrevistas = parseFloat(previsao.saidas_previstas) || 0;\nconst saldoPrevisto = entradasPrevistas - saidasPrevistas;\n\n// Data do relatório\nconst hoje = new Date();\nconst semanaAnteriorInicio = new Date(hoje);\nsemanaAnteriorInicio.setDate(hoje.getDate() - 7);\n\nconst formatarDataCurta = (d) => d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});\n\n// Montar mensagem\nlet mensagem = `*RELATÓRIO SEMANAL FINANCEIRO*\\n`;\nmensagem += `Período: ${formatarDataCurta(semanaAnteriorInicio)} a ${formatarDataCurta(hoje)}\\n\\n`;\n\n// Resumo da semana\nmensagem += `*RESUMO DA SEMANA*\\n`;\nmensagem += `Receitas: ${formatarValor(receitasRealizadas)} (${receitas.quitados || 0} recebidos)\\n`;\nmensagem += `Despesas: ${formatarValor(despesasRealizadas)} (${despesas.quitados || 0} pagos)\\n`;\nmensagem += `*Saldo: ${formatarValor(saldoSemana)}* ${saldoSemana >= 0 ? '(positivo)' : '(negativo)'}\\n\\n`;\n\n// Top despesas\nif (topDespesas.length > 0) {\n  mensagem += `*MAIORES GASTOS*\\n`;\n  topDespesas.slice(0, 5).forEach((item, idx) => {\n    const d = item.json;\n    mensagem += `${idx + 1}. ${d.descricao}: ${formatarValor(d.valor)}\\n`;\n  });\n  mensagem += `\\n`;\n}\n\n// Inadimplência\nconst valorInadimplencia = parseFloat(inadimplencia.valor_total_inadimplencia) || 0;\nif (valorInadimplencia > 0) {\n  mensagem += `*INADIMPLÊNCIA*\\n`;\n  mensagem += `${inadimplencia.qtd_inadimplentes || 0} títulos em atraso\\n`;\n  mensagem += `Total: *${formatarValor(valorInadimplencia)}*\\n\\n`;\n}\n\n// Previsão\nmensagem += `*PRÓXIMOS 7 DIAS*\\n`;\nmensagem += `Entradas previstas: ${formatarValor(entradasPrevistas)}\\n`;\nmensagem += `Saídas previstas: ${formatarValor(saidasPrevistas)}\\n`;\nmensagem += `Saldo previsto: *${formatarValor(saldoPrevisto)}*\\n\\n`;\n\nmensagem += `---\\nMottivme Sales - BPO Financeiro`;\n\nreturn [{\n  json: {\n    mensagem,\n    admin_contact_id: config.admin_contact_id,\n    ghl_api_key: config.ghl_api_key,\n    dados: {\n      receitas_realizadas: receitasRealizadas,\n      despesas_realizadas: despesasRealizadas,\n      saldo_semana: saldoSemana,\n      inadimplencia: valorInadimplencia,\n      entradas_previstas: entradasPrevistas,\n      saidas_previstas: saidasPrevistas\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 500],
      "id": "consolidar-relatorio",
      "name": "Consolidar Relatório"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-contact",
              "leftValue": "={{ $json.admin_contact_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1120, 500],
      "id": "check-enviar",
      "name": "Tem Destinatário?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.ghl_api_key }}"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"type\": \"SMS\",\n  \"contactId\": \"{{ $json.admin_contact_id }}\",\n  \"message\": \"{{ $json.mensagem.replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 400],
      "id": "send-relatorio",
      "name": "Enviar Relatório GHL"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Registrar envio do relatório\nINSERT INTO relatorios_enviados (tipo, periodo_inicio, periodo_fim, dados, enviado_para)\nVALUES (\n  'semanal',\n  CURRENT_DATE - INTERVAL '7 days',\n  CURRENT_DATE,\n  '{{ JSON.stringify($json.dados).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ $json.admin_contact_id }}'\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1560, 400],
      "id": "log-relatorio",
      "name": "Registrar Relatório",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1340, 600],
      "id": "noop-skip",
      "name": "Sem Destinatário"
    }
  ],
  "connections": {
    "Segunda-feira 9h": {
      "main": [
        [
          {
            "node": "Config GHL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config GHL": {
      "main": [
        [
          {
            "node": "Receitas Semana",
            "type": "main",
            "index": 0
          },
          {
            "node": "Despesas Semana",
            "type": "main",
            "index": 0
          },
          {
            "node": "Top 5 Despesas",
            "type": "main",
            "index": 0
          },
          {
            "node": "Inadimplência",
            "type": "main",
            "index": 0
          },
          {
            "node": "Previsão 7 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Receitas Semana": {
      "main": [
        [
          {
            "node": "Consolidar Relatório",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Despesas Semana": {
      "main": [
        [
          {
            "node": "Consolidar Relatório",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Top 5 Despesas": {
      "main": [
        [
          {
            "node": "Consolidar Relatório",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inadimplência": {
      "main": [
        [
          {
            "node": "Consolidar Relatório",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Previsão 7 dias": {
      "main": [
        [
          {
            "node": "Consolidar Relatório",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidar Relatório": {
      "main": [
        [
          {
            "node": "Tem Destinatário?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem Destinatário?": {
      "main": [
        [
          {
            "node": "Enviar Relatório GHL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sem Destinatário",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Relatório GHL": {
      "main": [
        [
          {
            "node": "Registrar Relatório",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "relatorio-semanal",
  "tags": []
}
