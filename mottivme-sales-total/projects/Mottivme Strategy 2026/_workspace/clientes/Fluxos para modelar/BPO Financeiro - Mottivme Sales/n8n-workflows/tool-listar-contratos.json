{
  "name": "[TOOL] Listar Contratos Cliente",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "trigger",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Buscar contratos do cliente\nSELECT \n  c.id,\n  c.numero_contrato,\n  c.valor_mensal,\n  c.moeda,\n  c.num_parcelas,\n  c.valor_entrada,\n  c.data_inicio,\n  c.data_fim,\n  c.dia_vencimento,\n  c.status,\n  c.assinado_em,\n  c.created_at,\n  cf.nome as cliente_nome\nFROM contratos c\nJOIN clientes_fornecedores cf ON c.cliente_fornecedor_id = cf.id\nWHERE c.cliente_fornecedor_id = '{{ $json.cliente_id }}'::uuid\nORDER BY c.created_at DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [460, 300],
      "id": "buscar-contratos",
      "name": "Buscar Contratos",
      "credentials": {
        "postgres": {
          "id": "supabase-bpo",
          "name": "Supabase - BPO Financeiro"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar lista de contratos\nconst contratos = $input.all().filter(i => i.json.id);\n\nif (contratos.length === 0) {\n  return {\n    json: {\n      encontrados: 0,\n      mensagem: 'Nenhum contrato encontrado para este cliente.',\n      contratos: []\n    }\n  };\n}\n\nconst formatarValor = (valor, moeda) => {\n  if (moeda === 'USD') {\n    return `US$ ${parseFloat(valor).toFixed(2)}`;\n  }\n  return new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(valor);\n};\n\nconst formatarData = (dataStr) => {\n  if (!dataStr) return '-';\n  const data = new Date(dataStr);\n  return data.toLocaleDateString('pt-BR');\n};\n\nconst getStatusLabel = (status) => {\n  const statusMap = {\n    'rascunho': 'ðŸ“ Rascunho',\n    'enviado': 'ðŸ“¤ Enviado',\n    'assinado': 'âœï¸ Assinado',\n    'ativo': 'âœ… Ativo',\n    'encerrado': 'ðŸ Encerrado',\n    'cancelado': 'âŒ Cancelado'\n  };\n  return statusMap[status] || status;\n};\n\nconst listaFormatada = contratos.map(c => {\n  const contrato = c.json;\n  return {\n    numero: contrato.numero_contrato,\n    valor_mensal: formatarValor(contrato.valor_mensal, contrato.moeda),\n    parcelas: contrato.num_parcelas,\n    valor_total: formatarValor(contrato.valor_mensal * contrato.num_parcelas, contrato.moeda),\n    periodo: `${formatarData(contrato.data_inicio)} a ${formatarData(contrato.data_fim)}`,\n    vencimento: `Dia ${contrato.dia_vencimento}`,\n    status: getStatusLabel(contrato.status),\n    assinado_em: contrato.assinado_em ? formatarData(contrato.assinado_em) : '-',\n    criado_em: formatarData(contrato.created_at)\n  };\n});\n\nreturn {\n  json: {\n    cliente: contratos[0].json.cliente_nome,\n    encontrados: contratos.length,\n    contratos: listaFormatada\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300],
      "id": "formatar-lista",
      "name": "Formatar Lista"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Buscar Contratos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Contratos": {
      "main": [
        [
          {
            "node": "Formatar Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "n8n-bpo-financeiro"
  },
  "id": "tool-listar-contratos",
  "tags": []
}
