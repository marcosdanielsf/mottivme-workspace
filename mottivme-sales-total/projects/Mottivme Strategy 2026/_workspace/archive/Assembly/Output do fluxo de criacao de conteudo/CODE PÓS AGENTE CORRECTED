const agentOutput = $input.item.json.output;

// Remove markdown code blocks
let cleaned = typeof agentOutput === 'string'
  ? agentOutput.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim()
  : JSON.stringify(agentOutput);

// ‚úÖ FIX: Handle truncated/incomplete JSON
try {
  // Tentar encontrar o √∫ltimo objeto/array completo
  let jsonStr = cleaned;

  // Se terminar de forma incompleta, tentar fechar adequadamente
  const openBraces = (jsonStr.match(/{/g) || []).length;
  const closeBraces = (jsonStr.match(/}/g) || []).length;
  const openBrackets = (jsonStr.match(/\[/g) || []).length;
  const closeBrackets = (jsonStr.match(/\]/g) || []).length;

  // Adicionar fechamentos faltantes
  if (openBraces > closeBraces) {
    console.log('‚ö†Ô∏è JSON incompleto detectado - tentando fechar...');
    const diff = openBraces - closeBraces;
    jsonStr += '}'.repeat(diff);
  }
  if (openBrackets > closeBrackets) {
    const diff = openBrackets - closeBrackets;
    jsonStr += ']'.repeat(diff);
  }

  // ‚úÖ FIX: Verificar strings n√£o terminadas
  // Procurar por strings que come√ßam mas n√£o terminam antes do fim
  const lastQuotePos = jsonStr.lastIndexOf('"');
  if (lastQuotePos > 0) {
    const afterLastQuote = jsonStr.substring(lastQuotePos + 1);
    // Se ap√≥s a √∫ltima aspas s√≥ tem caracteres de controle/espa√ßos/v√≠rgulas/colchetes
    if (afterLastQuote.match(/^[\s,\]\}]*$/)) {
      // Est√° OK
    } else {
      // Pode ter string n√£o terminada - adicionar aspas de fechamento
      const beforeClosing = jsonStr.substring(0, lastQuotePos + 1);
      const hasOpenString = (beforeClosing.match(/"/g) || []).length % 2 !== 0;
      if (hasOpenString) {
        console.log('‚ö†Ô∏è String n√£o terminada detectada - adicionando aspas de fechamento');
        // Encontrar posi√ß√£o segura para adicionar aspas
        const safePos = jsonStr.search(/[,\]\}](?!.*")/);
        if (safePos > 0) {
          jsonStr = jsonStr.substring(0, safePos) + '"' + jsonStr.substring(safePos);
        }
      }
    }
  }

  // Parse JSON
  const parsed = JSON.parse(jsonStr);

  console.log('‚úÖ JSON PARSEADO COM SUCESSO');
  console.log(`üìÖ Total trilha: ${parsed.trilha_editorial ? parsed.trilha_editorial.length : 0} dias`);

  // ‚úÖ FORMATA TRILHA PARA AIRTABLE (calend√°rio visual)
  const trilhaFormatada = (parsed.trilha_editorial || []).map(dia =>
    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
    `üìÖ DIA ${dia.dia} | ${dia.dia_semana} ${dia.data_sugerida}\n` +
    `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n` +
    `üéØ FASE: ${dia.fase}\n` +
    `üìå PILAR: ${dia.pilar}\n` +
    `üå°Ô∏è TEMPERATURA: ${dia.temperatura_lead}\n\n` +
    `üìù TEMA:\n${dia.tema}\n\n` +
    `üîç √ÇNGULO:\n${dia.angulo}\n\n` +
    `üé¨ FORMATO: ${dia.formato_primario}${dia.duracao_estimada ? ` (${dia.duracao_estimada})` : ''}\n\n` +
    `üé™ GATILHO MENTAL: ${dia.gatilho_mental}\n\n` +
    `üéØ OBJETIVO:\n${dia.objetivo}\n\n` +
    `üìä M√âTRICA DE SUCESSO: ${dia.metrica_sucesso}\n\n` +
    `üí° PONTOS-CHAVE:\n${(dia.pontos_chave || []).map((p, i) => `  ${i+1}. ${p}`).join('\n')}\n\n` +
    `ü™ù HOOK SUGERIDO:\n"${dia.hook_sugerido || 'N/A'}"\n\n` +
    `üì£ CTA (${dia.cta_tipo}):\n${dia.cta_texto || 'N/A'}\n`
  ).join('\n\n');

  // ‚úÖ FORMATA ESTRAT√âGIA RESUMO
  const estrategiaFormatada = parsed.estrategia_resumo ?
    `üìà ESTRAT√âGIA DO M√äS\n\n` +
    `üéØ OBJETIVO:\n${parsed.estrategia_resumo.objetivo_mes || 'N/A'}\n\n` +
    `üìä PILARES DOMINANTES:\n${(parsed.estrategia_resumo.pilares_dominantes || []).map(p => `‚Ä¢ ${p}`).join('\n')}\n\n` +
    `üé¨ DISTRIBUI√á√ÉO DE FORMATOS:\n` +
    `  ‚Ä¢ Reels: ${parsed.estrategia_resumo.distribuicao_formatos?.reels || 'N/A'}\n` +
    `  ‚Ä¢ Stories: ${parsed.estrategia_resumo.distribuicao_formatos?.stories || 'N/A'}\n` +
    `  ‚Ä¢ Carross√©is: ${parsed.estrategia_resumo.distribuicao_formatos?.carrosseis || 'N/A'}\n` +
    `  ‚Ä¢ Posts: ${parsed.estrategia_resumo.distribuicao_formatos?.posts || 'N/A'}\n\n` +
    `üéØ KPIs DO M√äS:\n${(parsed.estrategia_resumo.kpis_mes || []).map(k => `‚Ä¢ ${k}`).join('\n')}`
    : 'Estrat√©gia resumo n√£o dispon√≠vel';

  // ‚úÖ FORMATA INSIGHTS POR SEMANA
  const insightsFormatados = parsed.insights_estrategicos ?
    `üí° INSIGHTS ESTRAT√âGICOS\n\n` +
    `üìÖ SEMANA 1 (Awareness):\n${parsed.insights_estrategicos.semana_1 || 'N/A'}\n\n` +
    `üìÖ SEMANA 2 (Educa√ß√£o):\n${parsed.insights_estrategicos.semana_2 || 'N/A'}\n\n` +
    `üìÖ SEMANA 3 (Diferencia√ß√£o):\n${parsed.insights_estrategicos.semana_3 || 'N/A'}\n\n` +
    `üìÖ SEMANA 4 (Convers√£o):\n${parsed.insights_estrategicos.semana_4 || 'N/A'}`
    : 'Insights estrat√©gicos n√£o dispon√≠veis';

  // ‚úÖ CRIA CALEND√ÅRIO SIMPLIFICADO (1 linha por dia)
  const calendarioSimples = (parsed.trilha_editorial || []).map(dia =>
    `${dia.data_sugerida} (${dia.dia_semana}) | ${dia.formato_primario} | ${dia.tema}`
  ).join('\n');

  // ‚úÖ SEPARA APENAS OS DIAS COM REELS (para o pr√≥ximo agente)
  const diasComReels = (parsed.trilha_editorial || []).filter(dia =>
    dia.formato_primario === 'Reel'
  );

  // ‚úÖ ESTAT√çSTICAS DA TRILHA
  const trilhaArray = parsed.trilha_editorial || [];
  const stats = {
    total_dias: trilhaArray.length,
    total_reels: diasComReels.length,
    total_stories: trilhaArray.filter(d => d.formato_primario === 'Story').length,
    total_carrosseis: trilhaArray.filter(d => d.formato_primario === 'Carrossel').length,
    total_posts: trilhaArray.filter(d => d.formato_primario === 'Post').length,
    por_fase: {
      awareness: trilhaArray.filter(d => d.fase === 'Awareness').length,
      educacao: trilhaArray.filter(d => d.fase === 'Educa√ß√£o').length,
      diferenciacao: trilhaArray.filter(d => d.fase === 'Diferencia√ß√£o').length,
      conversao: trilhaArray.filter(d => d.fase === 'Convers√£o').length
    }
  };

  const statsFormatadas =
    `üìä ESTAT√çSTICAS DA TRILHA\n\n` +
    `üìÖ Total de dias: ${stats.total_dias}\n\n` +
    `üé¨ FORMATOS:\n` +
    `  ‚Ä¢ Reels: ${stats.total_reels}\n` +
    `  ‚Ä¢ Stories: ${stats.total_stories}\n` +
    `  ‚Ä¢ Carross√©is: ${stats.total_carrosseis}\n` +
    `  ‚Ä¢ Posts: ${stats.total_posts}\n\n` +
    `üå°Ô∏è POR FASE:\n` +
    `  ‚Ä¢ Awareness: ${stats.por_fase.awareness} dias\n` +
    `  ‚Ä¢ Educa√ß√£o: ${stats.por_fase.educacao} dias\n` +
    `  ‚Ä¢ Diferencia√ß√£o: ${stats.por_fase.diferenciacao} dias\n` +
    `  ‚Ä¢ Convers√£o: ${stats.por_fase.conversao} dias`;

  console.log('‚úÖ TRILHA EDITORIAL PARSEADA COM SUCESSO');
  console.log(`üìÖ Total: ${stats.total_dias} dias`);
  console.log(`üé¨ Reels: ${stats.total_reels}`);
  console.log(`üë§ Expert: ${parsed.expert_name || 'N/A'}`);

  return {
    json: {
      // Para Airtable - texto formatado
      trilha_texto: trilhaFormatada,
      estrategia_texto: estrategiaFormatada,
      insights_texto: insightsFormatados,
      calendario_texto: calendarioSimples,
      stats_texto: statsFormatadas,

      // Para uso program√°tico - JSON
      trilha_json: JSON.stringify(trilhaArray, null, 2),
      trilha_completa_json: JSON.stringify(parsed, null, 2),

      // ‚úÖ APENAS OS DIAS COM REELS (para pr√≥ximo agente)
      dias_reels_json: JSON.stringify(diasComReels, null, 2),

      // Metadata
      expert_id: parsed.expert_id || 'unknown',
      expert_name: parsed.expert_name || 'Unknown Expert',
      total_dias: stats.total_dias,
      total_reels: stats.total_reels,
      stats: stats,
      data_geracao: new Date().toISOString(),

      // ‚úÖ Flag de parsing
      parsing_status: 'success',
      parsing_warnings: jsonStr !== cleaned ? ['JSON foi reparado automaticamente'] : []
    }
  };

} catch (error) {
  console.error('‚ùå ERRO NO PARSE:', error.message);
  console.error('Output (primeiros 1000 chars):', cleaned.substring(0, 1000));
  console.error('Output (√∫ltimos 500 chars):', cleaned.substring(Math.max(0, cleaned.length - 500)));

  // ‚úÖ Retornar erro estruturado em vez de throw
  return {
    json: {
      parsing_status: 'error',
      error_message: error.message,
      error_type: 'JSON_PARSE_ERROR',
      output_preview: cleaned.substring(0, 500),
      output_length: cleaned.length,

      // Dados vazios para n√£o quebrar workflow
      trilha_texto: 'ERRO: N√£o foi poss√≠vel parsear a trilha editorial',
      estrategia_texto: 'ERRO: Parsing falhou',
      insights_texto: 'ERRO: Parsing falhou',
      calendario_texto: 'ERRO: Parsing falhou',
      stats_texto: 'ERRO: Parsing falhou',
      trilha_json: '[]',
      trilha_completa_json: '{}',
      dias_reels_json: '[]',
      expert_id: 'error',
      expert_name: 'Error',
      total_dias: 0,
      total_reels: 0,
      stats: {},
      data_geracao: new Date().toISOString()
    }
  };
}
